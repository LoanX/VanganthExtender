-- Database  : lin2report

USE [lin2report]
GO

CREATE PROCEDURE [dbo].[lin_CheckReportTable]

AS
SELECT 0
GO

CREATE PROCEDURE [dbo].[lin_DeleteReportTable]

AS
SELECT 0
GO

CREATE PROCEDURE [dbo].[lin_GetClassAmount]

AS
SELECT 0
GO

CREATE PROCEDURE [dbo].[lin_GetItemAmount]

AS
SELECT 0
GO

CREATE PROCEDURE [dbo].[lin_GetLevAmount]

AS
SELECT 0
GO

CREATE PROCEDURE [dbo].[lin_MakeDailyWorldSnap]

AS
SELECT 0
GO

CREATE PROCEDURE [dbo].[lin_MakeHourlyReport]

AS
SELECT 0
GO

CREATE PROCEDURE [dbo].[lin_MakeReport]

AS
SELECT 0
GO

CREATE PROCEDURE [dbo].[lin_MakeReportTable]

AS
SELECT 0
GO

CREATE PROCEDURE [dbo].[lin_ProcessLog]

AS
SELECT 0
GO

CREATE PROCEDURE [dbo].[lin_ProcessLog2]

AS
SELECT 0
GO

CREATE PROCEDURE [dbo].[lin_ProcessLog3]

AS
SELECT 0
GO

CREATE PROCEDURE [dbo].[lin_ProcessLog4]

AS
SELECT 0
GO

CREATE PROCEDURE [dbo].[lin_ProcessLogNew]

AS
SELECT 0
GO

CREATE PROCEDURE [dbo].[lin_RPAccountPlayTime]

AS
SELECT 0
GO

CREATE PROCEDURE [dbo].[lin_RPAchieveMaxLevel]

AS
SELECT 0
GO

CREATE PROCEDURE [dbo].[lin_RPAdenaIncDec]

AS
SELECT 0
GO

CREATE PROCEDURE [dbo].[lin_RPAdenaIncDecByChar]

AS
SELECT 0
GO

CREATE PROCEDURE [dbo].[lin_RPAdenaStatus]

AS
SELECT 0
GO

CREATE PROCEDURE [dbo].[lin_RPAsset]

AS
SELECT 0
GO

CREATE PROCEDURE [dbo].[lin_RPAuthed]

AS
SELECT 0
GO

CREATE PROCEDURE [dbo].[lin_RPAuthed2]

AS
SELECT 0
GO

CREATE PROCEDURE [dbo].[lin_RPAuthStat]

AS
SELECT 0
GO

CREATE PROCEDURE [dbo].[lin_RPAuthStatAge]

AS
SELECT 0
GO

CREATE PROCEDURE [dbo].[lin_RPAuthStatSex]

AS
SELECT 0
GO

CREATE PROCEDURE [dbo].[lin_RPBeginQuest]

AS
SELECT 0
GO

CREATE PROCEDURE [dbo].[lin_RPCastleTax]

AS
SELECT 0
GO

CREATE PROCEDURE [dbo].[lin_RPCastleTaxIncome]

AS
SELECT 0
GO

CREATE PROCEDURE [dbo].[lin_RPCastleTaxInfo]

AS
SELECT 0
GO

CREATE PROCEDURE [dbo].[lin_RPCastleTaxTribute]

AS
SELECT 0
GO

CREATE PROCEDURE [dbo].[lin_RPCastleWar]

AS
SELECT 0
GO

CREATE PROCEDURE [dbo].[lin_RPCastSkill]

AS
SELECT 0
GO

CREATE PROCEDURE [dbo].[lin_RPCastSpoil]

AS
SELECT 0
GO

CREATE PROCEDURE [dbo].[lin_RPChangeClass]

AS
SELECT 0
GO

CREATE PROCEDURE [dbo].[lin_RPChangeClassByClassRace]

AS
SELECT 0
GO

CREATE PROCEDURE [dbo].[lin_RPCharPlay]

AS
SELECT 0
GO

CREATE PROCEDURE [dbo].[lin_RPCharPlayTime]

AS
SELECT 0
GO

CREATE PROCEDURE [dbo].[lin_RPCheckTable]

AS
SELECT 0
GO

CREATE PROCEDURE [dbo].[lin_RPClass]

AS
SELECT 0
GO

CREATE PROCEDURE [dbo].[lin_RPClassBySubJob]

AS
SELECT 0
GO

CREATE PROCEDURE [dbo].[lin_RPClassDec]

AS
SELECT 0
GO

CREATE PROCEDURE [dbo].[lin_RPClassInc]

AS
SELECT 0
GO

CREATE PROCEDURE [dbo].[lin_RPConcurrent]

AS
SELECT 0
GO

CREATE PROCEDURE [dbo].[lin_RPCreateSubJobBySubJob]

AS
SELECT 0
GO

CREATE PROCEDURE [dbo].[lin_RPCreateSubJobCount]

AS
SELECT 0
GO

CREATE PROCEDURE [dbo].[lin_RPCrystalize]

AS
SELECT 0
GO

CREATE PROCEDURE [dbo].[lin_RPDailyLevUp]

AS
SELECT 0
GO

CREATE PROCEDURE [dbo].[lin_RPDieDrop]

AS
SELECT 0
GO

CREATE PROCEDURE [dbo].[lin_RPDieDuration]

AS
SELECT 0
GO

CREATE PROCEDURE [dbo].[lin_RPEarnAdena]

AS
SELECT 0
GO

CREATE PROCEDURE [dbo].[lin_RPEarnSP]

AS
SELECT 0
GO

CREATE PROCEDURE [dbo].[lin_RPEnchant]

AS
SELECT 0
GO

CREATE PROCEDURE [dbo].[lin_RPEnchantFail]

AS
SELECT 0
GO

CREATE PROCEDURE [dbo].[lin_RPEnchantItemByEnchantType]

AS
SELECT 0
GO

CREATE PROCEDURE [dbo].[lin_RPEnchantItemIncDec]

AS
SELECT 0
GO

CREATE PROCEDURE [dbo].[lin_RPEndQuest]

AS
SELECT 0
GO

CREATE PROCEDURE [dbo].[lin_RPEquipItem]

AS
SELECT 0
GO

CREATE PROCEDURE [dbo].[lin_RPEquipped]

AS
SELECT 0
GO

CREATE PROCEDURE [dbo].[lin_RPExp]

AS
SELECT 0
GO

CREATE PROCEDURE [dbo].[lin_RPFishingStatus]

AS
SELECT 0
GO

CREATE PROCEDURE [dbo].[lin_RPGetItem]

AS
SELECT 0
GO

CREATE PROCEDURE [dbo].[lin_RPHuntCount]

AS
SELECT 0
GO

CREATE PROCEDURE [dbo].[lin_RPItem]

AS
SELECT 0
GO

CREATE PROCEDURE [dbo].[lin_RPItemBuy]

AS
SELECT 0
GO

CREATE PROCEDURE [dbo].[lin_RPItemDec]

AS
SELECT 0
GO

CREATE PROCEDURE [dbo].[lin_RPItemInc]

AS
SELECT 0
GO

CREATE PROCEDURE [dbo].[lin_RPItemIncDec]

AS
SELECT 0
GO

CREATE PROCEDURE [dbo].[lin_RPItemSell]

AS
SELECT 0
GO

CREATE PROCEDURE [dbo].[lin_RPJoinSSQ]

AS
SELECT 0
GO

CREATE PROCEDURE [dbo].[lin_RPJoinSSQMainEvent]

AS
SELECT 0
GO

CREATE PROCEDURE [dbo].[lin_RPJoinSSQMember]

AS
SELECT 0
GO

CREATE PROCEDURE [dbo].[lin_RPKillPCCount]

AS
SELECT 0
GO

CREATE PROCEDURE [dbo].[lin_RPKillPCCount2]

AS
SELECT 0
GO

CREATE PROCEDURE [dbo].[lin_RPLearnSkillLev]

AS
SELECT 0
GO

CREATE PROCEDURE [dbo].[lin_RPLevDec]

AS
SELECT 0
GO

CREATE PROCEDURE [dbo].[lin_RPLevInc]

AS
SELECT 0
GO

CREATE PROCEDURE [dbo].[lin_RPLevUp]

AS
SELECT 0
GO

CREATE PROCEDURE [dbo].[lin_RPLevUp2]

AS
SELECT 0
GO

CREATE PROCEDURE [dbo].[lin_RPLocSweeper]

AS
SELECT 0
GO

CREATE PROCEDURE [dbo].[lin_RPLoginCount]

AS
SELECT 0
GO

CREATE PROCEDURE [dbo].[lin_RPLoginCountByRaceLevel]

AS
SELECT 0
GO

CREATE PROCEDURE [dbo].[lin_RPManorInfo]

AS
SELECT 0
GO

CREATE PROCEDURE [dbo].[lin_RPNewAccount]

AS
SELECT 0
GO

CREATE PROCEDURE [dbo].[lin_RPNPCDieLoc]

AS
SELECT 0
GO

CREATE PROCEDURE [dbo].[lin_RPNPCDieLoc2]

AS
SELECT 0
GO

CREATE PROCEDURE [dbo].[lin_RPNPCDrop]

AS
SELECT 0
GO

CREATE PROCEDURE [dbo].[lin_RPNPCDrop2]

AS
SELECT 0
GO

CREATE PROCEDURE [dbo].[lin_RPNPCDropItem]

AS
SELECT 0
GO

CREATE PROCEDURE [dbo].[lin_RPNPCDropLoc]

AS
SELECT 0
GO

CREATE PROCEDURE [dbo].[lin_RPNPCHunted]

AS
SELECT 0
GO

CREATE PROCEDURE [dbo].[lin_RPPCDie]

AS
SELECT 0
GO

CREATE PROCEDURE [dbo].[lin_RPPCDieLoc]

AS
SELECT 0
GO

CREATE PROCEDURE [dbo].[lin_RPPCDieLoc2]

AS
SELECT 0
GO

CREATE PROCEDURE [dbo].[lin_RPPCKillNPC]

AS
SELECT 0
GO

CREATE PROCEDURE [dbo].[lin_RPPCKillPC]

AS
SELECT 0
GO

CREATE PROCEDURE [dbo].[lin_RPPlayAge]

AS
SELECT 0
GO

CREATE PROCEDURE [dbo].[lin_RPPlaySex]

AS
SELECT 0
GO

CREATE PROCEDURE [dbo].[lin_RPPlayStat]

AS
SELECT 0
GO

CREATE PROCEDURE [dbo].[lin_RPPlayTime]

AS
SELECT 0
GO

CREATE PROCEDURE [dbo].[lin_RPPledgeUp]

AS
SELECT 0
GO

CREATE PROCEDURE [dbo].[lin_RPPrivateStore]

AS
SELECT 0
GO

CREATE PROCEDURE [dbo].[lin_RPQuestAssetByChar]

AS
SELECT 0
GO

CREATE PROCEDURE [dbo].[lin_RPRankDailyAdena]

AS
SELECT 0
GO

CREATE PROCEDURE [dbo].[lin_RPRankDailyCrystal]

AS
SELECT 0
GO

CREATE PROCEDURE [dbo].[lin_RPRankDailyExp]

AS
SELECT 0
GO

CREATE PROCEDURE [dbo].[lin_RPRankDailyGetExp]

AS
SELECT 0
GO

CREATE PROCEDURE [dbo].[lin_RPRankDailyOlympiadPoint]

AS
SELECT 0
GO

CREATE PROCEDURE [dbo].[lin_RPRankDailySealStone]

AS
SELECT 0
GO

CREATE PROCEDURE [dbo].[lin_RPRankRecommendation]

AS
SELECT 0
GO

CREATE PROCEDURE [dbo].[lin_RPRecipe]

AS
SELECT 0
GO

CREATE PROCEDURE [dbo].[lin_RPRecipeShopGetItem]

AS
SELECT 0
GO

CREATE PROCEDURE [dbo].[lin_RPRegionalStatByPartyMemberCount]

AS
SELECT 0
GO

CREATE PROCEDURE [dbo].[lin_RPSayCount]

AS
SELECT 0
GO

CREATE PROCEDURE [dbo].[lin_RPSellPrivate]

AS
SELECT 0
GO

CREATE PROCEDURE [dbo].[lin_RPSetHero]

AS
SELECT 0
GO

CREATE PROCEDURE [dbo].[lin_RPSkillEnchant]

AS
SELECT 0
GO

CREATE PROCEDURE [dbo].[lin_RPSnapSSQData]

AS
SELECT 0
GO

CREATE PROCEDURE [dbo].[lin_RPSnapSSQJoinData]

AS
SELECT 0
GO

CREATE PROCEDURE [dbo].[lin_RPSnapTimeAttackRecord]

AS
SELECT 0
GO

CREATE PROCEDURE [dbo].[lin_RPSSQSealSelection]

AS
SELECT 0
GO

CREATE PROCEDURE [dbo].[lin_RPStand]

AS
SELECT 0
GO

CREATE PROCEDURE [dbo].[lin_RPStopQuest]

AS
SELECT 0
GO

CREATE PROCEDURE [dbo].[lin_RPSvrStart]

AS
SELECT 0
GO

CREATE PROCEDURE [dbo].[lin_RPTblCastleWar]

AS
SELECT 0
GO

CREATE PROCEDURE [dbo].[lin_RPTblDailyAdenaUp]

AS
SELECT 0
GO

CREATE PROCEDURE [dbo].[lin_RPTblDailyCountItem]

AS
SELECT 0
GO

CREATE PROCEDURE [dbo].[lin_RPTblGetQuestItem]

AS
SELECT 0
GO

CREATE PROCEDURE [dbo].[lin_RPTblGetQuestItemChar]

AS
SELECT 0
GO

CREATE PROCEDURE [dbo].[lin_RPTblHourlyAdenaCount]

AS
SELECT 0
GO

CREATE PROCEDURE [dbo].[lin_RPTblHourlyAncientAdenaCount]

AS
SELECT 0
GO

CREATE PROCEDURE [dbo].[lin_RPTblHourlySealStoneCount]

AS
SELECT 0
GO

CREATE PROCEDURE [dbo].[lin_RPTblPartyInfoByClass]

AS
SELECT 0
GO

CREATE PROCEDURE [dbo].[lin_RPTblPledgeLevUp]

AS
SELECT 0
GO

CREATE PROCEDURE [dbo].[lin_RPTblQuestBegin]

AS
SELECT 0
GO

CREATE PROCEDURE [dbo].[lin_RPTblQuestEnd]

AS
SELECT 0
GO

CREATE PROCEDURE [dbo].[lin_RPTblQuestSettle]

AS
SELECT 0
GO

CREATE PROCEDURE [dbo].[lin_RPTblQuestStop]

AS
SELECT 0
GO

CREATE PROCEDURE [dbo].[lin_RPTradeGet]

AS
SELECT 0
GO

CREATE PROCEDURE [dbo].[lin_RPTradeGive]

AS
SELECT 0
GO

CREATE PROCEDURE [dbo].[lin_RPTradeItem]

AS
SELECT 0
GO

CREATE PROCEDURE [dbo].[lin_RPUseSkill]

AS
SELECT 0
GO

CREATE PROCEDURE [dbo].[lin_RPWareDeposit]

AS
SELECT 0
GO

CREATE PROCEDURE [dbo].[lin_RPWareRetrieve]

AS
SELECT 0
GO

CREATE PROCEDURE [dbo].[lin_RPWorldSnap]

AS
SELECT 0
GO

/********************************************
lin_MakeReportTable
do make report table

#argument	@table_type	int		table type, the type is between 1 and 4
#argument	@table_name	varchar(60)	table name to be created
#return
#result_set
#remark
#example	Exec lin_MakeReportTable 1, table_name
#history	create	young	2003-01-24
#see
********************************************/
ALTER PROCEDURE [DBO].[lin_MakeReportTable]
(
	@table_type int,
	@table_name varchar(60)
)
AS
SET NOCOUNT ON

declare @sql varchar(1024)

if @table_type = 1 
begin
	set @sql = 'CREATE TABLE dbo.' + @table_name + ' (' 
		+ ' log_id	int, '
		+ ' log_date	datetime, '
		+ ' level	int, '
		+ ' xloc	int, '
		+ ' yloc	int, '
		+ ' zloc	int, '
		+ ' hunt_count	int '
		+ ' ) '

	exec (@sql)
end

if @table_type = 2
begin
	set @sql = 'CREATE TABLE dbo.' + @table_name + ' (' 
		+ ' log_id	int, '
		+ ' log_date	datetime, '
		+ ' level	int, '
		+ ' npc_type int, '
		+ ' hunt_count	int '
		+ ' ) '

	exec (@sql)
end 

if @table_type = 3
begin
	set @sql = 'CREATE TABLE dbo.' + @table_name + ' (' 
		+ ' log_id	int, '
		+ ' log_date	datetime, '
		+ ' stats_type int, '
		+ ' die_count	int '
		+ ' ) '

	exec (@sql)
end

if @table_type = 4
begin
	set @sql = 'CREATE TABLE dbo.' + @table_name + ' (' 
		+ ' log_date	datetime, '
		+ 'count_id	int, '
		+ 'log_val	int, '
		+ 'log_subval	int,'
		+ 'log_count 	int'
		+ ' ) '

	exec (@sql)
end
GO

/********************************************
lin_CheckReportTable
do check whether report table is exist or not

#argument	@table_type	int		table type
#argument	@table_name	varchar(60)	table name to be checked
#return
#result_set
#remark
#example	Exec lin_CheckReportTable 1, 'R2004_11_PLAYTIME_8'
#history	create		young	2003-01-24
#see		lin_MakeReportTable
********************************************/
ALTER PROCEDURE [DBO].[lin_CheckReportTable]
(
	@table_type	int,
	@table_name varchar(60)

)
AS
SET NOCOUNT ON

declare @sql varchar(255)

set @sql = 'select * from lin2report.dbo.sysobjects (nolock) where name = ''' + @table_name + ''''

exec (@sql)

if (@@ROWCOUNT = 0)
begin

	exec lin_MakeReportTable @table_type , @table_name	

end

/*
if @table_type = 1 
begin
	-- HUNT_LOG table
	set @sql = 'select * from sysobjects (nolock) where name = ''' + @table_name + ''''

	exec (@sql)
	if (@@ROWCOUNT = 0)
	begin
		set @sql = 'exec lin_MakeReportTable 1, ''' + @table_name + ''''
		exec (@sql)
	end
end
*/
GO

/********************************************
lin_DeleteReportTable
delete Report data that is before 3 months 

#argument	@delete_date	int	the date to delete
#argument	@delete_world	int	the number of world
#return
#result_set
#remark
#example	exec lin_DeleteReportTable 20040716, 8
#history	create	flagoftiger	2004-07-16
#see
********************************************/
ALTER PROCEDURE dbo.lin_DeleteReportTable
	@delete_date	int,
	@delete_world	int
AS

if @delete_date is null
begin
	set @delete_date = cast(dateadd(month, -3, getdate()) as int)
end

declare @sql varchar(1024)
declare @table	varchar(60)

-- lin_RPRankDailyExp
set @table =  'RANKDAILYEXP_' + cast(@delete_world as varchar)
set @sql = ' delete RP_' + @table + '_' + cast(@delete_world as varchar) + ' where log_date < ' + cast(@delete_date as varchar(8))
exec (@sql)

-- lin_RPRankDailyAdena
set @table =  'RANKDAILYADENA_' + cast(@delete_world as varchar)
set @sql = ' delete RP_' + @table + '_' + cast(@delete_world as varchar) + ' where log_date < ' + cast(@delete_date as varchar(8))
exec (@sql)

-- lin_RPRankDailyCrystal
set @table =  'RANKDAILYCRYSTAL_' + cast(@delete_world as varchar)
set @sql = ' delete RP_' + @table + '_' + cast(@delete_world as varchar) + ' where log_date < ' + cast(@delete_date as varchar(8))
exec (@sql)

-- lin_RPTblDailyCountItem
set @table =  'TBLDAILYCOUNTITEM_' + cast(@delete_world as varchar)
set @sql = ' delete RP_' + @table + '_' + cast(@delete_world as varchar) + ' where log_date < ' + cast(@delete_date as varchar(8))
exec (@sql)
GO

/********************************************
lin_GetClassAmount
get class amount

#argument	@class	int	class id
#argument	@world	int	the number of world
#return
#result_set
#remark
#example	Exec lin_GetClassAmount 1, 1
#history	create	young	2003-11-10
#see
********************************************/
ALTER PROCEDURE [DBO].[lin_GetClassAmount]
	@class		int,
	@world		int

AS

SET NOCOUNT ON

declare @dt 	nvarchar(30)
declare @dt2 	nvarchar(30)
declare @ym	nvarchar(10)
declare @ym2 	nvarchar(10)
declare @sql nvarchar(3000)

set @dt = cast ( getdate() as nvarchar)
set @dt2 = cast ( dateadd ( mm, -1, getdate() ) as nvarchar )

set @ym = substring( @dt , 7, 4) + '_' + substring( @dt , 1, 2)
set @ym2 = substring( @dt2 , 7, 4) + '_' + substring( @dt2 , 1, 2)

set @sql = ' declare @nbase int  '
	+ ' declare @ndec int  '
	+ ' declare @ninc int  '
	+ ' declare @ndec2 int  '
	+ ' declare @ninc2 int  '
	+ ' declare @ndate int '
	+ ' set @nbase = 0 '
	+ ' set @ndec = 0 '
	+ ' set @ninc = 0 '
	+ ' set @ndec2 = 0 '
	+ ' set @ninc2 = 0 '
	+ ' set @ndate = 0 '
	+ ' select @ndate = log_date, @nbase = namount from  '
	+ ' ( '
	+ ' select top 1 log_date,  namount=sum(class_count) from lin2report.dbo.R' +  @ym + '_SNAPCLASS_' + cast ( @world as nvarchar) + ' (nolock) '
	+ ' where class  =  ' + cast ( @class as nvarchar)
	+ ' group by log_date  '
	+ ' order by log_date desc '
	+ ' ) as R1 '
	+ ' if @ndate > 0 '
	+ ' begin '
		+ ' select  @ndec = isnull( sum(amount) , 0) from lin2report.dbo.R' + @ym + '_CLASSDEC_' + cast ( @world as nvarchar)  + ' (nolock) '
		+ ' where class = ' + cast ( @class as nvarchar) + ' and log_date >= @ndate '
		+ ' select @ninc =  isnull( sum(amount) , 0) from lin2report.dbo.R' + @ym + '_CLASSINC_' + cast ( @world as nvarchar) + '  (nolock) '
		+ ' where class = ' + cast ( @class as nvarchar) + ' and log_date >= @ndate '
		+ ' select @nbase, @ninc + @ndec, @nbase + @ninc + @ndec '
	+ ' end else begin '
		+ ' select @ndate = log_date, @nbase = namount from  '
		+ ' ( '
		+ ' select top 1 log_date,  namount= isnull ( sum(class_count) , 0) from lin2report.dbo.R' +  @ym2 + '_SNAPCLASS_' + cast ( @world as nvarchar) + ' (nolock) '
		+ ' where class =  ' + cast ( @class as nvarchar)
		+ ' group by log_date  '
		+ ' order by log_date desc '
		+ ' ) as R1 '
		+ ' select  @ndec = isnull( sum(amount) , 0) from lin2report.dbo.R' + @ym2 + '_CLASSDEC_' + cast ( @world as nvarchar)  + ' (nolock) '
		+ ' where class = ' + cast ( @class as nvarchar) + ' and log_date >= @ndate '
		+ ' select @ninc = isnull ( sum(amount) , 0) from lin2report.dbo.R' + @ym2 + '_CLASSINC_' + cast ( @world as nvarchar) + '  (nolock) '
		+ ' where class = ' + cast ( @class as nvarchar) + ' and log_date >= @ndate '
		+ ' select  @ndec2 = isnull ( sum(amount) , 0) from lin2report.dbo.R' + @ym + '_CLASSDEC_' + cast ( @world as nvarchar)  + ' (nolock) '
		+ ' where class = ' + cast ( @class as nvarchar)  
		+ ' select @ninc2 = isnull (  sum(amount) , 0) from lin2report.dbo.R' + @ym + '_CLASSINC_' + cast ( @world as nvarchar) + '  (nolock) '
		+ ' where class = ' + cast ( @class as nvarchar)  
		+ ' select @nbase, @ninc + @ndec, @nbase + @ninc + @ndec  + @ninc2 + @ndec2 '
	+ ' end '

exec (@sql)
GO

/********************************************
lin_GetItemAmount
get stackable item amount

#argument	@item_type	int	item type
#argument	@world		int	the number of world
#return
#result_set
#remark
#example	Exec lin_GetItemAmount 175, 1
#history	create	young	2003-06-24
#see
********************************************/
ALTER PROCEDURE [DBO].[lin_GetItemAmount]
	@item_type	int,
	@world		int

AS

SET NOCOUNT ON

declare @dt 	nvarchar(30)
declare @dt2 	nvarchar(30)
declare @ym	nvarchar(10)
declare @ym2 	nvarchar(10)
declare @sql nvarchar(3000)

set @dt = cast ( getdate() as nvarchar)
set @dt2 = cast ( dateadd ( mm, -1, getdate() ) as nvarchar )

set @ym = substring( @dt , 7, 4) + '_' + substring( @dt , 1, 2)
set @ym2 = substring( @dt2 , 7, 4) + '_' + substring( @dt2 , 1, 2)

set @sql = ' declare @nbase money '
	+ ' declare @ndec money '
	+ ' declare @ninc money '
	+ ' declare @ndec2 money '
	+ ' declare @ninc2 money '
	+ ' declare @ndate int '
	+ ' set @nbase = 0 '
	+ ' set @ndec = 0 '
	+ ' set @ninc = 0 '
	+ ' set @ndec2 = 0 '
	+ ' set @ninc2 = 0 '
	+ ' set @ndate = 0 '
	+ ' select @ndate = log_date, @nbase = namount from  '
	+ ' ( '
	+ ' select top 1 log_date,  namount=sum(amount) from lin2report.dbo.R' +  @ym + '_SNAPITEM_' + cast ( @world as nvarchar) + ' (nolock) '
	+ ' where item_type =  ' + cast ( @item_type as nvarchar)
	+ ' group by log_date  '
	+ ' order by log_date desc '
	+ ' ) as R1 '
	+ ' if @ndate > 0 '
	+ ' begin '
		+ ' select  @ndec = isnull( sum(amount) , 0) from lin2report.dbo.R' + @ym + '_ITEMDEC_' + cast ( @world as nvarchar)  + ' (nolock) '
		+ ' where item_id = ' + cast ( @item_type as nvarchar) + ' and log_date >= @ndate '
		+ ' select @ninc =  isnull( sum(amount) , 0) from lin2report.dbo.R' + @ym + '_ITEMINC_' + cast ( @world as nvarchar) + '  (nolock) '
		+ ' where item_id = ' + cast ( @item_type as nvarchar) + ' and log_date >= @ndate '
		+ ' select @nbase, @ninc + @ndec, @nbase + @ninc + @ndec '
	+ ' end else begin '
		+ ' select @ndate = log_date, @nbase = namount from  '
		+ ' ( '
		+ ' select top 1 log_date,  namount= isnull ( sum(amount) , 0) from lin2report.dbo.R' +  @ym2 + '_SNAPITEM_' + cast ( @world as nvarchar) + ' (nolock) '
		+ ' where item_type =  ' + cast ( @item_type as nvarchar)
		+ ' group by log_date  '
		+ ' order by log_date desc '
		+ ' ) as R1 '
		+ ' select  @ndec = isnull( sum(amount) , 0) from lin2report.dbo.R' + @ym2 + '_ITEMDEC_' + cast ( @world as nvarchar)  + ' (nolock) '
		+ ' where item_id = ' + cast ( @item_type as nvarchar) + ' and log_date >= @ndate '
		+ ' select @ninc = isnull ( sum(amount) , 0) from lin2report.dbo.R' + @ym2 + '_ITEMINC_' + cast ( @world as nvarchar) + '  (nolock) '
		+ ' where item_id = ' + cast ( @item_type as nvarchar) + ' and log_date >= @ndate '
		+ ' select  @ndec2 = isnull ( sum(amount) , 0) from lin2report.dbo.R' + @ym + '_ITEMDEC_' + cast ( @world as nvarchar)  + ' (nolock) '
		+ ' where item_id = ' + cast ( @item_type as nvarchar)  
		+ ' select @ninc2 = isnull (  sum(amount) , 0) from lin2report.dbo.R' + @ym + '_ITEMINC_' + cast ( @world as nvarchar) + '  (nolock) '
		+ ' where item_id = ' + cast ( @item_type as nvarchar)  
		+ ' select @nbase, @ninc + @ndec, @nbase + @ninc + @ndec  + @ninc2 + @ndec2 '
	+ ' end '

exec (@sql)
GO

/********************************************
lin_GetLevAmount
get level amount

#argument	@lev	int	level
#argument	@world	int	the number of world
#return
#result_set
#remark
#example	Exec lin_GetLevAmount 20, 1
#history	create	young	2003-11-10
#see
********************************************/
ALTER PROCEDURE [DBO].[lin_GetLevAmount]
	@lev		int,
	@world		int

AS

SET NOCOUNT ON

declare @dt 	nvarchar(30)
declare @dt2 	nvarchar(30)
declare @ym	nvarchar(10)
declare @ym2 	nvarchar(10)
declare @sql nvarchar(3000)

set @dt = cast ( getdate() as nvarchar)
set @dt2 = cast ( dateadd ( mm, -1, getdate() ) as nvarchar )

set @ym = substring( @dt , 7, 4) + '_' + substring( @dt , 1, 2)
set @ym2 = substring( @dt2 , 7, 4) + '_' + substring( @dt2 , 1, 2)

set @sql = ' declare @nbase int  '
	+ ' declare @ndec int  '
	+ ' declare @ninc int  '
	+ ' declare @ndec2 int  '
	+ ' declare @ninc2 int  '
	+ ' declare @ndate int '
	+ ' set @nbase = 0 '
	+ ' set @ndec = 0 '
	+ ' set @ninc = 0 '
	+ ' set @ndec2 = 0 '
	+ ' set @ninc2 = 0 '
	+ ' set @ndate = 0 '
	+ ' select @ndate = log_date, @nbase = namount from  '
	+ ' ( '
	+ ' select top 1 log_date,  namount=sum(lev_count) from lin2report.dbo.R' +  @ym + '_SNAPLEV_' + cast ( @world as nvarchar) + ' (nolock) '
	+ ' where lev  =  ' + cast ( @lev as nvarchar)
	+ ' group by log_date  '
	+ ' order by log_date desc '
	+ ' ) as R1 '
	+ ' if @ndate > 0 '
	+ ' begin '
		+ ' select  @ndec = isnull( sum(amount) , 0) from lin2report.dbo.R' + @ym + '_LEVDEC_' + cast ( @world as nvarchar)  + ' (nolock) '
		+ ' where lev = ' + cast ( @lev as nvarchar) + ' and log_date >= @ndate '
		+ ' select @ninc =  isnull( sum(amount) , 0) from lin2report.dbo.R' + @ym + '_LEVINC_' + cast ( @world as nvarchar) + '  (nolock) '
		+ ' where lev = ' + cast ( @lev as nvarchar) + ' and log_date >= @ndate '
		+ ' select @nbase, @ninc + @ndec, @nbase + @ninc + @ndec '
	+ ' end else begin '
		+ ' select @ndate = log_date, @nbase = namount from  '
		+ ' ( '
		+ ' select top 1 log_date,  namount= isnull ( sum(lev_count) , 0) from lin2report.dbo.R' +  @ym2 + '_SNAPLEV_' + cast ( @world as nvarchar) + ' (nolock) '
		+ ' where lev =  ' + cast ( @lev as nvarchar)
		+ ' group by log_date  '
		+ ' order by log_date desc '
		+ ' ) as R1 '
		+ ' select  @ndec = isnull( sum(amount) , 0) from lin2report.dbo.R' + @ym2 + '_LEVDEC_' + cast ( @world as nvarchar)  + ' (nolock) '
		+ ' where lev = ' + cast ( @lev as nvarchar) + ' and log_date >= @ndate '
		+ ' select @ninc = isnull ( sum(amount) , 0) from lin2report.dbo.R' + @ym2 + '_LEVINC_' + cast ( @world as nvarchar) + '  (nolock) '
		+ ' where lev = ' + cast ( @lev as nvarchar) + ' and log_date >= @ndate '
		+ ' select  @ndec2 = isnull ( sum(amount) , 0) from lin2report.dbo.R' + @ym + '_LEVDEC_' + cast ( @world as nvarchar)  + ' (nolock) '
		+ ' where lev = ' + cast ( @lev as nvarchar)  
		+ ' select @ninc2 = isnull (  sum(amount) , 0) from lin2report.dbo.R' + @ym + '_LEVINC_' + cast ( @world as nvarchar) + '  (nolock) '
		+ ' where lev = ' + cast ( @lev as nvarchar)  
		+ ' select @nbase, @ninc + @ndec, @nbase + @ninc + @ndec  + @ninc2 + @ndec2 '
	+ ' end '

exec (@sql)
GO

/********************************************
lin_RPSnapTimeAttackRecord
Snap TimeAttackRecord from world DB

#argument	@db_server	varchar(30)	name of database server
#argument	@user_id	varchar(30)	user id
#argument	@user_pass	varchar(30)	user password
#argument	@table_to	varchar(60)	report table to be a destination
#return
#result_set
#remark
#example	lin_RPSnapTimeAttackRecord 'db_server', 'gamma', '', RP_SNAPTIMEATTACKRECORD_8
#history	create	zzangse		2005-03-03
#see
********************************************/

ALTER             PROCEDURE [DBO].[lin_RPSnapTimeAttackRecord]
	@db_server	varchar(30),
	@user_id	varchar(30),
	@user_pass	varchar(30),
	@table_to	varchar(60)

AS
SET NOCOUNT ON

declare @sql varchar(4000)
declare @dttoday datetime
declare @log_datetime_today varchar(12)

set @dttoday = getdate()

set @log_datetime_today = cast(convert(varchar(8), @dttoday , 112 ) as varchar(8)) 

-- check table whether @table_to exists or not
set @sql = 'select * from lin2report.dbo.sysobjects (nolock) where name = ''' + @table_to + ''''
exec (@sql)

if (@@ROWCOUNT = 0)
begin
	set @sql = 'CREATE TABLE dbo.' + @table_to + ' (' 
		+ ' log_datetime		int,'
		+ ' ssq_round		int, '
		+ ' room_no		tinyint, '
		+ ' record_type		tinyint, '
		+ ' ssq_part		tinyint, '
		+ ' point			int, '
		+ ' record_time		int, '
		+ ' elapsed_time		int, '
		+ ' member_count	int, '
		+ ' member_names	nvarchar(512), '
		+ ' member_dbid_list	nvarchar(256), '
		+ ' member_reward_flags	int, '
		+ ' fee			int '
		+ ' ) '
	exec (@sql)

	set @sql = 'CREATE clustered INDEX IX_' + @table_to + '_1 on dbo.' + @table_to + ' (log_datetime desc, room_no asc, record_type asc) with fillfactor = 90 '
	exec (@sql)
end
else begin
	set @sql = 'delete from dbo.' + @table_to + ' where log_datetime = ' + @log_datetime_today
	exec (@sql)
end

-- insert into report table
set @sql = 'insert into ' + RTRIM(@table_to) +  
	+ ' select ' + @log_datetime_today  + ', * '
	+ 'from OPENROWSET ( ''SQLOLEDB'', ''' + @db_server + ''';''' + @user_id + ''';''' + @user_pass  + ''',  ''select * from lin2world.dbo.time_attack_record (nolock) where ssq_round in (select max(round_number) from lin2world.dbo.ssq_data (nolock))'') ' 
	+ ' option (MAXDOP 1 ) '
exec (@sql )
GO

/********************************************
lin_RPSnapSSQJoinData
Snap SSQJoinDataTable from world DB

#argument	@db_server	varchar(30)	name of database server
#argument	@user_id	varchar(30)	user id
#argument	@user_pass	varchar(30)	user password
#argument	@table_to	varchar(60)	report table to be a destination
#return
#result_set
#remark
#example	lin_RPSnapSSQJoinData 'db_server', 'gamma', '', RP_SNAPSSQJOINDATA_8
#history	create	zzangse		2005-03-03
#see
********************************************/

ALTER             PROCEDURE [DBO].[lin_RPSnapSSQJoinData]
	@db_server	varchar(30),
	@user_id	varchar(30),
	@user_pass	varchar(30),
	@table_to	varchar(60)

AS
SET NOCOUNT ON

declare @sql varchar(4000)
declare @dttoday datetime
declare @log_datetime_today varchar(12)

set @dttoday = getdate()

set @log_datetime_today = cast(convert(varchar(8), @dttoday , 112 ) as varchar(8)) 

-- check table whether @table_to exists or not
set @sql = 'select * from lin2report.dbo.sysobjects (nolock) where name = ''' + @table_to + ''''
exec (@sql)

if (@@ROWCOUNT = 0)
begin
	set @sql = 'CREATE TABLE dbo.' + @table_to + ' (' 
		+ ' log_datetime		int,'
		+ ' round_number		int, '
		+ ' type			tinyint, '
		+ ' point			int, '
		+ ' main_event_point	int, '
		+ ' collected_point	int, '
		+ ' member_count	int, '
		+ ' seal1_selection_count	int, '
		+ ' seal2_selection_count	int, '
		+ ' seal3_selection_count	int, '
		+ ' seal4_selection_count	int, '
		+ ' seal5_selection_count	int, '
		+ ' seal6_selection_count	int, '
		+ ' seal7_selection_count	int, '
		+ ' last_changed_time	datetime '
		+ ' ) '
	exec (@sql)

	set @sql = 'CREATE clustered INDEX IX_' + @table_to + '_1 on dbo.' + @table_to + ' (log_datetime desc, type asc) with fillfactor = 90 '
	exec (@sql)
end
else begin
	set @sql = 'delete from dbo.' + @table_to + ' where log_datetime = ' + @log_datetime_today
	exec (@sql)
end

-- insert into report table
set @sql = 'insert into ' + RTRIM(@table_to) +  
	+ ' select ' + @log_datetime_today  + ', * '
	+ ' from OPENROWSET ( ''SQLOLEDB'', ''' + @db_server + ''';''' + @user_id + ''';''' + @user_pass  + ''',  ''select * from lin2world.dbo.ssq_join_data (nolock) where round_number in (select max(round_number) from lin2world.dbo.ssq_data (nolock))'') ' 
	+ ' option (MAXDOP 1 ) '
exec (@sql )
GO

/********************************************
lin_RPSnapSSQData
Snap SSQDataTable from world DB

#argument	@db_server	varchar(30)	name of database server
#argument	@user_id	varchar(30)	user id
#argument	@user_pass	varchar(30)	user password
#argument	@table_to	varchar(60)	report table to be a destination
#return
#result_set
#remark
#example	lin_RPSnapSSQData 'db_server', 'gamma', '', RP_SNAPSSQDATA_8
#history	create	zzangse		2005-03-03
#see
********************************************/

ALTER            PROCEDURE [DBO].[lin_RPSnapSSQData]
	@db_server	varchar(30),
	@user_id	varchar(30),
	@user_pass	varchar(30),
	@table_to	varchar(60)

AS
SET NOCOUNT ON

declare @sql varchar(4000)
declare @dttoday datetime
declare @log_datetime_today varchar(12)

set @dttoday = getdate()

set @log_datetime_today = cast(convert(varchar(8), @dttoday , 112 ) as varchar(8)) 

-- check table whether @table_to exists or not
set @sql = 'select * from lin2report.dbo.sysobjects (nolock) where name = ''' + @table_to + ''''
exec (@sql)

if (@@ROWCOUNT = 0)
begin
	set @sql = 'CREATE TABLE dbo.' + @table_to + ' (' 
		+ ' log_datetime		int,'
		+ ' round_number		int, '
		+ ' status		tinyint, '
		+ ' winner		tinyint, '
		+ ' event_start_time	int, '
		+ ' seal_effect_time	int, '
		+ ' event_end_time	int, '
		+ ' seal_effect_end_time	int, '
		+ ' seal1			tinyint, '
		+ ' seal2			tinyint, '
		+ ' seal3			tinyint, '
		+ ' seal4			tinyint, '
		+ ' seal5			tinyint, '
		+ ' seal6			tinyint, '
		+ ' seal7			tinyint, '
		+ ' last_changed_time	datetime, '
		+ ' castle_snapshot_time	int, '
		+ ' can_drop_guard	int '
		+ ' ) '
	exec (@sql)

	set @sql = 'CREATE clustered INDEX IX_' + @table_to + '_1 on dbo.' + @table_to + ' (log_datetime desc) with fillfactor = 90 '
	exec (@sql)
end
else begin
	set @sql = 'delete from dbo.' + @table_to + ' where log_datetime = ' + @log_datetime_today
	exec (@sql)
end

-- insert into report table
set @sql = 'insert into ' + RTRIM(@table_to) +  
	+ ' select ' + @log_datetime_today  + ', * '
	+ 'from OPENROWSET ( ''SQLOLEDB'', ''' + @db_server + ''';''' + @user_id + ''';''' + @user_pass  + ''',  ''select * from lin2world.dbo.ssq_data (nolock) where round_number in (select max(round_number) from lin2world.dbo.ssq_data (nolock))'') ' 
	+ ' option (MAXDOP 1 ) '
exec (@sql )
GO

/********************************************
lin_RPSSQSealSelection
Daily SSQ Seal Selection Information

#argument	@db_server	varchar(30)	name of database server
#argument	@user_id	varchar(30)	user id
#argument	@user_pass	varchar(30)	user password
#argument	@table_to	varchar(60)	report table to be a destination
#return
#result_set
#remark
#example	lin_RPSSQSealSelection 'db_server', 'gamma', '', RP_TBLSSQSEALSELECTION_8
#history	create	zzangse		2005-02-15
#see
********************************************/

ALTER            PROCEDURE [DBO].[lin_RPSSQSealSelection]
	@db_server	varchar(30),
	@user_id	varchar(30),
	@user_pass	varchar(30),
	@table_to	varchar(60)

AS
SET NOCOUNT ON


declare @sql varchar(4000)
declare @dttoday datetime
declare @log_datetime_today varchar(12)

set @dttoday = getdate()

set @log_datetime_today = cast(convert(varchar(8), @dttoday , 112 ) as varchar(8)) 

-- check table whether @table_to exists or not
set @sql = 'select * from lin2report.dbo.sysobjects (nolock) where name = ''' + @table_to + ''''
exec (@sql)

if (@@ROWCOUNT = 0)
begin
	set @sql = 'CREATE TABLE dbo.' + @table_to + ' (' 
		+ ' log_datetime	int,'
		+ ' round_number		bigint, '
		+ ' ssq_part		int, '
		+ ' seal_selection_no 	int, '
		+ ' seal_selection_count	bigint '
		+ ' ) '
	exec (@sql)

	set @sql = 'CREATE clustered INDEX IX_' + @table_to + '_1 on dbo.' + @table_to + ' (log_datetime) with fillfactor = 90 '
	exec (@sql)
end
else begin
	set @sql = 'delete from dbo.' + @table_to + ' where log_datetime = ' + @log_datetime_today
	exec (@sql)
end


-- insert initial record
set @sql = 'insert into ' + RTRIM (@table_to) + ' (log_datetime, round_number, ssq_part, seal_selection_no, seal_selection_count) '
	+ ' values ( ' + @log_datetime_today + ', 0, 1, 1, 0  ) '
exec (@sql)

set @sql = 'insert into ' + RTRIM (@table_to) + ' (log_datetime, round_number, ssq_part, seal_selection_no, seal_selection_count) '
	+ ' values ( ' + @log_datetime_today + ', 0, 1, 2, 0 ) '
exec (@sql)

set @sql = 'insert into ' + RTRIM (@table_to) + ' (log_datetime, round_number, ssq_part, seal_selection_no, seal_selection_count) '
	+ ' values ( ' + @log_datetime_today + ', 0, 1, 3, 0 ) '
exec (@sql)

set @sql = 'insert into ' + RTRIM (@table_to) + ' (log_datetime, round_number, ssq_part, seal_selection_no, seal_selection_count) '
	+ ' values ( ' + @log_datetime_today + ', 0, 2, 1, 0 ) '
exec (@sql)

set @sql = 'insert into ' + RTRIM (@table_to) + ' (log_datetime, round_number, ssq_part, seal_selection_no, seal_selection_count) '
	+ ' values ( ' + @log_datetime_today + ', 0, 2, 2, 0 ) '
exec (@sql)

set @sql = 'insert into ' + RTRIM (@table_to) + ' (log_datetime, round_number, ssq_part, seal_selection_no, seal_selection_count) '
	+ ' values ( ' + @log_datetime_today + ', 0, 2, 3, 0 ) '
exec (@sql)

-- update to real record
set @sql = 'update ' + RTRIM ( @table_to ) 
	+ ' set round_number = A.round_number, seal_selection_count = A.seal_selection_count ' 
	+ ' from OPENROWSET ( ''SQLOLEDB'', ''' + @db_server + ''';''' + @user_id + ''';''' + @user_pass + ''', '' select round_number, count(*) as seal_selection_count from lin2world.dbo.ssq_user_data(nolock) where round_number in ( select max ( round_number ) from lin2world.dbo.ssq_data(nolock) )  and ssq_part = 1 and seal_selection_no = 1 group by round_number'') as A '
	+ ' where log_datetime = ' + @log_datetime_today + ' and ssq_part = 1 and seal_selection_no = 1 '

exec ( @sql )

set @sql = 'update ' + RTRIM ( @table_to ) 
	+ ' set round_number = A.round_number, seal_selection_count = A.seal_selection_count ' 
	+ ' from OPENROWSET ( ''SQLOLEDB'', ''' + @db_server + ''';''' + @user_id + ''';''' + @user_pass + ''', '' select round_number, count(*) as seal_selection_count from lin2world.dbo.ssq_user_data(nolock) where round_number in ( select max ( round_number ) from lin2world.dbo.ssq_data(nolock) )  and ssq_part = 1 and seal_selection_no = 2 group by round_number'') as A '
	+ ' where log_datetime = ' + @log_datetime_today + ' and ssq_part = 1 and seal_selection_no = 2 '

exec ( @sql )

set @sql = 'update ' + RTRIM ( @table_to ) 
	+ ' set round_number = A.round_number, seal_selection_count = A.seal_selection_count ' 
	+ ' from OPENROWSET ( ''SQLOLEDB'', ''' + @db_server + ''';''' + @user_id + ''';''' + @user_pass + ''', '' select round_number, count(*) as seal_selection_count from lin2world.dbo.ssq_user_data(nolock) where round_number in ( select max ( round_number ) from lin2world.dbo.ssq_data(nolock) )  and ssq_part = 1 and seal_selection_no = 3 group by round_number'') as A '
	+ ' where log_datetime = ' + @log_datetime_today + ' and ssq_part = 1 and seal_selection_no = 3 '

exec ( @sql )

set @sql = 'update ' + RTRIM ( @table_to ) 
	+ ' set round_number = A.round_number, seal_selection_count = A.seal_selection_count ' 
	+ ' from OPENROWSET ( ''SQLOLEDB'', ''' + @db_server + ''';''' + @user_id + ''';''' + @user_pass + ''', '' select round_number, count(*) as seal_selection_count from lin2world.dbo.ssq_user_data(nolock) where round_number in ( select max ( round_number ) from lin2world.dbo.ssq_data(nolock) )  and ssq_part = 2 and seal_selection_no = 1 group by round_number'') as A '
	+ ' where log_datetime = ' + @log_datetime_today + ' and ssq_part = 2 and seal_selection_no = 1 '

exec ( @sql )

set @sql = 'update ' + RTRIM ( @table_to ) 
	+ ' set round_number = A.round_number, seal_selection_count = A.seal_selection_count ' 
	+ ' from OPENROWSET ( ''SQLOLEDB'', ''' + @db_server + ''';''' + @user_id + ''';''' + @user_pass + ''', '' select round_number, count(*) as seal_selection_count from lin2world.dbo.ssq_user_data(nolock) where round_number in ( select max ( round_number ) from lin2world.dbo.ssq_data(nolock) )  and ssq_part = 2 and seal_selection_no = 2 group by round_number'') as A '
	+ ' where log_datetime = ' + @log_datetime_today + ' and ssq_part = 2 and seal_selection_no = 2 '

exec ( @sql )

set @sql = 'update ' + RTRIM ( @table_to ) 
	+ ' set round_number = A.round_number, seal_selection_count = A.seal_selection_count ' 
	+ ' from OPENROWSET ( ''SQLOLEDB'', ''' + @db_server + ''';''' + @user_id + ''';''' + @user_pass + ''', '' select round_number, count(*) as seal_selection_count from lin2world.dbo.ssq_user_data(nolock) where round_number in ( select max ( round_number ) from lin2world.dbo.ssq_data(nolock) )  and ssq_part = 2 and seal_selection_no = 3 group by round_number'') as A '
	+ ' where log_datetime = ' + @log_datetime_today + ' and ssq_part = 2 and seal_selection_no = 3 '

exec ( @sql )
GO

/********************************************
lin_RPJoinSSQMember
Daily SSQ Member Join Information

#argument	@db_server	varchar(30)	name of database server
#argument	@user_id	varchar(30)	user id
#argument	@user_pass	varchar(30)	user password
#argument	@table_to	varchar(60)	report table to be a destination
#return
#result_set
#remark
#example	lin_RPJoinSSQMember 'db_server', 'gamma', '', RP_TBLJOINSSQMEMBER_8
#history	create	zzangse		2005-02-15
#see
********************************************/

ALTER           PROCEDURE [DBO].[lin_RPJoinSSQMember]
	@db_server	varchar(30),
	@user_id	varchar(30),
	@user_pass	varchar(30),
	@table_to	varchar(60)

AS
SET NOCOUNT ON

declare @sql varchar(4000)
declare @dttoday datetime
declare @log_datetime_today varchar(12)

set @dttoday = getdate()

set @log_datetime_today = cast(convert(varchar(8), @dttoday , 112 ) as varchar(8)) 

-- check table whether @table_to exists or not
set @sql = 'select * from lin2report.dbo.sysobjects (nolock) where name = ''' + @table_to + ''''
exec (@sql)

if (@@ROWCOUNT = 0)
begin
	set @sql = 'CREATE TABLE dbo.' + @table_to + ' (' 
		+ ' log_datetime	int,'
		+ ' round_number		bigint, '
		+ ' type		int, '
		+ ' member_count	bigint '
		+ ' ) '
	exec (@sql)

	set @sql = 'CREATE clustered INDEX IX_' + @table_to + '_1 on dbo.' + @table_to + ' (log_datetime) with fillfactor = 90 '
	exec (@sql)
end
else begin
	set @sql = 'delete from dbo.' + @table_to + ' where log_datetime = ' + @log_datetime_today
	exec (@sql)
end

-- insert into report table
set @sql = 'insert into ' + RTRIM(@table_to) + ' (log_datetime, round_number, type, member_count) ( ' 
	+ 'select ' + @log_datetime_today  + ', round_number, type, member_count '
	+ 'from OPENROWSET ( ''SQLOLEDB'', ''' + @db_server + ''';''' + @user_id + ''';''' + @user_pass  + ''',  ''select round_number, type, member_count from lin2world.dbo.ssq_join_data (nolock) where round_number in (select max(round_number) from lin2world.dbo.ssq_data (nolock))'') ' 
	+ ') option (MAXDOP 1 ) '
exec (@sql )
GO

/********************************************
lin_MakeDailyWorldSnap
Daily World DB Snap

#argument	@db_server	varchar(30)	name of database server
#argument	@user_id	varchar(30)	user id
#argument	@user_pass	varchar(30)	user password
#argument	@worldId	int		world id 
#return
#result_set
#remark
#example	lin_RPMakeDailyWorldSnap 'db_server', 'gamma', '', 8
#history	create	zzangse		2005-03-03
#see lin_RPJoinSSQMember
#see lin_RPSSQSealSelection
#see lin_RPSnapSSQData
#see lin_RPSnapSSQJoinData
#see lin_RPSnapTimeAttackRecord
********************************************/

ALTER             PROCEDURE [DBO].[lin_MakeDailyWorldSnap]
	@db_server	varchar(30) ,
	@user_id	varchar(30),
	@user_pass	varchar(30),
	@worldId	int 
AS
SET NOCOUNT ON


declare @table_to varchar(60)
declare @sql varchar(512)

-----------------------------
-- exec DailyWorldSnaptSP --
-----------------------------

-- lin_RPJoinSSQMember
set @table_to =  'RP_TBLJOINSSQMEMBER_' + cast(@worldId as varchar)
exec lin_RPJoinSSQMember @db_server, @user_id, @user_pass, @table_to
waitfor delay '0:0:6'


-- lin_RPSSQSealSelection
set @table_to =  'RP_TBLSSQSEALSELECTION_' + cast(@worldId as varchar)
exec lin_RPSSQSealSelection @db_server, @user_id, @user_pass, @table_to
waitfor delay '0:0:6'

-- lin_RPSnapSSQData
set @table_to = 'RP_SNAPSSQDATA_' + cast ( @worldId  as varchar )
exec lin_RPSnapSSQData @db_server, @user_id, @user_pass, @table_to
waitfor delay '0:0:6'

-- lin_RPSnapSSQJoinData
set @table_to = 'RP_SNAPSSQJOINDATA_' + cast ( @worldId as varchar )
exec lin_RPSnapSSQJoinData @db_server, @user_id, @user_pass, @table_to
waitfor delay '0:0:6'

-- lin_RPSnapTimeAttackRecord
set @table_to = 'RP_SNAPTIMEATTACKRECORD_' + cast (@worldId as varchar)
exec lin_RPSnapTimeAttackRecord @db_server, @user_id, @user_pass, @table_to
waitfor delay '0:0:6'
GO

/********************************************
lin_RPTblHourlyAdenaCount
do make a report that shows total amount of adena hour by hour

#argument	@db_server	varchar(30)	name of database server
#argument	@user_id	varchar(30)	user id
#argument	@user_pass	varchar(30)	user password
#argument	@table_to	varchar(60)	report table to be a destination
#return
#result_set
#remark
#example	lin_RPTblHourlyAdenaCount 'db_server', 'gamma', '', RP_TBLHOURLYADENACOUNT_8
#history	create	flagoftiger	2004-09-08
#history modify	zzangse		2005-03-03		// add condition : and char_id > 0
#see
********************************************/

ALTER            PROCEDURE [DBO].[lin_RPTblHourlyAdenaCount]
	@db_server	varchar(30),
	@user_id	varchar(30),
	@user_pass	varchar(30),
	@table_to	varchar(60)

AS
SET NOCOUNT ON

declare @sql varchar(4000)
declare @dtnow datetime
declare @dthour_ago datetime
declare @log_datetime_now varchar(12)
declare @log_datetime_hour_ago varchar(12)

set @dtnow = getdate()
set @dthour_ago = dateadd(hh, -1, @dtnow)

set @log_datetime_now = cast(convert(varchar(8), @dtnow , 112 ) as varchar(8))  +  case when datepart(hh, @dtnow) < 10  then '0'  else '' end + cast(datepart(hh, @dtnow) as varchar(2))
set @log_datetime_hour_ago = cast (convert(varchar(8), @dthour_ago, 112 ) as varchar(8)) + case when datepart(hh, @dthour_ago) < 10 then '0' else '' end + cast(datepart(hh, @dthour_ago) as varchar(2))

-- check table whether @table_to exists or not
set @sql = 'select * from lin2report.dbo.sysobjects (nolock) where name = ''' + @table_to + ''''
exec (@sql)

if (@@ROWCOUNT = 0)
begin
	set @sql = 'CREATE TABLE dbo.' + @table_to + ' (' 
		+ ' log_datetime	int,'
		+ ' amount	bigint, '
		+ ' amount_old	bigint, '
		+ ' amount_diff	bigint '
		+ ' ) '
	exec (@sql)

	set @sql = 'CREATE clustered INDEX IX_' + @table_to + '_1 on dbo.' + @table_to + ' (log_datetime) with fillfactor = 90 '
	exec (@sql)
end
else begin
	set @sql = 'delete from dbo.' + @table_to + ' where log_datetime = ' + @log_datetime_now
	exec (@sql)
end

-- get Adena(57) amount from user_item table
-- insert into report table
set @sql = 'insert into ' + RTRIM(@table_to) + ' (log_datetime, amount, amount_old, amount_diff) ( ' 
	+ 'select ' + @log_datetime_now  + ', isnull(amount,0), '
	+ '	(select isnull(amount,0) as amount_old from ' + RTRIM(@table_to) + ' (nolock) '
	+ '	where log_datetime = ' + @log_datetime_hour_ago  + ' ),'
	+ '	case when (select amount as amount_old from ' + RTRIM(@table_to) + ' (nolock) '
	+ '	where log_datetime = ' + @log_datetime_hour_ago + ' ) is null '
	+ '	then isnull(amount,0) else isnull(amount - (select amount as amount_old from ' + RTRIM(@table_to) + ' (nolock) '
	+ '	where log_datetime = ' + @log_datetime_hour_ago + ' ),0) end '
	+ 'from OPENROWSET ( ''SQLOLEDB'', ''' + @db_server + ''';''' + @user_id + ''';''' + @user_pass  + ''',  ''select sum(cast(amount as bigint)) as amount from lin2world.dbo.user_item (nolock) where item_type=57 and char_id > 0'') ' 
	+ ') option (MAXDOP 1 ) '
exec (@sql )
GO

/******************************************************************************
#Name:	lin_RPTblHourlySealStoneCount
#Desc:	make a report that shows total amount of sealstone hour by hour

#Argument:
	Input:		@db_server	varchar(30)	name of database server
				@user_id	varchar(30)	user id
				@user_pass	varchar(30)	user password
				@table_to	varchar(60)	report table to be a destination
	Output:
#Return:
#Result Set:

#Remark:
#Example:		exec lin_RPTblHourlySealStoneCount 'db_server', 'gamma', '', RP_TBLHOURLYSEALSTONECOUNT_8
#See:

#History:
				create		zzangse		2005-02-25
				modify		zzangse		2005-03-03		// add condition : and char_id > 0 
				modify		zzangse		2005-03-16		// add amount info of seal_stone_count at ssq_priest
******************************************************************************/
ALTER Procedure [dbo].[lin_RPTblHourlySealStoneCount]
	@db_server	varchar(30),
	@user_id	varchar(30),
	@user_pass	varchar(30),
	@table_to	varchar(60)
AS
SET NOCOUNT ON



declare @sql varchar(4000)
declare @dtnow datetime
declare @dthour_ago datetime
declare @log_datetime_now varchar(12)
declare @log_datetime_hour_ago varchar(12)

set @dtnow = getdate()
set @dthour_ago = dateadd(hh, -1, @dtnow)

set @log_datetime_now = cast(convert(varchar(8), @dtnow , 112 ) as varchar(8))  +  case when datepart(hh, @dtnow) < 10  then '0'  else '' end + cast(datepart(hh, @dtnow) as varchar(2))
set @log_datetime_hour_ago = cast (convert(varchar(8), @dthour_ago, 112 ) as varchar(8)) + case when datepart(hh, @dthour_ago) < 10 then '0' else '' end + cast(datepart(hh, @dthour_ago) as varchar(2))

-- check table whether @table_to exists or not
set @sql = 'select * from lin2report.dbo.sysobjects (nolock) where name = ''' + @table_to + ''''
exec (@sql)

if (@@ROWCOUNT = 0)
begin
	set @sql = 'CREATE TABLE dbo.' + @table_to + ' (' 
		+ ' log_datetime	int,'
		+ ' type		smallint, '
		+ ' amount	bigint, '
		+ ' amount_old	bigint, '
		+ ' amount_diff	bigint '
		+ ' ) '
	exec (@sql)

	set @sql = 'CREATE clustered INDEX IX_' + @table_to + '_1 on dbo.' + @table_to + ' (log_datetime asc, type asc) with fillfactor = 90 '
	exec (@sql)
end
else begin
	set @sql = 'delete from dbo.' + @table_to + ' where log_datetime = ' + @log_datetime_now
	exec (@sql)
end

-- get BlueSealStone(6360) amount from user_item table ( type 0 : blue )
-- insert into report table
set @sql = 'insert into ' + RTRIM(@table_to) + ' (log_datetime, type, amount, amount_old, amount_diff) ( ' 
	+ 'select ' + @log_datetime_now  + ', 0, isnull(amount,0), '
	+ '	(select isnull(amount,0) as amount_old from ' + RTRIM(@table_to) + ' (nolock) '
	+ '	where log_datetime = ' + @log_datetime_hour_ago  + ' and type = 0 ),'
	+ '	case when (select amount as amount_old from ' + RTRIM(@table_to) + ' (nolock) '
	+ '	where log_datetime = ' + @log_datetime_hour_ago + '  and type = 0 ) is null '
	+ '	then isnull(amount,0) else isnull(amount - (select amount as amount_old from ' + RTRIM(@table_to) + ' (nolock) '
	+ '	where log_datetime = ' + @log_datetime_hour_ago + ' and type = 0 ),0) end '
	+ 'from OPENROWSET ( ''SQLOLEDB'', ''' + @db_server + ''';''' + @user_id + ''';''' + @user_pass  + ''',  ''select sum(cast(amount as bigint)) as amount from lin2world.dbo.user_item (nolock) where item_type=6360 and char_id > 0'') ' 
	+ ') option (MAXDOP 1 ) '
exec (@sql )



-- get GreenSealStone(6361) amount from user_item table ( type 1 : green )
-- insert into report table
set @sql = 'insert into ' + RTRIM(@table_to) + ' (log_datetime, type, amount, amount_old, amount_diff) ( ' 
	+ 'select ' + @log_datetime_now  + ', 1, isnull(amount,0), '
	+ '	(select isnull(amount,0) as amount_old from ' + RTRIM(@table_to) + ' (nolock) '
	+ '	where log_datetime = ' + @log_datetime_hour_ago  + ' and type = 1 ),'
	+ '	case when (select amount as amount_old from ' + RTRIM(@table_to) + ' (nolock) '
	+ '	where log_datetime = ' + @log_datetime_hour_ago + '  and type = 1 ) is null '
	+ '	then isnull(amount,0) else isnull(amount - (select amount as amount_old from ' + RTRIM(@table_to) + ' (nolock) '
	+ '	where log_datetime = ' + @log_datetime_hour_ago + '  and type = 1 ),0) end '
	+ 'from OPENROWSET ( ''SQLOLEDB'', ''' + @db_server + ''';''' + @user_id + ''';''' + @user_pass  + ''',  ''select sum(cast(amount as bigint)) as amount from lin2world.dbo.user_item (nolock) where item_type=6361 and char_id > 0'') ' 
	+ ') option (MAXDOP 1 ) '
exec (@sql )



-- get RedSealStone(6362) amount from user_item table ( type 2 : red )
-- insert into report table
set @sql = 'insert into ' + RTRIM(@table_to) + ' (log_datetime, type, amount, amount_old, amount_diff) ( ' 
	+ 'select ' + @log_datetime_now  + ', 2, isnull(amount,0), '
	+ '	(select isnull(amount,0) as amount_old from ' + RTRIM(@table_to) + ' (nolock) '
	+ '	where log_datetime = ' + @log_datetime_hour_ago  + ' and type = 2 ),'
	+ '	case when (select amount as amount_old from ' + RTRIM(@table_to) + ' (nolock) '
	+ '	where log_datetime = ' + @log_datetime_hour_ago + ' and type = 2 ) is null '
	+ '	then isnull(amount,0) else isnull(amount - (select amount as amount_old from ' + RTRIM(@table_to) + ' (nolock) '
	+ '	where log_datetime = ' + @log_datetime_hour_ago + ' and type = 2 ),0) end '
	+ 'from OPENROWSET ( ''SQLOLEDB'', ''' + @db_server + ''';''' + @user_id + ''';''' + @user_pass  + ''',  ''select sum(cast(amount as bigint)) as amount from lin2world.dbo.user_item (nolock) where item_type=6362 and char_id > 0'') ' 
	+ ') option (MAXDOP 1 ) '
exec (@sql )


-- get BlueSealStone(6360) amount from ssq_user_data table ( type 10 : blue at dusk_priest )
-- insert into report table
set @sql = 'insert into ' + RTRIM(@table_to) + ' (log_datetime, type, amount, amount_old, amount_diff) ( ' 
	+ 'select ' + @log_datetime_now  + ', 10, isnull(amount,0), '
	+ '	(select isnull(amount,0) as amount_old from ' + RTRIM(@table_to) + ' (nolock) '
	+ '	where log_datetime = ' + @log_datetime_hour_ago  + ' and type = 10 ),'
	+ '	case when (select amount as amount_old from ' + RTRIM(@table_to) + ' (nolock) '
	+ '	where log_datetime = ' + @log_datetime_hour_ago + '  and type = 10 ) is null '
	+ '	then isnull(amount,0) else isnull(amount - (select amount as amount_old from ' + RTRIM(@table_to) + ' (nolock) '
	+ '	where log_datetime = ' + @log_datetime_hour_ago + ' and type = 10 ),0) end '
	+ 'from OPENROWSET ( ''SQLOLEDB'', ''' + @db_server + ''';''' + @user_id + ''';''' + @user_pass  + ''',  ''select sum(cast(isnull(twilight_a_item_num,0) as bigint)) as amount from lin2world.dbo.ssq_user_data (nolock) where char_id > 0'') ' 
	+ ') option (MAXDOP 1 ) '
exec (@sql )



-- get GreenSealStone(6361) amount from ssq_user_data table ( type 11 : green at dusk_priest )
-- insert into report table
set @sql = 'insert into ' + RTRIM(@table_to) + ' (log_datetime, type, amount, amount_old, amount_diff) ( ' 
	+ 'select ' + @log_datetime_now  + ', 11, isnull(amount,0), '
	+ '	(select isnull(amount,0) as amount_old from ' + RTRIM(@table_to) + ' (nolock) '
	+ '	where log_datetime = ' + @log_datetime_hour_ago  + ' and type = 11 ),'
	+ '	case when (select amount as amount_old from ' + RTRIM(@table_to) + ' (nolock) '
	+ '	where log_datetime = ' + @log_datetime_hour_ago + '  and type = 11 ) is null '
	+ '	then isnull(amount,0) else isnull(amount - (select amount as amount_old from ' + RTRIM(@table_to) + ' (nolock) '
	+ '	where log_datetime = ' + @log_datetime_hour_ago + ' and type = 11 ),0) end '
	+ 'from OPENROWSET ( ''SQLOLEDB'', ''' + @db_server + ''';''' + @user_id + ''';''' + @user_pass  + ''',  ''select sum(cast(isnull(twilight_b_item_num,0) as bigint)) as amount from lin2world.dbo.ssq_user_data (nolock) where char_id > 0'') ' 
	+ ') option (MAXDOP 1 ) '
exec (@sql )



-- get RedSealStone(6362) amount from ssq_user_data table ( type 12 : red at dusk_priest )
-- insert into report table
set @sql = 'insert into ' + RTRIM(@table_to) + ' (log_datetime, type, amount, amount_old, amount_diff) ( ' 
	+ 'select ' + @log_datetime_now  + ', 12, isnull(amount,0), '
	+ '	(select isnull(amount,0) as amount_old from ' + RTRIM(@table_to) + ' (nolock) '
	+ '	where log_datetime = ' + @log_datetime_hour_ago  + ' and type = 12 ),'
	+ '	case when (select amount as amount_old from ' + RTRIM(@table_to) + ' (nolock) '
	+ '	where log_datetime = ' + @log_datetime_hour_ago + '  and type = 12 ) is null '
	+ '	then isnull(amount,0) else isnull(amount - (select amount as amount_old from ' + RTRIM(@table_to) + ' (nolock) '
	+ '	where log_datetime = ' + @log_datetime_hour_ago + ' and type = 12 ),0) end '
	+ 'from OPENROWSET ( ''SQLOLEDB'', ''' + @db_server + ''';''' + @user_id + ''';''' + @user_pass  + ''',  ''select sum(cast(isnull(twilight_c_item_num,0) as bigint)) as amount from lin2world.dbo.ssq_user_data (nolock) where char_id > 0'') ' 
	+ ') option (MAXDOP 1 ) '
exec (@sql )



-- get BlueSealStone(6360) amount from ssq_user_data table ( type 20 : blue at dawn_priest )
-- insert into report table
set @sql = 'insert into ' + RTRIM(@table_to) + ' (log_datetime, type, amount, amount_old, amount_diff) ( ' 
	+ 'select ' + @log_datetime_now  + ', 20, isnull(amount,0), '
	+ '	(select isnull(amount,0) as amount_old from ' + RTRIM(@table_to) + ' (nolock) '
	+ '	where log_datetime = ' + @log_datetime_hour_ago  + ' and type = 20 ),'
	+ '	case when (select amount as amount_old from ' + RTRIM(@table_to) + ' (nolock) '
	+ '	where log_datetime = ' + @log_datetime_hour_ago + '  and type = 20 ) is null '
	+ '	then isnull(amount,0) else isnull(amount - (select amount as amount_old from ' + RTRIM(@table_to) + ' (nolock) '
	+ '	where log_datetime = ' + @log_datetime_hour_ago + ' and type = 20 ),0) end '
	+ 'from OPENROWSET ( ''SQLOLEDB'', ''' + @db_server + ''';''' + @user_id + ''';''' + @user_pass  + ''',  ''select sum(cast(isnull(dawn_a_item_num,0) as bigint)) as amount from lin2world.dbo.ssq_user_data (nolock) where char_id > 0'') ' 
	+ ') option (MAXDOP 1 ) '
exec (@sql )



-- get GreenSealStone(6361) amount from ssq_user_data table ( type 21 : green at dawn_priest )
-- insert into report table
set @sql = 'insert into ' + RTRIM(@table_to) + ' (log_datetime, type, amount, amount_old, amount_diff) ( ' 
	+ 'select ' + @log_datetime_now  + ', 21, isnull(amount,0), '
	+ '	(select isnull(amount,0) as amount_old from ' + RTRIM(@table_to) + ' (nolock) '
	+ '	where log_datetime = ' + @log_datetime_hour_ago  + ' and type = 21 ),'
	+ '	case when (select amount as amount_old from ' + RTRIM(@table_to) + ' (nolock) '
	+ '	where log_datetime = ' + @log_datetime_hour_ago + '  and type = 21 ) is null '
	+ '	then isnull(amount,0) else isnull(amount - (select amount as amount_old from ' + RTRIM(@table_to) + ' (nolock) '
	+ '	where log_datetime = ' + @log_datetime_hour_ago + ' and type = 21 ),0) end '
	+ 'from OPENROWSET ( ''SQLOLEDB'', ''' + @db_server + ''';''' + @user_id + ''';''' + @user_pass  + ''',  ''select sum(cast(isnull(dawn_b_item_num,0) as bigint)) as amount from lin2world.dbo.ssq_user_data (nolock) where char_id > 0'') ' 
	+ ') option (MAXDOP 1 ) '
exec (@sql )



-- get RedSealStone(6362) amount from ssq_user_data table ( type 22 : red at dawn_priest )
-- insert into report table
set @sql = 'insert into ' + RTRIM(@table_to) + ' (log_datetime, type, amount, amount_old, amount_diff) ( ' 
	+ 'select ' + @log_datetime_now  + ', 22, isnull(amount,0), '
	+ '	(select isnull(amount,0) as amount_old from ' + RTRIM(@table_to) + ' (nolock) '
	+ '	where log_datetime = ' + @log_datetime_hour_ago  + ' and type = 22 ),'
	+ '	case when (select amount as amount_old from ' + RTRIM(@table_to) + ' (nolock) '
	+ '	where log_datetime = ' + @log_datetime_hour_ago + '  and type = 22 ) is null '
	+ '	then isnull(amount,0) else isnull(amount - (select amount as amount_old from ' + RTRIM(@table_to) + ' (nolock) '
	+ '	where log_datetime = ' + @log_datetime_hour_ago + ' and type = 22 ),0) end '
	+ 'from OPENROWSET ( ''SQLOLEDB'', ''' + @db_server + ''';''' + @user_id + ''';''' + @user_pass  + ''',  ''select sum(cast(isnull(dawn_c_item_num,0) as bigint)) as amount from lin2world.dbo.ssq_user_data (nolock) where char_id > 0'') ' 
	+ ') option (MAXDOP 1 ) '
exec (@sql )

SET NOCOUNT OFF
GO

/********************************************
lin_RPTblHourlyAncientAdenaCount
do make a report that shows total amount of adena hour by hour

#argument	@db_server	varchar(30)	name of database server
#argument	@user_id	varchar(30)	user id
#argument	@user_pass	varchar(30)	user password
#argument	@table_to	varchar(60)	report table to be a destination
#return
#result_set
#remark
#example	lin_RPTblHourlyAncientAdenaCount 'db_server', 'gamma', '', RP_TBLHOURLYANCIENTADENACOUNT_8
#history	create	zzangse		2005-01-13
#history modify	zzangse		2005-03-03		// add condition : and char_id > 0
#see
********************************************/

ALTER            PROCEDURE [DBO].[lin_RPTblHourlyAncientAdenaCount]
	@db_server	varchar(30),
	@user_id	varchar(30),
	@user_pass	varchar(30),
	@table_to	varchar(60)

AS
SET NOCOUNT ON

declare @sql varchar(4000)
declare @dtnow datetime
declare @dthour_ago datetime
declare @log_datetime_now varchar(12)
declare @log_datetime_hour_ago varchar(12)

set @dtnow = getdate()
set @dthour_ago = dateadd(hh, -1, @dtnow)

set @log_datetime_now = cast(convert(varchar(8), @dtnow , 112 ) as varchar(8))  +  case when datepart(hh, @dtnow) < 10  then '0'  else '' end + cast(datepart(hh, @dtnow) as varchar(2))
set @log_datetime_hour_ago = cast (convert(varchar(8), @dthour_ago, 112 ) as varchar(8)) + case when datepart(hh, @dthour_ago) < 10 then '0' else '' end + cast(datepart(hh, @dthour_ago) as varchar(2))

-- check table whether @table_to exists or not
set @sql = 'select * from lin2report.dbo.sysobjects (nolock) where name = ''' + @table_to + ''''
exec (@sql)

if (@@ROWCOUNT = 0)
begin
	set @sql = 'CREATE TABLE dbo.' + @table_to + ' (' 
		+ ' log_datetime	int,'
		+ ' amount	bigint, '
		+ ' amount_old	bigint, '
		+ ' amount_diff	bigint '
		+ ' ) '
	exec (@sql)

	set @sql = 'CREATE clustered INDEX IX_' + @table_to + '_1 on dbo.' + @table_to + ' (log_datetime) with fillfactor = 90 '
	exec (@sql)
end
else begin
	set @sql = 'delete from dbo.' + @table_to + ' where log_datetime = ' + @log_datetime_now
	exec (@sql)
end

-- get Adena(5575) amount from user_item table
-- insert into report table

set @sql = 'insert into ' + RTRIM(@table_to) + ' (log_datetime, amount, amount_old, amount_diff) ( ' 
	+ 'select ' + @log_datetime_now  + ', isnull(amount,0), '
	+ '	(select isnull(amount,0) as amount_old from ' + RTRIM(@table_to) + ' (nolock) '
	+ '	where log_datetime = ' + @log_datetime_hour_ago  + ' ),'
	+ '	case when (select amount as amount_old from ' + RTRIM(@table_to) + ' (nolock) '
	+ '	where log_datetime = ' + @log_datetime_hour_ago + ' ) is null '
	+ '	then isnull(amount,0) else isnull(amount - (select amount as amount_old from ' + RTRIM(@table_to) + ' (nolock) '
	+ '	where log_datetime = ' + @log_datetime_hour_ago + ' ),0) end '
	+ 'from OPENROWSET ( ''SQLOLEDB'', ''' + @db_server + ''';''' + @user_id + ''';''' + @user_pass  + ''',  ''select sum(cast(amount as bigint)) as amount from lin2world.dbo.user_item (nolock) where item_type=5575 and char_id > 0'') ' 
	+ ') option (MAXDOP 1 ) '
exec (@sql )
GO

/********************************************
lin_MakeHourlyReport
do make hourly reports

#argument	@db_server	varchar(30)	name of database server
#argument	@user_id	varchar(30)	user id
#argument	@user_pass	varchar(30)	user password
#argument	@worldId	int		world ID

#return
#result_set
#remark
#example	Exec lin_MakeHourlyReport 'db_server', 'gamma', '', 8
#history	create	zzangse		2005-02-25
#see	lin_RPTblHourlyAdenaCount
#see 	lin_RPTblHourlyAncientAdenaCount
#see	lin_RPTblHourlySealStoneCount
********************************************/
ALTER           PROCEDURE [DBO].[lin_MakeHourlyReport]

	@db_server	varchar(30) ,
	@user_id	varchar(30),
	@user_pass	varchar(30),
	@worldId	int 
AS

declare @table_to varchar(60)
declare @sql varchar(512)

-----------------------------
-- exec hourlyReportSP --
-----------------------------

-- lin_RPTblHourlyAdenaCount
set @table_to =  'RP_TBLHOURLYADENACOUNT_' + cast(@worldId as varchar)
exec lin_RPTblHourlyAdenaCount @db_server, @user_id, @user_pass, @table_to
waitfor delay '0:0:6'


-- lin_RPTblHourlyAncientAdenaCount
set @table_to =  'RP_TBLHOURLYANCIENTADENACOUNT_' + cast(@worldId as varchar)
exec lin_RPTblHourlyAncientAdenaCount @db_server, @user_id, @user_pass, @table_to
waitfor delay '0:0:6'


-- lin_RPTblHourlySealStoneCount
set @table_to =  'RP_TBLHOURLYSEALSTONECOUNT_' + cast(@worldId as varchar)
exec lin_RPTblHourlySealStoneCount @db_server, @user_id, @user_pass, @table_to
waitfor delay '0:0:6'
GO

/********************************************
lin_RPRankDailyExp
make Daily Exp Ranking Table

#argument	@table_from	varchar(60)	log table to be a source
#argument	@table_to	varchar(60)	report table to be a destination
#argument	@logdate	int		the date of report to be created
#return
#result_set
#remark
#example	lin_RPRankDailyExp 'L2004_11_30_log_data_8', 'RP_RANKDAILYEXP_8', 20041130
#history	create	flagoftiger	2004-07-16
#see
********************************************/
ALTER PROCEDURE [DBO].[lin_RPRankDailyExp]
	@table_from	varchar(60),
	@table_to	varchar(60),
	@logdate	int

AS
SET NOCOUNT ON

declare @sql varchar(4000)
declare @yesterday	varchar(8)

-- check table whether @table_to is exists or not
set @sql = 'select * from lin2report.dbo.sysobjects (nolock) where name = ''' + @table_to + ''''
exec (@sql)

if (@@ROWCOUNT = 0)
begin
	set @sql = 'CREATE TABLE dbo.' + @table_to + ' (' 
		+ ' log_date	int, '
		+ ' log_type	smallint, '
		+ ' rank	int, '
		+ ' rank_old	int, '
		+ ' rank_diff	int, '
		+ ' race	smallint, '
		+ ' class	smallint, '
		+ ' gender	smallint, '
		+ ' char_id	int, '
		+ ' char_name	nvarchar(60), '
		+ ' account_id	int, '
		+ ' account_name	nvarchar(60), '
		+ ' level	smallint, '
		+ ' level_old	smallint, '
		+ ' level_diff	smallint, '
		+ ' exp	int, '
		+ ' exp_old	int, '
		+ ' exp_diff	int, '
		+ ' sp	int, '
		+ ' use_time	int '
		+ ' ) '
	exec (@sql)

	set @sql = 'CREATE clustered INDEX IX_' + @table_to + '_1 on dbo.' + @table_to + ' (log_date, log_type, class, rank, use_time desc) with fillfactor = 90 '
	exec (@sql)
	set @sql = 'CREATE nonclustered INDEX IX_' + @table_to + '_2 on dbo.' + @table_to + ' (log_date, log_type, race , rank, use_time desc) with fillfactor = 90 '
	exec (@sql)
	set @sql = 'CREATE nonclustered INDEX IX_' + @table_to + '_3 on dbo.' + @table_to + ' (log_date, log_type, rank, use_time desc) with fillfactor = 90 '
	exec (@sql)
end
else begin
	set @sql = 'delete from dbo.' + @table_to + ' where log_date = ' + CAST(@logdate as varchar)
	exec (@sql)
end

-- check tmp table
declare @tmp_table varchar(512)
set @tmp_table = 'dbo.tmp' + @table_to

set @sql = 'select * from lin2report.dbo.sysobjects (nolock) where name = ''tmp' + @table_to + ''''
exec (@sql)

if (@@ROWCOUNT > 0)
begin
	set @sql = ' drop table dbo.tmp' + @table_to
	exec (@sql)
end

-- make tmptable
set @sql = ' select char_name, char_id, account_name, account_id, race, class, gender, sp, exp, lev, use_time into ' 
	+ @tmp_table + ' from lin2log.dbo.' + @table_from  + ' ( nolock) where builder = 0 and account_id > 0  '
	+ 'order by exp desc, race, class'
exec (@sql)

-- set table names
set @yesterday = convert(varchar(8), dateadd(day, -1, cast(cast(@logdate as varchar) as datetime)), 112)

-- insert into report table
-- log_type = 0 (ALL)
set @sql = 'insert into ' + RTRIM(@table_to) + ' (log_date, log_type, rank, rank_old, rank_diff, race, class, gender, char_id, char_name, account_id, account_name, level, level_old, level_diff, exp, exp_old, exp_diff, sp, use_time) ( ' 
	+ 'select ' + cast(@logdate as varchar) + ', 0, S1.rank, S2.rank_old, S1.rank-S2.rank_old as rank_diff, '
	+ '	S1.race, S1.class, S1.gender, S1.char_id, S1.char_name, S1.account_id, S1.account_name, S1.level, S2.level_old, S1.level-S2.level_old, S1.exp, S2.exp_old, S1.exp-S2.exp_old, S1.sp, S1.use_time '
	+ 'from ( '
	+ '	select count(R1.char_name) as rank, R1.race, R1.class, R1.gender, R1.char_id, R1.char_name, R1.account_id, R1.account_name, R1.lev as level, R1.exp, R1.sp, R1.use_time '
	+ '	from ( '
	+ '		select top 100 * from ' + @tmp_table + ' (nolock) '
	+ '		order by exp desc ) as R1 '
	+ '	inner join ( '
	+ '		select top 100 * from ' + @tmp_table + ' (nolock) '
	+ '		order by exp desc ) as R2 '
	+ '	on R1.exp <= R2.exp '
	+ '	group by R1.race, R1.class, R1.gender, R1.char_id, R1.char_name, R1.account_id, R1.account_name, R1.lev, R1.exp, R1.sp, R1.use_time ) as S1 '
	+ 'left join ( '
	+ '	select char_id, rank as rank_old, level as level_old, exp as exp_old '
	+ '	from ' + @table_to + ' (nolock) '
	+ '	where log_date = ' + @yesterday + ' and log_type = 0) as S2 '
	+ 'on S1.char_id = S2.char_id '
	+ ') option (MAXDOP 1 ) '
exec (@sql )

-- log_type = 1 (race)
declare @idx int
set @idx = 0
while @idx < 5
begin
	set @sql = 'insert into ' + RTRIM(@table_to) + ' (log_date, log_type, rank, rank_old, rank_diff, race, class, gender, char_id, char_name, account_id, account_name, level, level_old, level_diff, exp, exp_old, exp_diff, sp, use_time) ( ' 
		+ 'select ' + cast(@logdate as varchar) + ', 1, S1.rank, S2.rank_old, S1.rank-S2.rank_old as rank_diff, '
		+ '	S1.race, S1.class, S1.gender, S1.char_id, S1.char_name, S1.account_id, S1.account_name, S1.level, S2.level_old, S1.level-S2.level_old, S1.exp, S2.exp_old, S1.exp-S2.exp_old, S1.sp, S1.use_time '
		+ 'from ( '
		+ '	select count(R1.char_name) as rank, R1.race, R1.class, R1.gender, R1.char_id, R1.char_name, R1.account_id, R1.account_name, R1.lev as level, R1.exp, R1.sp, R1.use_time '
		+ '	from ( '
		+ '		select top 100 * from ' + @tmp_table + ' (nolock) '
		+ '		where race = ' + cast(@idx as varchar)
		+ '		order by exp desc ) as R1 '
		+ '	inner join ( '
		+ '		select top 100 * from ' + @tmp_table + ' (nolock) '
		+ '		where race = ' + cast(@idx as varchar)
		+ '		order by exp desc ) as R2 '
		+ '	on R1.exp <= R2.exp '
		+ '	group by R1.race, R1.class, R1.gender, R1.char_id, R1.char_name, R1.account_id, R1.account_name, R1.lev, R1.exp, R1.sp, R1.use_time ) as S1 '
		+ 'left join ( '
		+ '	select log_type, char_id, rank as rank_old, level as level_old, exp as exp_old '
		+ '	from ' + @table_to + ' (nolock) '
		+ '	where log_date = ' + @yesterday + ' and log_type = 1 ) as S2 '
		+ 'on S1.char_id = S2.char_id '
		+ ') option (MAXDOP 1 ) '
	exec (@sql )
	set @idx = @idx + 1
end

-- log_type = 2 (class)
set @idx = 0
while @idx < 58
begin
	set @sql = 'insert into ' + RTRIM(@table_to) + ' (log_date, log_type, rank, rank_old, rank_diff, race, class, gender, char_id, char_name, account_id, account_name, level, level_old, level_diff, exp, exp_old, exp_diff, sp, use_time) ( ' 
		+ 'select ' + cast(@logdate as varchar) + ', 2, S1.rank, S2.rank_old, S1.rank-S2.rank_old as rank_diff, '
		+ '	S1.race, S1.class, S1.gender, S1.char_id, S1.char_name, S1.account_id, S1.account_name, S1.level, S2.level_old, S1.level-S2.level_old, S1.exp, S2.exp_old, S1.exp-S2.exp_old, S1.sp, S1.use_time '
		+ 'from ( '
		+ '	select count(R1.char_name) as rank, R1.race, R1.class, R1.gender, R1.char_id, R1.char_name, R1.account_id, R1.account_name, R1.lev as level, R1.exp, R1.sp, R1.use_time '
		+ '	from ( '
		+ '		select top 100 * from ' + @tmp_table + ' (nolock) '
		+ '		where class = ' + cast(@idx as varchar)
		+ '		order by exp desc ) as R1 '
		+ '	inner join ( '
		+ '		select top 100 * from ' + @tmp_table + ' (nolock) '
		+ '		where class = ' + cast(@idx as varchar)
		+ '		order by exp desc ) as R2 '
		+ '	on R1.exp <= R2.exp '
		+ '	group by R1.race, R1.class, R1.gender, R1.char_id, R1.char_name, R1.account_id, R1.account_name, R1.lev, R1.exp, R1.sp, R1.use_time ) as S1 '
		+ 'left join ( '
		+ '	select log_type, char_id, rank as rank_old, level as level_old, exp as exp_old '
		+ '	from ' + @table_to + ' (nolock) '
		+ '	where log_date = ' + @yesterday + ' and log_type = 2 ) as S2 '
		+ 'on S1.char_id = S2.char_id '
		+ ') option (MAXDOP 1 ) '
	exec (@sql )
	set @idx = @idx + 1
end

-- drop tmptable
set @sql = ' drop table ' + @tmp_table
exec (@sql)
GO

/********************************************
lin_RPTblQuestSettle
make a report that shows recursive quests

#argument	@table_from	varchar(60)	log table to be a source
#argument	@table_to	varchar(60)	report table to be a destination
#argument	@logdate	int		the date of report to be created
#return
#result_set
#remark
#example	lin_RPTblCasleWar 'L2004_11_30_log_data_8', 'RP_TBLQUESTSETTLE_8', 20041130
#history	create	flagoftiger	2004-08-04
#see
********************************************/
ALTER  PROCEDURE [DBO].[lin_RPTblQuestSettle]
	@table_from	varchar(60),
	@table_to	varchar(60),
	@logdate	int

AS
SET NOCOUNT ON

declare @sql varchar(4000)

-- check table whether @table_to is exists or not
set @sql = 'select * from lin2report.dbo.sysobjects (nolock) where name = ''' + @table_to + ''''
exec (@sql)

if (@@ROWCOUNT = 0)
begin
	set @sql = 'CREATE TABLE dbo.' + @table_to + ' (' 
		+ ' log_date	int, '
		+ ' race		smallint, '
		+ ' class		smallint, '
		+ ' level		smallint, '
		+ ' quest_id	int, '
		+ ' quest_count	int  '
		+ ' ) '
	exec (@sql)

	set @sql = 'CREATE clustered INDEX IX_' + @table_to + '_1 on dbo.' + @table_to + ' (log_date, race, quest_count desc) '
	exec (@sql)
	set @sql = 'CREATE INDEX IX_' + @table_to + '_2 on dbo.' + @table_to + ' (log_date, class, quest_count desc) '
	exec (@sql)
	set @sql = 'CREATE INDEX IX_' + @table_to + '_3 on dbo.' + @table_to + ' (log_date, level, quest_count desc) '
	exec (@sql)
	set @sql = 'CREATE INDEX IX_' + @table_to + '_4 on dbo.' + @table_to + ' (log_date, quest_id, quest_count desc) '
	exec (@sql)
end
else begin
	set @sql = 'delete from dbo.' + @table_to + ' where log_date = ' + CAST(@logdate as varchar)
	exec (@sql)
end

-- check tmp table
declare @tmp_table varchar(512)
set @tmp_table = 'dbo.tmp' + @table_to

set @sql = 'select * from lin2report.dbo.sysobjects (nolock) where name = ''tmp' + @table_to + ''''
exec (@sql)

if (@@ROWCOUNT > 0)
begin
	set @sql = ' drop table dbo.tmp' + @table_to
	exec (@sql)
end

-- make tmptable
set @sql = ' select log_id, etc_num1, etc_num3, etc_num4, etc_num5 into ' + @tmp_table
	+ ' from lin2log.dbo.' + @table_from  + ' ( nolock) where log_id = 308   '
exec (@sql)

-- insert into report table
-- begin quest report
set @sql = 'insert into ' + RTRIM(@table_to) + ' ( log_date,  race, class, level, quest_id, quest_count  ) ( ' 
	+ ' select ' + CAST(@logdate as varchar) + ', etc_num1, etc_num3, etc_num4, etc_num5, count(log_id)  from '
	+ @tmp_table + ' ( nolock )  group by  etc_num1, etc_num3, etc_num4, etc_num5 ) option (MAXDOP 1 ) '
exec (@sql )

-- drop tmltable
set @sql = ' drop table ' + @tmp_table
exec (@sql)
GO

/********************************************
lin_RPTblPartyInfoByClass
do make a report that shows party information by class

#argument	@table_from	varchar(60)	log table to be a source
#argument	@table_to	varchar(60)	report table to be a destination
#argument	@logdate	int		the date of report to be created
#return
#result_set
#remark
#example	lin_RPTblPartyInfoByClass 'L2004_11_30_log_data_8', 'RP_TBLPARTYINFOBYCLASS_8', 20041130
#history	create	zzangse	2004-10-18
#see
********************************************/
ALTER          PROCEDURE [DBO].[lin_RPTblPartyInfoByClass]
	@table_from	varchar(60),
	@table_to	varchar(60),
	@logdate	int

AS
SET NOCOUNT ON

declare @sql varchar(4000)

-- check table whether @table_to is exists or not
set @sql = 'select * from lin2report.dbo.sysobjects (nolock) where name = ''' + @table_to + ''''
exec (@sql)

if (@@ROWCOUNT = 0)
begin
	set @sql = 'CREATE TABLE dbo.' + @table_to + ' (' 
		+ ' log_date				int, '
		+ ' class_id      				int, '
		+ ' log_count				bigint, '
		+ ' total_exp				bigint, '
		+ ' party_member				int, '
		+ ' char_level				int '
		+ ' ) '
	exec (@sql)

	set @sql = 'CREATE clustered INDEX IX_' + @table_to + '_1 on dbo.' + @table_to + ' (log_date desc, class_id asc, party_member asc, char_level asc) with fillfactor = 90 '
	exec (@sql)
end
else begin
	set @sql = 'delete from dbo.' + @table_to + ' where log_date = ' + CAST(@logdate as varchar)
	exec (@sql)
end

-- insert into report table
-- begin report
set @sql = 'insert into ' + RTRIM(@table_to) + ' ( log_date, class_id, log_count, total_exp, party_member, char_level  ) ( ' 
	+ ' select ' + CAST(@logdate as varchar) + ', class_id, sum(cast(log_count as bigint)) , sum(cast(total_exp as bigint)) ,  party_member, char_level  from ('
	+ ' select etc_num5 as class_id, count(*) as log_count, sum(cast(etc_num7 as bigint)) as total_exp , etc_num8 as party_member, (etc_num4/10) * 10 as char_level from lin2log.dbo.'
	+ @table_from + ' ( nolock )  where log_id = 813  group by  etc_num5, etc_num8, etc_num4  '
	+ ') as R1 group by class_id, party_member, char_level ) option (MAXDOP 1 )'
exec (@sql )
GO

/********************************************
lin_RPTblDailyCountItem
make Table of Daily Item Count

#argument	@table_from	varchar(60)	log table to be a source
#argument	@table_to	varchar(60)	report table to be a destination
#argument	@logdate	int		the date of report to be created
#return
#result_set
#remark
#example	lin_RPTblDailyCountItem 'L2004_11_30_log_data_8', 'RP_TBLDAILYCOUNTITEM_8', 20041130
#history	create	flagoftiger	2004-07-13
#see
********************************************/
ALTER PROCEDURE [DBO].[lin_RPTblDailyCountItem]
	@table_from	varchar(60),
	@table_to	varchar(60),
	@logdate	int

AS
SET NOCOUNT ON

declare @sql varchar(4000)
declare @yesterday	varchar(8)
declare @table_from2	varchar(60)

-- check table whether @table_to exists or not
set @sql = 'select * from lin2report.dbo.sysobjects (nolock) where name = ''' + @table_to + ''''
exec (@sql)

if (@@ROWCOUNT = 0)
begin
	set @sql = 'CREATE TABLE dbo.' + @table_to + ' (' 
		+ ' log_date	int, '
		+ ' item_type	int, '
		+ ' enchant	int, '
		+ ' amount	bigint, '
		+ ' amount_old	bigint, '
		+ ' amount_diff	bigint '
		+ ' ) '
	exec (@sql)

	set @sql = 'CREATE clustered INDEX IX_' + @table_to + '_1 on dbo.' + @table_to + ' (log_date, item_type, enchant) with fillfactor = 90 '
	exec (@sql)
end
else begin
	set @sql = 'delete from dbo.' + @table_to + ' where log_date = ' + CAST(@logdate as varchar)
	exec (@sql)
end

-- set table names
set @yesterday = convert(varchar(8), dateadd(day, -1, cast(cast(@logdate as varchar) as datetime)), 112)
set @table_from2 = replace(@table_from, 'item', 'data')


-- insert into report table
set @sql = 'insert into ' + RTRIM(@table_to) + ' (log_date, item_type, enchant, amount, amount_old, amount_diff) ( ' 
	+ 'select ' + cast(@logdate as varchar) + ', S1.item_type, S1.enchant, S1.amount, case when S2.amount_old is null then 0 else S2.amount_old end, '
	+ '	case when S2.amount_old is null then S1.amount else S1.amount-S2.amount_old end as amount_diff '
	+ 'from ( '
	+ '	select T1.item_type, T1.enchant, sum(T1.amount) as amount '
	+ '	from ( '
	+ '		select R1.item_type, R1.enchant, cast(R1.amount as bigint) as amount, R2.account_id, R2.builder '
	+ '		from ( '
	+ '			select * from lin2log.dbo.' + @table_from + ' (nolock) '
	+ '			where warehouse < 1000) as R1 '
	+ '		left join lin2log.dbo.' + @table_from2 + ' as R2 (nolock) '
	+ '		on R1.char_id = R2.char_id ) as T1 '
	+ '	where T1.account_id > 0 and T1.builder = 0 '
	+ '	group by item_type, enchant ) as S1 '
	+ 'left join ( '
	+ '	select item_type, enchant, amount as amount_old '
	+ '	from ' + @table_to + ' (nolock) '
	+ '	where log_date = ' + @yesterday + ' ) as S2 '
	+ 'on S1.item_type = S2.item_type and S1.enchant = S2.enchant '
	+ ') option (MAXDOP 1 ) '
exec (@sql )
GO

/********************************************
lin_RPTblDailyAdenaUp
do make a report that shows an adena status by character

#argument	@table_from	varchar(60)	log table to be a source
#argument	@table_to	varchar(60)	report table to be a destination
#argument	@logdate	int		the date of report to be created
#return
#result_set
#remark
#example	lin_RPTblDailyAdenaUp 'L2004_11_30_log_data_8', 'RP_TBLDAILYADENAUP_8', 20040909
#history	create	flagoftiger	2004-09-09
#see
********************************************/
ALTER    PROCEDURE [DBO].[lin_RPTblDailyAdenaUp]
	@table_from	varchar(60),
	@table_to	varchar(60),
	@logdate	int

AS
SET NOCOUNT ON

declare @sql varchar(4000)

-- check table whether @table_to is exists or not
set @sql = 'select * from lin2report.dbo.sysobjects (nolock) where name = ''' + @table_to + ''''
exec (@sql)

if (@@ROWCOUNT = 0)
begin
	set @sql = 'CREATE TABLE dbo.' + @table_to + ' (' 
		+ ' log_date	int, '
		+ ' log_type	int, '
		+ ' char_id	int, '
		+ ' char_name	nvarchar(60), '
		+ ' adena_min	bigint, '
		+ ' adena_max	bigint, '
		+ ' adena_diff	bigint, '
		+ ' dprice_min	bigint, '
		+ ' dprice_max	bigint, '
		+ ' dprice_diff	bigint, '
		+ ' item_count_min	int, '
		+ ' item_count_max	int, '
		+ ' item_count_diff		int '
		+ ' ) '
	exec (@sql)

	set @sql = 'CREATE clustered INDEX IX_' + @table_to + '_1 on dbo.' + @table_to + ' (log_date asc, adena_diff desc, dprice_diff desc ) with fillfactor = 90 '
	exec (@sql)
	set @sql = 'CREATE nonclustered INDEX IX_' + @table_to + '_2 on dbo.' + @table_to + ' (log_date asc, dprice_diff desc, adena_diff desc ) with fillfactor = 90 '
	exec (@sql)
end
else begin
	set @sql = 'delete from dbo.' + @table_to + ' where log_date = ' + CAST(@logdate as varchar)
	exec (@sql)
end

-- check tmp table
declare @tmp_table varchar(512)
set @tmp_table = 'dbo.tmp' + @table_to

set @sql = 'select * from lin2report.dbo.sysobjects (nolock) where name = ''tmp' + @table_to + ''''
exec (@sql)

if (@@ROWCOUNT > 0)
begin
	set @sql = ' drop table dbo.tmp' + @table_to
	exec (@sql)
end

-- make tmptable
set @sql = ' select log_id, actor, STR_actor, etc_num1, etc_num2, etc_num3 into ' + @tmp_table
	+ ' from lin2log.dbo.' + @table_from  + ' ( nolock) where log_id = 813   '
exec (@sql)

-- insert into report table
-- begin quest report
set @sql = 'insert into ' + RTRIM(@table_to) + ' ( log_date, char_id, char_name, adena_min, adena_max, adena_diff, dprice_min, dprice_max, dprice_diff, item_count_min, item_count_max, item_count_diff  ) ( ' 
	+ ' select ' + CAST(@logdate as varchar) + ', actor, STR_actor, min(etc_num1), max(etc_num1), max(etc_num1)-min(etc_num1), min(etc_num2), max(etc_num2), max(etc_num2)-min(etc_num2), min(etc_num3), max(etc_num3), max(etc_num3)-min(etc_num3)  from '
	+ @tmp_table + ' ( nolock )  group by  actor, STR_actor) option (MAXDOP 1 ) '
exec (@sql )

-- drop tmltable
set @sql = ' drop table ' + @tmp_table
exec (@sql)
GO

/********************************************
lin_RPSkillEnchant
do make skill enchant success report table

#argument	@table_from	varchar(60)	log table to be a source
#argument	@table_to	varchar(60)	report table to be a destination
#argument	@logdate	int		the date of report to be created
#return
#result_set
#remark
#example	Exec lin_RPSkillEnchant 'L2005_10_05_log_data0_8', 'R_SKILLENCHANT_8', 20051005
#history	create		neoliebe	2005-10-14
#see
********************************************/
ALTER  PROCEDURE [DBO].[lin_RPSkillEnchant ]
	@table_from	varchar(60),
	@table_to	varchar(60),
	@logdate	int

AS
SET NOCOUNT ON

declare @sql varchar(4000)

-- check table whether @table_to is exists or not
set @sql = 'select * from lin2report.dbo.sysobjects (nolock) where name = ''' + @table_to + ''''
exec (@sql)

if (@@ROWCOUNT = 0)
begin
	set @sql = 'CREATE TABLE dbo.' + @table_to + ' (' 
		+ ' log_date	int, '
		+ ' skill_id	int,'
		+ ' skill_level	int,'
		+ ' race	int,'
		+ ' class	int, ' 
		+ ' level	int, ' 
		+ ' count 	int'
		+ ' ) '
	exec (@sql)

	set @sql = 'CREATE INDEX IX_' + @table_to + '_1 on dbo.' + @table_to + ' (log_date, class, level) '
	exec (@sql)
end
else begin
	set @sql = 'delete from dbo.' + @table_to + ' where log_date = ' + CAST(@logdate as varchar)
	exec (@sql)
end


-- insert into report table

set @sql = 'insert into ' + RTRIM(@table_to) + ' ( log_date,  skill_id, skill_level, race, class, level, count) ( ' 
	+ 'select  ' + CAST(@logdate as varchar)  + ', item_id, etc_num6, etc_num1, etc_num3, etc_num4, count( log_id)  from  '
	+ 'lin2log.dbo.' + @table_from + ' ( nolock ) where log_id = 410 group by item_id, etc_num1, etc_num6, etc_num3, etc_num4) option (MAXDOP 1 ) '
exec (@sql )
GO

/******************************************************************************
#Name:	lin_RPSetHero
#Desc:	make daily report about character info set hero 

#Argument:
	Input:	@table_from	varchar(60)	log view: Lyyyy_mm_dd_Log_Data0_world
		@table_to	varchar(60)	report table: RP_AchieveMaxLevel
		@logdate	int		report date
	Output:	
#Return:
#Result Set:

#Remark:
#Example:	exec lin_RPSetHero 'L2005_10_12_log_data0_8', 'RP_SetHero_8', 20051012
#See:

#History:
	Create	neoliebe	2005-10-13
******************************************************************************/
ALTER    Procedure [dbo].[lin_RPSetHero]
	@table_from	varchar(60),
	@table_to	varchar(60),
	@logdate	int
AS
SET NOCOUNT ON

declare	@sql	varchar(4000)

-- report table is initiated
set @sql = 'if not exists (select * from dbo.sysobjects where id = object_id(N''[dbo].[' + @table_to + ']'') and objectproperty(id, N''IsUserTable'') = 1)'
	+ ' begin'
	+ ' create table [dbo].[' + @table_to + '] ('
	+ 'log_date	int, '
	+ 'log_time	varchar(4), '
	+ 'char_name	nvarchar(48), '
	+ 'account_name	nvarchar(32), '
	+ 'class	int, '
	+ 'level	int, '
	+ 'olympiad_point	int, '
	+ 'hero_cnt	int'
	+ ' )'
	+ ' create index ix_' + @table_to + '_1 on [dbo].[' + @table_to + '] (log_date asc, log_time desc)' 
	+ ' end'
exec (@sql)

set @sql = 'delete from [dbo].[' + @table_to + '] where log_date = ' + cast(@logdate as varchar)
exec (@sql)

set @sql = 'insert into [dbo].[' + @table_to + '] (log_date, log_time, char_name, account_name, class, level, olympiad_point, hero_cnt) '
	+ 'select  ' + cast(@logdate as varchar) + ', substring(convert(varchar(5), act_time, 108), 0, 3) +  substring(convert(varchar(5), act_time, 108), 4, 6), '
	+ ' str_actor, str_actor_account, etc_num3, etc_num4, etc_num5, etc_num6 '
	+ 'from [lin2log].[dbo].[' +@table_from + '] (nolock) where log_id = 862'
exec(@sql)

SET NOCOUNT OFF
GO

/********************************************
lin_RPRegionalStatByPartyMemberCount
do make a report that shows locational infomation by an amount of party member

#argument	@table_from	varchar(60)	log table to be a source
#argument	@table_to	varchar(60)	report table to be a destination
#argument	@logdate	int		the date of report to be created
#return
#result_set
#remark
#example	lin_RPRegionalStatByPartyMemberCount 'L2004_11_30_log_data_8', 'RP_TBLREGIONALSTATBYPARTYMEMBERCOUNT_8', 20041130
#history	create	zzangse	2004-10-22
#see
********************************************/
ALTER   PROCEDURE [DBO].[lin_RPRegionalStatByPartyMemberCount]
	@table_from	varchar(60),
	@table_to	varchar(60),
	@logdate	int

AS
SET NOCOUNT ON

declare @sql varchar(4000)

-- check table whether @table_to is exists or not
set @sql = 'select * from lin2report.dbo.sysobjects (nolock) where name = ''' + @table_to + ''''
exec (@sql)

if (@@ROWCOUNT = 0)
begin
	set @sql = 'CREATE TABLE dbo.' + @table_to + ' (' 
		+ ' log_date		int, '
		+ ' party_member_count  	int, '
		+ ' x_loc			int, '
		+ ' y_loc			int, '
		+ ' play_count		int '
		+ ' ) '
	exec (@sql)

	set @sql = 'CREATE clustered INDEX IX_' + @table_to + '_1 on dbo.' + @table_to + ' (log_date, party_member_count, x_loc, y_loc) '
	exec (@sql)
end
else begin
	set @sql = 'delete from dbo.' + @table_to + ' where log_date = ' + CAST(@logdate as varchar)
	exec (@sql)
end


-- check tmp table
declare @tmp_table varchar(512)
set @tmp_table = 'dbo.tmp' + @table_to

set @sql = 'select * from lin2report.dbo.sysobjects (nolock) where name = ''tmp' + @table_to + ''''
exec (@sql)

if (@@ROWCOUNT > 0)
begin
	set @sql = ' drop table ' + @tmp_table
	exec (@sql)
end

--  make tmp table
set @sql = ' select etc_num8, location_x, location_y into ' + @tmp_table 
	+ ' from lin2log.dbo.' + @table_from + ' (nolock) where log_id = 813 '
exec (@sql)

-- insert into report table
set @sql = ' insert into ' + RTRIM(@table_to) + ' ( log_date, party_member_count, x_loc, y_loc, play_count )' 
	+ ' ( select ' + CAST(@logdate as varchar) + ' , etc_num8, floor(location_x/1024.0), floor(location_y/1024.0), case when etc_num8 != 0 then ceiling(cast( count(*) as float)/cast(etc_num8 as float)) else count(*) end'
	+ ' from ' + @tmp_table + ' (nolock) '
	+ ' group by etc_num8, floor(location_x/1024.0), floor(location_y/1024.0) '
	+ ' ) '
	+ ' option (MAXDOP 1 )'
exec ( @sql )

-- drop tmp table
set @sql = ' drop table ' + @tmp_table
exec ( @sql )
GO

/********************************************
lin_RPRecipeShopGetItem
do make a report that shows items be made by recipe

#argument	@table_from	varchar(60)	log table to be a source
#argument	@table_to	varchar(60)	report table to be a destination
#argument	@logdate	int		the date of report to be created
#return
#result_set
#remark
#example	lin_RPRecipeShopGetItem 'L2004_11_30_log_data_8', 'R2004_11_PLAYTIME_8', 20041130
#history	create	zzangse	2004-09-16
#see
********************************************/
ALTER          PROCEDURE [DBO].[lin_RPRecipeShopGetItem]
	@table_from	varchar(60),
	@table_to	varchar(60),
	@logdate	int

AS
SET NOCOUNT ON

declare @sql varchar(4000)

-- check table whether @table_to is exists or not
set @sql = 'select * from lin2report.dbo.sysobjects (nolock) where name = ''' + @table_to + ''''
exec (@sql)

if (@@ROWCOUNT = 0)
begin
	set @sql = 'CREATE TABLE dbo.' + @table_to + ' (' 
		+ ' log_date	int, '
		+ ' item_id	int, '
		+ ' item_count	bigint '
		+ ' ) '
	exec (@sql)
end 

-- check tmp table
declare @tmp_table varchar(512)
set @tmp_table = 'dbo.tmp' + @table_to

set @sql = 'select * from lin2report.dbo.sysobjects (nolock) where name = ''' + @tmp_table + ''''
exec (@sql)

if (@@ROWCOUNT > 0)
begin
	set @sql = ' drop table ' + @tmp_table
	exec (@sql)
end

-- make tmptable
set @sql = ' select etc_num8, etc_num9 into ' + @tmp_table
	+ ' from lin2log.dbo.' + @table_from  + '(nolock) where log_id = 961   '
exec (@sql)


-- insert into report table
-- begin quest report
set @sql = 'insert into ' + RTRIM(@table_to) + ' ( log_date, item_id, item_count  ) ( ' 
	+ ' select ' + CAST(@logdate as varchar) + ',  etc_num8 '  
	+ ' , case when sum(cast(etc_num9 as bigint)) is null then 0 else sum(cast (etc_num9 as bigint)) end from '  
	+ @tmp_table + '  (nolock)  '  
	+ ' group by  etc_num8 ) option (MAXDOP 1 ) ' 

exec (@sql )

-- drop tmltable
set @sql = ' drop table ' + @tmp_table
exec (@sql)
GO

/********************************************
lin_RPRankRecommendation
do make a report that shows ranking of recommendation

#argument	@table_from	varchar(60)	log table to be a source
#argument	@table_to	varchar(60)	report table to be a destination
#argument	@logdate	int		the date of report to be created
#return
#result_set
#remark
#example	lin_RPRankRecommendation 'L2004_11_30_log_data_8', 'RP_RankRecommendation_8', 20041130
#history	create	zzangse	2004-12-06
#history	modify	btwinuni	2005-02-24	Column [level] is added.
#see
********************************************/
ALTER          PROCEDURE [DBO].[lin_RPRankRecommendation]
	@table_from	varchar(60),
	@table_to	varchar(60),
	@logdate	int

AS
SET NOCOUNT ON

declare @sql varchar(4000)

-- check table whether @table_to is exists or not
set @sql = 'select * from lin2report.dbo.sysobjects (nolock) where name = ''' + @table_to + ''''
exec (@sql)

if (@@ROWCOUNT = 0)
begin
	set @sql = 'CREATE TABLE dbo.' + @table_to + ' (' 
		+ ' log_date				int, '
		+ ' actor      				int, '
		+ ' str_actor				varchar(48), '
		+ ' level					int, '
		+ ' recommendation_count			int, '
		+ ' ) '
	exec (@sql)

	set @sql = 'CREATE clustered INDEX IX_' + @table_to + '_1 on dbo.' + @table_to + ' (log_date desc, recommendation_count desc) with fillfactor = 90 '
	exec (@sql)
end
else begin
	set @sql = 'delete from dbo.' + @table_to + ' where log_date = ' + CAST(@logdate as varchar)
	exec (@sql)
end

-- insert into report table
-- begin report
set @sql = 'insert into ' + RTRIM(@table_to) + ' ( log_date, actor, str_actor, level, recommendation_count  ) ( ' 
	+ ' select ' + CAST(@logdate as varchar) + ', actor, str_actor, max(isnull(etc_num4, 0)), count(*)  from lin2log.dbo.'
	+ @table_from + ' ( nolock )  where log_id = 842  group by  actor, str_actor)' + ' option (MAXDOP 1 )'
exec (@sql )
GO

/******************************************************************************
#Name:	lin_RPRankDailySealStone
#Desc:	make Daily SealStone Ranking Table

#Argument:
	Input:		@table_from	varchar(60)	snap_shot table to be a source
			@table_to	varchar(60)	report table to be a destination
			@logdate	int			the date of report to be created
	Output:
#Return:
#Result Set:

#Remark:	
#Example:	exec lin_RPRankDailySealStone 'S2005_02_25_snap_item_8', 'RP_RANKDAILYSEALSTONE_8', 20050225
#See:

#History:
	create	zzangse		2005-02-25
	modify	zzangse		2005-03-04			int -> bigint
******************************************************************************/
ALTER  Procedure [dbo].[lin_RPRankDailySealStone]
	@table_from	varchar(60),
	@table_to	varchar(60),
	@logdate	int
AS
SET NOCOUNT ON


declare @sql varchar(4000)
declare @yesterday	varchar(8)
declare @table_from2	varchar(60)

-- check table whether @table_to is exists or not
set @sql = 'select * from lin2report.dbo.sysobjects (nolock) where name = ''' + @table_to + ''''
exec (@sql)

if (@@ROWCOUNT = 0)
begin
	set @sql = 'CREATE TABLE dbo.' + @table_to + ' (' 
		+ ' log_date	int, '
		+ ' seal_stone_type	smallint, '
		+ ' log_type	smallint, '
		+ ' rank	int, '
		+ ' rank_old	int, '
		+ ' rank_diff	int, '
		+ ' race	smallint, '
		+ ' class	smallint, '
		+ ' gender	smallint, '
		+ ' char_id	int, '
		+ ' char_name	nvarchar(60), '
		+ ' account_id	int, '
		+ ' account_name	nvarchar(60), '
		+ ' level	smallint, '
		+ ' amount	bigint, '
		+ ' amount_old	bigint, '
		+ ' amount_diff	bigint '
		+ ' ) '
	exec (@sql)

	set @sql = 'CREATE clustered INDEX IX_' + @table_to + '_1 on dbo.' + @table_to + ' (log_date, seal_stone_type, log_type, class, rank ) with fillfactor = 90 '
	exec (@sql)
	set @sql = 'CREATE nonclustered INDEX IX_' + @table_to + '_2 on dbo.' + @table_to + ' (log_date, log_type, race , rank) with fillfactor = 90 '
	exec (@sql)
	set @sql = 'CREATE nonclustered INDEX IX_' + @table_to + '_3 on dbo.' + @table_to + ' (log_date, log_type, rank) with fillfactor = 90 '
	exec (@sql)
end
else begin
	set @sql = 'delete from dbo.' + @table_to + ' where log_date = ' + CAST(@logdate as varchar)
	exec (@sql)
end

-- set table names
set @yesterday = convert(varchar(8), dateadd(day, -1, cast(cast(@logdate as varchar) as datetime)), 112)
set @table_from2 = replace (@table_from, 'item', 'data' )

-- check tmp table
declare @tmp_table varchar(512)
set @tmp_table = 'dbo.tmp' + @table_to

set @sql = 'select * from lin2report.dbo.sysobjects (nolock) where name = ''tmp' + @table_to + ''''
exec (@sql)

if (@@ROWCOUNT > 0)
begin
	set @sql = ' drop table dbo.tmp' + @table_to
	exec (@sql)
end

-- make tmptable
-- warehouse- 0, 1L+ -=, + -+=- -+- L+T -=
-- -- -+ LL+- +v+ T-- -
set @sql = ' select 0 as seal_stone_type, race, class, gender, char_id, char_name, account_id, account_name, max(lev) as level, sum(cast(amount as bigint)) as amount '
	+ 'into ' + @tmp_table
	+ ' from ( '
	+ '	select R1.char_id, R1.amount, R2.race, R2.class, R2.gender, R2.char_name, R2.account_id, R2.account_name, R2.lev, R2.builder '
	+ '	from ( '
	+ '		select * from lin2log.dbo.' + @table_from + ' (nolock) '
	+ '		where item_type = 6360 and warehouse <= 1) as R1 '
	+ '	left join lin2log.dbo.' + @table_from2 + ' as R2 (nolock) '
	+ '	on R1.char_id = R2.char_id ) as T1 '
	+ 'where T1.account_id > 0 and T1.builder = 0 '
	+ 'group by race, class, gender, char_id, char_name, account_id, account_name '
	+ 'order by sum(cast(amount as bigint)) desc, char_id '
exec (@sql)

set @sql = ' insert into ' + @tmp_table +  '  select 1 as seal_stone_type, race, class, gender, char_id, char_name, account_id, account_name, max(lev) as level, sum(cast(amount as bigint)) as amount '
	+ ' from ( '
	+ '	select R1.char_id, R1.amount, R2.race, R2.class, R2.gender, R2.char_name, R2.account_id, R2.account_name, R2.lev, R2.builder '
	+ '	from ( '
	+ '		select * from lin2log.dbo.' + @table_from + ' (nolock) '
	+ '		where item_type = 6361 and warehouse <= 1) as R1 '
	+ '	left join lin2log.dbo.' + @table_from2 + ' as R2 (nolock) '
	+ '	on R1.char_id = R2.char_id ) as T1 '
	+ 'where T1.account_id > 0 and T1.builder = 0 '
	+ 'group by race, class, gender, char_id, char_name, account_id, account_name '
	+ 'order by sum(cast(amount as bigint)) desc, char_id '
exec (@sql)



set @sql = ' insert into ' + @tmp_table +  '  select 2 as seal_stone_type, race, class, gender, char_id, char_name, account_id, account_name, max(lev) as level, sum(cast(amount as bigint)) as amount '
	+ ' from ( '
	+ '	select R1.char_id, R1.amount, R2.race, R2.class, R2.gender, R2.char_name, R2.account_id, R2.account_name, R2.lev, R2.builder '
	+ '	from ( '
	+ '		select * from lin2log.dbo.' + @table_from + ' (nolock) '
	+ '		where item_type = 6362 and warehouse <= 1) as R1 '
	+ '	left join lin2log.dbo.' + @table_from2 + ' as R2 (nolock) '
	+ '	on R1.char_id = R2.char_id ) as T1 '
	+ 'where T1.account_id > 0 and T1.builder = 0 '
	+ 'group by race, class, gender, char_id, char_name, account_id, account_name '
	+ 'order by sum(cast(amount as bigint)) desc, char_id '
exec (@sql)


-- insert into report table
-- log_type = 0 (ALL)
declare @iCounter int
set @iCounter = 0
while @iCounter < 3
begin
	set @sql = 'insert into ' + RTRIM(@table_to) + ' (log_date, seal_stone_type, log_type, rank, rank_old, rank_diff, race, class, gender, char_id, char_name, account_id, account_name, level, amount, amount_old, amount_diff) ( ' 
		+ 'select ' + cast(@logdate as varchar) + ', S1.seal_stone_type,  0, S1.rank, S2.rank_old, S1.rank-S2.rank_old as rank_diff, '
		+ '	S1.race, S1.class, S1.gender, S1.char_id, S1.char_name, S1.account_id, S1.account_name, S1.level, S1.amount, S2.amount_old, '
		+ '	case when S2.amount_old is null then S1.amount else S1.amount-S2.amount_old end as amount_diff '
		+ 'from ( '
		+ '	select count(R1.char_id) as rank , R1.race, R1.class, R1.gender, R1.char_id, R1.char_name, R1.account_id, R1.account_name, R1.level, R1.amount , R1.seal_stone_type '
		+ '	from ( '
		+ '		select top 100 * from ' + @tmp_table + ' (nolock) '
		+ '		where seal_stone_type = ' + cast ( @iCounter as varchar )
		+ '		order by amount desc ) as R1 '
		+ '	inner join ( '
		+ '		select top 100 * from ' + @tmp_table + ' (nolock) '
		+ '		where seal_stone_type = ' + cast ( @iCounter as varchar )
		+ '		order by amount desc ) as R2 '
		+ '	on R1.amount <= R2.amount '
		+ '	group by R1.seal_stone_type, R1.race, R1.class, R1.gender, R1.char_id, R1.char_name, R1.account_id, R1.account_name, R1.level, R1.amount ) as S1 '
		+ 'left join ( '
		+ '	select char_id, rank as rank_old, amount as amount_old '
		+ '	from ' + @table_to + ' (nolock) '
		+ '	where log_date = ' + @yesterday + ' and log_type = 0 and seal_stone_type = ' + cast (@iCounter as varchar ) + ' ) as S2 '
		+ 'on S1.char_id = S2.char_id '
		+ ') option (MAXDOP 1 ) '
	
	exec (@sql)
	set @iCounter = @iCounter + 1
end




-- log_type = 1 (race)
declare @idx int
set @idx = 0
while @idx < 5
begin
	set @iCounter = 0
	while @iCounter < 3
	begin
		set @sql = 'insert into ' + RTRIM(@table_to) + ' (log_date, seal_stone_type, log_type, rank, rank_old, rank_diff, race, class, gender, char_id, char_name, account_id, account_name, level, amount, amount_old, amount_diff) ( ' 
			+ 'select ' + cast(@logdate as varchar) + ', S1.seal_stone_type,  1, S1.rank, S2.rank_old, S1.rank-S2.rank_old as rank_diff, '
			+ '	S1.race, S1.class, S1.gender, S1.char_id, S1.char_name, S1.account_id, S1.account_name, S1.level, S1.amount, S2.amount_old, '
			+ '	case when S2.amount_old is null then S1.amount else S1.amount-S2.amount_old end as amount_diff '
			+ 'from ( '
			+ '	select count(R1.char_id) as rank, R1.race, R1.class, R1.gender, R1.char_id, R1.char_name, R1.account_id, R1.account_name, R1.level, R1.amount , R1.seal_stone_type '
			+ '	from ( '
			+ '		select top 100 * from ' + @tmp_table + ' (nolock) '
			+ '		where race = ' + cast(@idx as varchar)
			+ '			and seal_stone_type = ' + cast ( @iCounter as varchar )
			+ '		order by amount desc ) as R1 '
			+ '	inner join ( '
			+ '		select top 100 * from ' + @tmp_table + ' (nolock) '
			+ '		where race = ' + cast(@idx as varchar)
			+ ' 			and seal_stone_type = ' + cast ( @iCounter as varchar )
			+ '		order by amount desc ) as R2 '
			+ '	on R1.amount <= R2.amount '
			+ '	group by R1.seal_stone_type , R1.race, R1.class, R1.gender, R1.char_id, R1.char_name, R1.account_id, R1.account_name, R1.level, R1.amount ) as S1 '
			+ 'left join ( '
			+ '	select char_id, rank as rank_old, amount as amount_old '
			+ '	from ' + @table_to + ' (nolock) '
			+ '	where log_date = ' + @yesterday + ' and log_type = 1 and seal_stone_type = ' + cast ( @iCounter as varchar ) + ' ) as S2 '
			+ 'on S1.char_id = S2.char_id '
			+ ') option (MAXDOP 1 ) '
		exec (@sql )
		set @iCounter = @iCounter + 1
	end
	set @idx = @idx + 1
end

-- log_type = 2 (class)
set @idx = 0
while @idx < 58
begin

	set @iCounter = 0
	while @iCounter < 3
	begin

		set @sql = 'insert into ' + RTRIM(@table_to) + ' (log_date, seal_stone_type, log_type, rank, rank_old, rank_diff, race, class, gender, char_id, char_name, account_id, account_name, level, amount, amount_old, amount_diff) ( ' 
			+ 'select ' + cast(@logdate as varchar) + ', S1.seal_stone_type,  2, S1.rank, S2.rank_old, S1.rank-S2.rank_old as rank_diff, '
			+ '	S1.race, S1.class, S1.gender, S1.char_id, S1.char_name, S1.account_id, S1.account_name, S1.level, S1.amount, S2.amount_old, '
			+ '	case when S2.amount_old is null then S1.amount else S1.amount-S2.amount_old end as amount_diff '
			+ 'from ( '
			+ '	select count(R1.char_id) as rank, R1.race, R1.class, R1.gender, R1.char_id, R1.char_name, R1.account_id, R1.account_name, R1.level, R1.amount , R1.seal_stone_type '
			+ '	from ( '
			+ '		select top 100 * from ' + @tmp_table + ' (nolock) '
			+ '		where class = ' + cast(@idx as varchar)
			+ '			and seal_stone_type = ' + cast ( @iCounter as varchar )
			+ '		order by amount desc ) as R1 '
			+ '	inner join ( '
			+ '		select top 100 * from ' + @tmp_table + ' (nolock) '
			+ '		where class = ' + cast(@idx as varchar)
			+ '			and seal_stone_type = ' + cast ( @iCounter as varchar )
			+ '		order by amount desc ) as R2 '
			+ '	on R1.amount <= R2.amount '
			+ '	group by R1.seal_stone_type,  R1.race, R1.class, R1.gender, R1.char_id, R1.char_name, R1.account_id, R1.account_name, R1.level, R1.amount ) as S1 '
			+ 'left join ( '
			+ '	select char_id, rank as rank_old, amount as amount_old '
			+ '	from ' + @table_to + ' (nolock) '
			+ '	where log_date = ' + @yesterday + ' and log_type = 2 and seal_stone_type = ' + cast ( @iCounter as varchar ) + ' ) as S2 '
			+ 'on S1.char_id = S2.char_id '
			+ ') option (MAXDOP 1 ) '
		exec (@sql )
		set @iCounter = @iCounter + 1
	end
	set @idx = @idx + 1
end


-- drop tmptable
set @sql = ' drop table ' + @tmp_table
exec (@sql)


SET NOCOUNT OFF
GO

/********************************************
lin_RPRankDailyCrystal
make Daily Crystal Ranking Table

#argument	@table_from	varchar(60)	log table to be a source
#argument	@table_to	varchar(60)	report table to be a destination
#argument	@logdate	int		the date of report to be created
#return
#result_set
#remark
#example	lin_RPRankDailyCrystal 'L2004_11_30_log_data_8', 'RP_RANKDAILYCRYSTAL_8', 20040716
#history	create	flagoftiger	2004-07-16
#see
********************************************/
ALTER PROCEDURE [DBO].[lin_RPRankDailyCrystal]
	@table_from	varchar(60),
	@table_to	varchar(60),
	@logdate	int

AS
SET NOCOUNT ON

declare @sql varchar(4000)
declare @yesterday	varchar(8)
declare @table_from2	varchar(60)

-- check table whether @table_to is exists or not
set @sql = 'select * from lin2report.dbo.sysobjects (nolock) where name = ''' + @table_to + ''''
exec (@sql)

if (@@ROWCOUNT = 0)
begin
	set @sql = 'CREATE TABLE dbo.' + @table_to + ' (' 
		+ ' log_date	int, '
		+ ' crystal_type	smallint, '
		+ ' log_type	smallint, '
		+ ' rank	int, '
		+ ' rank_old	int, '
		+ ' rank_diff	int, '
		+ ' race	smallint, '
		+ ' class	smallint, '
		+ ' gender	smallint, '
		+ ' char_id	int, '
		+ ' char_name	nvarchar(60), '
		+ ' account_id	int, '
		+ ' account_name	nvarchar(60), '
		+ ' level	smallint, '
		+ ' amount	bigint, '
		+ ' amount_old	bigint, '
		+ ' amount_diff	bigint '
		+ ' ) '
	exec (@sql)

	set @sql = 'CREATE clustered INDEX IX_' + @table_to + '_1 on dbo.' + @table_to + ' (log_date, crystal_type, log_type, race , rank) with fillfactor = 90 '
	exec (@sql)
	set @sql = 'CREATE nonclustered INDEX IX_' + @table_to + '_2 on dbo.' + @table_to + ' (log_date, crystal_type, log_type, rank) with fillfactor = 90 '
	exec (@sql)
end
else begin
	set @sql = 'delete from dbo.' + @table_to + ' where log_date = ' + CAST(@logdate as varchar)
	exec (@sql)
end

-- set table names
set @yesterday = convert(varchar(8), dateadd(day, -1, cast(cast(@logdate as varchar) as datetime)), 112)
set @table_from2 = replace (@table_from, 'item', 'data' )

-- check tmp table
declare @tmp_table varchar(512)
set @tmp_table = 'dbo.tmp' + @table_to

set @sql = 'select * from lin2report.dbo.sysobjects (nolock) where name = ''tmp' + @table_to + ''''
exec (@sql)

if (@@ROWCOUNT > 0)
begin
	set @sql = ' drop table dbo.tmp' + @table_to
	exec (@sql)
end

-- make tmptable
-- warehouse- 0, 1L+ -=, + -+=- -+- L+T -=
set @sql = ' select race, class, gender, char_id, char_name, account_id, account_name, lev as level, item_type as crystal_type, sum(amount) as amount '
	+ 'into ' + @tmp_table
	+ ' from ( '
	+ '	select R1.char_id, R1.item_type, R1.amount, R2.race, R2.class, R2.gender, R2.char_name, R2.account_id, R2.account_name, R2.lev, R2.builder '
	+ '	from ( '
	+ '		select * from lin2log.dbo.' + @table_from + ' (nolock) '
	+ '		where item_type in (1458, 1459, 1460, 1461, 1462) and warehouse <= 1) as R1 '
	+ '	left join lin2log.dbo.' + @table_from2 + ' as R2 (nolock) '
	+ '	on R1.char_id = R2.char_id ) as T1 '
	+ 'where T1.account_id > 0 and T1.builder = 0 '
	+ 'group by item_type, race, class, gender, char_id, char_name, account_id, account_name, lev '
	+ 'order by sum(amount) desc, char_id '
exec (@sql)

-- insert into report table
-- loop for crystal type (1458~1462)
declare @crystal_idx int
set @crystal_idx = 1458
while @crystal_idx < 1463
begin
	-- log_type = 0 (ALL)
	set @sql = 'insert into '+ RTRIM(@table_to) + '(log_date, crystal_type, log_type, rank, rank_old, rank_diff, race, class, gender, char_id, char_name, account_id, account_name, level, amount, amount_old, amount_diff) ( '
	+ 'select ' + cast(@logdate as varchar(8)) + ', S1.crystal_type, 0, S1.rank, S2.rank_old, S1.rank-S2.rank_old as rank_diff, S1.race, S1.class, S1.gender, S1.char_id, S1.char_name, S1.account_id, S1.account_name, '
	+ '	S1.level, S1.amount, S2.amount_old, S1.amount-S2.amount_old as amount_diff '
	+ 'from ( '
	+ '	select R1.crystal_type, count(R1.char_id) as rank , R1.race, R1.class, R1.gender, R1.char_id, R1.char_name, R1.account_id, R1.account_name, R1.level, R1.amount '
	+ '	from ( '
	+ '		select top 100 * from ' + @tmp_table + ' (nolock) '
	+ '		where crystal_type = ' + cast(@crystal_idx as varchar)
	+ '		order by amount desc ) as R1 '
	+ '	inner join ( '
	+ '		select top 100 * from ' + @tmp_table + ' (nolock) '
	+ '		where crystal_type = ' + cast(@crystal_idx as varchar)
	+ '		order by amount desc ) as R2 '
	+ '	on R1.amount <= R2.amount '
	+ '	group by R1.crystal_type, R1.race, R1.class, R1.gender, R1.char_id, R1.char_name, R1.account_id, R1.account_name, R1.level, R1.amount ) as S1 '
	+ 'left join ( '
	+ '	select char_id, rank as rank_old, amount as amount_old '
	+ '	from ' + @table_to + ' (nolock) '
	+ '	where log_date = ' + cast(@yesterday as varchar) + ' and crystal_type = ' + cast(@crystal_idx as varchar) + ' and log_type = 0 ) as S2 '
	+ 'on S1.char_id = S2.char_id '
	+ ') option (MAXDOP 1 ) '
	exec (@sql )
	
	-- log_type = 1 (race)
	declare @idx int
	set @idx = 0
	while @idx < 5
	begin
		set @sql = 'insert into ' + RTRIM(@table_to) + ' (log_date, crystal_type, log_type, rank, rank_old, rank_diff, race, class, gender, char_id, char_name, account_id, account_name, level, amount, amount_old, amount_diff) ( ' 
			+ 'select ' + cast(@logdate as varchar) + ', S1.crystal_type, 1, S1.rank, S2.rank_old, S1.rank-S2.rank_old as rank_diff, '
			+ '	S1.race, S1.class, S1.gender, S1.char_id, S1.char_name, S1.account_id, S1.account_name, S1.level, S1.amount, S2.amount_old, '
			+ '	S1.amount-S2.amount_old as amount_diff '
			+ 'from ( '
			+ '	select R1.crystal_type, count(R1.char_id) as rank, R1.race, R1.class, R1.gender, R1.char_id, R1.char_name, R1.account_id, R1.account_name, R1.level, R1.amount '
			+ '	from ( '
			+ '		select top 100 * from ' + @tmp_table + ' (nolock) '
			+ '		where race = ' + cast(@idx as varchar) + ' and crystal_type = ' + cast(@crystal_idx as varchar) 
			+ '		order by amount desc ) as R1 '
			+ '	inner join ( '
			+ '		select top 100 * from ' + @tmp_table + ' (nolock) '
			+ '		where race = ' + cast(@idx as varchar) + ' and crystal_type = ' + cast(@crystal_idx as varchar) 
			+ '		order by amount desc ) as R2 '
			+ '	on R1.amount <= R2.amount '
			+ '	group by R1.crystal_type, R1.race, R1.class, R1.gender, R1.char_id, R1.char_name, R1.account_id, R1.account_name, R1.level, R1.amount ) as S1 '
			+ 'left join ( '
			+ '	select char_id, rank as rank_old, amount as amount_old '
			+ '	from ' + @table_to + ' (nolock) '
			+ '	where log_date = ' + cast(@yesterday as varchar) + ' and crystal_type = ' + cast(@crystal_idx as varchar) + ' and log_type = 1 ) as S2 '
			+ 'on S1.char_id = S2.char_id '
			+ ') option (MAXDOP 1 ) '
		exec (@sql )
		set @idx = @idx + 1
	end
	set @crystal_idx = @crystal_idx + 1
end
-- drop tmptable
set @sql = ' drop table ' + @tmp_table
exec (@sql)
GO

/******************************************************************************
#Name:	lin_RPRankDailyAdena
#Desc:	make Daily Adena Ranking Table

#Argument:
	Input:	@table_from	varchar(60)	snap_shot table to be a source
			@table_to	varchar(60)	report table to be a destination
			@logdate	int			the date of report to be created
	Output:
#Return:
#Result Set:

#Remark:
#Example:	exec lin_RPRankDailyAdena 'S2004_11_30_snap_item_8', 'RP_RANKDAILYADENA_8', 20041130
#See:

#History:
	create	flagoftiger	2004-07-16
	modify	btwinuni	2004-12-14
	modify	btwinuni	2005-03-04	int --> bigint
	modify	btwinuni	2005-05-24	top 100 --> top 300
******************************************************************************/
ALTER Procedure [dbo].[lin_RPRankDailyAdena]
	@table_from	varchar(60),
	@table_to	varchar(60),
	@logdate	int
AS
SET NOCOUNT ON

declare @sql varchar(4000)
declare @yesterday	varchar(8)
declare @table_from2	varchar(60)

-- check table whether @table_to is exists or not
set @sql = 'select * from lin2report.dbo.sysobjects (nolock) where name = ''' + @table_to + ''''
exec (@sql)

if (@@ROWCOUNT = 0)
begin
	set @sql = 'CREATE TABLE dbo.' + @table_to + ' (' 
		+ ' log_date	int, '
		+ ' log_type	smallint, '
		+ ' rank	int, '
		+ ' rank_old	int, '
		+ ' rank_diff	int, '
		+ ' race	smallint, '
		+ ' class	smallint, '
		+ ' gender	smallint, '
		+ ' char_id	int, '
		+ ' char_name	nvarchar(60), '
		+ ' account_id	int, '
		+ ' account_name	nvarchar(60), '
		+ ' level	smallint, '
		+ ' amount	bigint, '
		+ ' amount_old	bigint, '
		+ ' amount_diff	bigint '
		+ ' ) '
	exec (@sql)

	set @sql = 'CREATE clustered INDEX IX_' + @table_to + '_1 on dbo.' + @table_to + ' (log_date, log_type, class, rank ) with fillfactor = 90 '
	exec (@sql)
	set @sql = 'CREATE nonclustered INDEX IX_' + @table_to + '_2 on dbo.' + @table_to + ' (log_date, log_type, race , rank) with fillfactor = 90 '
	exec (@sql)
	set @sql = 'CREATE nonclustered INDEX IX_' + @table_to + '_3 on dbo.' + @table_to + ' (log_date, log_type, rank) with fillfactor = 90 '
	exec (@sql)
end
else begin
	set @sql = 'delete from dbo.' + @table_to + ' where log_date = ' + CAST(@logdate as varchar)
	exec (@sql)
end

-- set table names
set @yesterday = convert(varchar(8), dateadd(day, -1, cast(cast(@logdate as varchar) as datetime)), 112)
set @table_from2 = replace (@table_from, 'item', 'data' )

-- check tmp table
declare @tmp_table varchar(512)
set @tmp_table = 'dbo.tmp' + @table_to

set @sql = 'select * from lin2report.dbo.sysobjects (nolock) where name = ''tmp' + @table_to + ''''
exec (@sql)

if (@@ROWCOUNT > 0)
begin
	set @sql = ' drop table dbo.tmp' + @table_to
	exec (@sql)
end

-- make tmptable
-- warehouse- 0, 1L+ -=, + -+=- -+- L+T -=
set @sql = ' select race, class, gender, char_id, char_name, account_id, account_name, max(lev) as level, sum( cast (amount as bigint) ) as amount '
	+ 'into ' + @tmp_table
	+ ' from ( '
	+ '	select R1.char_id, R1.amount, R2.race, R2.class, R2.gender, R2.char_name, R2.account_id, R2.account_name, R2.lev, R2.builder '
	+ '	from ( '
	+ '		select * from lin2log.dbo.' + @table_from + ' (nolock) '
	+ '		where item_type = 57 and warehouse <= 1) as R1 '
	+ '	left join lin2log.dbo.' + @table_from2 + ' as R2 (nolock) '
	+ '	on R1.char_id = R2.char_id ) as T1 '
	+ 'where T1.account_id > 0 and T1.builder = 0 '
	+ 'group by race, class, gender, char_id, char_name, account_id, account_name '
	+ 'order by sum(cast(amount as bigint)) desc, char_id '
exec (@sql)

-- insert into report table
-- log_type = 0 (ALL)
set @sql = 'insert into ' + RTRIM(@table_to) + ' (log_date, log_type, rank, rank_old, rank_diff, race, class, gender, char_id, char_name, account_id, account_name, level, amount, amount_old, amount_diff) ( ' 
	+ 'select ' + cast(@logdate as varchar) + ', 0, S1.rank, S2.rank_old, S1.rank-S2.rank_old as rank_diff, '
	+ '	S1.race, S1.class, S1.gender, S1.char_id, S1.char_name, S1.account_id, S1.account_name, S1.level, S1.amount, S2.amount_old, '
	+ '	case when S2.amount_old is null then S1.amount else S1.amount-S2.amount_old end as amount_diff '
	+ 'from ( '
	+ '	select count(R1.char_id) as rank , R1.race, R1.class, R1.gender, R1.char_id, R1.char_name, R1.account_id, R1.account_name, R1.level, R1.amount '
	+ '	from ( '
	+ '		select top 300 * from ' + @tmp_table + ' (nolock) '
	+ '		order by amount desc ) as R1 '
	+ '	inner join ( '
	+ '		select top 300 * from ' + @tmp_table + ' (nolock) '
	+ '		order by amount desc ) as R2 '
	+ '	on R1.amount <= R2.amount '
	+ '	group by R1.race, R1.class, R1.gender, R1.char_id, R1.char_name, R1.account_id, R1.account_name, R1.level, R1.amount ) as S1 '
	+ 'left join ( '
	+ '	select char_id, rank as rank_old, amount as amount_old '
	+ '	from ' + @table_to + ' (nolock) '
	+ '	where log_date = ' + @yesterday + ' and log_type = 0 ) as S2 '
	+ 'on S1.char_id = S2.char_id '
	+ ') option (MAXDOP 1 ) '
exec (@sql)


-- log_type = 1 (race)
declare @idx int
set @idx = 0
while @idx < 5
begin
	set @sql = 'insert into ' + RTRIM(@table_to) + ' (log_date, log_type, rank, rank_old, rank_diff, race, class, gender, char_id, char_name, account_id, account_name, level, amount, amount_old, amount_diff) ( ' 
		+ 'select ' + cast(@logdate as varchar) + ', 1, S1.rank, S2.rank_old, S1.rank-S2.rank_old as rank_diff, '
		+ '	S1.race, S1.class, S1.gender, S1.char_id, S1.char_name, S1.account_id, S1.account_name, S1.level, S1.amount, S2.amount_old, '
		+ '	case when S2.amount_old is null then S1.amount else S1.amount-S2.amount_old end as amount_diff '
		+ 'from ( '
		+ '	select count(R1.char_id) as rank, R1.race, R1.class, R1.gender, R1.char_id, R1.char_name, R1.account_id, R1.account_name, R1.level, R1.amount '
		+ '	from ( '
		+ '		select top 300 * from ' + @tmp_table + ' (nolock) '
		+ '		where race = ' + cast(@idx as varchar)
		+ '		order by amount desc ) as R1 '
		+ '	inner join ( '
		+ '		select top 300 * from ' + @tmp_table + ' (nolock) '
		+ '		where race = ' + cast(@idx as varchar)
		+ '		order by amount desc ) as R2 '
		+ '	on R1.amount <= R2.amount '
		+ '	group by R1.race, R1.class, R1.gender, R1.char_id, R1.char_name, R1.account_id, R1.account_name, R1.level, R1.amount ) as S1 '
		+ 'left join ( '
		+ '	select char_id, rank as rank_old, amount as amount_old '
		+ '	from ' + @table_to + ' (nolock) '
		+ '	where log_date = ' + @yesterday + ' and log_type = 1 ) as S2 '
		+ 'on S1.char_id = S2.char_id '
		+ ') option (MAXDOP 1 ) '
	exec (@sql )
	set @idx = @idx + 1
end

-- log_type = 2 (class)
set @idx = 0
while @idx < 58
begin
	set @sql = 'insert into ' + RTRIM(@table_to) + ' (log_date, log_type, rank, rank_old, rank_diff, race, class, gender, char_id, char_name, account_id, account_name, level, amount, amount_old, amount_diff) ( ' 
		+ 'select ' + cast(@logdate as varchar) + ', 2, S1.rank, S2.rank_old, S1.rank-S2.rank_old as rank_diff, '
		+ '	S1.race, S1.class, S1.gender, S1.char_id, S1.char_name, S1.account_id, S1.account_name, S1.level, S1.amount, S2.amount_old, '
		+ '	case when S2.amount_old is null then S1.amount else S1.amount-S2.amount_old end as amount_diff '
		+ 'from ( '
		+ '	select count(R1.char_id) as rank, R1.race, R1.class, R1.gender, R1.char_id, R1.char_name, R1.account_id, R1.account_name, R1.level, R1.amount '
		+ '	from ( '
		+ '		select top 300 * from ' + @tmp_table + ' (nolock) '
		+ '		where class = ' + cast(@idx as varchar)
		+ '		order by amount desc ) as R1 '
		+ '	inner join ( '
		+ '		select top 300 * from ' + @tmp_table + ' (nolock) '
		+ '		where class = ' + cast(@idx as varchar)
		+ '		order by amount desc ) as R2 '
		+ '	on R1.amount <= R2.amount '
		+ '	group by R1.race, R1.class, R1.gender, R1.char_id, R1.char_name, R1.account_id, R1.account_name, R1.level, R1.amount ) as S1 '
		+ 'left join ( '
		+ '	select char_id, rank as rank_old, amount as amount_old '
		+ '	from ' + @table_to + ' (nolock) '
		+ '	where log_date = ' + @yesterday + ' and log_type = 2) as S2 '
		+ 'on S1.char_id = S2.char_id '
		+ ') option (MAXDOP 1 ) '
	exec (@sql )
	set @idx = @idx + 1
end


-- drop tmptable
set @sql = ' drop table ' + @tmp_table
exec (@sql)


--- --++=+T -+v -
-- make tmptable
-- warehouse- 0, 1L+ -=, + -+=- -+- L+T -=
set @sql = ' select race, class, gender, char_id, char_name, account_id, account_name, max(lev) as level, sum( cast (amount as bigint )) as amount '
	+ 'into ' + @tmp_table
	+ ' from ( '
	+ '	select R1.char_id, R1.amount, R2.race, R2.class, R2.gender, R2.char_name, R2.account_id, R2.account_name, R2.lev, R2.builder '
	+ '	from ( '
	+ '		select * from lin2log.dbo.' + @table_from + ' (nolock) '
	+ '		where item_type = 5575 and warehouse <= 1) as R1 '
	+ '	left join lin2log.dbo.' + @table_from2 + ' as R2 (nolock) '
	+ '	on R1.char_id = R2.char_id ) as T1 '
	+ 'where T1.account_id > 0 and T1.builder = 0 '
	+ 'group by race, class, gender, char_id, char_name, account_id, account_name '
	+ 'order by sum(cast(amount as bigint)) desc, char_id '
exec (@sql)

-- insert into report table
-- log_type = 10 (ALL)
set @sql = 'insert into ' + RTRIM(@table_to) + ' (log_date, log_type, rank, rank_old, rank_diff, race, class, gender, char_id, char_name, account_id, account_name, level, amount, amount_old, amount_diff) ( ' 
	+ 'select ' + cast(@logdate as varchar) + ', 10, S1.rank, S2.rank_old, S1.rank-S2.rank_old as rank_diff, '
	+ '	S1.race, S1.class, S1.gender, S1.char_id, S1.char_name, S1.account_id, S1.account_name, S1.level, S1.amount, S2.amount_old, '
	+ '	case when S2.amount_old is null then S1.amount else S1.amount-S2.amount_old end as amount_diff '
	+ 'from ( '
	+ '	select count(R1.char_id) as rank , R1.race, R1.class, R1.gender, R1.char_id, R1.char_name, R1.account_id, R1.account_name, R1.level, R1.amount '
	+ '	from ( '
	+ '		select top 300 * from ' + @tmp_table + ' (nolock) '
	+ '		order by amount desc ) as R1 '
	+ '	inner join ( '
	+ '		select top 300 * from ' + @tmp_table + ' (nolock) '
	+ '		order by amount desc ) as R2 '
	+ '	on R1.amount <= R2.amount '
	+ '	group by R1.race, R1.class, R1.gender, R1.char_id, R1.char_name, R1.account_id, R1.account_name, R1.level, R1.amount ) as S1 '
	+ 'left join ( '
	+ '	select char_id, rank as rank_old, amount as amount_old '
	+ '	from ' + @table_to + ' (nolock) '
	+ '	where log_date = ' + @yesterday + ' and log_type = 10 ) as S2 '
	+ 'on S1.char_id = S2.char_id '
	+ ') option (MAXDOP 1 ) '
exec (@sql)


-- log_type = 11 (race)
set @idx = 0
while @idx < 5
begin
	set @sql = 'insert into ' + RTRIM(@table_to) + ' (log_date, log_type, rank, rank_old, rank_diff, race, class, gender, char_id, char_name, account_id, account_name, level, amount, amount_old, amount_diff) ( ' 
		+ 'select ' + cast(@logdate as varchar) + ', 11, S1.rank, S2.rank_old, S1.rank-S2.rank_old as rank_diff, '
		+ '	S1.race, S1.class, S1.gender, S1.char_id, S1.char_name, S1.account_id, S1.account_name, S1.level, S1.amount, S2.amount_old, '
		+ '	case when S2.amount_old is null then S1.amount else S1.amount-S2.amount_old end as amount_diff '
		+ 'from ( '
		+ '	select count(R1.char_id) as rank, R1.race, R1.class, R1.gender, R1.char_id, R1.char_name, R1.account_id, R1.account_name, R1.level, R1.amount '
		+ '	from ( '
		+ '		select top 300 * from ' + @tmp_table + ' (nolock) '
		+ '		where race = ' + cast(@idx as varchar)
		+ '		order by amount desc ) as R1 '
		+ '	inner join ( '
		+ '		select top 300 * from ' + @tmp_table + ' (nolock) '
		+ '		where race = ' + cast(@idx as varchar)
		+ '		order by amount desc ) as R2 '
		+ '	on R1.amount <= R2.amount '
		+ '	group by R1.race, R1.class, R1.gender, R1.char_id, R1.char_name, R1.account_id, R1.account_name, R1.level, R1.amount ) as S1 '
		+ 'left join ( '
		+ '	select char_id, rank as rank_old, amount as amount_old '
		+ '	from ' + @table_to + ' (nolock) '
		+ '	where log_date = ' + @yesterday + ' and log_type = 11 ) as S2 '
		+ 'on S1.char_id = S2.char_id '
		+ ') option (MAXDOP 1 ) '
	exec (@sql )
	set @idx = @idx + 1
end

-- log_type =12 (class)
set @idx = 0
while @idx < 58
begin
	set @sql = 'insert into ' + RTRIM(@table_to) + ' (log_date, log_type, rank, rank_old, rank_diff, race, class, gender, char_id, char_name, account_id, account_name, level, amount, amount_old, amount_diff) ( ' 
		+ 'select ' + cast(@logdate as varchar) + ', 12, S1.rank, S2.rank_old, S1.rank-S2.rank_old as rank_diff, '
		+ '	S1.race, S1.class, S1.gender, S1.char_id, S1.char_name, S1.account_id, S1.account_name, S1.level, S1.amount, S2.amount_old, '
		+ '	case when S2.amount_old is null then S1.amount else S1.amount-S2.amount_old end as amount_diff '
		+ 'from ( '
		+ '	select count(R1.char_id) as rank, R1.race, R1.class, R1.gender, R1.char_id, R1.char_name, R1.account_id, R1.account_name, R1.level, R1.amount '
		+ '	from ( '
		+ '		select top 300 * from ' + @tmp_table + ' (nolock) '
		+ '		where class = ' + cast(@idx as varchar)
		+ '		order by amount desc ) as R1 '
		+ '	inner join ( '
		+ '		select top 300 * from ' + @tmp_table + ' (nolock) '
		+ '		where class = ' + cast(@idx as varchar)
		+ '		order by amount desc ) as R2 '
		+ '	on R1.amount <= R2.amount '
		+ '	group by R1.race, R1.class, R1.gender, R1.char_id, R1.char_name, R1.account_id, R1.account_name, R1.level, R1.amount ) as S1 '
		+ 'left join ( '
		+ '	select char_id, rank as rank_old, amount as amount_old '
		+ '	from ' + @table_to + ' (nolock) '
		+ '	where log_date = ' + @yesterday + ' and log_type = 12) as S2 '
		+ 'on S1.char_id = S2.char_id '
		+ ') option (MAXDOP 1 ) '
	exec (@sql )
	set @idx = @idx + 1
end

SET NOCOUNT OFF
GO

/******************************************************************************
#Name:	lin_RPQuestAssetByChar
#Desc:	Gather total amount of quest adena and default price by character

#Argument:
	Input:	@table_from	varchar(60)	log view: Lyyyy_mm_dd_Log_Data0_world
		@table_to	varchar(60)	report table: RP_QuestAssetByChar_world
		@logdate	int		report date
	Output:	
#Return:
#Result Set:

#Remark:
#Example:	exec lin_RPQuestAssetByChar 'L2005_05_11_log_data0_8', 'RP_QuestAssetByChar_8', 20050511
#See:

#History:
	Create	btwinuni	2005-05-12
	Modify	btwinuni	2005-06-13
******************************************************************************/
ALTER Procedure [dbo].[lin_RPQuestAssetByChar]
	@table_from	varchar(60),
	@table_to	varchar(60),
	@logdate	int
AS
SET NOCOUNT ON

declare	@sql	varchar(4000)

-- report table is initiated
set @sql = 'if not exists (select * from dbo.sysobjects where id = object_id(N''[dbo].[' + @table_to + ']'') and objectproperty(id, N''IsUserTable'') = 1)'
	+ ' begin'
	+ ' create table [dbo].[' + @table_to + '] ('
	+ ' 	log_date		int,'
	+ '	char_id		int,'
	+ ' 	char_name	varchar(50),'
	+ ' 	quest_id		int,'
	+ ' 	quest_count	int,'
	+ ' 	adena		bigint,'
	+ ' 	dp		bigint,'
	+ ' )'
	+ ' create index ix_' + @table_to + '_1 on [dbo].[' + @table_to + '] (log_date, char_id)'
	+ ' create index ix_' + @table_to + '_2 on [dbo].[' + @table_to + '] (log_date, quest_id)'
	+ ' end'
exec (@sql)

set @sql = 'delete from [dbo].[' + @table_to + '] where log_date = ' + cast(@logdate as varchar)
exec (@sql)

set @sql = 'insert into [dbo].[' + @table_to + ']'
	+ ' select ' + cast(@logdate as varchar) + ', actor, STR_actor, quest_id, quest_count, adena, dp'
	+ ' from ('
	+ ' 	select actor, STR_actor, etc_num7 as quest_id, '
	+ ' 		count(*) as quest_count,'
	+ ' 		isnull((select sum(cast(etc_num6 as bigint)) from [lin2log].[dbo].[' + @table_from + '](nolock) where log_id = 301 and actor = T.actor and etc_num7 = T.etc_num7 and etc_num5 = 57), 0) as adena, '
	+ ' 		isnull(sum(cast(etc_num8 as bigint)), 0) as dp'
	+ ' 	from [lin2log].[dbo].[' + @table_from + '] T(nolock)'
	+ ' 	where log_id = 301'
	+ ' 	group by actor, STR_actor, etc_num7'
	+ ' 	having etc_num7 > 0'
	+ ' ) R'
	+ ' where adena > 0'
	+ ' 	or dp > 0'
exec (@sql)
GO

/******************************************************************************
#Name:	lin_RPNewAccount
#Desc:	make daily report about increase and decrease of new account

#Argument:
	Input:	@table_from	varchar(60)	log view: Lyyyy_mm_dd_Log_Data0_world
		@table_to	varchar(60)	report table: RP_NewAccount
		@logdate	int		report date
	Output:	
#Return:
#Result Set:

#Remark:
#Example:	exec lin_RPNewAccount 'L2005_02_25_log_data0_8', 'RP_NewAccount_8', 20050420
#See:

#History:
	Create	kernel0	2005-05-18
******************************************************************************/
ALTER Procedure [dbo].[lin_RPNewAccount]
	@table_from	varchar(60),
	@table_to	varchar(60),
	@logdate	int
AS
SET NOCOUNT ON

declare	@sql	varchar(4000)

-- report table is initiated
set @sql = 'if not exists (select * from dbo.sysobjects where id = object_id(N''[dbo].[' + @table_to + ']'') and objectproperty(id, N''IsUserTable'') = 1)'
	+ ' begin'
	+ ' create table [dbo].[' + @table_to + '] ('
	+ ' 	log_date		int,'
	+ '         log_id                      int,'
	+ ' 	cnt		int'
	+ ' )'
	+ ' create index ix_' + @table_to + '_1 on [dbo].[' + @table_to + '] (log_date asc, log_id asc)' 
	+ ' end'
exec (@sql)

set @sql = 'delete from [dbo].[' + @table_to + '] where log_date = ' + cast(@logdate as varchar)
exec (@sql)

set @sql = 'insert into [dbo].[' + @table_to + '] (log_date, log_id, cnt) '
	+ 'select  ' + cast(@logdate as varchar) + ', log_id, count(*) from [lin2log].[dbo].[' +@table_from + '] (nolock) where log_id in( 853, 854) group by log_id'
exec(@sql)

SET NOCOUNT OFF
GO

/******************************************************************************
#Name:	lin_RPManorInfo
#Desc:	Gather manor information

#Argument:
	Input:	@table_from	varchar(60)	log view: Lyyyy_mm_dd_Log_Data0_world
		@table_to	varchar(60)	report table: RP_ManorInfo_world
		@logdate	int		report date
	Output:	
#Return:
#Result Set:

#Remark:
#Example:	exec lin_RPManorInfo 'L2005_05_11_log_data0_8', 'RP_ManorInfo_8', 20050511
#See:

#History:
	Create	btwinuni	2005-06-14
	Modify	btwinuni	2005-06-30	add manor_output
******************************************************************************/
ALTER Procedure [dbo].[lin_RPManorInfo]
	@table_from	varchar(60),
	@table_to	varchar(60),
	@logdate	int
AS
SET NOCOUNT ON

declare	@sql	varchar(4000)

-- report table is initiated
set @sql = 'if not exists (select * from dbo.sysobjects where id = object_id(N''[dbo].[' + @table_to + ']'') and objectproperty(id, N''IsUserTable'') = 1)'
	+ ' begin'
	+ ' create table [dbo].[' + @table_to + '] ('
	+ ' 	log_date		int,'
	+ '	manor_id	int,'
	+ ' 	seed_profit	bigint,'
	+ ' 	remain_crop	bigint,'
	+ ' 	remain_seed	bigint,'
	+ ' 	expense		bigint,'
	+ ' 	manor_status	int,'
	+ '	manor_output	bigint'
	+ ' )'
	+ ' create index ix_' + @table_to + '_1 on [dbo].[' + @table_to + '] (log_date)'
	+ ' end'
exec (@sql)

set @sql = 'delete from [dbo].[' + @table_to + '] where log_date = ' + cast(@logdate as varchar)
exec (@sql)

set @sql = 'insert into [dbo].[' + @table_to + ']'
	+ ' select ' + cast(@logdate as varchar) + ', T.actor, '
	+ ' 	isnull((select sum((etc_num3 - etc_num4) * (etc_num2 - isnull(etc_str3, 0))) from [lin2log].[dbo].[' + @table_from + '] (nolock) where log_id = 265 and actor = T.actor), 0) as seed_profit,'
	+ ' 	sum(etc_num4) as remain_crop, sum(etc_num3) as remain_seed,'
	+ ' 	isnull((select sum((etc_num3 - etc_num4) * isnull(etc_str3, etc_num2) + (etc_num6 - etc_num7) * etc_num8) from [lin2log].[dbo].[' + @table_from + '] (nolock) where log_id = 265 and actor = T.actor), 0) as expense,'
	+ ' 	isnull((select etc_num3 from [lin2log].[dbo].[' + @table_from + '] where log_id = 268 and actor = T.actor), 0),'
	+ ' 	isnull((select sum(etc_num3 * isnull(etc_str3, etc_num2) + etc_num6 * etc_num8) from [lin2log].[dbo].[' + @table_from + '] (nolock) where log_id = 265 and actor = T.actor), 0) as manor_output'
	+ ' from [lin2log].[dbo].[' + @table_from + '] T(nolock)'
	+ ' where log_id = 266'
	+ ' group by actor'
exec (@sql)
GO

/********************************************
#Name:	lin_RPLoginCountByRaceLevel
#Desc:	do make login count report table by race and level

#Argument:
	Input:	@table_from	varchar(60)	log table to be a source
		@table_to	varcahr(60)	report table to be a destination
		@logdate	int	the date of report to be created
	Output:
#Return:
#Result Set:
#Remark:	This procedure creates the report by race, level and total amount of sign-in account
#Example:	Exec lin_RPLoginCountByRaceLevel 'L2005_03_23_log_data0_8', 'RP_LoginCountByRaceLevel_8', 20050323
#See:
#History:
	create	btwinuni	2005-03-23
********************************************/
ALTER PROCEDURE [DBO].[lin_RPLoginCountByRaceLevel]
	@table_from	varchar(60),
	@table_to	varchar(60),
	@logdate	int

AS
SET NOCOUNT ON

declare @sql varchar(4000)

-- check table whether @table_to is exists or not
set @sql = 'select * from lin2report.dbo.sysobjects (nolock) where name = ''' + @table_to + ''''
exec (@sql)

if (@@ROWCOUNT = 0)
begin
	set @sql = 'CREATE TABLE dbo.' + @table_to + ' (' 
		+ ' log_date	int, '
		+ 'race	smallint, '
		+ 'level	int, '
		+ 'user_count 	int'
		+ ' ) '
	exec (@sql)

	set @sql = 'CREATE INDEX IX_' + @table_to + '_1 on dbo.' + @table_to + ' (log_date, level) '
	exec (@sql)
end
else begin
	set @sql = 'delete from dbo.' + @table_to + ' where log_date = ' + CAST(@logdate as varchar)
	exec (@sql)
end

-- check tmp table
declare @tmp_table varchar(512)
set @tmp_table = 'dbo.tmp' + @table_to

set @sql = 'select * from lin2report.dbo.sysobjects (nolock) where name = ''tmp' + @table_to + ''''
exec (@sql)

if (@@ROWCOUNT > 0)
begin
	set @sql = ' drop table dbo.tmp' + @table_to
	exec (@sql)
end


-- make tmptable
set @table_from = replace ( @table_from, 'data0', 'data2' )
set @sql = ' select etc_num1,  etc_num4, actor , actor_account  into ' + @tmp_table
	+ ' from lin2log.dbo.' + @table_from  + ' ( nolock) where log_id = 803  '
exec (@sql)

set @table_from = replace ( @table_from, 'data2', 'data' )
set @sql = ' insert into ' + @tmp_table + ' ( etc_num1, etc_num4,  actor , actor_account ) ( select etc_num1, etc_num4, actor , actor_account  '
	+ ' from lin2log.dbo.' + @table_from  + ' ( nolock) where log_id = 803  ) '
exec (@sql)


-- insert into report table
set @sql = 'insert into ' + RTRIM(@table_to) + ' ( log_date,  race, level, user_count ) ( ' 
	+ ' select  ' + CAST(@logdate as varchar)  + ', etc_num1, etc_num4, count(actor) from '
	+ @tmp_table + '  ( nolock )  group by etc_num1, etc_num4 )  option (MAXDOP 1 ) '
exec (@sql )


-- drop tmptable
set @sql = ' drop table ' + @tmp_table
exec (@sql)
GO

/******************************************************************************
#Name:	lin_RPJoinSSQMainEvent
#Desc:	This procedure creates the report by race, sex, class, level, room, ssq_part informations of SSQ_Main_Event_Members

#Argument:	
	Input:	@table_from	varchar(60)	snap_shot table to be a source
			@table_to	varchar(60)	report table to be a destination
			@logdate	int			the date of report to be created
	Output:
#Return:
#Result Set:

#Remark:
#Example:	Exec lin_RPJoinSSQMainEvent 'L2005_01_31_log_data0_8', 'RP_JOINSSQMAINEVENT_8', 20050131
#See:

#History:
	create	zzangse		2005-01-31
	modify	zzangse		2005-03-16		add ssq_part info
******************************************************************************/
ALTER Procedure [dbo].[lin_RPJoinSSQMainEvent]
	@table_from	varchar(60),
	@table_to	varchar(60),
	@logdate	int
AS
SET NOCOUNT ON


declare @sql varchar(4000)

-- check table whether @table_to is exists or not
set @sql = 'select * from lin2report.dbo.sysobjects (nolock) where name = ''' + @table_to + ''''
exec (@sql)

if (@@ROWCOUNT = 0)
begin
	set @sql = 'CREATE TABLE dbo.' + @table_to + ' (' 
		+ ' log_date	int, '
		+ ' room_number smallint, '
		+ 'log_type	smallint, '
		+ 'log_val	int, '
		+ 'log_count 	int'
		+ ' ) '
	exec (@sql)

	set @sql = 'CREATE INDEX IX_' + @table_to + '_1 on dbo.' + @table_to + ' (log_date asc, room_number asc) '
	exec (@sql)
end
else begin
	set @sql = 'delete from dbo.' + @table_to + ' where log_date = ' + CAST(@logdate as varchar)
	exec (@sql)
end

-- check tmp table
declare @tmp_table varchar(512)
set @tmp_table = 'dbo.tmp' + @table_to

set @sql = 'select * from lin2report.dbo.sysobjects (nolock) where name = ''tmp' + @table_to + ''''
exec (@sql)

if (@@ROWCOUNT > 0)
begin
	set @sql = ' drop table dbo.tmp' + @table_to
	exec (@sql)
end


-- make tmptable
set @sql = ' select log_id, etc_num1,  etc_num2, etc_num3, etc_num4, etc_num5, etc_num7, actor , actor_account  into ' + @tmp_table
	+ ' from lin2log.dbo.' + @table_from  + ' (nolock) where log_id = 311  '
exec (@sql)


-- insert into report table

-- race - 
set @sql = 'insert into ' + RTRIM(@table_to) + ' ( log_date, room_number,  log_type, log_val, log_count ) ( ' 
	+ ' select  ' + CAST(@logdate as varchar)  + ', etc_num7, 1, etc_num1, count(distinct actor) from '
	+ @tmp_table + '  ( nolock )  group by etc_num7, etc_num1 )  option (MAXDOP 1 ) '
exec (@sql )

-- sex -
set @sql = 'insert into ' + RTRIM(@table_to) + ' ( log_date,  room_number, log_type, log_val, log_count ) ( ' 
	+ ' select  ' + CAST(@logdate as varchar)   + ', etc_num7,  2, etc_num2, count(distinct actor) from '
	+ @tmp_table + '  ( nolock )  group by etc_num7, etc_num2 )  option (MAXDOP 1 ) '
exec (@sql )

-- class - 
set @sql = 'insert into ' + RTRIM(@table_to) + ' ( log_date,  room_number, log_type, log_val, log_count ) ( ' 
	+ ' select  ' + CAST(@logdate as varchar)   + ', etc_num7, 3, etc_num3, count(distinct actor) from '
	+ @tmp_table + '   ( nolock )  group by etc_num7, etc_num3 )  option (MAXDOP 1 ) '
exec (@sql )

-- level - 
set @sql = 'insert into ' + RTRIM(@table_to) + ' ( log_date, room_number,  log_type, log_val, log_count ) ( ' 
	+ ' select  ' + CAST(@logdate as varchar)   + ', etc_num7, 4, etc_num4, count(distinct actor) from '
	+ @tmp_table + '   ( nolock )  group by etc_num7, etc_num4 )  option (MAXDOP 1 ) '
exec (@sql )

-- ssq_part -
set @sql = 'insert into ' + RTRIM(@table_to) + ' ( log_date, room_number,  log_type, log_val, log_count ) ( ' 
	+ ' select  ' + CAST(@logdate as varchar)   + ', etc_num7, 5, etc_num5, count(distinct actor) from '
	+ @tmp_table + '   ( nolock )  group by etc_num7, etc_num5 )  option (MAXDOP 1 ) '
exec (@sql )




-- drop tmptable
set @sql = ' drop table ' + @tmp_table
exec (@sql)




SET NOCOUNT OFF
GO

/******************************************************************************
#Name:	lin_RPJoinSSQ
#Desc:	Make report based on log_id 310 ( joinSSQ )

#Argument:	
	Input:	@table_from	varchar(60)	snap_shot table to be a source
			@table_to	varchar(60)	report table to be a destination
			@logdate	int			the date of report to be created
	Output:
#Return:
#Result Set:

#Remark:
#Example:	Exec lin_RPJoinSSQ 'L2005_03_04_log_data0_8', 'RP_JOINSSQ_8', 20050304
#See:

#History:	
	create	zzangse		2005-03-04
******************************************************************************/
ALTER Procedure [dbo].[lin_RPJoinSSQ]
	@table_from	varchar(60),
	@table_to	varchar(60),
	@logdate	int
AS
SET NOCOUNT ON



declare @sql varchar(4000)

-- check table whether @table_to is exists or not
set @sql = 'select * from lin2report.dbo.sysobjects (nolock) where name = ''' + @table_to + ''''
exec (@sql)

if (@@ROWCOUNT = 0)
begin
	set @sql = 'CREATE TABLE dbo.' + @table_to + ' (' 
		+ ' log_date	int, '
		+ ' log_type	tinyint, '
		+ ' ssq_part	tinyint, '
		+ '	seal_type	tinyint, '
		+ '	log_type_value	smallint, '
		+ '	member_count 	int'
		+ ' ) '
	exec (@sql)

	set @sql = 'CREATE INDEX IX_' + @table_to + '_1 on dbo.' + @table_to + ' (log_date asc, ssq_part asc, seal_type asc, log_type asc, log_type_value asc) with fillfactor = 90'
	exec (@sql)
	
end
else begin
	set @sql = 'delete from dbo.' + @table_to + ' where log_date = ' + CAST(@logdate as varchar)
	exec (@sql)
end

-- check tmp table
declare @tmp_table varchar(512)
set @tmp_table = 'tmp' + @table_to

set @sql = 'select * from lin2report.dbo.sysobjects (nolock) where name = ''' + @tmp_table + '''' 
exec (@sql)

if (@@ROWCOUNT > 0)
begin
	set @sql = ' drop table dbo.' + @tmp_table
	exec (@sql)
end


-- make tmptable
set @sql = ' select log_id, etc_num1,  etc_num2, etc_num3, (cast(etc_num4 as int)/10)*10 as etc_num4, etc_num5, etc_num6 , actor , actor_account  into ' + @tmp_table
	+ ' from lin2log.dbo.' + @table_from  + ' (nolock) where log_id = 310  '
exec (@sql)


-- insert into report table
-- level -
set @sql = 'insert into ' + RTRIM(@table_to) + ' ( log_date, log_type, ssq_part, seal_type, log_type_value, member_count ) ( ' 
	+ ' select  ' + CAST(@logdate as varchar)  + ', 0, etc_num5, etc_num6, etc_num4, count(distinct actor) from '
	+ @tmp_table + '  ( nolock )  group by etc_num5, etc_num6, etc_num4 )  option (MAXDOP 1 ) '
exec (@sql )

-- drop tmptable
set @sql = ' drop table ' + @tmp_table
exec (@sql)


SET NOCOUNT OFF
GO

/******************************************************************************
#Name:	lin_RPItemIncDec
#Desc:	Gather the factor that items(6360, 6361, 6362, 5575, 1458, 1459, 1460, 1461, 1462) are increased or decreased

#Argument:
	Input:	@table_from	varchar(60)	log view: Lyyyy_mm_dd_Log_Data0_world
		@table_to	varchar(60)	report table: RP_ItemIncDec_world
		@logdate	int		report date
	Output:	
#Return:
#Result Set:

#Remark:
	Increasing Factor: 906, 933
	Decreasing Factor: 907
#Example:	exec lin_RPItemIncDec 'L2005_05_18_log_data0_8', 'RP_ItemIncDec_8', 20050518
#See:

#History:
	Create	btwinuni	2005-05-18
******************************************************************************/
ALTER Procedure [dbo].[lin_RPItemIncDec]
	@table_from	varchar(60),
	@table_to	varchar(60),
	@logdate	int
AS
SET NOCOUNT ON

declare	@sql	varchar(4000)

-- report table is initiated
set @sql = 'if not exists (select * from dbo.sysobjects where id = object_id(N''[dbo].[' + @table_to + ']'') and objectproperty(id, N''IsUserTable'') = 1)'
	+ ' begin'
	+ ' create table [dbo].[' + @table_to + '] ('
	+ ' 	log_date		int,'
	+ '	item_type	int,'
	+ ' 	log_type		int,'
	+ '	log_id		int,'
	+ ' 	amount		bigint'
	+ ' )'
	+ ' create index ix_' + @table_to + '_1 on [dbo].[' + @table_to + '] (log_date, item_type)'
	+ ' end'
exec (@sql)

set @sql = 'delete from [dbo].[' + @table_to + '] where log_date = ' + cast(@logdate as varchar)
exec (@sql)

-- Increasing Factor: 906
set @sql = 'insert into [dbo].[' + @table_to + ']'
	+ ' select ' + cast(@logdate as varchar) + ', etc_num8, 1, 906, isnull(sum(isnull(cast(etc_num9 as bigint),0)),0)'
	+ ' from [lin2log].[dbo].[' + @table_from + '](nolock)'
	+ ' where log_id = 906'
	+ ' group by etc_num8'
	+ ' having etc_num8 in (1461, 5575, 6360, 6361, 6362)'
exec (@sql)

-- Increasing Factor: 933
set @sql = 'insert into [dbo].[' + @table_to + ']'
	+ ' select ' + cast(@logdate as varchar) + ', etc_num5, 1, 933, isnull(sum(isnull(cast(etc_num5 as bigint),0)),0)'
	+ ' from [lin2log].[dbo].[' + @table_from + '](nolock)'
	+ ' where log_id = 933'
	+ ' group by etc_num5'
	+ ' having etc_num5 in (1458, 1459, 1460, 1461, 1462)'
exec (@sql)

-- Decreasing Factor: 907
set @sql = 'insert into [dbo].[' + @table_to + ']'
	+ ' select ' + cast(@logdate as varchar) + ', etc_num8, -1, 907, isnull(sum(isnull(cast(etc_num9 as bigint),0)),0)'
	+ ' from [lin2log].[dbo].[' + @table_from + '](nolock)'
	+ ' where log_id = 907'
	+ ' group by etc_num8'
	+ ' having etc_num8 in (1458, 1459, 1460, 1461, 1462, 5575, 6360, 6361, 6362)'
exec (@sql)

SET NOCOUNT OFF
GO

/******************************************************************************
#Name:	lin_RPFishingStatus
#Desc:	

#Argument:
	Input:	@table_from	varchar(60)	log view: Lyyyy_mm_dd_Log_Data0_world
		@table_to	varchar(60)	report table: RP_FishingStatus_world
		@logdate	int		report date
	Output:	
#Return:
#Result Set:

#Remark:
#Example:	exec lin_RPFishingStatus 'L2005_09_28_log_data0_8', 'RP_FishingStatus_8', 20050928
#See:

#History:
	Create	btwinuni	2005-09-29
	Modify	btwinuni	2005-10-04	if isSuccess > 0 then is success
******************************************************************************/
ALTER Procedure [dbo].[lin_RPFishingStatus]
	@table_from	varchar(60),
	@table_to	varchar(60),
	@logdate	int
AS
SET NOCOUNT ON

declare	@sql	varchar(4000)

-- report table is initiated
set @sql = 'if not exists (select * from dbo.sysobjects where id = object_id(N''[dbo].[' + @table_to + ']'') and objectproperty(id, N''IsUserTable'') = 1)'
	+ ' begin'
	+ ' create table [dbo].[' + @table_to + '] ('
	+ ' 	log_date	int,'
	+ '	isSuccess	int,'
	+ '	char_id		int,'
	+ ' 	char_name	nvarchar(50),'
	+ '	account_id	int,'
	+ ' 	account_name	nvarchar(50),'
	+ ' 	race		int,'
	+ ' 	sex		int,'
	+ ' 	cls		int,'
	+ '	lev		int,'
	+ '	dp		bigint,'
	+ '	count		int'
	+ ' )'
	+ ' create index ix_' + @table_to + '_1 on [dbo].[' + @table_to + '] (log_date)'
	+ ' end'
exec (@sql)

set @sql = 'delete from [dbo].[' + @table_to + '] where log_date = ' + cast(@logdate as varchar)
exec (@sql)

set @sql = 'insert into [dbo].[' + @table_to + ']'
	+ ' select ' + cast(@logdate as varchar) + ', count(*), T.actor, T.STR_actor, T.actor_account, T.STR_actor_account, '
	+ '	max(etc_num1), max(etc_num2), max(etc_num3), max(etc_num4), sum(etc_num9), count(*)'
	+ ' from [lin2log].[dbo].[' + @table_from + '] T(nolock)'
	+ ' where log_id = 408'
	+ ' group by actor, STR_actor, actor_account, STR_actor_account'
exec (@sql)

set @sql = 'insert into [dbo].[' + @table_to + ']'
	+ ' select ' + cast(@logdate as varchar) + ', 0, T.actor, T.STR_actor, T.actor_account, T.STR_actor_account, '
	+ '	max(etc_num1), max(etc_num2), max(etc_num3), max(etc_num4), 0, count(*)'
	+ ' from [lin2log].[dbo].[' + @table_from + '] T(nolock)'
	+ ' where log_id = 409'
	+ ' group by actor, STR_actor, actor_account, STR_actor_account'
exec (@sql)
GO

/******************************************************************************
#Name:	lin_RPEnchantItemIncDec
#Desc:	Gather the factor of changing the number of enchanted items

#Argument:
	Input:	@table_from	varchar(60)	log view: Lyyyy_mm_dd_Log_Data0_world
		@table_to	varchar(60)	report table: RPEnchantItemIncDec_world
		@logdate	int		report date
	Output:	
#Return:
#Result Set:

#Remark:
	Increasing Factor: 925
	Decreasing Factor: 925,926
#Example:	exec lin_RPEnchantItemIncDec 'L2005_05_11_log_data0_8', 'RP_EnchantItemIncDec_8', 20050511
#See:

#History:
	Create	zzangse 	2005-05-11
******************************************************************************/
ALTER   Procedure [dbo].[lin_RPEnchantItemIncDec]
	@table_from	varchar(60),
	@table_to	varchar(60),
	@logdate	int
AS
SET NOCOUNT ON

declare	@sql	varchar(4000)


-- report table is initiated
set @sql = 'if not exists (select * from dbo.sysobjects where id = object_id(N''[dbo].[' + @table_to + ']'') and objectproperty(id, N''IsUserTable'') = 1)'
	+ ' begin'
	+ ' create table [dbo].[' + @table_to + '] ('
	+ ' 	log_date		int,'
	+ '	log_type		int,'
	+ ' 	log_id		int,'
	+ '	item_type	int,'
	+ '	enchant_level	int,'
	+ ' 	amount		bigint'
	+ ' )'
	+ ' create index ix_' + @table_to + '_1 on [dbo].[' + @table_to + '] (log_date desc, log_type, enchant_level)'
	+ ' end'
exec (@sql)

set @sql = 'delete from [dbo].[' + @table_to + '] where log_date = ' + cast(@logdate as varchar)
exec (@sql)

-- Increasing Factor: 925
set @sql = 'insert into [dbo].[' + @table_to + ']'
	+ ' select ' + cast(@logdate as varchar) + ', 0, 925, etc_num9, etc_num6, isnull(count(*),0)'
	+ ' from [lin2log].[dbo].[' + @table_from  + '](nolock)'
	+ ' where log_id = 925 '
	+ ' group by etc_num9, etc_num6 '
exec (@sql)

---------------------------------------------------------------------------
-- Decreasing Factor: 925
set @sql = 'insert into [dbo].[' + @table_to + ']'
	+ ' select ' + cast(@logdate as varchar) + ', 1, 925, etc_num9, etc_num5, isnull(count(*),0)*-1'
	+ ' from [lin2log].[dbo].[' + @table_from  + '](nolock) '
	+ ' where log_id = 925 '
	+ ' group by etc_num9, etc_num5 '
exec (@sql)

-- Decreasing Factor: 926
set @sql = 'insert into [dbo].[' + @table_to + ']'
	+ ' select ' + cast(@logdate as varchar) + ', 1, 925, etc_num9, etc_num7, isnull(count(*),0)*-1'
	+ ' from [lin2log].[dbo].[' + @table_from  + '](nolock) '
	+ ' where log_id = 926 '
	+ ' group by etc_num9, etc_num7 '
exec (@sql)

SET NOCOUNT OFF
GO

/******************************************************************************
#Name:	lin_RPEnchantItemByEnchantType
#Desc:	make daily report for monitoring tool check point

#Argument:
	Input:	@table_from	varchar(60)	log view: Lyyyy_mm_dd_Log_Data0_world
		@table_to	varchar(60)	report table: RP_EnchantItemByEnchantType
		@logdate	int		report date
	Output:	
#Return:
#Result Set:

#Remark:
#Example:	exec lin_RPEnchantItemByEnchantType 'L2005_02_25_log_data0_8', 'RP_EnchantItemByEnchantType_8', 20050420
#See:

#History:
	Create	kernel0	2005-05-20
******************************************************************************/
ALTER Procedure [dbo].[lin_RPEnchantItemByEnchantType]
	@table_from	varchar(60),
	@table_to	varchar(60),
	@logdate	int
AS
SET NOCOUNT ON

declare	@sql	varchar(4000)

-- report table is initiated
set @sql = 'if not exists (select * from dbo.sysobjects where id = object_id(N''[dbo].[' + @table_to + ']'') and objectproperty(id, N''IsUserTable'') = 1)'
	+ ' begin'
	+ ' create table [dbo].[' + @table_to + '] ('
	+ 'log_date		int,'
	+ 'log_time		varchar(4),'
	+ 'log_id		int, '
	+ 'char_name	nvarchar(48), '
	+ 'account_name	nvarchar(32), '
	+ 'item_type	int, '
	+ 'enchant_level	int, '
	+ 'enchant_type	int '
	+ ' )'
	+ ' create index ix_' + @table_to + '_1 on [dbo].[' + @table_to + '] (log_date asc, log_time asc)' 
	+ ' end'
exec (@sql)

set @sql = 'delete from [dbo].[' + @table_to + '] where log_date = ' + cast(@logdate as varchar)
exec (@sql)

set @sql = 'insert into [dbo].[' + @table_to + '] (log_date, log_time, log_id, char_name, account_name, item_type, enchant_level, enchant_type) '
	+ 'select  ' + cast(@logdate as varchar) + ', substring(convert(varchar(5), act_time, 108), 0, 3) +  substring(convert(varchar(5), act_time, 108), 4, 6), '
	+ ' log_id, str_actor, str_actor_account, etc_num8 as item_type, etc_num6 as enchant_level, etc_num9 as enchant_type '
	+ 'from [lin2log].[dbo].[' +@table_from + '] (nolock) where log_id in (925, 926) and ( (etc_num9 = 0 and etc_num6 > 11 )  or (etc_num9 = 1 and etc_num6 > 6))'
exec(@sql)

SET NOCOUNT OFF
GO

/********************************************
#Name: lin_RPCreateSubJobCount
#Desc: do make ALTER  subclass report table by subjob

#argument	@table_from	varchar(60)	log table to be a source
#argument	@table_to	varchar(60)	report table to be a destination
#argument	@logdate	int		the date of report to be created

#Argument:	
	Input:	@table_from	varchar(60)	snap_shot table to be a source
		@table_to	varchar(60)	report table to be a destination
		@logdate	int		the date of report to be created
	Output:
#Return:
#Result Set:
#Remark:
#History:
#Example	Exec lin_RPCreateSubJobCount 'L2005_06_15_log_data0_1', 'RP_CreateSubJobCount_1', 20050615
#history	create		neoliebe 	2005-08-09
#see
********************************************/
ALTER  PROCEDURE [DBO].[lin_RPCreateSubJobCount]

	@table_from	varchar(60),
	@table_to	varchar(60),
	@logdate	int

AS
SET NOCOUNT ON

declare @sql varchar(4000)

-- check table whether @table_to is exists or nots
set @sql = 'select * from lin2report.dbo.sysobjects (nolock) where name = ''' + @table_to + ''''
exec (@sql)

if (@@ROWCOUNT = 0)
begin
	set @sql = 'CREATE TABLE dbo.' + @table_to + ' (' 
		+ ' log_date	int, '
		+ ' class 	smallint, '
		+ ' subclass	smallint, '
		+ ' create_cnt 	int'
		+ ' ) '

	exec (@sql)

	set @sql = 'CREATE INDEX IX_' + @table_to + '_1 on dbo.' + @table_to + ' (log_date, class) '
	exec (@sql)
end
else begin
	set @sql = 'delete from dbo.' + @table_to + ' where log_date = ' + CAST(@logdate as varchar)
	exec (@sql)
end


-- insert into report table

--  -L -L--
set @sql = 'insert into ' + RTRIM(@table_to) + ' ( log_date, class, subclass, create_cnt) ( ' 
	+ 'select ' + cast(@logdate as varchar) +' , etc_num3 class, etc_num5 subclass, count(log_id) create_cnt '
	+ 'from lin2log.dbo.' + @table_from + '( nolock ) ' 
	+ 'where log_id = 847 '
	+ 'group by etc_num3, etc_num5 )'
	+ 'option (MAXDOP 1 )'
exec (@sql )
GO

/******************************************************************************
#Name:	lin_RPCreateSubJobBySubJob
#Desc:	make daily report about maximum popular class among characters did create_subjob, sum of create_subjob by subjob

#Argument:
	Input:	@table_from	varchar(60)	log view: Lyyyy_mm_dd_Log_Data0_world
		@table_to	varchar(60)	report table: RPCreateSubJobBySubJob
		@logdate	int		report date
	Output:	
#Return:
#Result Set:

#Remark:
#Example:	exec lin_RPCreateSubJobBySubJob 'L2005_04_20_log_data0_8', 'RPCreateSubJobBySubJob_8', 20050420
#See:

#History:
	Create	kernel0	2005-05-16
******************************************************************************/
ALTER Procedure [dbo].[lin_RPCreateSubJobBySubJob]
	@table_from	varchar(60),
	@table_to	varchar(60),
	@logdate	int
AS
SET NOCOUNT ON

declare	@sql	varchar(4000)

-- report table is initiated
set @sql = 'if not exists (select * from dbo.sysobjects where id = object_id(N''[dbo].[' + @table_to + ']'') and objectproperty(id, N''IsUserTable'') = 1)'
	+ ' begin'
	+ ' create table [dbo].[' + @table_to + '] ('
	+ ' 	log_date		int,'
	+ '	count_class		int,'
	+ ' 	class		int,'
	+ ' 	subjob_id		int'
	+ ' )'
	+ ' create index ix_' + @table_to + '_1 on [dbo].[' + @table_to + '] (log_date asc, subjob_id asc, count_class desc)'
	+ ' end'
exec (@sql)

set @sql = 'delete from [dbo].[' + @table_to + '] where log_date = ' + cast(@logdate as varchar)
exec (@sql)

set @sql = 'insert into [dbo].[' + @table_to + '] (log_date, count_class, class, subjob_id) '
	+ 'select ' + cast(@logdate as varchar) + ', count(*) as count_class, etc_num5 as class, etc_num10  as subjob_id  '
	+ 'from [lin2log].[dbo].[' + @table_from + '] (nolock) '
	+ 'where '
	+ ' log_id = 847 and etc_num10 < 4 '
	+ 'group by etc_num10, etc_num5'

exec(@sql)

SET NOCOUNT OFF
GO

/********************************************
#Name: lin_RPClassBySubJob
#Desc: do make class change report table by subjob

#argument	@table_from	varchar(60)	log table to be a source
#argument	@table_to	varchar(60)	report table to be a destination
#argument	@logdate	int		the date of report to be created

#Argument:	
	Input:	@table_from	varchar(60)	snap_shot table to be a source
			@table_to	varchar(60)	report table to be a destination
			@logdate	int			the date of report to be created
	Output:
#Return:
#Result Set:
#Remark:
#History:
#Example	Exec lin_RPClassBySubJob 'L2004_11_30_log_data_8', 'RP_CLASS_BY_SUBJOB_8', 20041130
#history	create		kernel0	2005-02-24
#see
********************************************/
ALTER PROCEDURE [DBO].[lin_RPClassBySubJob]
	@table_from	varchar(60),
	@table_to	varchar(60),
	@logdate	int

AS
SET NOCOUNT ON

declare @sql varchar(4000)

-- check table whether @table_to is exists or nots
set @sql = 'select * from lin2report.dbo.sysobjects (nolock) where name = ''' + @table_to + ''''
exec (@sql)

if (@@ROWCOUNT = 0)
begin
	set @sql = 'CREATE TABLE dbo.' + @table_to + ' (' 
		+ ' log_date	int, '
		+ ' old_class	smallint, '
		+ ' new_class	smallint, '
		+ ' subjob_id	int, '
		+ ' change_count 	int'
		+ ' ) '
	exec (@sql)

	set @sql = 'CREATE INDEX IX_' + @table_to + '_1 on dbo.' + @table_to + ' (log_date) '
	exec (@sql)
end
else begin
	set @sql = 'delete from dbo.' + @table_to + ' where log_date = ' + CAST(@logdate as varchar)
	exec (@sql)
end

-- check tmp table
declare @tmp_table varchar(512)
set @tmp_table = 'dbo.tmp' + @table_to

set @sql = 'select * from lin2report.dbo.sysobjects (nolock) where name = ''tmp' + @table_to + ''''
exec (@sql)

if (@@ROWCOUNT > 0)
begin
	set @sql = ' drop table dbo.tmp' + @table_to
	exec (@sql)
end

-- make tmptable
set @table_from = replace ( @table_from, 'data0', 'data2' )
set @sql = ' select log_id, etc_num3, etc_num5, etc_num7, etc_num8  into ' + @tmp_table
	+ ' from lin2log.dbo.' + @table_from  + ' ( nolock) where log_id = 816 and ( etc_num7 is null or etc_num7 = 0 )  '
exec (@sql)

set @table_from = replace ( @table_from, 'data2', 'data' )
set @sql = ' insert into ' + @tmp_table + ' ( log_id, etc_num3, etc_num5, etc_num7, etc_num8  ) ( select log_id, etc_num3, etc_num5, etc_num7, etc_num8  '
	+ ' from lin2log.dbo.' + @table_from  + ' ( nolock) where log_id = 816 and ( etc_num7 is null or etc_num7 = 0 )  ) '
exec (@sql)


-- insert into report table

--  L+T L--
set @sql = 'insert into ' + RTRIM(@table_to) + ' ( log_date,  old_class, new_class, subjob_id, change_count ) ( ' 
	+ ' select  ' + CAST(@logdate as varchar)  + ', etc_num5, etc_num3, etc_num8, count(log_id)  from '
	+ @tmp_table + ' ( nolock )  group by etc_num5, etc_num3, etc_num8 ) option (MAXDOP 1 ) '
exec (@sql )

-- drop 
set @sql = ' drop table ' + @tmp_table
exec ( @sql )
GO

/******************************************************************************
#Name:	lin_RPCastleTaxInfo
#Desc:	Gather the tax information of castles

#Argument:
	Input:	@table_from	varchar(60)	log view: Lyyyy_mm_dd_Log_Data0_world
		@table_to	varchar(60)	report table: RP_CastleTaxInfo_world
		@logdate	int		report date
	Output:	
#Return:
#Result Set:

#Remark:
#Example:	exec lin_RPCastleTaxInfo 'L2005_05_18_log_data0_8', 'RP_CastleTaxInfo_8', 20050518
#See:

#History:
	Create	btwinuni	2005-05-23
	Modify	btwinuni	2005-10-19	edit @snap_pledge, @snap_data
******************************************************************************/
ALTER Procedure [dbo].[lin_RPCastleTaxInfo]
	@table_from	varchar(60),
	@table_to	varchar(60),
	@logdate	int
AS
SET NOCOUNT ON

declare	@sql	varchar(4000)
declare	@snap_pledge	varchar(60)
declare	@snap_data	varchar(60)

set @snap_pledge = 'S' + substring(@table_from, 2, 10) + '_snap_pledge_' +substring(@table_from, 23, 3)
set @snap_data = 'S' + substring(@table_from, 2, 10) + '_snap_data_' +substring(@table_from, 23, 3)

-- report table is initiated
set @sql = 'if not exists (select * from dbo.sysobjects where id = object_id(N''[dbo].[' + @table_to + ']'') and objectproperty(id, N''IsUserTable'') = 1)'
	+ ' begin'
	+ ' create table [dbo].[' + @table_to + '] ('
	+ ' 	log_date		int,'
	+ '	castle_id	tinyint,'
	+ ' 	pledge_id	int,'
	+ '	pledge_name	varchar(60),'
	+ ' 	ruler_name	varchar(60),'
	+ '	tribute_tax	bigint,'
	+ '	real_tax		bigint,'
	+ '	tax_rate		int'
	+ ' )'
	+ ' create index ix_' + @table_to + '_1 on [dbo].[' + @table_to + '] (log_date)'
	+ ' end'
exec (@sql)

set @sql = 'delete from [dbo].[' + @table_to + '] where log_date = ' + cast(@logdate as varchar)
exec (@sql)

-- etc_num1: - ID
-- etc_num2: L - ID
-- etc_num3: +--
-- etc_num4: ----
-- etc_num5: - -TL = ID(+)
-- etc_num6: --L-(+)

set @sql = 'insert into [dbo].[' + @table_to + ']'
	+ ' select ' + cast(@logdate as varchar) + ', etc_num1, etc_num5,'
	+ ' 	(select name from [lin2log].[dbo].[' + @snap_pledge + '] (nolock) where pledge_id = etc_num6) pledge_name,'
	+ ' 	(select char_name from [lin2log].[dbo].[' + @snap_data + '] (nolock)'
	+ ' 		where char_id = (select ruler_id from [lin2log].[dbo].[' + @snap_pledge + '] (nolock) where pledge_id = etc_num6)) ruler_name,'
	+ ' 	isnull(sum(isnull(cast(etc_num3 as bigint),0)),0) tribute,'
	+ ' 	isnull(sum(isnull(cast(etc_num4 as bigint),0)),0) real,'
	+ ' 	etc_num6'
	+ ' from [lin2log].[dbo].[' + @table_from + '] (nolock)'
	+ ' where log_id = 950'
	+ ' 	and etc_num1 <= 20'
	+ ' group by etc_num1, etc_num5, etc_num6'
exec (@sql)

SET NOCOUNT OFF
GO

/******************************************************************************
#Name:	lin_RPAdenaIncDecByChar
#Desc:	Gather the factor that adena of top 10 character is increased or decreased

#Argument:
	Input:	@table_from	varchar(60)	log view: Lyyyy_mm_dd_Log_Data0_world
		@table_to	varchar(60)	report table: RP_AdenaIncDecByChar_world
		@logdate	int		report date
	Output:	
#Return:
#Result Set:

#Remark:
	Increasing Factor: 902, 906, 964, 966, 301, 638, 910, 943
	Decreasing Factor: 901, 908, 928, 939, 945, 947, 963, 965, 639, 310, 909
	This procedure must be executed after lin_RPRankDailyAdena is executed
#Example:	exec lin_RPAdenaIncDecByChar 'L2005_04_20_log_data0_8', 'RP_AdenaIncDecByChar_8', 20050420
#See:

#History:
	Create	btwinuni	2005-05-19
	Modify	btwinuni	2005-07-01	add: 909, 910, 943 and top 20
	Modify	btwinuni	2005-07-27	modify: 909's type = 1
	Modify	btwinuni	2005-08-04	modify: delete condition (rank <= 20)
******************************************************************************/
ALTER Procedure [dbo].[lin_RPAdenaIncDecByChar]
	@table_from	varchar(60),
	@table_to	varchar(60),
	@logdate	int
AS
SET NOCOUNT ON

declare	@sql	varchar(4000)
declare	@lotto_price	int
declare	@donation	int
declare	@world	varchar(2)

set @lotto_price = 2000
set @donation = 50000
set @world = substring(@table_from, 23, 2)

-- report table is initiated
set @sql = 'if not exists (select * from dbo.sysobjects where id = object_id(N''[dbo].[' + @table_to + ']'') and objectproperty(id, N''IsUserTable'') = 1)'
	+ ' begin'
	+ ' create table [dbo].[' + @table_to + '] ('
	+ ' 	log_date		int,'
	+ '	char_name	varchar(60),'
	+ '	log_type		int,'
	+ ' 	log_id		int,'
	+ ' 	amount		bigint'
	+ ' )'
	+ ' create index ix_' + @table_to + '_1 on [dbo].[' + @table_to + '] (log_date, char_name)'
	+ ' end'
exec (@sql)

set @sql = 'delete from [dbo].[' + @table_to + '] where log_date = ' + cast(@logdate as varchar)
exec (@sql)

-- Increasing Factor: 902
set @sql = 'insert into [dbo].[' + @table_to + ']'
	+ ' select ' + cast(@logdate as varchar) + ', STR_actor, 0, 902, isnull(sum(isnull(cast(etc_num9 as bigint),0)),0)'
	+ ' from [lin2log].[dbo].[' + @table_from  + '](nolock)'
	+ ' where log_id = 902 and etc_num8 = 57'
	+ ' group by STR_actor'
	+ ' having STR_actor in ('
	+ '	select char_name from RP_RANKDAILYADENA_' + @world + ' (nolock)'
	+ '	where log_date = ' + cast(@logdate as varchar) + ' and log_type = 0)'

exec (@sql)

-- Increasing Factor: 906
set @sql = 'insert into [dbo].[' + @table_to + ']'
	+ ' select ' + cast(@logdate as varchar) + ', STR_actor, 0, 906, isnull(sum(isnull(cast(etc_num9 as bigint),0)),0)'
	+ ' from [lin2log].[dbo].[' + @table_from  + '](nolock)'
	+ ' where log_id = 906 and etc_num8 = 57'
	+ ' group by STR_actor'
	+ ' having STR_actor in ('
	+ '	select char_name from RP_RANKDAILYADENA_' + @world + ' (nolock)'
	+ '	where log_date = ' + cast(@logdate as varchar) + ' and log_type = 0)'
exec (@sql)

-- Increasing Factor: 964
set @sql = 'insert into [dbo].[' + @table_to + ']'
	+ ' select ' + cast(@logdate as varchar) + ', STR_actor, 0, 964, isnull(sum(isnull(cast(etc_num9 as bigint),0)),0)'
	+ ' from [lin2log].[dbo].[' + @table_from  + '](nolock) '
	+ ' where log_id = 964'
	+ ' group by STR_actor'
	+ ' having STR_actor in ('
	+ '	select char_name from RP_RANKDAILYADENA_' + @world + ' (nolock)'
	+ '	where log_date = ' + cast(@logdate as varchar) + ' and log_type = 0)'
exec (@sql)

-- Increasing Factor: 966
set @sql = 'insert into [dbo].[' + @table_to + ']'
	+ ' select ' + cast(@logdate as varchar) + ', STR_actor, 0, 966, isnull(sum(isnull(cast(etc_num10 as bigint),0)),0)'
	+ ' from [lin2log].[dbo].[' + @table_from  + '](nolock) '
	+ ' where log_id = 966'
	+ ' group by STR_actor'
	+ ' having STR_actor in ('
	+ '	select char_name from RP_RANKDAILYADENA_' + @world + ' (nolock)'
	+ '	where log_date = ' + cast(@logdate as varchar) + ' and log_type = 0)'
exec (@sql)

-- Increasing Factor: 301
set @sql = 'insert into [dbo].[' + @table_to + ']'
	+ ' select ' + cast(@logdate as varchar) + ', STR_actor, 0, 301, isnull(sum(isnull(cast(etc_num6 as bigint),0)),0)'
	+ ' from [lin2log].[dbo].[' + @table_from  + '](nolock) '
	+ ' where log_id = 301 and etc_num5 = 57 and etc_num7 <> 0'
	+ ' group by STR_actor'
	+ ' having STR_actor in ('
	+ '	select char_name from RP_RANKDAILYADENA_' + @world + ' (nolock)'
	+ '	where log_date = ' + cast(@logdate as varchar) + ' and log_type = 0)'
exec (@sql)

-- Increasing Factor: 638
set @sql = 'insert into [dbo].[' + @table_to + ']'
	+ ' select ' + cast(@logdate as varchar) + ', STR_actor, 0, 638, isnull(sum(isnull(cast(etc_num9 as bigint),0)),0)'
	+ ' from [lin2log].[dbo].[' + @table_from + '](nolock)'
	+ ' where log_id = 638 and etc_num8 = 57'
	+ ' group by STR_actor'
	+ ' having STR_actor in ('
	+ '	select char_name from RP_RANKDAILYADENA_' + @world + ' (nolock)'
	+ '	where log_date = ' + cast(@logdate as varchar) + ' and log_type = 0)'
exec (@sql)

-- Increasing Factor: 910
set @sql = 'insert into [dbo].[' + @table_to + ']'
	+ ' select ' + cast(@logdate as varchar) + ', STR_actor, 0, 910, isnull(sum(isnull(cast(etc_num9 as bigint),0)),0)'
	+ ' from [lin2log].[dbo].[' + @table_from  + '](nolock)'
	+ ' where log_id = 910 and etc_num8 = 57'
	+ ' group by STR_actor'
	+ ' having STR_actor in ('
	+ '	select char_name from RP_RANKDAILYADENA_' + @world + ' (nolock)'
	+ '	where log_date = ' + cast(@logdate as varchar) + ' and log_type = 0)'

exec (@sql)

-- Increasing Factor: 943
set @sql = 'insert into [dbo].[' + @table_to + ']'
	+ ' select ' + cast(@logdate as varchar) + ', STR_actor, 0, 943, isnull(sum(isnull(cast(etc_num9 as bigint),0)),0)'
	+ ' from [lin2log].[dbo].[' + @table_from  + '](nolock)'
	+ ' where log_id = 943 and etc_num8 = 57'
	+ ' group by STR_actor'
	+ ' having STR_actor in ('
	+ '	select char_name from RP_RANKDAILYADENA_' + @world + ' (nolock)'
	+ '	where log_date = ' + cast(@logdate as varchar) + ' and log_type = 0)'

exec (@sql)

---------------------------------------------------------------------------
-- Decreasing Factor: 901
set @sql = 'insert into [dbo].[' + @table_to + ']'
	+ ' select ' + cast(@logdate as varchar) + ', STR_actor, 1, 901, isnull(sum(isnull(cast(etc_num9 as bigint),0)),0)'
	+ ' from [lin2log].[dbo].[' + @table_from  + '](nolock) '
	+ ' where log_id = 901 and etc_num8 = 57'
	+ ' group by STR_actor'
	+ ' having STR_actor in ('
	+ '	select char_name from RP_RANKDAILYADENA_' + @world + ' (nolock)'
	+ '	where log_date = ' + cast(@logdate as varchar) + ' and log_type = 0)'
exec (@sql)

-- Decreasing Factor: 908
set @sql = 'insert into [dbo].[' + @table_to + ']'
	+ ' select ' + cast(@logdate as varchar) + ', STR_actor, 1, 908, isnull(sum(isnull(cast(etc_num9 as bigint),0)),0)'
	+ ' from [lin2log].[dbo].[' + @table_from  + '](nolock) '
	+ ' where log_id = 908 and etc_num8 = 57'
	+ ' group by STR_actor'
	+ ' having STR_actor in ('
	+ '	select char_name from RP_RANKDAILYADENA_' + @world + ' (nolock)'
	+ '	where log_date = ' + cast(@logdate as varchar) + ' and log_type = 0)'
exec (@sql)

-- Decreasing Factor: 928
set @sql = 'insert into [dbo].[' + @table_to + ']'
	+ ' select ' + cast(@logdate as varchar) + ', STR_actor, 1, 928, isnull(sum(isnull(cast(etc_num9 as bigint),0)),0)*-1'
	+ ' from [lin2log].[dbo].[' + @table_from  + '](nolock) '
	+ ' where log_id = 928 and etc_num8 = 57'
	+ ' group by STR_actor'
	+ ' having STR_actor in ('
	+ '	select char_name from RP_RANKDAILYADENA_' + @world + ' (nolock)'
	+ '	where log_date = ' + cast(@logdate as varchar) + ' and log_type = 0)'
exec (@sql)

-- Decreasing Factor: 939
set @sql = 'insert into [dbo].[' + @table_to + ']'
	+ ' select ' + cast(@logdate as varchar) + ', STR_actor, 1, 939, isnull(sum(isnull(cast(etc_num5 as bigint),0)),0)*-1'
	+ ' from [lin2log].[dbo].[' + @table_from  + '](nolock) '
	+ ' where log_id = 939'
	+ ' group by STR_actor'
	+ ' having STR_actor in ('
	+ '	select char_name from RP_RANKDAILYADENA_' + @world + ' (nolock)'
	+ '	where log_date = ' + cast(@logdate as varchar) + ' and log_type = 0)'
exec (@sql)

-- Decreasing Factor: 945
set @sql = 'insert into [dbo].[' + @table_to + ']'
	+ ' select ' + cast(@logdate as varchar) + ', STR_actor, 1, 945, isnull(sum(isnull(cast(etc_num9 as bigint),0)),0)*-1'
	+ ' from [lin2log].[dbo].[' + @table_from  + '](nolock) '
	+ ' where log_id = 945'
	+ ' group by STR_actor'
	+ ' having STR_actor in ('
	+ '	select char_name from RP_RANKDAILYADENA_' + @world + ' (nolock)'
	+ '	where log_date = ' + cast(@logdate as varchar) + ' and log_type = 0)'
exec (@sql)

-- Decreasing Factor: 947
set @sql = 'insert into [dbo].[' + @table_to + ']'
	+ ' select ' + cast(@logdate as varchar) + ', STR_actor, 1, 947, isnull(sum(isnull(cast(etc_num9 as bigint),0)),0)*-1'
	+ ' from [lin2log].[dbo].[' + @table_from  + '](nolock) '
	+ ' where log_id = 947'
	+ ' group by STR_actor'
	+ ' having STR_actor in ('
	+ '	select char_name from RP_RANKDAILYADENA_' + @world + ' (nolock)'
	+ '	where log_date = ' + cast(@logdate as varchar) + ' and log_type = 0)'
exec (@sql)

-- Decreasing Factor: 963
set @sql = 'insert into [dbo].[' + @table_to + ']'
	+ ' select ' + cast(@logdate as varchar) + ', STR_actor, 1, 963, count(*)*-1*' + cast(@lotto_price as varchar) + ''
	+ ' from [lin2log].[dbo].[' + @table_from  + '](nolock) '
	+ ' where log_id = 963'
	+ ' group by STR_actor'
	+ ' having STR_actor in ('
	+ '	select char_name from RP_RANKDAILYADENA_' + @world + ' (nolock)'
	+ '	where log_date = ' + cast(@logdate as varchar) + ' and log_type = 0)'
exec (@sql)

-- Decreasing Factor: 965
set @sql = 'insert into [dbo].[' + @table_to + ']'
	+ ' select ' + cast(@logdate as varchar) + ', STR_actor, 1, 965, isnull(sum(isnull(cast(etc_num9 as bigint),0)),0)*-1'
	+ ' from [lin2log].[dbo].[' + @table_from  + '](nolock) '
	+ ' where log_id = 965'
	+ ' group by STR_actor'
	+ ' having STR_actor in ('
	+ '	select char_name from RP_RANKDAILYADENA_' + @world + ' (nolock)'
	+ '	where log_date = ' + cast(@logdate as varchar) + ' and log_type = 0)'
exec (@sql)

-- Decreasing Factor: 639
set @sql = 'insert into [dbo].[' + @table_to + ']'
	+ ' select ' + cast(@logdate as varchar) + ', STR_actor, 1, 639, isnull(sum(isnull(cast(etc_num9 as bigint),0)),0)*-1'
	+ ' from [lin2log].[dbo].[' + @table_from + '](nolock)'
	+ ' where log_id = 639 and etc_num8 = 57'
	+ ' group by STR_actor'
	+ ' having STR_actor in ('
	+ '	select char_name from RP_RANKDAILYADENA_' + @world + ' (nolock)'
	+ '	where log_date = ' + cast(@logdate as varchar) + ' and log_type = 0)'
exec (@sql)

-- Decreasing Factor: 310
set @sql = 'insert into [dbo].[' + @table_to + ']'
	+ ' select ' + cast(@logdate as varchar) + ', STR_actor, 1, 310, count(*)*-1*' + cast(@donation as varchar)
	+ ' from [lin2log].[dbo].[' + @table_from + '](nolock)'
	+ ' where log_id = 310 and etc_num8 = 3'
	+ ' group by STR_actor'
	+ ' having STR_actor in ('
	+ '	select char_name from RP_RANKDAILYADENA_' + @world + ' (nolock)'
	+ '	where log_date = ' + cast(@logdate as varchar) + ' and log_type = 0)'
exec (@sql)

-- Decreasing Factor: 909
set @sql = 'insert into [dbo].[' + @table_to + ']'
	+ ' select ' + cast(@logdate as varchar) + ', STR_actor, 1, 909, isnull(sum(isnull(cast(etc_num9 as bigint),0)),0)'
	+ ' from [lin2log].[dbo].[' + @table_from  + '](nolock)'
	+ ' where log_id = 909 and etc_num8 = 57'
	+ ' group by STR_actor'
	+ ' having STR_actor in ('
	+ '	select char_name from RP_RANKDAILYADENA_' + @world + ' (nolock)'
	+ '	where log_date = ' + cast(@logdate as varchar) + ' and log_type = 0)'

exec (@sql)

SET NOCOUNT OFF
GO

/******************************************************************************
#Name:	lin_RPAdenaIncDec
#Desc:	Gather the factor that adena is increased or decreased

#Argument:
	Input:	@table_from	varchar(60)	log view: Lyyyy_mm_dd_Log_Data0_world
		@table_to	varchar(60)	report table: RPAdenaIncDec_world
		@logdate	int		report date
	Output:	
#Return:
#Result Set:

#Remark:
	Increasing Factor: 902, 906, 950, 964, 966, 301, 266, 638
	Decreasing Factor: 901, 908, 928, 939, 945, 947, 963, 965, 246, 639, 310
#Example:	exec lin_RPAdenaIncDec 'L2005_04_20_log_data0_8', 'RP_AdenaIncDec_8', 20050420
#See:

#History:
	Create	btwinuni	2005-04-20
	Modify	btwinuni	2005-04-26	add: 266, 638, 928, 246, 639, 310 / del: 912, 949, 952, 954, 301, 907, 915, 962
	Modify	btwinuni	2005-05-10	mod: 964, 301, 266, 966
	Modify	btwinuni	2005-05-24	mod: 266
	Modify	btwinuni	2005-06-16	mod: 265
******************************************************************************/
ALTER Procedure [dbo].[lin_RPAdenaIncDec]
	@table_from	varchar(60),
	@table_to	varchar(60),
	@logdate	int
AS
SET NOCOUNT ON

declare	@sql	varchar(4000)
declare	@lotto_price	int
declare	@donation	int

set @lotto_price = 2000
set @donation = 50000

-- report table is initiated
set @sql = 'if not exists (select * from dbo.sysobjects where id = object_id(N''[dbo].[' + @table_to + ']'') and objectproperty(id, N''IsUserTable'') = 1)'
	+ ' begin'
	+ ' create table [dbo].[' + @table_to + '] ('
	+ ' 	log_date		int,'
	+ '	log_type		int,'
	+ ' 	log_id		int,'
	+ ' 	amount		bigint'
	+ ' )'
	+ ' create index ix_' + @table_to + '_1 on [dbo].[' + @table_to + '] (log_date)'
	+ ' end'
exec (@sql)

set @sql = 'delete from [dbo].[' + @table_to + '] where log_date = ' + cast(@logdate as varchar)
exec (@sql)

-- Increasing Factor: 902
set @sql = 'insert into [dbo].[' + @table_to + ']'
	+ ' select ' + cast(@logdate as varchar) + ', 0, 902, isnull(sum(isnull(cast(etc_num9 as bigint),0)),0)'
	+ ' from [lin2log].[dbo].[' + @table_from  + '](nolock)'
	+ ' where log_id = 902 and etc_num8 = 57'
exec (@sql)

-- Increasing Factor: 906
set @sql = 'insert into [dbo].[' + @table_to + ']'
	+ ' select ' + cast(@logdate as varchar) + ', 0, 906, isnull(sum(isnull(cast(etc_num9 as bigint),0)),0)'
	+ ' from [lin2log].[dbo].[' + @table_from  + '](nolock)'
	+ ' where log_id = 906 and etc_num8 = 57'
exec (@sql)

-- Increasing Factor: 950
set @sql = 'insert into [dbo].[' + @table_to + ']'
	+ ' select ' + cast(@logdate as varchar) + ', 0, 950, isnull(sum(isnull(cast(etc_num4 as bigint),0)),0)'
	+ ' from [lin2log].[dbo].[' + @table_from  + '](nolock) '
	+ ' where log_id = 950'
exec (@sql)

-- Increasing Factor: 964
set @sql = 'insert into [dbo].[' + @table_to + ']'
	+ ' select ' + cast(@logdate as varchar) + ', 0, 964, isnull(sum(isnull(cast(etc_num9 as bigint),0)),0)'
	+ ' from [lin2log].[dbo].[' + @table_from  + '](nolock) '
	+ ' where log_id = 964'
exec (@sql)

-- Increasing Factor: 966
set @sql = 'insert into [dbo].[' + @table_to + ']'
	+ ' select ' + cast(@logdate as varchar) + ', 0, 966, isnull(sum(isnull(cast(etc_num10 as bigint),0)),0)'
	+ ' from [lin2log].[dbo].[' + @table_from  + '](nolock) '
	+ ' where log_id = 966'
exec (@sql)

-- Increasing Factor: 301
set @sql = 'insert into [dbo].[' + @table_to + ']'
	+ ' select ' + cast(@logdate as varchar) + ', 0, 301, isnull(sum(isnull(cast(etc_num6 as bigint),0)),0)'
	+ ' from [lin2log].[dbo].[' + @table_from  + '](nolock) '
	+ ' where log_id = 301 and etc_num5 = 57 and etc_num7 <> 0'
exec (@sql)

-- Increasing Factor: 266
set @sql = 'insert into [dbo].[' + @table_to + ']'
	+ ' select ' + cast(@logdate as varchar) + ', 0, 266, isnull(sum(isnull(cast(etc_num1 as bigint),0) + isnull(cast(etc_num3 as bigint),0) + isnull(cast(etc_num4 as bigint),0)),0)'
	+ ' from [lin2log].[dbo].[' + @table_from + '](nolock)'
	+ ' where log_id = 266'
exec (@sql)

-- Increasing Factor: 638
set @sql = 'insert into [dbo].[' + @table_to + ']'
	+ ' select ' + cast(@logdate as varchar) + ', 0, 638, isnull(sum(isnull(cast(etc_num9 as bigint),0)),0)'
	+ ' from [lin2log].[dbo].[' + @table_from + '](nolock)'
	+ ' where log_id = 638 and etc_num8 = 57'
exec (@sql)

---------------------------------------------------------------------------
-- Decreasing Factor: 901
set @sql = 'insert into [dbo].[' + @table_to + ']'
	+ ' select ' + cast(@logdate as varchar) + ', 1, 901, isnull(sum(isnull(cast(etc_num9 as bigint),0)),0)'
	+ ' from [lin2log].[dbo].[' + @table_from  + '](nolock) '
	+ ' where log_id = 901 and etc_num8 = 57'
exec (@sql)

/*-- Decreasing Factor: 907
set @sql = 'insert into [dbo].[' + @table_to + ']'
	+ ' select ' + cast(@logdate as varchar) + ', 1, 907, isnull(sum(isnull(cast(etc_num9 as bigint),0)),0)'
	+ ' from [lin2log].[dbo].[' + @table_from  + '](nolock) '
	+ ' where log_id = 907 and etc_num8 = 57'
exec (@sql)
*/

-- Decreasing Factor: 908
set @sql = 'insert into [dbo].[' + @table_to + ']'
	+ ' select ' + cast(@logdate as varchar) + ', 1, 908, isnull(sum(isnull(cast(etc_num9 as bigint),0)),0)'
	+ ' from [lin2log].[dbo].[' + @table_from  + '](nolock) '
	+ ' where log_id = 908 and etc_num8 = 57'
exec (@sql)

-- Decreasing Factor: 928
set @sql = 'insert into [dbo].[' + @table_to + ']'
	+ ' select ' + cast(@logdate as varchar) + ', 1, 928, isnull(sum(isnull(cast(etc_num9 as bigint),0)),0)*-1'
	+ ' from [lin2log].[dbo].[' + @table_from  + '](nolock) '
	+ ' where log_id = 928 and etc_num8 = 57'
exec (@sql)

-- Decreasing Factor: 939
set @sql = 'insert into [dbo].[' + @table_to + ']'
	+ ' select ' + cast(@logdate as varchar) + ', 1, 939, isnull(sum(isnull(cast(etc_num5 as bigint),0)),0)*-1'
	+ ' from [lin2log].[dbo].[' + @table_from  + '](nolock) '
	+ ' where log_id = 939'
exec (@sql)

-- Decreasing Factor: 945
set @sql = 'insert into [dbo].[' + @table_to + ']'
	+ ' select ' + cast(@logdate as varchar) + ', 1, 945, isnull(sum(isnull(cast(etc_num9 as bigint),0)),0)*-1'
	+ ' from [lin2log].[dbo].[' + @table_from  + '](nolock) '
	+ ' where log_id = 945'
exec (@sql)

-- Decreasing Factor: 947
set @sql = 'insert into [dbo].[' + @table_to + ']'
	+ ' select ' + cast(@logdate as varchar) + ', 1, 947, isnull(sum(isnull(cast(etc_num9 as bigint),0)),0)*-1'
	+ ' from [lin2log].[dbo].[' + @table_from  + '](nolock) '
	+ ' where log_id = 947'
exec (@sql)

-- Decreasing Factor: 963
set @sql = 'insert into [dbo].[' + @table_to + ']'
	+ ' select ' + cast(@logdate as varchar) + ', 1, 963, count(*)*-1*' + cast(@lotto_price as varchar) + ''
	+ ' from [lin2log].[dbo].[' + @table_from  + '](nolock) '
	+ ' where log_id = 963'
exec (@sql)

-- Decreasing Factor: 965
set @sql = 'insert into [dbo].[' + @table_to + ']'
	+ ' select ' + cast(@logdate as varchar) + ', 1, 965, isnull(sum(isnull(cast(etc_num9 as bigint),0)),0)*-1'
	+ ' from [lin2log].[dbo].[' + @table_from  + '](nolock) '
	+ ' where log_id = 965'
exec (@sql)

-- Decreasing Factor: 246
set @sql = 'insert into [dbo].[' + @table_to + ']'
	+ ' select ' + cast(@logdate as varchar) + ', 1, 246, isnull(sum(isnull(cast(etc_num3 as bigint),0)),0)*-1'
	+ ' from [lin2log].[dbo].[' + @table_from  + '](nolock) '
	+ ' where log_id = 246 and etc_num4 = 1'
exec (@sql)

-- Decreasing Factor: 639
set @sql = 'insert into [dbo].[' + @table_to + ']'
	+ ' select ' + cast(@logdate as varchar) + ', 1, 639, isnull(sum(isnull(cast(etc_num9 as bigint),0)),0)*-1'
	+ ' from [lin2log].[dbo].[' + @table_from + '](nolock)'
	+ ' where log_id = 639 and etc_num8 = 57'
exec (@sql)

-- Decreasing Factor: 310
set @sql = 'insert into [dbo].[' + @table_to + ']'
	+ ' select ' + cast(@logdate as varchar) + ', 1, 310, count(*)*-1*' + cast(@donation as varchar)
	+ ' from [lin2log].[dbo].[' + @table_from + '](nolock)'
	+ ' where log_id = 310 and etc_num8 = 3'
exec (@sql)

-- Decreasing Factor: 265
set @sql = 'insert into [dbo].[' + @table_to + ']'
	+ ' select ' + cast(@logdate as varchar) + ', 1, 265, isnull(sum(isnull(cast(etc_str3 as bigint),0) * isnull(cast(etc_num3 as bigint),0) + isnull(cast(etc_num6 as bigint),0) * isnull(cast(etc_num8 as bigint),0)),0)*-1'
	+ ' from [lin2log].[dbo].[' + @table_from + '](nolock)'
	+ ' where log_id = 265'
exec (@sql)

SET NOCOUNT OFF
GO

/******************************************************************************
#Name:	lin_RPAchieveMaxLevel
#Desc:	make daily report about character info achieved max level 

#Argument:
	Input:	@table_from	varchar(60)	log view: Lyyyy_mm_dd_Log_Data0_world
		@table_to	varchar(60)	report table: RP_AchieveMaxLevel
		@logdate	int		report date
	Output:	
#Return:
#Result Set:

#Remark:
#Example:	exec lin_RPAchieveMaxLevel 'L2005_02_25_log_data0_8', 'RP_AchieveMaxLevel_8', 20050420
#See:

#History:
	Create	kernel0	2005-05-20
******************************************************************************/
ALTER   Procedure [dbo].[lin_RPAchieveMaxLevel]
	@table_from	varchar(60),
	@table_to	varchar(60),
	@logdate	int
AS
SET NOCOUNT ON

declare	@sql	varchar(4000)

-- report table is initiated
set @sql = 'if not exists (select * from dbo.sysobjects where id = object_id(N''[dbo].[' + @table_to + ']'') and objectproperty(id, N''IsUserTable'') = 1)'
	+ ' begin'
	+ ' create table [dbo].[' + @table_to + '] ('
	+ 'log_date		int,'
	+ 'log_time		varchar(4),'
	+ 'char_name	nvarchar(48), '
	+ 'account_name	nvarchar(32), '
	+ 'subjob_id	int '
	+ ' )'
	+ ' create index ix_' + @table_to + '_1 on [dbo].[' + @table_to + '] (log_date asc, log_time desc)' 
	+ ' end'
exec (@sql)

set @sql = 'delete from [dbo].[' + @table_to + '] where log_date = ' + cast(@logdate as varchar)
exec (@sql)

set @sql = 'insert into [dbo].[' + @table_to + '] (log_date, log_time, char_name, account_name, subjob_id) '
	+ 'select  ' + cast(@logdate as varchar) + ', substring(convert(varchar(5), act_time, 108), 0, 3) +  substring(convert(varchar(5), act_time, 108), 4, 6), '
	+ ' str_actor, str_actor_account, etc_num8 '
	+ 'from [lin2log].[dbo].[' +@table_from + '] (nolock) where log_id = 810 and etc_num4 = 78 and etc_num8  <>  1'
exec(@sql)

SET NOCOUNT OFF
GO

/********************************************
lin_RPRankDailyOlympiadPoint
make Daily OlympiadPoint Ranking Table

#argument	@table_from	varchar(60)	log table to be a source
#argument	@table_from2	varchar(60)	log table to be a source
#argument	@table_to	varchar(60)	report table to be a destination
#argument	@logdate	int		the date of report to be created
#return
#result_set
#remark
#example	lin_RPRankDailyOlympiadPoint 's2005_10_09_snap_nobless_8', 's2005_10_09_snap_data_8', 'RP_RANKDAILYOLYMPOINT_8', 20051009
#history	create	neoliebe		2005-10-06
#see
********************************************/
ALTER PROCEDURE [DBO].[lin_RPRankDailyOlympiadPoint](
	@table_from	varchar(60),
	@table_from2	varchar(60),
	@table_to	varchar(60),
	@logdate	int
)
AS
SET NOCOUNT ON

declare @sql varchar(4000)
declare @yesterday	varchar(8)

-- check table whether @table_to is exists or not
set @sql = 'select * from lin2report.dbo.sysobjects (nolock) where name = ''' + @table_to + ''''
exec (@sql)

if (@@ROWCOUNT = 0)
begin
	set @sql = 'CREATE TABLE dbo.' + @table_to + ' (' 
		+ ' log_date	int, '
		+ ' race	smallint, '
		+ ' class	smallint, '
		+ ' gender	smallint, '
		+ ' char_id	int, '
		+ ' char_name	nvarchar(60), '
		+ ' account_id	int, '
		+ ' account_name	nvarchar(60), '
		+ ' level	smallint, '
		+ ' point		int, '
		+ ' point_old	int, '
		+ ' point_diff	int '
		+ ' ) '
	exec (@sql)

	set @sql = 'CREATE clustered INDEX IX_' + @table_to + ' on dbo.' + @table_to + ' (log_date, race, class) with fillfactor = 90 '
	exec (@sql)
	set @sql = 'CREATE nonclustered INDEX IX_' + @table_to + '2 on dbo.' + @table_to + ' (log_date, char_id)'
	exec (@sql)
end
else begin
	set @sql = 'delete from dbo.' + @table_to + ' where log_date = ' + CAST(@logdate as varchar)
	exec (@sql)
end


-- set variables
set @yesterday = convert(varchar(8), dateadd(day, -1, cast(cast(@logdate as varchar) as datetime)), 112)

-- insert into report table
set @sql = 'insert into ' + RTRIM(@table_to) + ' (log_date, race, class, gender, char_id, char_name, account_id, account_name, level, point, point_old, point_diff) ( ' 
+ 'select ' + cast(@logdate as varchar) + ' log_date, today.race, today.class, today.gender, today.char_id, today.char_name, today.account_id, today.account_name, today.level, today.point, yesterday.point point_old, today.point-yesterday.point point_diff '
+ 'from '
+ '( '
+ '	select usr.race race, usr.class class, usr.gender gender, nob.char_id char_id, usr.char_name char_name, usr.account_id account_id, usr.account_name account_name, usr.lev level, nob.olympiad_point point '
+ '	from lin2log.dbo.' + @table_from + ' nob '
+ '	inner join lin2log.dbo.' + @table_from2 + ' usr '
+ '	on nob.char_id = usr.char_id  '
+ ') today left outer join ' + @table_to + ' yesterday '
+ 'ON today.char_id = yesterday.char_id and yesterday.log_date = ' + @yesterday
+ ')'

exec (@sql )
GO

/******************************************************************************
#Name:	lin_RPChangeClassByClassRace
#Desc:	make daily report about change of class level up by class and race

#Argument:
	Input:	@table_from	varchar(60)	log view: Lyyyy_mm_dd_Log_Data0_world
		@table_to	varchar(60)	report table: RPChangeClassByClassRace
		@logdate	int		report date
	Output:	
#Return:
#Result Set:

#Remark:
#Example:	exec lin_RPChangeClassByClassRace 'S2005_02_25_snap_data_8', 'RPChangeClassByClassRace_8', 20050420
#See:

#History:
	Create	kernel0	2005-05-17
******************************************************************************/
ALTER Procedure [dbo].[lin_RPChangeClassByClassRace]
	@table_from	varchar(60),
	@table_to	varchar(60),
	@logdate	int
AS
SET NOCOUNT ON

declare	@sql	varchar(4000)

-- report table is initiated
set @sql = 'if not exists (select * from dbo.sysobjects where id = object_id(N''[dbo].[' + @table_to + ']'') and objectproperty(id, N''IsUserTable'') = 1)'
	+ ' begin'
	+ ' create table [dbo].[' + @table_to + '] ('
	+ ' 	log_date		int,'
	+ '         cnt                      int,'
	+ ' 	class		int,'
	+ ' 	race		int'
	+ ' )'
	+ ' create index ix_' + @table_to + '_1 on [dbo].[' + @table_to + '] (log_date asc, class asc, race asc)' 
	+ ' end'
exec (@sql)

set @sql = 'delete from [dbo].[' + @table_to + '] where log_date = ' + cast(@logdate as varchar)
exec (@sql)

set @sql = 'insert into [dbo].[' + @table_to + '] (log_date, cnt, class, race) '
	+ 'select ' + cast(@logdate as varchar) + ', count(*) as cnt, class , race from [lin2log].[dbo].[' +@table_from + '] (nolock)  group by class, race'

exec(@sql)

SET NOCOUNT OFF
GO

/********************************************
#Name:	lin_MakeReport
#Desc:	do make reports

#Argument:
	Input:
		@report_date	int	the date to ALTER  a report
		@report_world	int	(default: 1) the number of world
	Output:
#Return:
#Result Set:

#Remark:
#Example:	Exec lin_MakeReport 20041130, 8	-- the 8th world's report will be created
	Exec lin_MakeReport 20041130	-- the 1st world's report will be created
#See:	lin_RPTblDailyAdenaUp
	lin_RPTblGetQuestItem
	lin_RPTblGetQuestItemChar
	lin_RPTblQuestSettle
	lin_RPRecipeShopGetItem
	lin_RPTblPartyInfoByClass
	lin_RPRegionalStatByPartyMemberCount
	lin_RPRankDailyExp
	lin_RPRankDailyAdena
	lin_RPRankDailyCrystal
	lin_RPTblDailyCountItem
	lin_RPRankRecommendation
	lin_RPRankDailySealStone
	lin_RPJoinSSQ
	lin_RPLoginCountByRaceLevel
	lin_RPRankDailyOlympiadPoint
	lin_RPSetHero
	lin_RPSkillEnchant

#History:
	create	flagoftiger	2004-07-13
	modify	btwinuni	2005-03-23	add lin_RPLoginCountByRaceLevel procedure
	modify	btwinuni	2005-04-20	add lin_RPAdenaIncDec procedure
	modify	btwinuni	2005-05-18	add lin_RPItemIncDec procedure / change making order
	modify	btwinuni	2005-05-25	add lin_RPQuestAssetByChar procedure
	modify	btwinuni	2005-05-26	add lin_RPCastleTaxInfo procedure
	modify	btwinuni	2005-06-14	add lin_RPManorInfo procedure
	modify	btwinuni	2005-07-27	remove lin_RPGetQuestItem, lin_RPGetQuestItemChar
	modify	btwinuni	2005-09-29	add lin_RPFishingStatus procedure
	modify	neoliebe	2005-10-11	add lin_RPRankDailyOlympiadPoint
	modify	neoliebe	2005-10-11	add lin_RPSetHero
	modify	neoliebe	2005-10-19	add lin_RPSkillEnchant
********************************************/
ALTER     PROCEDURE [DBO].[lin_MakeReport]

	@report_date int ,
	@report_world int = 1
AS

------------------
-- Set string date --
------------------
SET NOCOUNT ON

if @report_date is null
begin
	set @report_date = cast(convert(varchar(8), dateadd(d, -1, getdate()), 112) as int)
end

declare @stryear varchar(10)
declare @strmonth varchar(10)
declare @strday varchar(10)

set @stryear = substring(cast(@report_date as varchar(8)), 1, 4)
set @strmonth = substring(cast(@report_date as varchar(8)), 5, 2)
set @strday = substring(cast(@report_date as varchar(8)), 7, 2)

declare @table_from varchar(60)
declare @table_from2 varchar(60)
declare @table_to varchar(60)
declare @sql varchar(512)

-----------------------------------
-- Make report from snap_data Table --
-----------------------------------
set @table_from = 'S' + @stryear  + '_' + @strmonth + '_' + @strday + '_snap_data_' + cast ( @report_world as varchar)

-- linRPRankDailyExp
set @table_to =  'RP_RANKDAILYEXP_' + cast(@report_world as varchar)
exec lin_RPRankDailyExp @table_from, @table_to, @report_date
waitfor delay '0:0:6'

-- lin_RPChangeClassByClassRace
set @table_to =  'RPChangeClassByClassRace_' + cast(@report_world as varchar)
exec lin_RPChangeClassByClassRace @table_from, @table_to, @report_date
waitfor delay '0:0:6'

-- lin_RPRankDailyOlympiadPoint
set @table_from2 = 'S' + @stryear  + '_' + @strmonth + '_' + @strday + '_snap_nobless_' + cast ( @report_world as varchar)
set @table_to = 'RP_RankDailyOlymPoint_' + cast(@report_world as varchar)
exec lin_RPRankDailyOlympiadPoint @table_from2, @table_from, @table_to, @report_date
waitfor delay '0:0:6'

-----------------------------------
-- Make report from snap_item Table --
-----------------------------------
set @table_from = 'S' + @stryear  + '_' + @strmonth + '_' + @strday + '_snap_item_' + cast ( @report_world as varchar)

-- linRPRankDailyAdena
set @table_to =  'RP_RANKDAILYADENA_' + cast(@report_world as varchar)
exec lin_RPRankDailyAdena @table_from, @table_to, @report_date
waitfor delay '0:0:6'

-- linRPRankDailyCrystal
set @table_to =  'RP_RANKDAILYCRYSTAL_' + cast(@report_world as varchar)
exec lin_RPRankDailyCrystal @table_from, @table_to, @report_date
waitfor delay '0:0:6'

-- linRPTblDailyCountItem
set @table_to =  'RP_TBLDAILYCOUNTITEM_' + cast(@report_world as varchar)
exec lin_RPTblDailyCountItem @table_from, @table_to, @report_date


-- linRPRankDailySealStone
set @table_to = 'RP_RANKDAILYSEALSTONE_' + cast ( @report_world as varchar)
exec lin_RPRankDailySealStone @table_from , @table_to, @report_date

-----------------------------
-- Make report from Log View --
-----------------------------
set @table_from = 'L' + @stryear  + '_' + @strmonth + '_' + @strday + '_log_data0_' + cast ( @report_world as varchar)

-- lin_RPTblDailyAdenaUp
set @table_to =  'RP_TBLDAILYADENAUP_' + cast(@report_world as varchar)
exec lin_RPTblDailyAdenaUp @table_from, @table_to, @report_date
waitfor delay '0:0:6'


-- modified by btwinuni: change to lin_RPQuestAssetByChar
-- lin_RPTblGetQuestItem
-- set @table_to = 'RP_TBLGETQUESTITEM_' + cast(@report_world as varchar )
-- exec lin_RPTblGetQuestItem @table_from, @table_to, @report_date
-- waitfor delay '0:0:6'

-- lin_RPTblGetQuestItemChar
-- set @table_to = 'RP_TBLGETQUESTITEMCHAR_' + cast(@report_world as varchar)
-- exec lin_RPTblGetQuestItemChar @table_from, @table_to, @report_date
-- waitfor delay '0:0:6'


-- lin_RPTblQuestSettle
set @table_to = 'RP_TBLQUESTSETTLE_' + cast(@report_world as varchar)
exec lin_RPTblQuestSettle @table_from, @table_to, @report_date
waitfor delay '0:0:6'

-- lin_RPRecipeShopGetItem
set @table_to = 'RP_RECIPESHOPGETITEM_' + cast(@report_world as varchar)
exec lin_RPRecipeShopGetItem @table_from, @table_to, @report_date
waitfor delay '0:0:6'

-- lin_RPTblPartyInfoByClass
set @table_to = 'RP_TBLPARTYINFOBYCLASS_' + cast(@report_world as varchar)
exec lin_RPTblPartyInfoByClass @table_from, @table_to, @report_date
waitfor delay '0:0:6'

-- lin_RPRegionalStatByPartyMemberCount
set @table_to = 'RP_TBLREGIONALSTATBYPARTYMEMBERCOUNT_' + cast(@report_world as varchar)
exec lin_RPRegionalStatByPartyMemberCount @table_from, @table_to, @report_date
waitfor delay '0:0:6'

-- lin_RPRankRecommendation
set @table_to = 'RP_RankRecommendation_' + cast(@report_world as varchar)
exec lin_RPRankRecommendation @table_from, @table_to, @report_date
waitfor delay '0:0:6'

-- lin_RPJoinSSQMainEvent
set @table_to = 'RP_JOINSSQMAINEVENT_' + cast(@report_world as varchar)
exec lin_RPJoinSSQMainEvent @table_from, @table_to, @report_date
waitfor delay '0:0:6'

-- lin_RPJoinSSQ
set @table_to = 'RP_JOINSSQ_' + cast(@report_world as varchar)
exec lin_RPJoinSSQ @table_from, @table_to, @report_date
waitfor delay '0:0:6'

-- lin_RPClassBySubJob
set @table_to = 'RP_CLASS_BY_SUBJOB_' + cast(@report_world as varchar)
exec lin_RPClassBySubJob @table_from, @table_to, @report_date
waitfor delay '0:0:6'

-- lin_RPLoginCountByRaceLevel
set @table_to = 'RP_LoginCountByRaceLevel_' + cast(@report_world as varchar)
exec lin_RPLoginCountByRaceLevel @table_from, @table_to, @report_date
waitfor delay '0:0:6'

-- lin_RPAdenaIncDec
set @table_to = 'RP_AdenaIncDec_' + cast(@report_world as varchar)
exec lin_RPAdenaIncDec @table_from, @table_to, @report_date
waitfor delay '0:0:6'

-- lin_RPEnchantItemIncDec
set @table_to = 'RP_EnchantItemIncDec_' + cast(@report_world as varchar)
exec lin_RPEnchantItemIncDec @table_from, @table_to, @report_date
waitfor delay '0:0:6'

-- lin_RPCreateSubJobBySubJob
set @table_to = 'RPCreateSubJobBySubJob_' + cast(@report_world as varchar)
exec lin_RPCreateSubJobBySubJob @table_from, @table_to, @report_date
waitfor delay '0:0:6'

-- lin_RPNewAccount
set @table_to = 'RP_NewAccount_' + cast(@report_world as varchar)
exec lin_RPNewAccount @table_from, @table_to, @report_date
waitfor delay '0:0:6'

-- lin_RPItemIncDec
set @table_to = 'RP_ItemIncDec_' + cast(@report_world as varchar)
exec lin_RPItemIncDec @table_from, @table_to, @report_date
waitfor delay '0:0:6'

-- lin_RPAdenaIncDecByChar
set @table_to = 'RP_AdenaIncDecByChar_' + cast(@report_world as varchar)
exec lin_RPAdenaIncDecByChar @table_from, @table_to, @report_date
waitfor delay '0:0:6'

-- lin_RPAchieveMaxLevel
set @table_to = 'RP_AchieveMaxLevel_' + cast(@report_world as varchar)
exec lin_RPAchieveMaxLevel @table_from, @table_to, @report_date
waitfor delay '0:0:6'

-- lin_RPEnchantItemByEnchantType
set @table_to = 'RP_EnchantItemByEnchantType_' + cast(@report_world as varchar)
exec lin_RPEnchantItemByEnchantType @table_from, @table_to, @report_date
waitfor delay '0:0:6'

-- lin_RPQuestAssetByChar
set @table_to = 'RP_QuestAssetByChar_' + cast(@report_world as varchar)
exec lin_RPQuestAssetByChar @table_from, @table_to, @report_date
waitfor delay '0:0:6'

-- lin_RPCastleTaxInfo
set @table_to = 'RP_CastleTaxInfo_' + cast(@report_world as varchar)
exec lin_RPCastleTaxInfo @table_from, @table_to, @report_date
waitfor delay '0:0:6'

-- lin_RPManorInfo
set @table_to = 'RP_ManorInfo_' + cast(@report_world as varchar)
exec lin_RPManorInfo @table_from, @table_to, @report_date
waitfor delay '0:0:6'

-- lin_RPCreateSubJobCount
set @table_to = 'RP_CreateSubJobCount_' + cast(@report_world as varchar)
exec lin_RPCreateSubJobCount @table_from, @table_to, @report_date
waitfor delay '0:0:6'

-- lin_RPFishingStatus
set @table_to = 'RP_FishingStatus_' + cast(@report_world as varchar)
exec lin_RPFishingStatus @table_from, @table_to, @report_date
waitfor delay '0:0:6'

-- lin_RPSetHero
set @table_to = 'RP_SetHero_' + cast(@report_world as varchar)
exec lin_RPSetHero @table_from, @table_to, @report_date
waitfor delay '0:0:6'

-- lin_RPSkillEnchant
set @table_to = 'RP_SkillEnchant_' + cast(@report_world as varchar)
exec lin_RPSkillEnchant @table_from, @table_to, @report_date
waitfor delay '0:0:6'
GO

/********************************************
lin_ProcessLog
makes report tables from log tables every early morning.

#argument	@report_date	datetime	the date to create reports
#argument	@report_world	int		the number of world to create reports
#return
#result_set	
#remark		Currently, this procedure is not used.
#example	Exec lin_ProcessLog getdate(), 1: This Example makes the current report of the 1st world.
#history	create		young	2003-03-17
#see		lin_ProcessLog2
#see		lin_ProcessLog3
#see		lin_ProcessLog4
********************************************/
ALTER PROCEDURE [DBO].[lin_ProcessLog]

	@report_date datetime ,
	@report_world int = 1
AS
SET NOCOUNT ON

if @report_date is null
begin
	set @report_date = getdate()
	set @report_date = dateadd(d, -1, getdate())
end

DECLARE @nyear int
DECLARE @nmonth int
DECLARE @nday int
DECLARE @stryear varchar(10)
DECLARE @strmonth varchar(10)
DECLARE @strday varchar(10)
DECLARE @str_report varchar(32)
DECLARE @logdate int

set @nyear = datepart(yyyy, @report_date)
set @nmonth = datepart(mm, @report_date)
set @nday = datepart(dd, @report_date)

set @stryear = cast(@nyear as varchar)
if @nmonth < 10
	set @strmonth = '0' + cast(@nmonth as varchar)
else
	set @strmonth = cast (@nmonth as varchar)

if @nday < 10
	set @strday = '0' + cast(@nday as varchar)
else
	set @strday = cast (@nday as varchar)	

set @str_report = @stryear + '/' + @strmonth + '/' + @strday
set @logdate = cast(@stryear + @strmonth + @strday as int)

------------- now.. we have year, month, day string
DECLARE @table_from varchar(60)
set @table_from = 'L' + @stryear  + '_' + @strmonth + '_' + @strday + '_log_data_' + cast ( @report_world as varchar)

DECLARE @table_to varchar(60)

-----------------------------------------------------------------------------------------------------------------------------------------------------------------
-----------------------------------------------------------------------------------------------------------------------------------------------------------------

/*
-- make LOGINCOUNT report
set @table_to =  'R' + @stryear + '_' + @strmonth  +  '_LOGINCOUNT_' + cast(@report_world as varchar)
exec lin_RPLoginCount @table_from, @table_to, @logdate
waitfor delay '0:0:10'

-- make HUNTCOUNT report
set @table_to =  'R' + @stryear + '_' + @strmonth  +  '_HUNTCOUNT_' + cast(@report_world as varchar)
exec lin_RPHuntCount @table_from, @table_to, @logdate
waitfor delay '0:0:10'

-- make LEARNSKILLLEV report
set @table_to =  'R' + @stryear + '_' + @strmonth  +  '_LEARNSKILLLEV_' + cast(@report_world as varchar)
exec lin_RPLearnSkillLev @table_from, @table_to, @logdate
waitfor delay '0:0:10'

-- make CHANGECLASS report
set @table_to =  'R' + @stryear + '_' + @strmonth  +  '_CHANGECLASS_' + cast(@report_world as varchar)
exec lin_RPChangeClass @table_from, @table_to, @logdate
waitfor delay '0:0:10'

-- make PLAYTIME report
set @table_to =  'R' + @stryear + '_' + @strmonth  +  '_PLAYTIME_' + cast(@report_world as varchar)
exec lin_RPPlayTime @table_from, @table_to, @logdate
waitfor delay '0:0:10'

-- make NPCHUNTED report
set @table_to =  'R' + @stryear + '_' + @strmonth  +  '_NPCHUNTED_' + cast(@report_world as varchar)
exec lin_RPNPCHunted @table_from, @table_to, @logdate
waitfor delay '0:0:10'

-- make ITEMBUY report
set @table_to =  'R' + @stryear + '_' + @strmonth  +  '_ITEMBUY_' + cast(@report_world as varchar)
exec lin_RPItemBuy @table_from, @table_to, @logdate
waitfor delay '0:0:10'

-- make ITEMSELL report
set @table_to =  'R' + @stryear + '_' + @strmonth  +  '_ITEMSELL_' + cast(@report_world as varchar)
exec lin_RPItemSell @table_from, @table_to, @logdate
waitfor delay '0:0:10'

-- make EARNADENA report
set @table_to =  'R' + @stryear + '_' + @strmonth  +  '_EARNADENA_' + cast(@report_world as varchar)
exec lin_RPEarnAdena @table_from, @table_to, @logdate
waitfor delay '0:0:10'

-- make EARNSP report
set @table_to =  'R' + @stryear + '_' + @strmonth  +  '_EARNSP_' + cast(@report_world as varchar)
exec lin_RPEarnSP @table_from, @table_to, @logdate
waitfor delay '0:0:10'

-- make NPCDROP report
set @table_to =  'R' + @stryear + '_' + @strmonth  +  '_NPCDROP_' + cast(@report_world as varchar)
exec lin_RPNPCDrop @table_from, @table_to, @logdate
waitfor delay '0:0:10'

-- make NPCDROP2 report
set @table_to =  'R' + @stryear + '_' + @strmonth  +  '_NPCDROP2_' + cast(@report_world as varchar)
exec lin_RPNPCDrop2 @table_from, @table_to, @logdate
waitfor delay '0:0:10'

-- make LEVUP report
set @table_to =  'R' + @stryear + '_' + @strmonth  +  '_LEVUP_' + cast(@report_world as varchar)
exec lin_RPLevUp @table_from, @table_to, @logdate
waitfor delay '0:0:10'

-- make PCDIE report
set @table_to =  'R' + @stryear + '_' + @strmonth  +  '_PCDIE_' + cast(@report_world as varchar)
exec lin_RPPCDie @table_from, @table_to, @logdate
waitfor delay '0:0:10'

-- make PCDIELOC report
set @table_to =  'R' + @stryear + '_' + @strmonth  +  '_PCDIELOC_' + cast(@report_world as varchar)
exec lin_RPPCDieLoc @table_from, @table_to, @logdate
waitfor delay '0:0:10'

-- make NPCDIELOC report
set @table_to =  'R' + @stryear + '_' + @strmonth  +  '_NPCDIELOC_' + cast(@report_world as varchar)
exec lin_RPNPCDieLoc @table_from, @table_to, @logdate
waitfor delay '0:0:10'

-- make PCDIELOC2 report
set @table_to =  'R' + @stryear + '_' + @strmonth  +  '_PCDIELOC2_' + cast(@report_world as varchar)
exec lin_RPPCDieLoc2 @table_from, @table_to, @logdate
waitfor delay '0:0:10'

-- make NPCDIELOC2 report
set @table_to =  'R' + @stryear + '_' + @strmonth  +  '_NPCDIELOC2_' + cast(@report_world as varchar)
exec lin_RPNPCDieLoc2 @table_from, @table_to, @logdate
waitfor delay '0:0:10'

-- make WAREDEPOSIT report
set @table_to =  'R' + @stryear + '_' + @strmonth  +  '_WAREDEPOSIT_' + cast(@report_world as varchar)
exec lin_RPWareDeposit @table_from, @table_to, @logdate
waitfor delay '0:0:10'

-- make WARERETRIEVE report
set @table_to =  'R' + @stryear + '_' + @strmonth  +  '_WARERETRIEVE_' + cast(@report_world as varchar)
exec lin_RPWareRetrieve @table_from, @table_to, @logdate
waitfor delay '0:0:10'

-- make TRADEGIVE report
set @table_to =  'R' + @stryear + '_' + @strmonth  +  '_TRADEGIVE_' + cast(@report_world as varchar)
exec lin_RPTradeGive @table_from, @table_to, @logdate
waitfor delay '0:0:10'

-- make TRADEGET  report
set @table_to =  'R' + @stryear + '_' + @strmonth  +  '_TRADEGET_' + cast(@report_world as varchar)
exec lin_RPTradeGet  @table_from, @table_to, @logdate
waitfor delay '0:0:10'

-- make USESKILL report
set @table_to =  'R' + @stryear + '_' + @strmonth  +  '_USESKILL_' + cast(@report_world as varchar)
exec lin_RPUseSkill @table_from, @table_to, @logdate
waitfor delay '0:0:10'

-- make ACCOUNTPLAYTIME  report
set @table_to =  'R' + @stryear + '_' + @strmonth  +  '_ACCOUNTPLAYTIME_' + cast(@report_world as varchar)
exec lin_RPAccountPlayTime @table_from, @table_to, @logdate
waitfor delay '0:0:10'

-- make CASTSKILL report
set @table_to =  'R' + @stryear + '_' + @strmonth  +  '_CASTSKILL_' + cast(@report_world as varchar)
exec lin_RPCastSkill @table_from, @table_to, @logdate
waitfor delay '0:0:10'

-- make PCKILLNPC report
set @table_to =  'R' + @stryear + '_' + @strmonth  +  '_PCKILLNPC_' + cast(@report_world as varchar)
exec lin_RPPCKillNPC @table_from, @table_to, @logdate
waitfor delay '0:0:10'

-- make NPCDROPLOC report
set @table_to =  'R' + @stryear + '_' + @strmonth  +  '_NPCDROPLOC_' + cast(@report_world as varchar)
exec lin_RPNPCDropLoc @table_from, @table_to, @logdate
waitfor delay '0:0:10'

-- make EQUIPITEM report
set @table_to =  'R' + @stryear + '_' + @strmonth  +  '_EQUIPITEM_' + cast(@report_world as varchar)
exec lin_RPEquipItem @table_from, @table_to, @logdate
waitfor delay '0:0:10'

-- make STAND report
set @table_to =  'R' + @stryear + '_' + @strmonth  +  '_STAND_' + cast(@report_world as varchar)
exec lin_RPStand @table_from, @table_to, @logdate
waitfor delay '0:0:10'

-- make DIEDURATION report
set @table_to =  'R' + @stryear + '_' + @strmonth  +  '_DIEDURATION_' + cast(@report_world as varchar)
exec lin_RPDieDuration @table_from, @table_to, @logdate

waitfor delay '0:0:10'

-- make CONCURRENT  report
set @table_to =  'R' + @stryear + '_' + @strmonth  +  '_CONCURRENT_' + cast(@report_world as varchar)
exec lin_RPConcurrent @table_from, @table_to, @logdate
waitfor delay '0:0:10'

-- make CLASS report
set @table_to =  'R' + @stryear + '_' + @strmonth  +  '_CLASS_' + cast(@report_world as varchar)
exec lin_RPClass @table_from, @table_to, @logdate
waitfor delay '0:0:10'

-- make ENCHANT report
set @table_to =  'R' + @stryear + '_' + @strmonth  +  '_ENCHANT_' + cast(@report_world as varchar)
exec lin_RPEnchant @table_from, @table_to, @logdate
waitfor delay '0:0:10'

-- make ENCHANTFAIL report
set @table_to =  'R' + @stryear + '_' + @strmonth  +  '_ENCHANTFAIL_' + cast(@report_world as varchar)
exec lin_RPEnchantFail @table_from, @table_to, @logdate
waitfor delay '0:0:10'

-- make CRYSTALIZE report
set @table_to =  'R' + @stryear + '_' + @strmonth  +  '_CRYSTALIZE_' + cast(@report_world as varchar)
exec lin_RPCrystalize @table_from, @table_to, @logdate
waitfor delay '0:0:10'

-- make SELLPRIVATE report
set @table_to =  'R' + @stryear + '_' + @strmonth  +  '_SELLPRIVATE_' + cast(@report_world as varchar)
exec lin_RPSellPrivate @table_from, @table_to, @logdate
waitfor delay '0:0:10'

-- make ITEMINC report
set @table_to =  'R' + @stryear + '_' + @strmonth  +  '_ITEMINC_' + cast(@report_world as varchar)
exec lin_RPItemInc @table_from, @table_to, @logdate
waitfor delay '0:0:10'

-- make ITEMDEC report
set @table_to =  'R' + @stryear + '_' + @strmonth  +  '_ITEMDEC_' + cast(@report_world as varchar)
exec lin_RPItemDec @table_from, @table_to, @logdate
waitfor delay '0:0:10'

-- make BEGINQUEST report
set @table_to =  'R' + @stryear + '_' + @strmonth  +  '_BEGINQUEST_' + cast(@report_world as varchar)
exec lin_RPBeginQuest @table_from, @table_to, @logdate
waitfor delay '0:0:10'

-- make ENDQUEST report
set @table_to =  'R' + @stryear + '_' + @strmonth  +  '_ENDQUEST_' + cast(@report_world as varchar)
exec lin_RPEndQuest @table_from, @table_to, @logdate
waitfor delay '0:0:10'

-- make STOPQUEST report
set @table_to =  'R' + @stryear + '_' + @strmonth  +  '_STOPQUEST_' + cast(@report_world as varchar)
exec lin_RPStopQuest @table_from, @table_to, @logdate

*/
GO

/********************************************
lin_RPWareRetrieve
do make warehouse retrieve report

#argument	@table_from	varchar(60)	log table to be a source
#argument	@table_to	varchar(60)	report table to be a destination
#argument	@logdate	int		the date of report to be created
#return
#result_set
#remark		This procedure creates the report by race, sex, class and level
#example	Exec lin_RPWareRetrieve 'L2004_11_30_log_data_8', 'R2004_11_WARERETRIEVE_8', 20041130
#history	create		young	2003-03-28
#see
********************************************/
ALTER PROCEDURE [DBO].[lin_RPWareRetrieve]
	@table_from	varchar(60),
	@table_to	varchar(60),
	@logdate	int

AS
SET NOCOUNT ON

declare @sql varchar(4000)

-- check table whether @table_to is exists or not
set @sql = 'select * from lin2report.dbo.sysobjects (nolock) where name = ''' + @table_to + ''''
exec (@sql)

if (@@ROWCOUNT = 0)
begin
	set @sql = 'CREATE TABLE dbo.' + @table_to + ' (' 
		+ ' log_date	int, '
		+ 'log_type	smallint, '
		+ 'log_val	int, '
		+ ' retrieve_count 	int , '
		+ ' char_count	int '
		+ ' ) '
	exec (@sql)

	set @sql = 'CREATE INDEX IX_' + @table_to + '_1 on dbo.' + @table_to + ' (log_date) '
	exec (@sql)
end
else begin
	set @sql = 'delete from dbo.' + @table_to + ' where log_date = ' + CAST(@logdate as varchar)
	exec (@sql)
end

-- check tmp table
declare @tmp_table varchar(512)
set @tmp_table = 'dbo.tmp' + @table_to

set @sql = 'select * from lin2report.dbo.sysobjects (nolock) where name = ''tmp' + @table_to + ''''
exec (@sql)

if (@@ROWCOUNT > 0)
begin
	set @sql = ' drop table dbo.tmp' + @table_to
	exec (@sql)
end

-- insert into report table

-- race L--
set @sql = ' select log_id, etc_num1, actor into ' + @tmp_table
	+ ' from lin2log.dbo.' + @table_from + ' ( nolock ) where log_id = 904  '
	+ ' insert into ' + @table_to + ' ( log_date,  log_type, log_val,  retrieve_count , char_count) ( ' 
	+ ' select ' + CAST(@logdate as varchar) + ', 1, etc_num1, count(log_id) , count( distinct  actor )   from '
	+ @tmp_table + ' ( nolock) group by etc_num1 ) option ( MAXDOP 1 ) '
	+ ' drop table ' + @tmp_table
exec (@sql )

-- sex  L--
set @sql =  ' select log_id, etc_num2, actor into ' + @tmp_table
	+ ' from lin2log.dbo.' + @table_from + ' ( nolock ) where log_id = 904  '
	+ ' insert into ' + @table_to + ' ( log_date,  log_type, log_val,  retrieve_count , char_count) ( ' 
	+ ' select ' + CAST(@logdate as varchar) + ', 2, etc_num2, count(log_id) , count( distinct  actor )   from '
	+ @tmp_table + ' ( nolock) group by etc_num2 ) option ( MAXDOP 1 ) '
	+ ' drop table ' + @tmp_table

exec (@sql )

-- class  L--
set @sql =  ' select log_id, etc_num3, actor into ' + @tmp_table
	+ ' from lin2log.dbo.' + @table_from + ' ( nolock ) where log_id = 904  '
	+ ' insert into ' + @table_to + ' ( log_date,  log_type, log_val,  retrieve_count , char_count) ( ' 
	+ ' select ' + CAST(@logdate as varchar) + ', 3, etc_num3, count(log_id) , count( distinct  actor )   from '
	+ @tmp_table + ' ( nolock) group by etc_num3 ) option ( MAXDOP 1 ) '
	+ ' drop table ' + @tmp_table

exec (@sql )

-- level  L--

set @sql =   ' select log_id, etc_num4, actor into ' + @tmp_table
	+ ' from lin2log.dbo.' + @table_from + ' ( nolock ) where log_id = 904  '
	+ ' insert into ' + @table_to + ' ( log_date,  log_type, log_val,  retrieve_count , char_count) ( ' 
	+ ' select ' + CAST(@logdate as varchar) + ', 4, etc_num4, count(log_id) , count( distinct  actor )   from '
	+ @tmp_table + ' ( nolock) group by etc_num4 ) option ( MAXDOP 1 ) '
	+ ' drop table ' + @tmp_table

exec (@sql )
GO

/********************************************
lin_RPWareDeposit
do make warehouse deposit report

#argument	@table_from	varchar(60)	log table to be a source
#argument	@table_to	varchar(60)	report table to be a destination
#argument	@logdate	int		the date of report to be created
#return
#result_set
#remark		This procedure creates the report by race, sex, class and level
#example	Exec lin_RPWareDeposit 'L2004_11_30_log_data_8', 'R2004_11_WAREDEPOSIT_8', 20041130
#history	create		young	2003-03-28
#see
********************************************/
ALTER PROCEDURE [DBO].[lin_RPWareDeposit]
	@table_from	varchar(60),
	@table_to	varchar(60),
	@logdate	int

AS
SET NOCOUNT ON

declare @sql varchar(4000)

-- check table whether @table_to is exists or not
set @sql = 'select * from lin2report.dbo.sysobjects (nolock) where name = ''' + @table_to + ''''
exec (@sql)

if (@@ROWCOUNT = 0)
begin
	set @sql = 'CREATE TABLE dbo.' + @table_to + ' (' 
		+ ' log_date	int, '
		+ 'log_type	smallint, '
		+ 'log_val	int, '
		+ ' deposit_count 	int, '
		+ ' char_count 	int  '
		+ ' ) '
	exec (@sql)

	set @sql = 'CREATE INDEX IX_' + @table_to + '_1 on dbo.' + @table_to + ' (log_date) '
	exec (@sql)
end
else begin
	set @sql = 'delete from dbo.' + @table_to + ' where log_date = ' + CAST(@logdate as varchar)
	exec (@sql)
end


-- check tmp table
declare @tmp_table varchar(512)
set @tmp_table = 'dbo.tmp' + @table_to

set @sql = 'select * from lin2report.dbo.sysobjects (nolock) where name = ''tmp' + @table_to + ''''
exec (@sql)

if (@@ROWCOUNT > 0)
begin
	set @sql = ' drop table dbo.tmp' + @table_to
	exec (@sql)
end


-- insert into report table

-- race L--
set @sql = ' select log_id, etc_num1, actor into ' + @tmp_table
	+ ' from lin2log.dbo.' + @table_from +  ' (nolock) where log_id = 903  '
	+ ' insert into ' + RTRIM(@table_to) + ' ( log_date,  log_type, log_val,  deposit_count , char_count) ( ' 
	+ ' select ' + CAST(@logdate as varchar) + ', 1, etc_num1, count(log_id)  , count ( distinct actor)  from '
	+ @tmp_table  + ' ( nolock ) group by etc_num1  ) option (MAXDOP 1 ) '
	+ ' drop table ' + @tmp_table
exec (@sql )

-- sex  L--
set @sql = ' select log_id, etc_num2, actor into ' + @tmp_table
	+ ' from lin2log.dbo.' + @table_from +  ' (nolock) where log_id = 903  '
	+ ' insert into ' + RTRIM(@table_to) + ' ( log_date,  log_type, log_val,  deposit_count , char_count) ( ' 
	+ ' select ' + CAST(@logdate as varchar) + ', 2, etc_num2, count(log_id)  , count ( distinct actor)  from '
	+ @tmp_table  + ' ( nolock ) group by etc_num2  ) option (MAXDOP 1 ) '
	+ ' drop table ' + @tmp_table

exec (@sql )

-- class  L--
set @sql = ' select log_id, etc_num3, actor into ' + @tmp_table
	+ ' from lin2log.dbo.' + @table_from +  ' (nolock) where log_id = 903  '
	+ ' insert into ' + RTRIM(@table_to) + ' ( log_date,  log_type, log_val,  deposit_count , char_count) ( ' 
	+ ' select ' + CAST(@logdate as varchar) + ', 3, etc_num3, count(log_id)  , count ( distinct actor)  from '
	+ @tmp_table  + ' ( nolock ) group by etc_num3  ) option (MAXDOP 1 ) '
	+ ' drop table ' + @tmp_table

exec (@sql )

-- level  L--
set @sql = ' select log_id, etc_num4, actor into ' + @tmp_table
	+ ' from lin2log.dbo.' + @table_from +  ' (nolock) where log_id = 903  '
	+ ' insert into ' + RTRIM(@table_to) + ' ( log_date,  log_type, log_val,  deposit_count , char_count) ( ' 
	+ ' select ' + CAST(@logdate as varchar) + ', 4, etc_num4, count(log_id)  , count ( distinct actor)  from '
	+ @tmp_table  + ' ( nolock ) group by etc_num4  ) option (MAXDOP 1 ) '
	+ ' drop table ' + @tmp_table

exec (@sql )
GO

/********************************************
lin_RPUseSkill
do make use skill report

#argument	@table_from	varchar(60)	log table to be a source
#argument	@table_to	varchar(60)	report table to be a destination
#argument	@logdate	int		the date of report to be created
#return
#result_set
#remark
#example	Exec lin_RPUseSkill 'L2004_11_30_log_data_8', 'R2004_11_CASTSKILL_8', 20041130
#history	create	 young	2003-03-28
#see
********************************************/
ALTER PROCEDURE [DBO].[lin_RPUseSkill]
	@table_from	varchar(60),
	@table_to	varchar(60),
	@logdate	int

AS
SET NOCOUNT ON

declare @sql varchar(4000)

-- check table whether @table_to is exists or not
set @sql = 'select * from lin2report.dbo.sysobjects (nolock) where name = ''' + @table_to + ''''
exec (@sql)

if (@@ROWCOUNT = 0)
begin
	set @sql = 'CREATE TABLE dbo.' + @table_to + ' (' 
		+ ' log_date	int, '
		+ 'log_type	smallint, '
		+ 'log_val	int, '
		+ ' skill_id 	int , '
		+ ' skill_level 	smallint , '
		+ ' use_count 	int  '
		+ ' ) '
	exec (@sql)

	set @sql = 'CREATE INDEX IX_' + @table_to + '_1 on dbo.' + @table_to + ' (log_date) '
	exec (@sql)
end
else begin
	set @sql = 'delete from dbo.' + @table_to + ' where log_date = ' + CAST(@logdate as varchar)
	exec (@sql)
end

-- check tmp table
declare @tmp_table varchar(512)
set @tmp_table = 'dbo.tmp' + @table_to

set @sql = 'select * from lin2report.dbo.sysobjects (nolock) where name = ''tmp' + @table_to + ''''
exec (@sql)

if (@@ROWCOUNT > 0)
begin
	set @sql = ' drop table dbo.tmp' + @table_to
	exec (@sql)
end


-- insert into report table

-- make tmptable
set @table_from = replace ( @table_from, 'data0', 'data2' )
set @sql = ' select log_id, etc_num1, etc_num2, etc_num3, etc_num4, etc_num5, etc_num6 into ' + @tmp_table
	+ ' from lin2log.dbo.' + @table_from  + ' ( nolock) where log_id = 403 and ( etc_num7 is null or etc_num7 = 0 ) '
exec (@sql)

set @table_from = replace ( @table_from, 'data2', 'data' )
set @sql = ' insert into ' + @tmp_table + ' ( log_id, etc_num1, etc_num2, etc_num3, etc_num4, etc_num5, etc_num6 ) ( select log_id, etc_num1, etc_num2, etc_num3, etc_num4, etc_num5, etc_num6 '
	+ ' from lin2log.dbo.' + @table_from  + ' ( nolock) where log_id = 403 and ( etc_num7 is null or etc_num7 = 0 ) ) '
exec (@sql)


-- race L--
set @sql = ' insert into ' + RTRIM(@table_to) + ' ( log_date,  log_type, log_val,  skill_id, skill_level, use_count ) ( ' 
	+ ' select ' + CAST(@logdate as varchar) + ', 1, etc_num1, etc_num5, etc_num6, count ( log_id ) from    '
	+ @tmp_table  + ' ( nolock ) group by etc_num5, etc_num6, etc_num1   )  option (MAXDOP 1 )'
exec (@sql )

-- sex  L--
set @sql =  ' insert into ' + RTRIM(@table_to) + ' ( log_date,  log_type, log_val,  skill_id, skill_level, use_count ) ( ' 
	+ ' select ' + CAST(@logdate as varchar) + ', 2, etc_num2, etc_num5, etc_num6, count ( log_id ) from    '
	+ @tmp_table  + ' ( nolock ) group by etc_num5, etc_num6, etc_num2   )  option (MAXDOP 1 )'
exec (@sql )

-- class  L--
set @sql =  ' insert into ' + RTRIM(@table_to) + ' ( log_date,  log_type, log_val,  skill_id, skill_level, use_count ) ( ' 
	+ ' select ' + CAST(@logdate as varchar) + ', 3, etc_num3,  etc_num5, etc_num6, count ( log_id ) from    '
	+ @tmp_table  + ' ( nolock ) group by etc_num5, etc_num6, etc_num3  )  option (MAXDOP 1 )'
exec (@sql )

-- level  L--
set @sql = ' insert into ' + RTRIM(@table_to) + ' ( log_date,  log_type, log_val,  skill_id, skill_level, use_count ) ( ' 
	+ ' select ' + CAST(@logdate as varchar) + ', 4, etc_num4, etc_num5, etc_num6, count ( log_id ) from    '
	+ @tmp_table  + ' ( nolock ) group by etc_num5, etc_num6, etc_num4  )  option (MAXDOP 1 )'
exec ( @sql)

-- drop tmptable
set @sql = ' drop table ' + @tmp_table
exec (@sql)
GO

/********************************************
lin_RPTradeItem
do make trade item report

#argument	@table_from	varchar(60)	log table to be a source
#argument	@table_to	varchar(60)	report table to be a destination
#argument	@logdate	int		the date of report to be created
#return
#result_set
#remark
#example	lin_RPTradeItem 'L2004_11_30_log_data_8', 'R2004_11_TRADEITEM_8', 20041130
#history	create	 young	2003-10-31
#see
********************************************/
ALTER PROCEDURE [DBO].[lin_RPTradeItem]
	@table_from	varchar(60),
	@table_to	varchar(60),
	@logdate	int

AS
SET NOCOUNT ON

declare @sql varchar(4000)

-- check table whether @table_to is exists or not
set @sql = 'select * from lin2report.dbo.sysobjects (nolock) where name = ''' + @table_to + ''''
exec (@sql)

if (@@ROWCOUNT = 0)
begin
	set @sql = 'CREATE TABLE dbo.' + @table_to + ' (' 
		+ ' log_date	int, '
		+ ' level_from	int, '
		+ ' level_to	int, '
		+ ' item_type	int, '
		+ ' trade_no	int, '
		+ ' trade_count	bigint  '
		+ ' ) '
	exec (@sql)

	set @sql = 'CREATE INDEX IX_' + @table_to + '_1 on dbo.' + @table_to + ' (log_date) '
	exec (@sql)
end
else begin
	set @sql = 'delete from dbo.' + @table_to + ' where log_date = ' + CAST(@logdate as varchar)
	exec (@sql)
end

-- check tmp table
declare @tmp_table varchar(512)
set @tmp_table = 'dbo.tmp' + @table_to

set @sql = 'select * from lin2report.dbo.sysobjects (nolock) where name = ''tmp' + @table_to + ''''
exec (@sql)

if (@@ROWCOUNT > 0)
begin
	set @sql = ' drop table dbo.tmp' + @table_to
	exec (@sql)
end

-- make tmptable
set @table_from = replace ( @table_from, 'data0', 'data2' )
set @sql = ' select log_id, etc_num4, etc_num6, etc_num8, etc_num9  into ' + @tmp_table
	+ ' from lin2log.dbo.' + @table_from  + ' ( nolock) where log_id = 910 '
exec (@sql)

set @table_from = replace ( @table_from, 'data2', 'data' )
set @sql = ' insert into ' + @tmp_table + ' ( log_id, etc_num4, etc_num6, etc_num8, etc_num9   ) ( select log_id, etc_num4, etc_num6, etc_num8, etc_num9  '
	+ ' from lin2log.dbo.' + @table_from  + ' ( nolock) where log_id = 910 ) '
exec (@sql)

-- insert into report table

set @sql = 'insert into ' + RTRIM(@table_to) + ' ( log_date,  level_from, level_to, item_type, trade_no,  trade_count) ( ' 
	+ ' select ' + CAST(@logdate as varchar) + ', etc_num4, etc_num6, etc_num8,  count( etc_num9 ), amount=sum( cast ( etc_num9 as bigint ) )  from '
	+ @tmp_table  + ' ( nolock )  group by etc_num4, etc_num6, etc_num8  )  option (MAXDOP 1 ) '

exec (@sql )

-- 
set @sql = ' drop  table ' + @tmp_table
exec ( @sql )
GO

/********************************************
lin_RPTradeGive
do make trade give report

#argument	@table_from	varchar(60)	log table to be a source
#argument	@table_to	varchar(60)	report table to be a destination
#argument	@logdate	int		the date of report to be created
#return
#result_set
#remark		This procedure creates the report by race, sex, class and level
#example	Exec lin_RPTradeGive 'L2004_11_30_log_data_8', 'R2004_11_TRADEGIVE_8', 20041130
#history	create		young	2003-03-28
#see
********************************************/
ALTER PROCEDURE [DBO].[lin_RPTradeGive]
	@table_from	varchar(60),
	@table_to	varchar(60),
	@logdate	int

AS
SET NOCOUNT ON

declare @sql varchar(4000)

-- check table whether @table_to is exists or not
set @sql = 'select * from lin2report.dbo.sysobjects (nolock) where name = ''' + @table_to + ''''
exec (@sql)

if (@@ROWCOUNT = 0)
begin
	set @sql = 'CREATE TABLE dbo.' + @table_to + ' (' 
		+ ' log_date	int, '
		+ 'log_type	smallint, '
		+ 'log_val	int, '
		+ ' trade_count 	int , '
		+ ' char_count	int '
		+ ' ) '
	exec (@sql)

	set @sql = 'CREATE INDEX IX_' + @table_to + '_1 on dbo.' + @table_to + ' (log_date) '
	exec (@sql)
end
else begin
	set @sql = 'delete from dbo.' + @table_to + ' where log_date = ' + CAST(@logdate as varchar)
	exec (@sql)
end

-- check tmp table
declare @tmp_table varchar(512)
set @tmp_table = 'dbo.tmp' + @table_to

set @sql = 'select * from lin2report.dbo.sysobjects (nolock) where name = ''tmp' + @table_to + ''''
exec (@sql)

if (@@ROWCOUNT > 0)
begin
	set @sql = ' drop table dbo.tmp' + @table_to
	exec (@sql)
end

-- make tmptable
set @table_from = replace ( @table_from, 'data0', 'data2' )
set @sql = ' select log_id, etc_num1, etc_num2, etc_num3, etc_num4, actor  into ' + @tmp_table
	+ ' from lin2log.dbo.' + @table_from  + ' ( nolock) where log_id = 909   '
exec (@sql)

set @table_from = replace ( @table_from, 'data2', 'data' )
set @sql = ' insert into ' + @tmp_table + ' ( log_id, etc_num1, etc_num2, etc_num3, etc_num4, actor ) ( select log_id, etc_num1, etc_num2, etc_num3, etc_num4, actor '
	+ ' from lin2log.dbo.' + @table_from  + ' ( nolock) where log_id = 909 ) '
exec (@sql)


-- insert into report table

-- race L--
set @sql = 'insert into ' + RTRIM(@table_to) + ' ( log_date,  log_type, log_val,  trade_count , char_count  ) ( ' 
	+ ' select ' + CAST(@logdate as varchar) + ', 1, etc_num1, count( log_id)  , count(distinct actor )  from '
	+ @tmp_table + ' ( nolock )  group by etc_num1  ) option (MAXDOP 1 ) '
exec (@sql )

-- sex  L--
set @sql = 'insert into ' + RTRIM(@table_to) + ' ( log_date,  log_type, log_val,  trade_count , char_count  ) ( ' 
	+ ' select ' + CAST(@logdate as varchar) + ', 2, etc_num2, count( log_id)  , count(distinct actor )  from '
	+ @tmp_table + ' ( nolock )  group by etc_num2  ) option (MAXDOP 1 ) '
exec (@sql )

-- class  L--
set @sql = 'insert into ' + RTRIM(@table_to) + ' ( log_date,  log_type, log_val,  trade_count , char_count  ) ( ' 
	+ ' select ' + CAST(@logdate as varchar) + ', 3, etc_num3, count( log_id)  , count(distinct actor )  from '
	+ @tmp_table + ' ( nolock )  group by etc_num3 ) option (MAXDOP 1 ) '
exec (@sql )

-- level  L--
set @sql = 'insert into ' + RTRIM(@table_to) + ' ( log_date,  log_type, log_val,  trade_count , char_count  ) ( ' 
	+ ' select ' + CAST(@logdate as varchar) + ', 4, etc_num4, count( log_id)  , count(distinct actor )  from '
	+ @tmp_table + ' ( nolock )  group by etc_num4  ) option (MAXDOP 1 ) '
exec (@sql )

-- drop tmptable
set @sql = ' drop table ' + @tmp_table
exec ( @sql )
GO

/********************************************
lin_RPTradeGet
do make trade get report

#argument	@table_from	varchar(60)	log table to be a source
#argument	@table_to	varchar(60)	report table to be a destination
#argument	@logdate	int		the date of report to be created
#return
#result_set
#remark		This procedure creates the report by race, sex, class and level
#example	Exec lin_RPTradeGet 'L2004_11_30_log_data_8', 'R2004_11_TRADEGET_8', 20041130
#history	create		young	2003-03-28
#see
********************************************/
ALTER PROCEDURE [DBO].[lin_RPTradeGet]
	@table_from	varchar(60),
	@table_to	varchar(60),
	@logdate	int

AS
SET NOCOUNT ON

declare @sql varchar(4000)

-- check table whether @table_to is exists or not
set @sql = 'select * from lin2report.dbo.sysobjects (nolock) where name = ''' + @table_to + ''''
exec (@sql)

if (@@ROWCOUNT = 0)
begin
	set @sql = 'CREATE TABLE dbo.' + @table_to + ' (' 
		+ ' log_date	int, '
		+ 'log_type	smallint, '
		+ 'log_val	int, '
		+ ' trade_count 	int , '
		+ ' char_count	int '
		+ ' ) '
	exec (@sql)

	set @sql = 'CREATE INDEX IX_' + @table_to + '_1 on dbo.' + @table_to + ' (log_date) '
	exec (@sql)
end
else begin
	set @sql = 'delete from dbo.' + @table_to + ' where log_date = ' + CAST(@logdate as varchar)
	exec (@sql)
end

-- check tmp table
declare @tmp_table varchar(512)
set @tmp_table = 'dbo.tmp' + @table_to

set @sql = 'select * from lin2report.dbo.sysobjects (nolock) where name = ''tmp' + @table_to + ''''
exec (@sql)

if (@@ROWCOUNT > 0)
begin
	set @sql = ' drop table dbo.tmp' + @table_to
	exec (@sql)
end

-- make tmptable
set @table_from = replace ( @table_from, 'data0', 'data2' )
set @sql = ' select log_id, etc_num1, etc_num2, etc_num3, etc_num4, actor  into ' + @tmp_table
	+ ' from lin2log.dbo.' + @table_from  + ' ( nolock) where log_id = 910   '
exec (@sql)

set @table_from = replace ( @table_from, 'data2', 'data' )
set @sql = ' insert into ' + @tmp_table + ' ( log_id, etc_num1, etc_num2, etc_num3, etc_num4, actor ) ( select log_id, etc_num1, etc_num2, etc_num3, etc_num4, actor '
	+ ' from lin2log.dbo.' + @table_from  + ' ( nolock) where log_id = 910 ) '
exec (@sql)

-- insert into report table

-- race L--
set @sql = 'insert into ' + RTRIM(@table_to) + ' ( log_date,  log_type, log_val,  trade_count, char_count ) ( ' 
	+ ' select ' + CAST(@logdate as varchar) + ', 1, etc_num1, count( log_id ) , count ( distinct actor )  from  '
	+ @tmp_table + ' ( nolock )  group by etc_num1  ) option (MAXDOP 1 ) '
exec (@sql )

-- sex  L--
set @sql = 'insert into ' + RTRIM(@table_to) + ' ( log_date,  log_type, log_val,  trade_count, char_count ) ( ' 
	+ ' select ' + CAST(@logdate as varchar) + ', 2, etc_num2, count( log_id ) , count ( distinct actor )  from  '
	+ @tmp_table + ' ( nolock )  group by etc_num2  ) option (MAXDOP 1 ) '
exec (@sql )

-- class  L--
set @sql = 'insert into ' + RTRIM(@table_to) + ' ( log_date,  log_type, log_val,  trade_count, char_count ) ( ' 
	+ ' select ' + CAST(@logdate as varchar) + ', 3, etc_num3, count( log_id ) , count ( distinct actor )  from  '
	+ @tmp_table + ' ( nolock )  group by etc_num3  ) option (MAXDOP 1 ) '
exec (@sql )

-- level  L--
set @sql = 'insert into ' + RTRIM(@table_to) + ' ( log_date,  log_type, log_val,  trade_count, char_count ) ( ' 
	+ ' select ' + CAST(@logdate as varchar) + ', 4, etc_num4, count( log_id ) , count ( distinct actor )  from  '
	+ @tmp_table + ' ( nolock )  group by etc_num4  ) option (MAXDOP 1 ) '
exec (@sql )

-- drop tmptable
set @sql = ' drop table ' + @tmp_table
exec (@sql)
GO

/********************************************
lin_RPSvrStart
do make server start, stop stats

#argument	@table_from	varchar(60)	log table to be a source
#argument	@table_to	varchar(60)	report table to be a destination
#argument	@logdate	int		the date of report to be created
#return
#result_set
#remark
#example	Exec lin_RPSvrStart 'L2004_11_30_log_data_8', 'R2004_11_SVRSTART_8', 20041130
#history	create	young	2003-03-19
#see
********************************************/
ALTER PROCEDURE [DBO].[lin_RPSvrStart]
	@table_from	varchar(60),
	@table_to	varchar(60),
	@logdate	int

AS
SET NOCOUNT ON

declare @sql varchar(4000)

-- check table whether @table_to is exists or not
set @sql = 'select * from lin2report.dbo.sysobjects (nolock) where name = ''' + @table_to + ''''
exec (@sql)

if (@@ROWCOUNT = 0)
begin
	set @sql = 'CREATE TABLE dbo.' + @table_to + ' (' 
		+ ' log_date	int, '
		+ ' svr_type	smallint, '
		+ ' start_type	smallint, '
		+ ' act_time	datetime '
		+ ' ) '
	exec (@sql)

	set @sql = 'CREATE INDEX IX_' + @table_to + '_1 on dbo.' + @table_to + ' (log_date) '
	exec (@sql)
end
else begin
	set @sql = 'delete from dbo.' + @table_to + ' where log_date = ' + CAST(@logdate as varchar)
	exec (@sql)
end


	set @sql = 'insert into ' + RTRIM(@table_to) + ' ( log_date,  start_type,  svr_type, act_time  ) ( ' 
		+ ' select ' + CAST(@logdate as varchar) + ', 2, etc_num1, act_time  from '
		+ 'lin2log.dbo.' + @table_from + '  ( nolock )  where log_id = 1305  )  option (MAXDOP 1 ) '
	exec (@sql )


	set @sql = 'insert into ' + RTRIM(@table_to) + ' ( log_date,  start_type,  svr_type, act_time  ) ( ' 
		+ ' select ' + CAST(@logdate as varchar) + ', 1, etc_num1, act_time  from '
		+ 'lin2log.dbo.' + @table_from + '  ( nolock )  where log_id = 1306  )  option (MAXDOP 1 ) '
	exec (@sql )
GO

/********************************************
lin_RPStopQuest
do make stop quest

#argument	@table_from	varchar(60)	log table to be a source
#argument	@table_to	varchar(60)	report table to be a destination
#argument	@logdate	int		the date of report to be created
#return
#result_set
#remark		This procedure creates the report by race, sex, class and level
#example	Exec lin_RPStopQuest 'L2004_11_30_log_data_8', 'R2004_11_STOPQUEST_8', 20041130
#history	create		young	2003-06-02
#see
********************************************/
ALTER PROCEDURE [DBO].[lin_RPStopQuest]
	@table_from	varchar(60),
	@table_to	varchar(60),
	@logdate	int

AS
SET NOCOUNT ON

declare @sql varchar(4000)

-- check table whether @table_to is exists or not
set @sql = 'select * from lin2report.dbo.sysobjects (nolock) where name = ''' + @table_to + ''''
exec (@sql)

if (@@ROWCOUNT = 0)
begin
	set @sql = 'CREATE TABLE dbo.' + @table_to + ' (' 
		+ ' log_date	int, '
		+ ' race		smallint, '
		+ ' class		smallint, '
		+ ' level		smallint, '
		+ ' quest_id	int, '
		+ ' quest_count	int  '
		+ ' ) '
	exec (@sql)

	set @sql = 'CREATE INDEX IX_' + @table_to + '_1 on dbo.' + @table_to + ' (log_date) '
	exec (@sql)
end
else begin
	set @sql = 'delete from dbo.' + @table_to + ' where log_date = ' + CAST(@logdate as varchar)
	exec (@sql)
end

-- check tmp table
declare @tmp_table varchar(512)
set @tmp_table = 'dbo.tmp' + @table_to

set @sql = 'select * from lin2report.dbo.sysobjects (nolock) where name = ''tmp' + @table_to + ''''
exec (@sql)

if (@@ROWCOUNT > 0)
begin
	set @sql = ' drop table dbo.tmp' + @table_to
	exec (@sql)
end

-- make tmptable
set @table_from = replace ( @table_from, 'data0', 'data2' )
set @sql = ' select log_id, etc_num1, etc_num3, etc_num4, etc_num5 into ' + @tmp_table
	+ ' from lin2log.dbo.' + @table_from  + ' ( nolock) where log_id = 307   '
exec (@sql)

set @table_from = replace ( @table_from, 'data2', 'data' )
set @sql = ' insert into ' + @tmp_table + ' ( log_id, etc_num1, etc_num3, etc_num4, etc_num5 ) ( select log_id, etc_num1, etc_num3, etc_num4, etc_num5 '
	+ ' from lin2log.dbo.' + @table_from  + ' ( nolock) where log_id = 307 ) '
exec (@sql)


-- insert into report table
-- begin quest report
set @sql = 'insert into ' + RTRIM(@table_to) + ' ( log_date,  race, class, level, quest_id, quest_count  ) ( ' 
	+ ' select ' + CAST(@logdate as varchar) + ', etc_num1, etc_num3, etc_num4, etc_num5, count(log_id)  from '
	+ @tmp_table + ' ( nolock )  group by  etc_num1, etc_num3, etc_num4, etc_num5 ) option (MAXDOP 1 ) '
exec (@sql )

-- drop tmltable
set @sql = ' drop table ' + @tmp_table
exec (@sql)
GO

/********************************************
lin_RPStand
do make stand report

#argument	@table_from	varchar(60)	log table to be a source
#argument	@table_to	varchar(60)	report table to be a destination
#argument	@logdate	int		the date of report to be created
#return
#result_set
#remark		This procedure creates the report by race, sex, class and level
#example	Exec lin_RPStand 'L2004_11_30_log_data_8', 'R2004_11_STAND_8', 20041130
#history	create		young	2003-03-28
#see
********************************************/
ALTER PROCEDURE [DBO].[lin_RPStand]
	@table_from	varchar(60),
	@table_to	varchar(60),
	@logdate	int

AS
SET NOCOUNT ON

declare @sql varchar(4000)

-- check table whether @table_to is exists or not
set @sql = 'select * from lin2report.dbo.sysobjects (nolock) where name = ''' + @table_to + ''''
exec (@sql)

if (@@ROWCOUNT = 0)
begin
	set @sql = 'CREATE TABLE dbo.' + @table_to + ' (' 
		+ ' log_date	int, '
		+ 'log_type	smallint, '
		+ 'log_val	int, '
		+ ' stand_count 	int , '
		+ ' sit_time 	int '
		+ ' ) '
	exec (@sql)

	set @sql = 'CREATE INDEX IX_' + @table_to + '_1 on dbo.' + @table_to + ' (log_date) '
	exec (@sql)
end
else begin
	set @sql = 'delete from dbo.' + @table_to + ' where log_date = ' + CAST(@logdate as varchar)
	exec (@sql)
end

-- check tmp table
declare @tmp_table varchar(512)
set @tmp_table = 'dbo.tmp' + @table_to

set @sql = 'select * from lin2report.dbo.sysobjects (nolock) where name = ''tmp' + @table_to + ''''
exec (@sql)

if (@@ROWCOUNT > 0)
begin
	set @sql = ' drop table dbo.tmp' + @table_to
	exec (@sql)
end

-- make tmptable
set @table_from = replace ( @table_from, 'data0', 'data2' )
set @sql = ' select log_id, etc_num1, etc_num2, etc_num3, etc_num4, etc_num5 into ' + @tmp_table
	+ ' from lin2log.dbo.' + @table_from  + ' ( nolock) where log_id = 822   '
exec (@sql)

set @table_from = replace ( @table_from, 'data2', 'data' )
set @sql = ' insert into ' + @tmp_table + ' ( log_id, etc_num1, etc_num2, etc_num3, etc_num4,  etc_num5 ) ( select log_id,  etc_num1, etc_num2, etc_num3, etc_num4, etc_num5 '
	+ ' from lin2log.dbo.' + @table_from  + ' ( nolock) where log_id = 822 ) '
exec (@sql)


-- insert into report table

-- race L--
set @sql = 'insert into ' + RTRIM(@table_to) + ' ( log_date,  log_type, log_val,  stand_count, sit_time ) ( ' 
	+ ' select ' + CAST(@logdate as varchar) + ', 1, etc_num1,  count( log_id ), sum(etc_num5)  from '
	+ @tmp_table  + ' ( nolock )  group by etc_num1 ) option (MAXDOP 1 ) '
exec (@sql )

-- sex  L--
set @sql = 'insert into ' + RTRIM(@table_to) + ' ( log_date,  log_type, log_val,  stand_count, sit_time ) ( ' 
	+ ' select ' + CAST(@logdate as varchar) + ', 2, etc_num2,  count( log_id ), sum(etc_num5)  from '
	+ @tmp_table  + ' ( nolock )  group by etc_num2 ) option (MAXDOP 1 ) '
exec (@sql )

-- class  L--
set @sql = 'insert into ' + RTRIM(@table_to) + ' ( log_date,  log_type, log_val,  stand_count, sit_time ) ( ' 
	+ ' select ' + CAST(@logdate as varchar) + ', 3, etc_num3,  count( log_id ), sum(etc_num5)  from '
	+ @tmp_table  + ' ( nolock )  group by etc_num3 ) option (MAXDOP 1 ) '
exec (@sql )

-- level  L--
set @sql = 'insert into ' + RTRIM(@table_to) + ' ( log_date,  log_type, log_val,  stand_count, sit_time ) ( ' 
	+ ' select ' + CAST(@logdate as varchar) + ', 4, etc_num4,  count( log_id ), sum(etc_num5)  from '
	+ @tmp_table  + ' ( nolock )  group by etc_num4 ) option (MAXDOP 1 ) '
exec (@sql )

-- drop tmptable
set @sql = ' drop table ' + @tmp_table
exec ( @sql )
GO

/********************************************
lin_RPSellPrivate
do make item sell in private store

#argument	@table_from	varchar(60)	log table to be a source
#argument	@table_to	varchar(60)	report table to be a destination
#argument	@logdate	int		the date of report to be created
#return
#result_set
#remark
#example	Exec lin_RPSellPrivate 'L2004_11_30_log_data_8', 'R2004_11_SELLPRIVATE_8', 20041130
#history	create		young	2003-06-02
#see
********************************************/
ALTER PROCEDURE [DBO].[lin_RPSellPrivate]
	@table_from	varchar(60),
	@table_to	varchar(60),
	@logdate	int

AS
SET NOCOUNT ON

declare @sql varchar(4000)

-- check table whether @table_to is exists or not
set @sql = 'select * from lin2report.dbo.sysobjects (nolock) where name = ''' + @table_to + ''''
exec (@sql)

if (@@ROWCOUNT = 0)
begin
	set @sql = 'CREATE TABLE dbo.' + @table_to + ' (' 
		+ ' log_date	int, '
		+ ' class_id	int,' 
		+ ' level		int, '
		+ ' item_id	int, '
		+ ' enchant_no	int, '
		+ ' sell_count	bigint, '
		+ ' sell_price	bigint '
		+ ' ) '
	exec (@sql)

	set @sql = 'CREATE INDEX IX_' + @table_to + '_1 on dbo.' + @table_to + ' (log_date) '
	exec (@sql)
end
else begin
	set @sql = 'delete from dbo.' + @table_to + ' where log_date = ' + CAST(@logdate as varchar)
	exec (@sql)
end

-- check tmp table
declare @tmp_table varchar(512)
set @tmp_table = 'dbo.tmp' + @table_to

set @sql = 'select * from lin2report.dbo.sysobjects (nolock) where name = ''tmp' + @table_to + ''''
exec (@sql)

if (@@ROWCOUNT > 0)
begin
	set @sql = ' drop table dbo.tmp' + @table_to
	exec (@sql)
end

-- make tmptable
set @table_from = replace ( @table_from, 'data0', 'data2' )
set @sql = ' select log_id, etc_num3, etc_num4, etc_num7, etc_num8, etc_num9, etc_num10 into ' + @tmp_table
	+ ' from lin2log.dbo.' + @table_from  + ' ( nolock) where log_id = 931 and etc_num8 <> 57   '
exec (@sql)

set @table_from = replace ( @table_from, 'data2', 'data' )
set @sql = ' insert into ' + @tmp_table + ' ( log_id, etc_num3, etc_num4, etc_num7, etc_num8, etc_num9, etc_num10 ) ( select log_id, etc_num3, etc_num4, etc_num7, etc_num8, etc_num9, etc_num10 '
	+ ' from lin2log.dbo.' + @table_from  + ' ( nolock) where log_id = 931 and etc_num8 <> 57 ) '
exec (@sql)

-- insert into report table

-- +T  item
set @sql = 'insert into ' + RTRIM(@table_to) + ' ( log_date, class_id, level, item_id, enchant_no, sell_count, sell_price  ) ( ' 
	+ ' select ' + CAST(@logdate as varchar) + ', etc_num3, etc_num4, etc_num8, etc_num7, sum( cast ( etc_num9 as bigint ) ) , sum( cast ( etc_num10 * etc_num9  as bigint ) )  from '
	+ @tmp_table + ' ( nolock ) group by etc_num3, etc_num4, etc_num8, etc_num7 )  option (MAXDOP 1 ) '
exec (@sql )

set @sql = ' drop table ' + @tmp_table
exec (@sql)
GO

/********************************************
lin_RPSayCount
do make say count report

#argument	@table_from	varchar(60)	log table to be a source
#argument	@table_to	varchar(60)	report table to be a destination
#argument	@logdate	int		the date of report to be created
#return
#result_set
#remark
#example	Exec lin_RPSayCount 'L2004_11_30_log_data_8', 'R2004_11_SAYCOUNT_8', 20041130
#history	create		young	2003-09-03
#see
********************************************/
ALTER PROCEDURE [DBO].[lin_RPSayCount]
	@table_from	varchar(60),
	@table_to	varchar(60),
	@logdate	int

AS
SET NOCOUNT ON

declare @sql varchar(4000)

-- check table whether @table_to is exists or not
set @sql = 'select * from lin2report.dbo.sysobjects (nolock) where name = ''' + @table_to + ''''
exec (@sql)

if (@@ROWCOUNT = 0)
begin
	set @sql = 'CREATE TABLE dbo.' + @table_to + ' (' 
		+ ' log_date	int, '
		+ ' log_time	datetime, '
		+ ' say_count	int, '
		+ ' say_size	int  '
		+ ' ) '
	exec (@sql)

	set @sql = 'CREATE INDEX IX_' + @table_to + '_1 on dbo.' + @table_to + ' (log_date) '
	exec (@sql)
end
else begin
	set @sql = 'delete from dbo.' + @table_to + ' where log_date = ' + CAST(@logdate as varchar)
	exec (@sql)
end

-- check tmp table
declare @tmp_table varchar(512)
set @tmp_table = 'dbo.tmp' + @table_to

set @sql = 'select * from lin2report.dbo.sysobjects (nolock) where name = ''tmp' + @table_to + ''''
exec (@sql)

if (@@ROWCOUNT > 0)
begin
	set @sql = ' drop table dbo.tmp' + @table_to
	exec (@sql)
end

-- make tmptable
set @table_from = replace ( @table_from, 'data0', 'data2' )
set @sql = ' select log_id, act_time, etc_num1, etc_num2  into ' + @tmp_table
	+ ' from lin2log.dbo.' + @table_from  + ' ( nolock) where log_id = 832  '
exec (@sql)

set @table_from = replace ( @table_from, 'data2', 'data' )
set @sql = ' insert into ' + @tmp_table + ' ( log_id, act_time, etc_num1, etc_num2 ) ( select log_id, act_time, etc_num1, etc_num2 '
	+ ' from lin2log.dbo.' + @table_from  + ' ( nolock) where log_id = 832 ) '
exec (@sql)


-- insert into report table
-- levelup report
set @sql = 'insert into ' + RTRIM(@table_to) + ' ( log_date,  log_time, say_count, say_size   ) ( ' 
	+ ' select ' + CAST(@logdate as varchar) + ', act_time, etc_num1, etc_num2  from '
	+ @tmp_table + ' ( nolock )  )  option (MAXDOP 1 ) '

exec (@sql )

-- drop tmptable
set @sql = ' drop table ' + @tmp_table
exec (@sql)
GO

/********************************************
lin_RPRecipe
do make recipe  report

#argument	@table_from	varchar(60)	log table to be a source
#argument	@table_to	varchar(60)	report table to be a destination
#argument	@logdate	int		the date of report to be created
#return
#result_set
#remark
#example	Exec lin_RPRecipe 'L2004_11_30_log_data_8', 'R2004_11_RECIPE_8', 20041130
#history	create		young	2003-09-03
#see
********************************************/
ALTER PROCEDURE [DBO].[lin_RPRecipe]
	@table_from	varchar(60),
	@table_to	varchar(60),
	@logdate	int

AS
SET NOCOUNT ON

declare @sql varchar(4000)

-- check table whether @table_to is exists or not
set @sql = 'select * from lin2report.dbo.sysobjects (nolock) where name = ''' + @table_to + ''''
exec (@sql)

if (@@ROWCOUNT = 0)
begin
	set @sql = 'CREATE TABLE dbo.' + @table_to + ' (' 
		+ ' log_date	int, '
		+ ' item_type	int, '
		+ ' user_class	int, '
		+ ' user_level	int, '
		+ ' item_count	int, '
		+ ' item_amount	int '
		+ ' ) '
	exec (@sql)

	set @sql = 'CREATE INDEX IX_' + @table_to + '_1 on dbo.' + @table_to + ' (log_date) '
	exec (@sql)
end
else begin
	set @sql = 'delete from dbo.' + @table_to + ' where log_date = ' + CAST(@logdate as varchar)
	exec (@sql)
end

-- check tmp table
declare @tmp_table varchar(512)
set @tmp_table = 'dbo.tmp' + @table_to

set @sql = 'select * from lin2report.dbo.sysobjects (nolock) where name = ''tmp' + @table_to + ''''
exec (@sql)

if (@@ROWCOUNT > 0)
begin
	set @sql = ' drop table dbo.tmp' + @table_to
	exec (@sql)
end

-- make tmptable
set @table_from = replace ( @table_from, 'data0', 'data2' )
set @sql = ' select log_id, etc_num8, etc_num3, etc_num4, etc_num9  into ' + @tmp_table
	+ ' from lin2log.dbo.' + @table_from  + ' ( nolock) where log_id = 935  '
exec (@sql)

set @table_from = replace ( @table_from, 'data2', 'data' )
set @sql = ' insert into ' + @tmp_table + ' ( log_id, etc_num8, etc_num3, etc_num4, etc_num9 ) ( select log_id, etc_num8, etc_num3, etc_num4, etc_num9 '
	+ ' from lin2log.dbo.' + @table_from  + ' ( nolock) where log_id = 935 ) '
exec (@sql)



-- insert into report table
-- levelup report
set @sql = 'insert into ' + RTRIM(@table_to) + ' ( log_date,  item_type, user_class, user_level, item_count, item_amount  ) ( ' 
	+ ' select ' + CAST(@logdate as varchar) + ', etc_num8, etc_num3, etc_num4, count(log_id), sum( etc_num9 ) from '
	+ @tmp_table + ' ( nolock )  group by etc_num8, etc_num3, etc_num4  )  option (MAXDOP 1 ) '

exec (@sql )


-- drop tmptable
set @sql = ' drop table ' + @tmp_table
exec ( @sql )
GO

/********************************************
lin_RPPrivateStore
do make a report that shows soloing time and count

#argument	@table_from	varchar(60)	log table to be a source
#argument	@table_to	varchar(60)	report table to be a destination
#argument	@logdate	int		the date of report to be created
#return
#result_set
#remark
#example	Exec lin_RPPrivateStore 'L2004_11_30_log_data_8', 'R2004_11_PRIVATESTORE_8', 20041130
#history	create	young	2003-11-18
#see
********************************************/
ALTER PROCEDURE [DBO].[lin_RPPrivateStore]
	@table_from	varchar(60),
	@table_to	varchar(60),
	@logdate	int

AS
SET NOCOUNT ON

declare @sql varchar(4000)

-- check table whether @table_to is exists or not
set @sql = 'select * from lin2report.dbo.sysobjects (nolock) where name = ''' + @table_to + ''''
exec (@sql)

if (@@ROWCOUNT = 0)
begin
	set @sql = 'CREATE TABLE dbo.' + @table_to + ' (' 
		+ ' log_date	int, '
		+ ' race		int, '
		+ ' class		int, '
		+ ' level		int, '
		+ ' private_count		int, '
		+ ' private_time	 	int'
		+ ' ) '
	exec (@sql)

	set @sql = 'CREATE INDEX IX_' + @table_to + '_1 on dbo.' + @table_to + ' (log_date) '
	exec (@sql)
end
else begin
	set @sql = 'delete from dbo.' + @table_to + ' where log_date = ' + CAST(@logdate as varchar)
	exec (@sql)
end

-- check tmp table
declare @tmp_table varchar(512)
set @tmp_table = 'dbo.tmp' + @table_to

set @sql = 'select * from lin2report.dbo.sysobjects (nolock) where name = ''tmp' + @table_to + ''''
exec (@sql)

if (@@ROWCOUNT > 0)
begin
	set @sql = ' drop table dbo.tmp' + @table_to
	exec (@sql)
end

-- make tmptable
set @table_from = replace ( @table_from, 'data0', 'data2' )
set @sql = ' select log_id, etc_num1, etc_num2, etc_num3, etc_num4, etc_num5 into ' + @tmp_table
	+ ' from lin2log.dbo.' + @table_from  + ' ( nolock) where log_id = 838  '
exec (@sql)

set @table_from = replace ( @table_from, 'data2', 'data' )
set @sql = ' insert into ' + @tmp_table + ' ( log_id, etc_num1, etc_num2, etc_num3, etc_num4, etc_num5 ) ( select log_id, etc_num1, etc_num2, etc_num3, etc_num4, etc_num5 '
	+ ' from lin2log.dbo.' + @table_from  + ' ( nolock) where log_id = 838 ) '
exec (@sql)

	-- race - T +T NPC-
	set @sql = 'insert into ' + RTRIM(@table_to) + ' ( log_date,  race, class, level, private_count, private_time ) ( ' 
		+ ' select ' + CAST(@logdate as varchar) + ', etc_num1, etc_num3, etc_num4, count(etc_num1), sum(etc_num5)   from  '
		+ @tmp_table  + ' ( nolock )  group by etc_num1, etc_num3, etc_num4 )  option (MAXDOP 1 ) '
	exec (@sql )

-- drop tmptable
set @sql = 'drop table ' + @tmp_table
exec ( @sql )
GO

/********************************************
lin_RPPledgeUp
do make pledge level up report

#argument	@table_from	varchar(60)	log table to be a source
#argument	@table_to	varchar(60)	report table to be a destination
#argument	@logdate	int		the date of report to be created
#return
#result_set
#remark
#example	Exec lin_RPPledgeUp 'L2004_11_30_log_data_8', 'R2004_11_PLEDGEUP_8', 20041130
#history	create		young	2004-02-25
#see
********************************************/
ALTER PROCEDURE [DBO].[lin_RPPledgeUp]
	@table_from	varchar(60),
	@table_to	varchar(60),
	@logdate	int

AS
SET NOCOUNT ON

declare @sql varchar(4000)

-- check table whether @table_to is exists or not
set @sql = 'select * from lin2report.dbo.sysobjects (nolock) where name = ''' + @table_to + ''''
exec (@sql)

if (@@ROWCOUNT = 0)
begin
	set @sql = 'CREATE TABLE dbo.' + @table_to + ' (' 
		+ ' log_date	int, '
		+ ' lev		smallint, '
		+ ' lev_count	int '
		+ ' ) '
	exec (@sql)

	set @sql = 'CREATE INDEX IX_' + @table_to + '_1 on dbo.' + @table_to + ' (log_date) '
	exec (@sql)
end
else begin
	set @sql = 'delete from dbo.' + @table_to + ' where log_date = ' + CAST(@logdate as varchar)
	exec (@sql)
end


-- insert into report table

-- race L--
set @sql = 'insert into ' + RTRIM(@table_to) + ' ( log_date,  lev, lev_count ) ( ' 
	+ ' select ' + CAST(@logdate as varchar) + ', etc_num7, count( etc_num7)  from '
	+ ' lin2log.dbo.' + @table_from  + ' ( nolock )  where log_id = 215 and etc_num6 = 5 group by etc_num7 ) option (MAXDOP 1 ) '

exec (@sql )
GO

/********************************************
lin_RPPlayStat
do make player report

#argument	@table_from	varchar(60)	log table to be a source
#argument	@table_to	varchar(60)	report table to be a destination
#argument	@logdate	int		the date of report to be created
#return
#result_set
#remark
#example	Exec lin_RPPlayStat 'L2004_11_30_log_data_8', 'R2004_11_PLAYSTAT_8', 20041130
#history	create		young	2004-02-25
#see
********************************************/
ALTER PROCEDURE [DBO].[lin_RPPlayStat]
	@table_from	varchar(60),
	@table_to	varchar(60),
	@logdate	int

AS
SET NOCOUNT ON

declare @sql varchar(4000)

-- check table whether @table_to is exists or not
set @sql = 'select * from lin2report.dbo.sysobjects (nolock) where name = ''' + @table_to + ''''
exec (@sql)

if (@@ROWCOUNT = 0)
begin
	set @sql = 'CREATE TABLE dbo.' + @table_to + ' (' 
		+ ' log_date	int, '
		+ ' snap_hour	smallint, '
		+ ' snap_level	smallint, '
		+ ' snap_count	int'
		+ ' ) '
	exec (@sql)

	set @sql = 'CREATE INDEX IX_' + @table_to + '_1 on dbo.' + @table_to + ' (log_date) '
	exec (@sql)
end
else begin
	set @sql = 'delete from dbo.' + @table_to + ' where log_date = ' + CAST(@logdate as varchar)
	exec (@sql)
end


-- insert into report table

-- race L--
set @sql = 'insert into ' + RTRIM(@table_to) + ' ( log_date,  snap_hour, snap_level, snap_count ) ( ' 
	+ ' select ' + CAST(@logdate as varchar) + ', datepart ( hh, act_time), etc_num5, count ( distinct ( actor ))  from '
	+ ' lin2log.dbo.' + @table_from  + ' ( nolock )  where log_id = 812 and datepart ( mi, act_time ) < 20  group by datepart( hh, act_time), etc_num5 ) option (MAXDOP 1 ) '

exec (@sql )
GO

/********************************************
lin_RPPCKillPC
do make pc kill pc  stats

#argument	@table_from	varchar(60)	log table to be a source
#argument	@table_to	varchar(60)	report table to be a destination
#argument	@logdate	int		the date of report to be created
#return
#result_set
#remark
#example	Exec lin_RPPCKillPC 'L2004_11_30_log_data_8', 'R2004_11_PCKILLPC_8', 20041130
#history	create		young	2004-02-26
#see
********************************************/
ALTER PROCEDURE [DBO].[lin_RPPCKillPC]
	@table_from	varchar(60),
	@table_to	varchar(60),
	@logdate	int

AS
SET NOCOUNT ON

declare @sql varchar(4000)

-- check table whether @table_to is exists or not
set @sql = 'select * from lin2report.dbo.sysobjects (nolock) where name = ''' + @table_to + ''''
exec (@sql)

if (@@ROWCOUNT = 0)
begin
	set @sql = 'CREATE TABLE dbo.' + @table_to + ' (' 
		+ ' log_date	int, '
		+ ' kill_type	smallint, '
		+ ' char_count	int, '
		+ ' kill_count	int '
		+ ' ) '
	exec (@sql)

	set @sql = 'CREATE INDEX IX_' + @table_to + '_1 on dbo.' + @table_to + ' (log_date) '
	exec (@sql)
end
else begin
	set @sql = 'delete from dbo.' + @table_to + ' where log_date = ' + CAST(@logdate as varchar)
	exec (@sql)
end


	set @sql = 'insert into ' + RTRIM(@table_to) + ' ( log_date,  kill_type, char_count, kill_count ) ( ' 
		+ ' select ' + CAST(@logdate as varchar) + ', 0, count ( distinct ( actor)  ) , count ( actor )  from '
		+ 'lin2log.dbo.' + @table_from + '  ( nolock )  where log_id = 1111  )  option (MAXDOP 1 ) '
	exec (@sql )


	set @sql = 'insert into ' + RTRIM(@table_to) + ' ( log_date,  kill_type, char_count, kill_count ) ( ' 
		+ ' select ' + CAST(@logdate as varchar) + ', 1, count ( distinct ( target )  ) , count ( target )  from '
		+ 'lin2log.dbo.' + @table_from + '  ( nolock )  where log_id = 1111  )  option (MAXDOP 1 ) '
	exec (@sql )

	set @sql = 'insert into ' + RTRIM(@table_to) + ' ( log_date,  kill_type, char_count, kill_count ) ( ' 
		+ ' select ' + CAST(@logdate as varchar) + ', 2, count ( distinct ( actor)  ) , count ( actor )  from '
		+ 'lin2log.dbo.' + @table_from + '  ( nolock )  where log_id = 1111  and etc_num6 > 0 )  option (MAXDOP 1 ) '
	exec (@sql )

	set @sql = 'insert into ' + RTRIM(@table_to) + ' ( log_date,  kill_type, char_count, kill_count ) ( ' 
		+ ' select ' + CAST(@logdate as varchar) + ', 3, count ( distinct ( target )  ) , count ( target )  from '
		+ 'lin2log.dbo.' + @table_from + '  ( nolock )  where log_id = 1111  and etc_num6 > 0 )  option (MAXDOP 1 ) '
	exec (@sql )
GO

/******************************************************************************
#Name:	lin_RPPCKillNPC
#Desc:	do make pc kill npc report ( processed data )

#Argument:
	Input:	@table_from	varchar(60)	log view: Lyyyy_mm_dd_Log_Data0_world
		@table_to	varchar(60)	report table: RPAdenaIncDec_world
		@logdate	int		report date
	Output:	
#Return:
#Result Set:

#Remark:
#Example:	Exec lin_RPPCKillNPC 'L2004_11_30_log_data_8', 'R2004_11_PCKILLNPC_8', 20041130
#See:

#History:
	Create	young	2003-04-01
	Modify	btwinuni	2005-06-26	modify index
******************************************************************************/
ALTER PROCEDURE [DBO].[lin_RPPCKillNPC]
	@table_from	varchar(60),
	@table_to	varchar(60),
	@logdate	int

AS
SET NOCOUNT ON

declare @sql varchar(4000)

-- check table whether @table_to is exists or not
set @sql = 'select * from lin2report.dbo.sysobjects (nolock) where name = ''' + @table_to + ''''
exec (@sql)

if (@@ROWCOUNT = 0)
begin
	set @sql = 'CREATE TABLE dbo.' + @table_to + ' (' 
		+ ' log_date	int, '
		+ ' target_account	int , '
		+ ' x		smallint, '
		+ ' y		smallint, '
		+ ' z		smallint, '
		+ ' race		tinyint, ' 
		+ ' class		tinyint, '
		+ ' pc_level	tinyint, '
		+ ' npc_level	tinyint, '
		+ ' time2die	smallint, ' 
		+ ' kill_count	int  '
		+ ' ) '
	exec (@sql)

	set @sql = 'CREATE CLUSTERED INDEX IX_' + @table_to + '_1 on dbo.' + @table_to + ' (log_date, x, y)  WITH FILLFACTOR = 90  '
	exec (@sql)
end
else begin
	set @sql = 'delete from dbo.' + @table_to + ' where log_date = ' + CAST(@logdate as varchar)
	exec (@sql)
end

-- check tmp table
declare @tmp_table varchar(512)
set @tmp_table = 'dbo.tmp' + @table_to

set @sql = 'select * from lin2report.dbo.sysobjects (nolock) where name = ''tmp' + @table_to + ''''
exec (@sql)

if (@@ROWCOUNT > 0)
begin
	set @sql = ' drop table dbo.tmp' + @table_to
	exec (@sql)
end

-- make tmptable
set @table_from = replace ( @table_from, 'data0', 'data2' )
set @sql = ' select target_account, location_x, location_y, location_z, etc_num1, etc_num3, etc_num4, etc_num7, etc_num10 into ' + @tmp_table
	+ ' from lin2log.dbo.' + @table_from  + ' ( nolock) where log_id = 1112  '
exec (@sql)

set @table_from = replace ( @table_from, 'data2', 'data' )
set @sql = ' insert into ' + @tmp_table + ' ( target_account, location_x, location_y, location_z, etc_num1, etc_num3, etc_num4, etc_num7, etc_num10 ) '
	+ ' ( select target_account, location_x, location_y, location_z, etc_num1, etc_num3, etc_num4, etc_num7 , etc_num10 '
	+ ' from lin2log.dbo.' + @table_from  + ' ( nolock) where log_id = 1112  ) '
exec (@sql)


-- insert into report table

set @sql = 'insert into ' + RTRIM(@table_to) + ' ( log_date, target_account, x, y, z, race, class, pc_level, npc_level , time2die, kill_count ) ( ' 
	+ ' select ' + CAST(@logdate as varchar) + ', target_account, R_loc_x , R_loc_y , 0, etc_num1, etc_num3, etc_num4, avg(etc_num7), 0 , count( distinct ( etc_num10 ) ) from '
	+ ' ( select R_log_id = 1112, target_account, R_loc_x = FLOOR(location_x / 1024.0), R_loc_y = FLOOR(location_y / 1024.0) , etc_num1, etc_num3, etc_num4, etc_num7 , etc_num10 from '
	+ @tmp_table + ' ( nolock )  ) as R1 group by  target_account, R_loc_x , R_loc_y, etc_num1, etc_num3, etc_num4 )  option (MAXDOP 1 ) '
exec (@sql )

-- drop tmptable
set @sql = ' drop table ' + @tmp_table
exec (@sql)
GO

/********************************************
lin_RPNPCDropLoc
do make NPC drop item for each map location report

#argument	@table_from	varchar(60)	log table to be a source
#argument	@table_to	varchar(60)	report table to be a destination
#argument	@logdate	int		the date of report to be created
#return
#result_set
#remark
#example	Exec lin_RPNPCDropLoc 'L2004_11_30_log_data_8', 'R2004_11_NPCDROPLOC_8', 20041130
#history	create		young	2003-03-17
#see
********************************************/
ALTER PROCEDURE [DBO].[lin_RPNPCDropLoc]
	@table_from	varchar(60),
	@table_to	varchar(60),
	@logdate	int

AS
SET NOCOUNT ON

declare @sql varchar(4000)

-- check table whether @table_to is exists or not
set @sql = 'select * from lin2report.dbo.sysobjects (nolock) where name = ''' + @table_to + ''''
exec (@sql)

if (@@ROWCOUNT = 0)
begin
	set @sql = 'CREATE TABLE dbo.' + @table_to + ' (' 
		+ ' log_date	int, '
		+ ' map_x	tinyint, '
		+ ' map_y	tinyint, '
		+ ' map_z	tinyint, '
		+ ' item_type	int, '
		+ ' drop_amount	int '
		+ ' ) '
	exec (@sql)

	set @sql = 'CREATE INDEX IX_' + @table_to + '_1 on dbo.' + @table_to + ' (log_date) '
	exec (@sql)
end
else begin
	set @sql = 'delete from dbo.' + @table_to + ' where log_date = ' + CAST(@logdate as varchar)
	exec (@sql)
end

-- check tmp table
declare @tmp_table varchar(512)
set @tmp_table = 'dbo.tmp' + @table_to

set @sql = 'select * from lin2report.dbo.sysobjects (nolock) where name = ''tmp' + @table_to + ''''
exec (@sql)

if (@@ROWCOUNT > 0)
begin
	set @sql = ' drop table dbo.tmp' + @table_to
	exec (@sql)
end



-- make tmptable
set @table_from = replace ( @table_from, 'data0', 'data2' )
set @sql = ' select log_id, location_x, location_y, etc_num8, etc_num9 into ' + @tmp_table
	+ ' from lin2log.dbo.' + @table_from  + ' ( nolock) where log_id = 912  and act_time > ''2003/10/29 10:0:0'' '
exec (@sql)

set @sql = ' insert into ' + @tmp_table + ' ( log_id, location_x, location_y, etc_num8, etc_num9 ) ( select log_id, location_x, location_y, etc_num7, etc_num8 '
	+ ' from lin2log.dbo.' + @table_from  + ' ( nolock) where log_id = 912  and act_time < ''2003/10/29 10:0:0'' ) '
exec (@sql)

set @table_from = replace ( @table_from, 'data2', 'data' )
set @sql = ' insert into ' + @tmp_table + ' ( log_id, location_x, location_y, etc_num8, etc_num9 ) ( select log_id, location_x, location_y, etc_num8, etc_num9 '
	+ ' from lin2log.dbo.' + @table_from  + ' ( nolock) where log_id = 912 and act_time > ''2003/10/29 10:0:0''  ) '
exec (@sql)

set @sql = ' insert into ' + @tmp_table + ' ( log_id, location_x, location_y, etc_num8, etc_num9 ) ( select log_id, location_x, location_y, etc_num7, etc_num8 '
	+ ' from lin2log.dbo.' + @table_from  + ' ( nolock) where log_id = 912  and act_time < ''2003/10/29 10:0:0'' ) '
exec (@sql)

-- insert into report table

-- npc drop
set @sql = 'insert into ' + RTRIM(@table_to) + ' ( log_date,  map_x, map_y,  item_type, drop_amount ) ( ' 
	+ ' select ' + CAST(@logdate as varchar) + ', 20 + floor(location_x / 32768.0) , 18 + floor(location_y / 32768.0) , etc_num8, sum(etc_num9)  from '
	+ @tmp_table + ' group by 20 + floor(location_x / 32768.0), 18 + floor(location_y / 32768.0), etc_num8 )  option (MAXDOP 1 ) '
exec (@sql )

-- drop tmptable
set @sql = ' drop table ' + @tmp_table
exec (@sql)
GO

/********************************************
lin_RPNPCDropItem
do make NPC drop item report

#argument	@table_from	varchar(60)	log table to be a source
#argument	@table_to	varchar(60)	report table to be a destination
#argument	@logdate	int		the date of report to be created
#return
#result_set
#remark
#example	Exec lin_RPNPCDropItem 'L2004_11_30_log_data_8', 'R2004_11_NPCDROPITEM_8', 20041130
#history	create		young	2003-03-17
#see
********************************************/
ALTER PROCEDURE [DBO].[lin_RPNPCDropItem]
	@table_from	varchar(60),
	@table_to	varchar(60),
	@logdate	int

AS
SET NOCOUNT ON

declare @sql varchar(4000)

-- check table whether @table_to is exists or not
set @sql = 'select * from lin2report.dbo.sysobjects (nolock) where name = ''' + @table_to + ''''
exec (@sql)

if (@@ROWCOUNT = 0)
begin
	set @sql = 'CREATE TABLE dbo.' + @table_to + ' (' 
		+ ' log_date	int, '
		+ ' item_type	int, '
		+ ' npc_id	int, '
		+ ' drop_count	int, '
		+ ' drop_amount	money '
		+ ' ) '
	exec (@sql)

	set @sql = 'CREATE INDEX IX_' + @table_to + '_1 on dbo.' + @table_to + ' (log_date) '
	exec (@sql)
end
else begin
	set @sql = 'delete from dbo.' + @table_to + ' where log_date = ' + CAST(@logdate as varchar)
	exec (@sql)
end


-- check tmp table
declare @tmp_table varchar(512)
set @tmp_table = 'dbo.tmp' + @table_to

set @sql = 'select * from lin2report.dbo.sysobjects (nolock) where name = ''tmp' + @table_to + ''''
exec (@sql)

if (@@ROWCOUNT > 0)
begin
	set @sql = ' drop table dbo.tmp' + @table_to
	exec (@sql)
end




-- make tmptable
set @table_from = replace ( @table_from, 'data0', 'data2' )
set @sql = ' select log_id, actor_account, etc_num8, etc_num9 into ' + @tmp_table
	+ ' from lin2log.dbo.' + @table_from  + ' ( nolock) where log_id = 912  and act_time > ''2003/10/29 10:0:0'' '
exec (@sql)

set @sql = ' insert into ' + @tmp_table + ' ( log_id, actor_account, etc_num8, etc_num9 ) ( select log_id, actor_account, etc_num7, etc_num8 '
	+ ' from lin2log.dbo.' + @table_from  + ' ( nolock) where log_id = 912  and act_time < ''2003/10/29 10:0:0'' ) '
exec (@sql)

set @table_from = replace ( @table_from, 'data2', 'data' )
set @sql = ' insert into ' + @tmp_table + ' ( log_id, actor_account, etc_num8, etc_num9 ) ( select log_id, actor_account, etc_num8, etc_num9 '
	+ ' from lin2log.dbo.' + @table_from  + ' ( nolock) where log_id = 912 and act_time > ''2003/10/29 10:0:0''  ) '
exec (@sql)

set @sql = ' insert into ' + @tmp_table + ' ( log_id, actor_account, etc_num8, etc_num9 ) ( select log_id, actor_account, etc_num7, etc_num8 '
	+ ' from lin2log.dbo.' + @table_from  + ' ( nolock) where log_id = 912  and act_time < ''2003/10/29 10:0:0'' ) '
exec (@sql)


-- insert into report table

set @sql = 'insert into ' + RTRIM(@table_to) + ' ( log_date,  item_type, npc_id, drop_count, drop_amount ) ( ' 
	+ ' select ' + CAST(@logdate as varchar) + ', etc_num8, actor_account, count(log_id), sum(etc_num9)   from '
	+ @tmp_table + ' ( nolock )  group by etc_num8 , actor_account )  option (MAXDOP 1 ) '

exec (@sql )

-- drop tmptable
set @sql = ' drop table ' + @tmp_table
exec (@sql )
GO

/********************************************
lin_RPNPCDrop2
do make a NPC drop item report

#argument	@table_from	varchar(60)	log table to be a source
#argument	@table_to	varchar(60)	report table to be a destination
#argument	@logdate	int		the date of report to be created
#return
#result_set
#remark
#example	Exec lin_RPNPCDrop2 'L2004_11_30_log_data_8', 'R2004_11_NPCDROP2_8', 20041130
#history	create		young	2003-03-19
#see		lin_RPNPCDrop
********************************************/
ALTER PROCEDURE [DBO].[lin_RPNPCDrop2]
	@table_from	varchar(60),
	@table_to	varchar(60),
	@logdate	int

AS
SET NOCOUNT ON

declare @sql varchar(4000)

-- check table whether @table_to is exists or not
set @sql = 'select * from lin2report.dbo.sysobjects (nolock) where name = ''' + @table_to + ''''
exec (@sql)

if (@@ROWCOUNT = 0)
begin
	set @sql = 'CREATE TABLE dbo.' + @table_to + ' (' 
		+ ' log_date	int, '
		+ ' npc_id	int,'
		+ ' item_id	int, '
		+ ' item_sum	money '
		+ ' ) '
	exec (@sql)

	set @sql = 'CREATE INDEX IX_' + @table_to + '_1 on dbo.' + @table_to + ' (log_date) '
	exec (@sql)
end
else begin
	set @sql = 'delete from dbo.' + @table_to + ' where log_date = ' + CAST(@logdate as varchar)
	exec (@sql)
end

-- check tmp table
declare @tmp_table varchar(512)
set @tmp_table = 'dbo.tmp' + @table_to

set @sql = 'select * from lin2report.dbo.sysobjects (nolock) where name = ''tmp' + @table_to + ''''
exec (@sql)

if (@@ROWCOUNT > 0)
begin
	set @sql = ' drop table dbo.tmp' + @table_to
	exec (@sql)
end

-- make tmptable
set @table_from = replace ( @table_from, 'data0', 'data2' )
set @sql = ' select log_id, actor_account, etc_num8, etc_num9 into ' + @tmp_table
	+ ' from lin2log.dbo.' + @table_from  + ' ( nolock) where log_id = 912  and act_time > ''2003/10/29 10:0:0'' '
exec (@sql)

set @sql = ' insert into ' + @tmp_table + ' ( log_id, actor_account, etc_num8, etc_num9 ) ( select log_id, actor_account, etc_num7, etc_num8 '
	+ ' from lin2log.dbo.' + @table_from  + ' ( nolock) where log_id = 912  and act_time < ''2003/10/29 10:0:0'' ) '
exec (@sql)

set @table_from = replace ( @table_from, 'data2', 'data' )
set @sql = ' insert into ' + @tmp_table + ' ( log_id, actor_account, etc_num8, etc_num9 ) ( select log_id, actor_account, etc_num8, etc_num9 '
	+ ' from lin2log.dbo.' + @table_from  + ' ( nolock) where log_id = 912 and act_time > ''2003/10/29 10:0:0''  ) '
exec (@sql)

set @sql = ' insert into ' + @tmp_table + ' ( log_id, actor_account, etc_num8, etc_num9 ) ( select log_id, actor_account, etc_num7, etc_num8 '
	+ ' from lin2log.dbo.' + @table_from  + ' ( nolock) where log_id = 912  and act_time < ''2003/10/29 10:0:0'' ) '
exec (@sql)

-- insert into report table

-- 
set @sql = 'insert into ' + RTRIM(@table_to) + ' ( log_date,  npc_id, item_id, item_sum ) ( ' 
	+ ' select ' + CAST(@logdate as varchar) + ', actor_account, etc_num8, sum(etc_num9 )  from '
	+ @tmp_table + ' ( nolock ) group by actor_account, etc_num8 )  option (MAXDOP 1 ) '
exec (@sql )

-- drop tmptable
set @sql = ' drop table ' + @tmp_table
exec ( @sql )
GO

/********************************************
lin_RPNPCDrop
do make all NPC drop item report

#argument	@table_from	varchar(60)	log table to be a source
#argument	@table_to	varchar(60)	report table to be a destination
#argument	@logdate	int		the date of report to be created
#return
#result_set
#remark
#example	Exec lin_RPNPCDrop 'L2004_11_30_log_data_8', 'R2004_11_NPCDROP_8', 20041130
#history	create		young	2003-03-17
#see		lin_RPNPCDrop2
********************************************/
ALTER  PROCEDURE [DBO].[lin_RPNPCDrop]
	@table_from	varchar(60),
	@table_to	varchar(60),
	@logdate	int

AS
SET NOCOUNT ON

declare @sql varchar(4000)

-- check table whether @table_to is exists or not
set @sql = 'select * from lin2report.dbo.sysobjects (nolock) where name = ''' + @table_to + ''''
exec (@sql)

if (@@ROWCOUNT = 0)
begin
	set @sql = 'CREATE TABLE dbo.' + @table_to + ' (' 
		+ ' log_date	int, '
		+ ' item_id	int, '
		+ ' item_sum	money '
		+ ' ) '
	exec (@sql)

	set @sql = 'CREATE INDEX IX_' + @table_to + '_1 on dbo.' + @table_to + ' (log_date) '
	exec (@sql)
end
else begin
	set @sql = 'delete from dbo.' + @table_to + ' where log_date = ' + CAST(@logdate as varchar)
	exec (@sql)
end

-- check tmp table
declare @tmp_table varchar(512)
set @tmp_table = 'dbo.tmp' + @table_to

set @sql = 'select * from lin2report.dbo.sysobjects (nolock) where name = ''tmp' + @table_to + ''''
exec (@sql)

if (@@ROWCOUNT > 0)
begin
	set @sql = ' drop table dbo.tmp' + @table_to
	exec (@sql)
end

-- make tmptable
set @table_from = replace ( @table_from, 'data0', 'data2' )
set @sql = ' select log_id, actor_account, etc_num8, etc_num9 into ' + @tmp_table
	+ ' from lin2log.dbo.' + @table_from  + ' ( nolock) where log_id = 912  and act_time > ''2003/10/29 10:0:0'' '
exec (@sql)

set @sql = ' insert into ' + @tmp_table + ' ( log_id, actor_account, etc_num8, etc_num9 ) ( select log_id, actor_account, etc_num7, etc_num8 '
	+ ' from lin2log.dbo.' + @table_from  + ' ( nolock) where log_id = 912 and act_time < ''2003/10/29 10:0:0''  ) '
exec (@sql)

set @table_from = replace ( @table_from, 'data2', 'data' )
set @sql = ' insert into ' + @tmp_table + ' ( log_id, actor_account, etc_num8, etc_num9 ) ( select log_id, actor_account, etc_num8, etc_num9 '
	+ ' from lin2log.dbo.' + @table_from  + ' ( nolock) where log_id = 912 and act_time > ''2003/10/29 10:0:0''  ) '
exec (@sql)

set @sql = ' insert into ' + @tmp_table + ' ( log_id, actor_account, etc_num8, etc_num9 ) ( select log_id, actor_account, etc_num7, etc_num8 '
	+ ' from lin2log.dbo.' + @table_from  + ' ( nolock) where log_id = 912 and act_time < ''2003/10/29 10:0:0''  ) '
exec (@sql)

-- insert into report table

-- +- -+-+L +- LL
set @sql = 'insert into ' + RTRIM(@table_to) + ' ( log_date,  item_id, item_sum ) ( ' 
	+ ' select ' + CAST(@logdate as varchar) + ', etc_num8, sum(cast(etc_num9 as money))  from '
	+ @tmp_table  + ' ( nolock )  group by etc_num8 )  option (MAXDOP 1 ) '
exec (@sql )

-- drop tmptable
set @sql = ' drop table ' + @tmp_table
exec (@sql)
GO

/********************************************
lin_RPLevUp2
do make levelup2 report ( more accurate )

#argument	@table_from	varchar(60)	log table to be a source
#argument	@table_to	varchar(60)	report table to be a destination
#argument	@logdate	int		the date of report to be created
#return
#result_set
#remark
#example	Exec lin_RPLevUp2 'L2004_11_30_log_data_8', 'R2004_11_LEVUP2_8', 20041130
#history	create		young	2004-02-18
#see		lin_RPLevUP
********************************************/
ALTER PROCEDURE [DBO].[lin_RPLevUp2]
	@table_from	varchar(60),
	@table_to	varchar(60),
	@logdate	int

AS
SET NOCOUNT ON

declare @sql varchar(4000)

-- check table whether @table_to is exists or not
set @sql = 'select * from lin2report.dbo.sysobjects (nolock) where name = ''' + @table_to + ''''
exec (@sql)

if (@@ROWCOUNT = 0)
begin
	set @sql = 'CREATE TABLE dbo.' + @table_to + ' (' 
		+ ' log_date	int, '
		+ ' levup_level	int, '
		+ ' levup_count	int, '
		+ ' avg_time	int, '
		+ ' avgcount_time int, '
		+ ' std_time	int, '
		+ ' min_time	int, '
		+ ' max_time	int '
		+ ' ) '
	exec (@sql)

	set @sql = 'CREATE INDEX IX_' + @table_to + '_1 on dbo.' + @table_to + ' (log_date) '
	exec (@sql)
end
else begin
	set @sql = 'delete from dbo.' + @table_to + ' where log_date = ' + CAST(@logdate as varchar)
	exec (@sql)
end

-- check tmp table
declare @tmp_table varchar(512)
set @tmp_table = 'dbo.tmp' + @table_to

set @sql = 'select * from lin2report.dbo.sysobjects (nolock) where name = ''tmp' + @table_to + ''''
exec (@sql)

if (@@ROWCOUNT > 0)
begin
	set @sql = ' drop table dbo.tmp' + @table_to
	exec (@sql)
end

-- make tmptable
set @table_from = replace ( @table_from, 'data0', 'data2' )
set @sql = ' select log_id, etc_num4, etc_num5,  etc_num6 , etc_num7  into ' + @tmp_table
	+ ' from lin2log.dbo.' + @table_from  + ' ( nolock) where log_id = 810  and etc_num7 = 0 '
exec (@sql)

set @table_from = replace ( @table_from, 'data2', 'data' )
set @sql = ' insert into ' + @tmp_table + ' ( log_id, etc_num4, etc_num5,  etc_num6 , etc_num7   ) ( select log_id, etc_num4, etc_num5,  etc_num6 , etc_num7  '
	+ ' from lin2log.dbo.' + @table_from  + ' ( nolock) where log_id = 810 and etc_num7 = 0 ) '
exec (@sql)

-- insert into report table
-- levelup report
set @sql = 'insert into ' + RTRIM(@table_to) + ' ( log_date,  levup_level, levup_count, avg_time, avgcount_time,  std_time, min_time, max_time ) ( ' 
	+ ' select ' + CAST ( @logdate as varchar)  +  ' , R1.etc_num4, char_count=count ( R1.etc_num4),  char_avg=avg ( R1.etc_num6) , count( R1.etc_num4 ) * avg( R1.etc_num6 ), char_std=stdev ( R1.etc_num6), min ( R1.etc_num6), Max ( R1.etc_num6 ) from ( '
	+ ' select etc_num4, etc_num6  from ' + @tmp_table + ' (nolock)   where log_id = 810 and etc_num4 > etc_num5 ) as R1 '
	+ '  left join ( '
	+ ' select etc_num4, avg6=avg( etc_num6 )  ,  stdev6=stdev ( etc_num6 ) , min2 = min ( etc_num6 ) from ' + @tmp_table + ' (nolock) where log_id = 810 and etc_num4 > etc_num5 group by etc_num4   ) as R2 '
	+ ' on R1.etc_num4 = R2.etc_num4 and R1.etc_num6 between    R2.avg6 - R2.stdev6 * 0.5 and R2.avg6 + R2.stdev6 * 3.0 '
	+ ' where R2.etc_num4 is not null '
	+ ' group by R1.etc_num4 '
	+ ' )  option (MAXDOP 1 ) '

 exec (@sql )

-- drop tmptable
set @sql = 'drop table ' + @tmp_table
exec (@sql)
GO

/********************************************
lin_RPLevInc
do make Level increase report table

#argument	@table_from	varchar(60)	log table to be a source
#argument	@table_to	varchar(60)	report table to be a destination
#argument	@logdate	int		the date of report to be created
#return
#result_set
#remark
#example	Exec lin_RPLevInc 'L2004_11_30_log_data_8', 'R2004_11_LEVINC_8', 20041130
#history	create	young	2003-11-10
#see
********************************************/
ALTER PROCEDURE [DBO].[lin_RPLevInc ]
	@table_from	varchar(60),
	@table_to	varchar(60),
	@logdate	int

AS
SET NOCOUNT ON

declare @sql varchar(4000)

-- check table whether @table_to is exists or not
set @sql = 'select * from lin2report.dbo.sysobjects (nolock) where name = ''' + @table_to + ''''
exec (@sql)

if (@@ROWCOUNT = 0)
begin
	set @sql = 'CREATE TABLE dbo.' + @table_to + ' (' 
		+ ' log_date	int, '
		+ ' lev		int, '
		+ ' amount	int '
		+ ' ) '
	exec (@sql)

	set @sql = 'CREATE INDEX IX_' + @table_to + '_1 on dbo.' + @table_to + ' (log_date) '
	exec (@sql)
end
else begin
	set @sql = 'delete from dbo.' + @table_to + ' where log_date = ' + CAST(@logdate as varchar)
	exec (@sql)
end

-- check tmp table
declare @tmp_table varchar(512)
set @tmp_table = 'dbo.tmp' + @table_to

set @sql = 'select * from lin2report.dbo.sysobjects (nolock) where name = ''tmp' + @table_to + ''''
exec (@sql)

if (@@ROWCOUNT > 0)
begin
	set @sql = ' drop table dbo.tmp' + @table_to
	exec (@sql)
end

-- insert into report table

--  lev  increase
-- log_id = 810
-- make tmptable
set @table_from = replace ( @table_from, 'data0', 'data2' )
set @sql = ' select log_id, etc_num4 into ' + @tmp_table
	+ ' from lin2log.dbo.' + @table_from  + ' ( nolock) where log_id = 810  '
exec (@sql)

set @table_from = replace ( @table_from, 'data2', 'data' )
set @sql = ' insert into ' + @tmp_table + ' ( log_id, etc_num4 ) ( select log_id, etc_num4 '
	+ ' from lin2log.dbo.' + @table_from  + ' ( nolock) where log_id = 810 ) '
exec (@sql)

set @sql = 'insert into ' + RTRIM(@table_to) + ' ( log_date,  lev, amount ) ( ' 
	+ ' select  ' + CAST(@logdate as varchar)  + ', etc_num4, count( log_id ) from  '
	+ @tmp_table  + ' ( nolock )  group by etc_num4  ) option (MAXDOP 1 ) '
exec (@sql )

-- drop tmptable
set @sql = ' drop table ' + @tmp_table
exec (@sql)
GO

/********************************************
lin_RPLevDec
do make Level decrease report table

#argument	@table_from	varchar(60)	log table to be a source
#argument	@table_to	varchar(60)	report table to be a destination
#argument	@logdate	int		the date of report to be created
#return
#result_set
#remark
#example	Exec lin_RPLevDec 'L2004_11_30_log_data_8', 'R2004_11_LEVDEC_8', 20041130
#history	create	young	2003-11-10
#see
********************************************/
ALTER PROCEDURE [DBO].[lin_RPLevDec ]
	@table_from	varchar(60),
	@table_to	varchar(60),
	@logdate	int

AS
SET NOCOUNT ON

declare @sql varchar(4000)

-- check table whether @table_to is exists or not
set @sql = 'select * from lin2report.dbo.sysobjects (nolock) where name = ''' + @table_to + ''''
exec (@sql)

if (@@ROWCOUNT = 0)
begin
	set @sql = 'CREATE TABLE dbo.' + @table_to + ' (' 
		+ ' log_date	int, '
		+ ' lev		int, '
		+ ' amount	int '
		+ ' ) '
	exec (@sql)

	set @sql = 'CREATE INDEX IX_' + @table_to + '_1 on dbo.' + @table_to + ' (log_date) '
	exec (@sql)
end
else begin
	set @sql = 'delete from dbo.' + @table_to + ' where log_date = ' + CAST(@logdate as varchar)
	exec (@sql)
end

-- check tmp table
declare @tmp_table varchar(512)
set @tmp_table = 'dbo.tmp' + @table_to

set @sql = 'select * from lin2report.dbo.sysobjects (nolock) where name = ''tmp' + @table_to + ''''
exec (@sql)

if (@@ROWCOUNT > 0)
begin
	set @sql = ' drop table dbo.tmp' + @table_to
	exec (@sql)
end

-- insert into report table

--  lev decrease
-- log_id = 810
-- make tmptable
set @table_from = replace ( @table_from, 'data0', 'data2' )
set @sql = ' select log_id, etc_num5 into ' + @tmp_table
	+ ' from lin2log.dbo.' + @table_from  + ' ( nolock) where log_id = 810  '
exec (@sql)

set @table_from = replace ( @table_from, 'data2', 'data' )
set @sql = ' insert into ' + @tmp_table + ' ( log_id, etc_num5 ) ( select log_id, etc_num5 '
	+ ' from lin2log.dbo.' + @table_from  + ' ( nolock) where log_id = 810 ) '
exec (@sql)

set @sql = 'insert into ' + RTRIM(@table_to) + ' ( log_date,  lev, amount ) ( ' 
	+ ' select  ' + CAST(@logdate as varchar)  + ', etc_num5, -1 * count( log_id ) from  '
	+ @tmp_table  + ' ( nolock )  group by etc_num5  ) option (MAXDOP 1 ) '
exec (@sql )

-- drop tmptable
set @sql = ' drop table ' + @tmp_table
exec (@sql)
GO

/********************************************
lin_RPKillPCCount2
do make kill pc stat

#argument	@table_from	varchar(60)	log table to be a source
#argument	@table_to	varcahr(60)	report table to be a destination
#argument	@logdate	int		the date of report to be created
#return
#result_set
#remark
#example	Exec lin_RPKillPCCount2 'L2004_11_30_log_data_8', 'R2004_11_KILLPCCOUNT2_8', 20041130
#history	create		flagoftiger	2004-04-30
#see		lin_RPKillPCCount
********************************************/
ALTER PROCEDURE [DBO].[lin_RPKillPCCount2]
	@table_from	varchar(60),
	@table_to	varchar(60),
	@logdate	int

AS
SET NOCOUNT ON

declare @sql varchar(4000)

-- check table whether @table_to is exists or not
set @sql = 'select * from lin2report.dbo.sysobjects (nolock) where name = ''' + @table_to + ''''
exec (@sql)

if (@@ROWCOUNT = 0)
begin
	set @sql = 'CREATE TABLE dbo.' + @table_to + ' (' 
		+ ' log_date	int, '
		+ ' actor_class	smallint, '
		+ ' actor_level	smallint, '
		+ ' actor_pk	smallint, '
		+ ' target_class	smallint, '
		+ ' target_level	smallint, '
		+ ' target_pk	smallint, '
		+ ' loc_x		int, '
		+ ' loc_y		int,  '
		+ ' kill_count	int   '
		+ ' ) '
	exec (@sql)

	set @sql = 'CREATE INDEX IX_' + @table_to + '_1 on dbo.' + @table_to + ' ( log_date, loc_x, loc_y, actor_class, actor_level, actor_pk, target_class, target_level, target_pk  ) '
	exec (@sql)
end
else begin
	set @sql = 'delete from dbo.' + @table_to + ' where log_date = ' + CAST(@logdate as varchar)
	exec (@sql)
end



-- check tmp table
declare @tmp_table varchar(512)
set @tmp_table = 'dbo.tmp' + @table_to

set @sql = 'select * from lin2report.dbo.sysobjects (nolock) where name = ''tmp' + @table_to + ''''
exec (@sql)

if (@@ROWCOUNT > 0)
begin
	set @sql = ' drop table dbo.tmp' + @table_to
	exec (@sql)
end

-- make tmptable
set @table_from = replace ( @table_from, 'data0', 'data2' )
set @sql = ' select log_id, etc_num3, etc_num4, etc_num8, etc_num9, etc_num5, etc_num7, location_x, location_y into ' + @tmp_table
	+ ' from lin2log.dbo.' + @table_from  + ' ( nolock) where log_id = 1111  '
exec (@sql)

set @table_from = replace ( @table_from, 'data2', 'data' )
set @sql = ' insert into ' + @tmp_table + ' ( log_id, etc_num3, etc_num4, etc_num8, etc_num9, etc_num5, etc_num7, location_x, location_y ) ( select log_id, etc_num3, etc_num4, etc_num8, etc_num9, etc_num5, etc_num7, location_x, location_y '
	+ ' from lin2log.dbo.' + @table_from  + ' ( nolock) where log_id = 1111 ) '
exec (@sql)

-- insert into report table
-- begin quest report
set @sql = 'insert into ' + RTRIM(@table_to) + ' ( log_date, actor_class, actor_level, actor_pk,  target_class, target_level, target_pk, loc_x, loc_y, kill_count ) ( ' 
	+ ' select ' + CAST(@logdate as varchar) + ',etc_num3, etc_num4, etc_num8, etc_num9, etc_num5, etc_num7, floor( location_x / 1024.0) ,  floor ( location_y / 1024.0 ) , count ( log_id )  from '
	+ @tmp_table  + ' ( nolock )  group by  etc_num3, etc_num4, etc_num8, etc_num9, etc_num5, etc_num7, floor( location_x / 1024.0) ,  floor ( location_y / 1024.0 )   )  option (MAXDOP 1 ) '
exec (@sql )

-- drop tmptable
set @sql = ' drop table ' + @tmp_table
exec ( @sql )
GO

/********************************************
lin_RPKillPCCount
do make kill pc stat

#argument	@table_from	varchar(60)	log table to be a source
#argument	@table_to	varchar(60)	report table to be a destination
#argument	@logdate	int		the date of report to be created
#return
#result_set
#remark
#example	Exec lin_RPKillPCCount 'L2004_11_30_log_data_8', 'R2004_11_KILLPCCOUNT_8', 20041130
#history	create		young	2004-03-16
#see		lin_RPKillPCCount2
********************************************/
ALTER PROCEDURE [DBO].[lin_RPKillPCCount]
	@table_from	varchar(60),
	@table_to	varchar(60),
	@logdate	int

AS
SET NOCOUNT ON

declare @sql varchar(4000)

-- check table whether @table_to is exists or not
set @sql = 'select * from lin2report.dbo.sysobjects (nolock) where name = ''' + @table_to + ''''
exec (@sql)

if (@@ROWCOUNT = 0)
begin
	set @sql = 'CREATE TABLE dbo.' + @table_to + ' (' 
		+ ' log_date	int, '
		+ ' class		smallint, '
		+ ' level		smallint, '
		+ ' loc_x		int, '
		+ ' loc_y		int,  '
		+ ' kill_count	int   '
		+ ' ) '
	exec (@sql)

	set @sql = 'CREATE INDEX IX_' + @table_to + '_1 on dbo.' + @table_to + ' ( log_date, loc_x,  loc_y,class,  level  ) '
	exec (@sql)
end
else begin
	set @sql = 'delete from dbo.' + @table_to + ' where log_date = ' + CAST(@logdate as varchar)
	exec (@sql)
end



-- check tmp table
declare @tmp_table varchar(512)
set @tmp_table = 'dbo.tmp' + @table_to

set @sql = 'select * from lin2report.dbo.sysobjects (nolock) where name = ''tmp' + @table_to + ''''
exec (@sql)

if (@@ROWCOUNT > 0)
begin
	set @sql = ' drop table dbo.tmp' + @table_to
	exec (@sql)
end

-- make tmptable
set @table_from = replace ( @table_from, 'data0', 'data2' )
set @sql = ' select log_id, etc_num3, etc_num4, location_x, location_y into ' + @tmp_table
	+ ' from lin2log.dbo.' + @table_from  + ' ( nolock) where log_id = 1111  '
exec (@sql)

set @table_from = replace ( @table_from, 'data2', 'data' )
set @sql = ' insert into ' + @tmp_table + ' ( log_id, etc_num3, etc_num4, location_x, location_y ) ( select log_id, etc_num3, etc_num4, location_x, location_y '
	+ ' from lin2log.dbo.' + @table_from  + ' ( nolock) where log_id = 1111 ) '
exec (@sql)

-- insert into report table
-- begin quest report
set @sql = 'insert into ' + RTRIM(@table_to) + ' ( log_date,  class, level, loc_x, loc_y, kill_count ) ( ' 
	+ ' select ' + CAST(@logdate as varchar) + ', etc_num3, etc_num4, floor( location_x / 1024.0) ,  floor ( location_y / 1024.0 ) , count ( log_id )  from '
	+ @tmp_table  + ' ( nolock )  group by etc_num3, etc_num4, floor( location_x / 1024.0) ,  floor ( location_y / 1024.0 )   )  option (MAXDOP 1 ) '
exec (@sql )

-- drop tmptable
set @sql = ' drop table ' + @tmp_table
exec ( @sql )
GO

/******************************************************************************
#Name:	lin_RPItemSell
#Desc:	Do make item sell report

#Argument:
	Input:	@table_from	varchar(60)	log view: Lyyyy_mm_dd_Log_Data0_world
		@table_to	varchar(60)	report table: Ryyyy_mm_ItemSell_world
		@logdate	int		report date
	Output:	
#Return:
#Result Set:

#Remark:
#Example:	Exec lin_RPItemSell 'L2004_11_30_log_data_8', 'R2004_11_ITEMSELL_8', 20041130
#See:

#History:
	Create	young	2003-03-18
	Modify	btwinuni	2005-05-10	delete tmp_table
******************************************************************************/
ALTER PROCEDURE [DBO].[lin_RPItemSell]
	@table_from	varchar(60),
	@table_to	varchar(60),
	@logdate	int

AS
SET NOCOUNT ON

declare @sql varchar(4000)

-- check table whether @table_to is exists or not
set @sql = 'select * from lin2report.dbo.sysobjects (nolock) where name = ''' + @table_to + ''''
exec (@sql)

if (@@ROWCOUNT = 0)
begin
	set @sql = 'CREATE TABLE dbo.' + @table_to + ' (' 
		+ ' log_date	int, '
		+ ' buyer_id	int,' 
		+ ' item_id	int, '
		+ ' sell_count	int, '
		+ ' sell_amount	int '
		+ ' ) '
	exec (@sql)

	set @sql = 'CREATE INDEX IX_' + @table_to + '_1 on dbo.' + @table_to + ' (log_date) '
	exec (@sql)
end
else begin
	set @sql = 'delete from dbo.' + @table_to + ' where log_date = ' + CAST(@logdate as varchar)
	exec (@sql)
end

-- insert into report table

-- +T  item
set @sql = 'insert into ' + RTRIM(@table_to) + ' ( log_date, buyer_id, item_id, sell_count, sell_amount ) ( ' 
	+ ' select ' + CAST(@logdate as varchar) + ', etc_num5, etc_num8, count(log_id), sum(etc_num9) from '
	+ ' ( select log_id, etc_num5, etc_num8, etc_num9 '
	+ ' from lin2log.dbo.' + RTRIM(@table_from) + ' ( nolock ) where log_id = 902 ) as R1 group by etc_num5, etc_num8 )  option (MAXDOP 1 ) '
exec (@sql )
GO

/********************************************
lin_RPItemInc
do make item amount increase report table

#argument	@table_from	varchar(60)	log table to be a source
#argument	@table_to	varcahr(60)	report table to be a destination
#argument	@logdate	int		the date of report to be created
#return
#result_set
#remark
#example	Exec lin_RPItemInc 'L2004_11_30_log_data_8', 'R2004_11_ITEMINC_8', 20041130
#history	create		young	2003-03-17
#see
********************************************/
ALTER PROCEDURE [DBO].[lin_RPItemInc ]
	@table_from	varchar(60),
	@table_to	varchar(60),
	@logdate	int

AS
SET NOCOUNT ON

declare @sql varchar(4000)

-- check table whether @table_to is exists or not
set @sql = 'select * from lin2report.dbo.sysobjects (nolock) where name = ''' + @table_to + ''''
exec (@sql)

if (@@ROWCOUNT = 0)
begin
	set @sql = 'CREATE TABLE dbo.' + @table_to + ' (' 
		+ ' log_date	int, '
		+ ' item_id	int, '
		+ ' amount	money '
		+ ' ) '
	exec (@sql)

	set @sql = 'CREATE INDEX IX_' + @table_to + '_1 on dbo.' + @table_to + ' (log_date) '
	exec (@sql)
end
else begin
	set @sql = 'delete from dbo.' + @table_to + ' where log_date = ' + CAST(@logdate as varchar)
	exec (@sql)
end

-- check tmp table
declare @tmp_table varchar(512)
set @tmp_table = 'dbo.tmp' + @table_to

set @sql = 'select * from lin2report.dbo.sysobjects (nolock) where name = ''tmp' + @table_to + ''''
exec (@sql)

if (@@ROWCOUNT > 0)
begin
	set @sql = ' drop table dbo.tmp' + @table_to
	exec (@sql)
end

-- insert into report table

--  item amount increase
-- +- -=

-- make tmptable
set @table_from = replace ( @table_from, 'data0', 'data2' )
set @sql = ' select log_id, etc_num8, etc_num9 into ' + @tmp_table
	+ ' from lin2log.dbo.' + @table_from  + ' ( nolock) where log_id = 901  '
exec (@sql)

set @table_from = replace ( @table_from, 'data2', 'data' )
set @sql = ' insert into ' + @tmp_table + ' ( log_id, etc_num8, etc_num9 ) ( select log_id, etc_num8, etc_num9 '
	+ ' from lin2log.dbo.' + @table_from  + ' ( nolock) where log_id = 901 ) '
exec (@sql)

set @sql = 'insert into ' + RTRIM(@table_to) + ' ( log_date,  item_id, amount ) ( ' 
	+ ' select  ' + CAST(@logdate as varchar)  + ', etc_num8, sum(etc_num9)   from '
	+ @tmp_table  + ' ( nolock ) where etc_num9 > 0 and etc_num8 <> 57  group by etc_num8  )  option (MAXDOP 1 ) '
exec (@sql )

set @sql = 'insert into ' + RTRIM(@table_to) + ' ( log_date,  item_id, amount ) ( ' 
	+ ' select  ' + CAST(@logdate as varchar)  + ', etc_num8, count( log_id )   from '
	+ @tmp_table  + ' ( nolock ) where etc_num9 = 0 and etc_num8 <> 57  group by etc_num8  ) option (MAXDOP 1 ) '
exec (@sql )

-- drop tmptable
set @sql = ' drop table ' + @tmp_table
exec (@sql)

-- -L+- +L-=
-- make tmptable
set @table_from = replace ( @table_from, 'data0', 'data2' )
set @sql = ' select log_id, etc_num8, etc_num9 into ' + @tmp_table
	+ ' from lin2log.dbo.' + @table_from  + ' ( nolock) where log_id = 906  '
exec (@sql)

set @table_from = replace ( @table_from, 'data2', 'data' )
set @sql = ' insert into ' + @tmp_table + ' ( log_id, etc_num8, etc_num9 ) ( select log_id, etc_num8, etc_num9 '
	+ ' from lin2log.dbo.' + @table_from  + ' ( nolock) where log_id = 906 ) '
exec (@sql)

set @sql = 'insert into ' + RTRIM(@table_to) + ' ( log_date,  item_id, amount ) ( ' 
	+ ' select  ' + CAST(@logdate as varchar)  + ',  etc_num8, sum(etc_num9)  from '
	+ @tmp_table  + ' ( nolock ) where   etc_num9 > 0 and etc_num8 <> 57  group by etc_num8  ) option (MAXDOP 1 ) '
exec (@sql )

-- drop tmptable
set @sql = 'drop table ' + @tmp_table
exec (@sql)

-- -+L+- --=
-- make tmptable
set @table_from = replace ( @table_from, 'data0', 'data2' )
set @sql = ' select log_id, etc_num5, etc_num10 into ' + @tmp_table
	+ ' from lin2log.dbo.' + @table_from  + ' ( nolock) where log_id = 933  '
exec (@sql)

set @table_from = replace ( @table_from, 'data2', 'data' )
set @sql = ' insert into ' + @tmp_table + ' ( log_id, etc_num5, etc_num10 ) ( select log_id, etc_num5, etc_num10 '
	+ ' from lin2log.dbo.' + @table_from  + ' ( nolock) where log_id = 933 ) '
exec (@sql)

set @sql = 'insert into ' + RTRIM(@table_to) + ' ( log_date,  item_id, amount ) ( ' 
	+ ' select  ' + CAST(@logdate as varchar)  + ',   etc_num5, sum(etc_num10)  from '
	+ @tmp_table  + ' ( nolock ) where   etc_num5 <> 57   group by etc_num5   ) option (MAXDOP 1 ) '
exec (@sql )

set @sql = ' drop table ' + @tmp_table
exec (@sql )

--------------------------------------------------
-- adena amount increase
-- +- -L+-  --+
-- make tmptable
set @table_from = replace ( @table_from, 'data0', 'data2' )
set @sql = ' select log_id, etc_num8, etc_num9 into ' + @tmp_table
	+ ' from lin2log.dbo.' + @table_from  + ' ( nolock) where log_id = 902 and etc_num8 = 57  '
exec (@sql)

set @table_from = replace ( @table_from, 'data2', 'data' )
set @sql = ' insert into ' + @tmp_table + ' ( log_id, etc_num8, etc_num9 ) ( select log_id, etc_num8, etc_num9 '
	+ ' from lin2log.dbo.' + @table_from  + ' ( nolock) where log_id = 902 and etc_num8 = 57 ) '
exec (@sql)

set @sql = 'insert into ' + RTRIM(@table_to) + ' ( log_date,  item_id, amount ) ( ' 
	+ ' select  ' + CAST(@logdate as varchar)  + ', etc_num8, sum(cast(etc_num9 as money))   from '
	+ @tmp_table + ' ( nolock )  group by etc_num8  )  option (MAXDOP 1 ) '
exec (@sql )

set @sql = ' drop table ' + @tmp_table
exec ( @sql)


-- - +-
-- make tmptable
set @table_from = replace ( @table_from, 'data0', 'data2' )
set @sql = ' select log_id, etc_num8, etc_num9 into ' + @tmp_table
	+ ' from lin2log.dbo.' + @table_from  + ' ( nolock) where log_id = 906 and etc_num8 = 57  '
exec (@sql)

set @table_from = replace ( @table_from, 'data2', 'data' )
set @sql = ' insert into ' + @tmp_table + ' ( log_id, etc_num8, etc_num9 ) ( select log_id, etc_num8, etc_num9 '
	+ ' from lin2log.dbo.' + @table_from  + ' ( nolock) where log_id = 906 and etc_num8 = 57 ) '
exec (@sql)
set @sql = 'insert into ' + RTRIM(@table_to) + ' ( log_date,  item_id, amount ) ( ' 
	+ ' select  ' + CAST(@logdate as varchar)  + ', etc_num8, sum(cast(etc_num9 as money))  from  '
	+ @tmp_table  + ' ( nolock )  group by etc_num8  ) option (MAXDOP 1 ) '
exec (@sql )

set @sql = ' drop table ' + @tmp_table
exec (@sql)
GO

/********************************************
lin_RPItemDec
do make item amount decrease report table

#argument	@table_from	varchar(60)	log table to be a source
#argument	@table_to	varchar(60)	report table to be a destination
#argument	@logdate	int		the date of report to be created
#return
#result_set
#remark
#example	Exec lin_RPItemDec 'L2004_11_30_log_data_8', 'R2004_11_ITEMDEC_8', 20041130
#history	create		young	2003-03-17
#see
********************************************/
ALTER  PROCEDURE [DBO].[lin_RPItemDec ]
	@table_from	varchar(60),
	@table_to	varchar(60),
	@logdate	int

AS
SET NOCOUNT ON

declare @sql varchar(4000)

-- check table whether @table_to is exists or not
set @sql = 'select * from lin2report.dbo.sysobjects (nolock) where name = ''' + @table_to + ''''
exec (@sql)

if (@@ROWCOUNT = 0)
begin
	set @sql = 'CREATE TABLE dbo.' + @table_to + ' (' 
		+ ' log_date	int, '
		+ ' item_id	int, '
		+ ' amount	money '
		+ ' ) '
	exec (@sql)

	set @sql = 'CREATE INDEX IX_' + @table_to + '_1 on dbo.' + @table_to + ' (log_date) '
	exec (@sql)
end
else begin
	set @sql = 'delete from dbo.' + @table_to + ' where log_date = ' + CAST(@logdate as varchar)
	exec (@sql)
end

-- check tmp table
declare @tmp_table varchar(512)
set @tmp_table = 'dbo.tmp' + @table_to

set @sql = 'select * from lin2report.dbo.sysobjects (nolock) where name = ''tmp' + @table_to + ''''
exec (@sql)

if (@@ROWCOUNT > 0)
begin
	set @sql = ' drop table dbo.tmp' + @table_to
	exec (@sql)
end

-- insert into report table

--  item amount decrease
-- +- -=
-- make tmptable
set @table_from = replace ( @table_from, 'data0', 'data2' )
set @sql = ' select log_id, etc_num8, etc_num9 into ' + @tmp_table
	+ ' from lin2log.dbo.' + @table_from  + ' ( nolock) where log_id = 902 and etc_num9 < 0 and etc_num8 <> 57  '
exec (@sql)

set @table_from = replace ( @table_from, 'data2', 'data' )
set @sql = ' insert into ' + @tmp_table + ' ( log_id, etc_num8, etc_num9 ) ( select log_id, etc_num8, etc_num9 '
	+ ' from lin2log.dbo.' + @table_from  + ' ( nolock) where log_id = 902 and etc_num9 < 0 and etc_num8 <> 57  ) '
exec (@sql)

set @sql = 'insert into ' + RTRIM(@table_to) + ' ( log_date,  item_id, amount ) ( ' 
	+ ' select  ' + CAST(@logdate as varchar)  + ', etc_num8, sum(cast(etc_num9 as money))  from  '
	+ @tmp_table  + ' ( nolock )  group by etc_num8  ) option (MAXDOP 1 ) '
exec (@sql )

-- drop tmptable
set @sql = ' drop table ' + @tmp_table
exec (@sql)


-- -L+- -+T-=
-- make tmptable
set @table_from = replace ( @table_from, 'data0', 'data2' )
set @sql = ' select log_id, etc_num8, etc_num9, etc_num10  into ' + @tmp_table
	+ ' from lin2log.dbo.' + @table_from  + ' ( nolock) where log_id = 907  '
exec (@sql)

set @table_from = replace ( @table_from, 'data2', 'data' )
set @sql = ' insert into ' + @tmp_table + ' ( log_id, etc_num8, etc_num9, etc_num10 ) ( select log_id, etc_num8, etc_num9, etc_num10 '
	+ ' from lin2log.dbo.' + @table_from  + ' ( nolock) where log_id = 907 ) '
exec (@sql)


set @sql = 'insert into ' + RTRIM(@table_to) + ' ( log_date,  item_id, amount ) ( ' 
	+ ' select  ' + CAST(@logdate as varchar)  + ',  etc_num8, -1*sum(cast(etc_num10 as money))  from '
	+ @tmp_table  + ' ( nolock ) where  etc_num9 = 0  group by etc_num8  )  option (MAXDOP 1 ) '
exec (@sql )

set @sql = 'insert into ' + RTRIM(@table_to) + ' ( log_date,  item_id, amount ) ( ' 
	+ ' select  ' + CAST(@logdate as varchar)  + ',  etc_num8, sum(cast(etc_num9 as money))  from '
	+ @tmp_table  + ' ( nolock ) where  etc_num9 < 0   group by etc_num8  ) option (MAXDOP 1 ) '
exec (@sql )

set @sql = 'insert into ' + RTRIM(@table_to) + ' ( log_date,  item_id, amount ) ( ' 
	+ ' select  ' + CAST(@logdate as varchar)  + ',   etc_num8, -1*sum(cast(etc_num9 as money))   from  '
	+ @tmp_table  + ' ( nolock ) where  etc_num9 > 0 and etc_num10 = 0 and etc_num8 <> 57   group by etc_num8  ) option (MAXDOP 1 ) '
exec (@sql )

-- drop tmptable
set @sql = ' drop table ' + @tmp_table
exec ( @sql )

-- -L+- ----=
-- make tmptable
set @table_from = replace ( @table_from, 'data0', 'data2' )
set @sql = ' select log_id, etc_num8, etc_num9 into ' + @tmp_table
	+ ' from lin2log.dbo.' + @table_from  + ' ( nolock) where log_id = 908  '
exec (@sql)

set @table_from = replace ( @table_from, 'data2', 'data' )
set @sql = ' insert into ' + @tmp_table + ' ( log_id, etc_num8, etc_num9 ) ( select log_id, etc_num8, etc_num9 '
	+ ' from lin2log.dbo.' + @table_from  + ' ( nolock) where log_id = 908 ) '
exec (@sql)

set @sql = 'insert into ' + RTRIM(@table_to) + ' ( log_date,  item_id, amount ) ( ' 
	+ ' select  ' + CAST(@logdate as varchar)  + ',   etc_num8, sum(cast (etc_num9 as money)) from '
	+ @tmp_table  + ' ( nolock ) where  etc_num9 < 0    group by etc_num8  )  option (MAXDOP 1 ) '
exec (@sql )

set @sql = 'insert into ' + RTRIM(@table_to) + ' ( log_date,  item_id, amount ) ( ' 
	+ ' select  ' + CAST(@logdate as varchar)  + ',   etc_num8, -1*sum(cast(etc_num9 as money)) from '
	+ @tmp_table + ' ( nolock ) where   etc_num9 > 0   group by etc_num8  ) option (MAXDOP 1 ) '
exec (@sql )

-- drop tmptable
set @sql = ' drop table ' + @tmp_table
exec ( @sql)

-- use item T-=
-- make tmptable
set @table_from = replace ( @table_from, 'data0', 'data2' )
set @sql = ' select log_id, etc_num8, etc_num9 into ' + @tmp_table
	+ ' from lin2log.dbo.' + @table_from  + ' ( nolock) where log_id = 911  '
exec (@sql)

set @table_from = replace ( @table_from, 'data2', 'data' )
set @sql = ' insert into ' + @tmp_table + ' ( log_id, etc_num8, etc_num9 ) ( select log_id, etc_num8, etc_num9 '
	+ ' from lin2log.dbo.' + @table_from  + ' ( nolock) where log_id = 911 ) '
exec (@sql)


set @sql = 'insert into ' + RTRIM(@table_to) + ' ( log_date,  item_id, amount ) ( ' 
	+ ' select  ' + CAST(@logdate as varchar)  + ',   etc_num8, sum(cast(etc_num9 as money)) from '
	+ @tmp_table  + ' ( nolock )  group by etc_num8   ) option (MAXDOP 1 ) '
exec (@sql )

-- ++-- ----=
set @sql = 'insert into ' + RTRIM(@table_to) + ' ( log_date,  item_id, amount ) ( ' 
	+ ' select  ' + CAST(@logdate as varchar)  + ',    etc_num8, -1*sum(cast(etc_num9 as money)) from  '
	+ @tmp_table + ' ( nolock )  group by etc_num8  ) option (MAXDOP 1 ) '
exec (@sql )

-- drop tmptable
set @sql = ' drop table ' + @tmp_table
exec ( @sql)

-- enchant fail + --=
-- make tmptable
set @table_from = replace ( @table_from, 'data0', 'data2' )
set @sql = ' select log_id, etc_num8, etc_num9 into ' + @tmp_table
	+ ' from lin2log.dbo.' + @table_from  + ' ( nolock) where log_id = 926  '
exec (@sql)

set @table_from = replace ( @table_from, 'data2', 'data' )
set @sql = ' insert into ' + @tmp_table + ' ( log_id, etc_num8, etc_num9 ) ( select log_id, etc_num8, etc_num9 '
	+ ' from lin2log.dbo.' + @table_from  + ' ( nolock) where log_id = 926 ) '
exec (@sql)


set @sql = 'insert into ' + RTRIM(@table_to) + ' ( log_date,  item_id, amount ) ( ' 
	+ ' select  ' + CAST(@logdate as varchar)  + ',   etc_num8, -1*count(log_id) from  '
	+ @tmp_table  + ' ( nolock )  group by etc_num8  ) option (MAXDOP 1 ) '
exec (@sql )

-- drop tmptable
set @sql = ' drop table ' + @tmp_table
exec ( @sql )


-- -+L+- ++-=
-- make tmptable
set @table_from = replace ( @table_from, 'data0', 'data2' )
set @sql = ' select log_id, etc_num8, etc_num9 into ' + @tmp_table
	+ ' from lin2log.dbo.' + @table_from  + ' ( nolock) where log_id = 933  '
exec (@sql)

set @table_from = replace ( @table_from, 'data2', 'data' )
set @sql = ' insert into ' + @tmp_table + ' ( log_id, etc_num8, etc_num9 ) ( select log_id, etc_num8, etc_num9 '
	+ ' from lin2log.dbo.' + @table_from  + ' ( nolock) where log_id = 933 ) '
exec (@sql)

set @sql = 'insert into ' + RTRIM(@table_to) + ' ( log_date,  item_id, amount ) ( ' 
	+ ' select  ' + CAST(@logdate as varchar)  + ', etc_num8, -1*count(etc_num9) from '
	+ @tmp_table  + ' ( nolock )  group by etc_num8  ) option (MAXDOP 1 ) '
exec (@sql )

-- drop tmptable
set @sql = ' drop table ' + @tmp_table
exec ( @sql)

----------------------------------------------------------------------------------------------------------------------------------------------------------------
-- adena amount decrease
-- +- -L+- -LLT v
-- make tmptable
set @table_from = replace ( @table_from, 'data0', 'data2' )
set @sql = ' select log_id, etc_num8, etc_num9 into ' + @tmp_table
	+ ' from lin2log.dbo.' + @table_from  + ' ( nolock) where log_id = 901 and etc_num8 = 57  '
exec (@sql)

set @table_from = replace ( @table_from, 'data2', 'data' )
set @sql = ' insert into ' + @tmp_table + ' ( log_id, etc_num8, etc_num9 ) ( select log_id, etc_num8, etc_num9 '
	+ ' from lin2log.dbo.' + @table_from  + ' ( nolock) where log_id = 901 and etc_num8 = 57 ) '
exec (@sql)

set @sql = 'insert into ' + RTRIM(@table_to) + ' ( log_date,  item_id, amount ) ( ' 
	+ ' select  ' + CAST(@logdate as varchar)  + ', etc_num8, sum(cast(etc_num9 as money))  from  '
	+ @tmp_table  + ' ( nolock )  group by etc_num8  ) option (MAXDOP 1 ) '
exec (@sql )

-- drop tmptable
set @sql = ' drop table ' + @tmp_table
exec ( @sql )

--  deposit fee
-- make tmptable
set @table_from = replace ( @table_from, 'data0', 'data2' )
set @sql = ' select log_id, etc_num8, etc_num9 into ' + @tmp_table
	+ ' from lin2log.dbo.' + @table_from  + ' ( nolock) where log_id = 928and etc_num8 = 57  '
exec (@sql)

set @table_from = replace ( @table_from, 'data2', 'data' )
set @sql = ' insert into ' + @tmp_table + ' ( log_id, etc_num8, etc_num9 ) ( select log_id, etc_num8, etc_num9 '
	+ ' from lin2log.dbo.' + @table_from  + ' ( nolock) where log_id = 928 and etc_num8 = 57  ) '
exec (@sql)


set @sql = 'insert into ' + RTRIM(@table_to) + ' ( log_date,  item_id, amount ) ( ' 
	+ ' select  ' + CAST(@logdate as varchar)  + ',  etc_num8, -1*sum(cast(etc_num9 as money))  from  '
	+ @tmp_table  + ' ( nolock )  group by etc_num8 ) option (MAXDOP 1 ) '
exec (@sql )

-- drop table 
set @sql = ' drop table ' + @tmp_table
exec ( @sql)
GO

/********************************************
lin_RPItemBuy
do make item buy report

#argument	@table_from	varchar(60)	log table to be a source
#argument	@table_to	varchar(60)	report table to be a destination
#argument	@logdate	int		the date of report to be created
#return
#result_set
#remark
#example	Exec lin_RPItemBuy 'L2004_11_30_log_data_8', 'R2004_11_ITEMBUY_8', 20041130
#history	create		young	2003-03-18
#see
********************************************/
ALTER PROCEDURE [DBO].[lin_RPItemBuy]
	@table_from	varchar(60),
	@table_to	varchar(60),
	@logdate	int

AS
SET NOCOUNT ON

declare @sql varchar(4000)

-- check table whether @table_to is exists or not
set @sql = 'select * from lin2report.dbo.sysobjects (nolock) where name = ''' + @table_to + ''''
exec (@sql)

if (@@ROWCOUNT = 0)
begin
	set @sql = 'CREATE TABLE dbo.' + @table_to + ' (' 
		+ ' log_date	int, '
		+ ' seller_id	int,' 
		+ ' item_id	int, '
		+ ' buy_count	int, '
		+ ' buy_amount	bigint '
		+ ' ) '
	exec (@sql)

	set @sql = 'CREATE INDEX IX_' + @table_to + '_1 on dbo.' + @table_to + ' (log_date) '
	exec (@sql)
end
else begin
	set @sql = 'delete from dbo.' + @table_to + ' where log_date = ' + CAST(@logdate as varchar)
	exec (@sql)
end

-- check tmp table
declare @tmp_table varchar(512)
set @tmp_table = 'dbo.tmp' + @table_to

set @sql = 'select * from lin2report.dbo.sysobjects (nolock) where name = ''tmp' + @table_to + ''''
exec (@sql)

if (@@ROWCOUNT > 0)
begin
	set @sql = ' drop table dbo.tmp' + @table_to
	exec (@sql)
end

-- make tmptable
set @table_from = replace ( @table_from, 'data0', 'data2' )
set @sql = ' select log_id, etc_num5,  etc_num8, etc_num9 into ' + @tmp_table
	+ ' from lin2log.dbo.' + @table_from  + ' ( nolock) where log_id = 901  '
exec (@sql)

set @table_from = replace ( @table_from, 'data2', 'data' )
set @sql = ' insert into ' + @tmp_table + ' ( log_id, etc_num5, etc_num8, etc_num9 ) ( select log_id, etc_num5, etc_num8, etc_num9 '
	+ ' from lin2log.dbo.' + @table_from  + ' ( nolock) where log_id = 901 ) '
exec (@sql)

-- insert into report table

-- -LLT item
set @sql = 'insert into ' + RTRIM(@table_to) + ' ( log_date, seller_id, item_id, buy_count, buy_amount ) ( ' 
	+ ' select ' + CAST(@logdate as varchar) + ', etc_num5, etc_num8, count(log_id), sum( cast ( etc_num9 as bigint ) ) from '
	+ @tmp_table  + ' ( nolock )  group by etc_num5, etc_num8 ) option (MAXDOP 1 )'
exec (@sql )

-- drop tmptable
set @sql = ' drop table ' + @tmp_table
exec ( @sql)
GO

/********************************************
#Name:	lin_RPGetItem
#Desc:	do make get item report

#Argument:
	@table_from	varchar(60)	log table to be a source
	@table_to	varchar(60)	report table to be a destination
	@logdate	int	the date of report to be created
#Return:
#Result Set:
#Remark:
#Example:	Exec lin_RPGetItem 'L2004_11_30_log_data0_8', 'R2004_11_GETITEM_8', 20041130
#See:
#History
	Create	young	2003-10-29
	Modify	btwinuni	2005-03-22
********************************************/
ALTER PROCEDURE [DBO].[lin_RPGetItem]
	@table_from	varchar(60),
	@table_to	varchar(60),
	@logdate	int

AS
SET NOCOUNT ON

declare @sql varchar(4000)

-- check table whether @table_to is exists or not
set @sql = 'select * from lin2report.dbo.sysobjects (nolock) where name = ''' + @table_to + ''''
exec (@sql)

if (@@ROWCOUNT = 0)
begin
	set @sql = 'CREATE TABLE dbo.' + @table_to + ' (' 
		+ ' log_date	int, '
		+ ' level		int,' 
		+ ' class		int, '
		+ ' item_type	int, '
		+ ' char_count	int, '
		+ ' get_count	int, '
		+ ' item_amount	bigint '
		+ ' ) '
	exec (@sql)

	set @sql = 'CREATE INDEX IX_' + @table_to + '_1 on dbo.' + @table_to + ' (log_date) '
	exec (@sql)
end
else begin
	set @sql = 'delete from dbo.' + @table_to + ' where log_date = ' + CAST(@logdate as varchar)
	exec (@sql)
end

-- check tmp table
declare @tmp_table varchar(512)
set @tmp_table = 'dbo.tmp' + @table_to

set @sql = 'select * from lin2report.dbo.sysobjects (nolock) where name = ''tmp' + @table_to + ''''
exec (@sql)

if (@@ROWCOUNT > 0)
begin
	set @sql = ' drop table dbo.tmp' + @table_to
	exec (@sql)
end

-- make tmptable
set @table_from = replace ( @table_from, 'data0', 'data2' )
set @sql = ' select log_id, actor, etc_num3, etc_num4,  etc_num8, etc_num9 into ' + @tmp_table
	+ ' from lin2log.dbo.' + @table_from  + ' ( nolock) where log_id = 906  '
exec (@sql)

set @sql = ' insert into ' + @tmp_table + ' ( log_id, actor, etc_num3, etc_num4,  etc_num8, etc_num9 ) ( select log_id, actor,  etc_num3, etc_num4, etc_num8, -1*etc_num9 '
	+ ' from lin2log.dbo.' + @table_from  + ' ( nolock) where log_id = 940 and act_time > ''2003/10/29 10:0:0'' ) '
exec (@sql)

set @table_from = replace ( @table_from, 'data2', 'data' )
set @sql = ' insert into ' + @tmp_table + ' ( log_id, actor,  etc_num3, etc_num4,  etc_num8, etc_num9 ) ( select log_id, actor,  etc_num3, etc_num4, etc_num8, etc_num9 '
	+ ' from lin2log.dbo.' + @table_from  + ' ( nolock) where log_id = 906 ) '
exec (@sql)

set @sql = ' insert into ' + @tmp_table + ' ( log_id, actor,  etc_num3, etc_num4,  etc_num8, etc_num9 ) ( select log_id, actor, etc_num3, etc_num4, etc_num8, -1*etc_num9 '
	+ ' from lin2log.dbo.' + @table_from  + ' ( nolock) where log_id = 940 and act_time > ''2003/10/29 10:0:0'' ) '
exec (@sql)

-- insert into report table

-- get item  
set @sql = 'insert into ' + RTRIM(@table_to) + ' ( log_date,  class, level, item_type, char_count, get_count,  item_amount ) ( ' 
	+ ' select ' + CAST(@logdate as varchar) + ', etc_num3, etc_num4, etc_num8, count( distinct ( actor)), count( log_id),  sum(cast(etc_num9 as bigint)) from '
	+ @tmp_table  + ' ( nolock )  where etc_num9 > 0 group by etc_num3, etc_num4, etc_num8 ) option (MAXDOP 1 )'
exec (@sql )

-- get item  which char dropped
set @sql = 'insert into ' + RTRIM(@table_to) + ' ( log_date, class,  level, item_type, char_count, get_count, item_amount ) ( ' 
	+ ' select ' + CAST(@logdate as varchar) + ', etc_num3, etc_num4, etc_num8, count ( distinct ( actor ) ) , count( log_id), sum(cast(etc_num9 as bigint)) from '
	+ @tmp_table  + ' ( nolock )  where etc_num9 < 0 group by etc_num3, etc_num4, etc_num8 ) option (MAXDOP 1 )'
exec (@sql )

-- drop tmptable
set @sql = ' drop table ' + @tmp_table
exec ( @sql)
GO

/********************************************
lin_RPExp
do make exp report

#argument	@table_from	varchar(60)	log table to be a source
#argument	@table_to	varchar(60)	report table to be a destination
#argument	@logdate	int		the date of report to be created
#return
#result_set
#remark
#example	Exec lin_RPExp 'L2004_11_30_log_data_8', 'R2004_11_EXP_8', 20041130
#history	create	young	2003-10-23
#see
********************************************/
ALTER PROCEDURE [DBO].[lin_RPExp]
	@table_from	varchar(60),
	@table_to	varchar(60),
	@logdate	int

AS
SET NOCOUNT ON

declare @sql varchar(4000)

-- check table whether @table_to is exists or not
set @sql = 'select * from lin2report.dbo.sysobjects (nolock) where name = ''' + @table_to + ''''
exec (@sql)

if (@@ROWCOUNT = 0)
begin
	set @sql = 'CREATE TABLE dbo.' + @table_to + ' (' 
		+ ' log_date	int, '
		+ ' level		int, '
		+ ' class 	int, '
		+ ' party		int,  '
		+ ' partycount	int, '
		+ ' playtime	int, '
		+ ' exp		int '
		+ ' ) '
	exec (@sql)

	set @sql = 'CREATE INDEX IX_' + @table_to + '_1 on dbo.' + @table_to + ' (log_date) '
	exec (@sql)
end
else begin
	set @sql = 'delete from dbo.' + @table_to + ' where log_date = ' + CAST(@logdate as varchar)
	exec (@sql)
end

-- check tmp table
declare @tmp_table varchar(512)
set @tmp_table = 'dbo.tmp' + @table_to

set @sql = 'select * from lin2report.dbo.sysobjects (nolock) where name = ''tmp' + @table_to + ''''
exec (@sql)

if (@@ROWCOUNT > 0)
begin
	set @sql = ' drop table dbo.tmp' + @table_to
	exec (@sql)
end

-- make tmptable
set @table_from = replace ( @table_from, 'data0', 'data2' )
set @sql = ' select  etc_num4, etc_num5, etc_num6, etc_num7, etc_num8, etc_num10 into ' + @tmp_table
	+ ' from lin2log.dbo.' + @table_from  + ' ( nolock) where log_id = 813 and etc_num6 > 0 and etc_num7 >= 0  '
exec (@sql)

set @table_from = replace ( @table_from, 'data2', 'data' )
set @sql = ' insert into ' + @tmp_table + ' ( etc_num4, etc_num5, etc_num6, etc_num7, etc_num8, etc_num10 ) ( select  etc_num4, etc_num5, etc_num6, etc_num7, etc_num8 , etc_num10 '
	+ ' from lin2log.dbo.' + @table_from  + ' ( nolock) where log_id = 813 and etc_num6 > 0  and etc_num7 >= 0 ) '
exec (@sql)

	-- new insert 
	set @sql = 'insert into ' + RTRIM(@table_to) + ' ( log_date,  level, class,  party, partycount, playtime, exp ) ( ' 
		+ ' select ' + CAST(@logdate as varchar)  + ' ,  etc_num4, etc_num5, case etc_num8 when 0 then 0 else 1 end, '
		+ '  etc_num8, sum ( cast ( etc_num6 as float ) ) - sum ( cast ( isnull( etc_num10 , 0 ) as float ) ) ,  sum ( etc_num7 )  from '
		+  @tmp_table + ' group by etc_num4, etc_num5, etc_num8 '
		+ '  )  option (MAXDOP 1 ) '
	exec (@sql )

-- drop tmptable
set @sql = ' drop table ' + @tmp_table
exec (@sql)
GO

/********************************************
lin_RPEquipped
do make a report that shows items equipped by user on some level and class

#argument	@table_from	varchar(60)	log table to be a source
#argument	@table_to	varchar(60)	report table to be a destination
#argument	@logdate	int		the date of report to be created
#return
#result_set
#remark
#example	Exec lin_RPEquipped 'L2004_11_30_log_data_8', 'R2004_11_EQUIPPED_8', 20041130
#history	create	young	2003-10-31
#see
********************************************/
ALTER PROCEDURE [DBO].[lin_RPEquipped ]
	@table_from	varchar(60),
	@table_to	varchar(60),
	@logdate	int

AS
SET NOCOUNT ON

declare @sql varchar(4000)

-- check table whether @table_to is exists or not
set @sql = 'select * from lin2report.dbo.sysobjects (nolock) where name = ''' + @table_to + ''''
exec (@sql)

if (@@ROWCOUNT = 0)
begin
	set @sql = 'CREATE TABLE dbo.' + @table_to + ' (' 
		+ ' log_date	int, '
		+ ' level		int, '
		+ ' class		int, '
		+ ' slot_type	int,'
		+ ' item_type	int,'
		+ ' equip_count	int'
		+ ' ) '
	exec (@sql)

	set @sql = 'CREATE INDEX IX_' + @table_to + '_1 on dbo.' + @table_to + ' (log_date) '
	exec (@sql)
end
else begin
	set @sql = 'delete from dbo.' + @table_to + ' where log_date = ' + CAST(@logdate as varchar)
	exec (@sql)
end

-- check tmp table
declare @tmp_table varchar(512)
set @tmp_table = 'dbo.tmp' + @table_to

set @sql = 'select * from lin2report.dbo.sysobjects (nolock) where name = ''tmp' + @table_to + ''''
exec (@sql)

if (@@ROWCOUNT > 0)
begin
	set @sql = ' drop table dbo.tmp' + @table_to
	exec (@sql)
end

-- make tmptable
set @table_from = replace ( @table_from, 'data0', 'data2' )
set @sql = ' select log_id, etc_num1, etc_num2, etc_num3, etc_num4, etc_num5, etc_num6, etc_num7, etc_num8, etc_num9, etc_num10 into ' + @tmp_table
	+ ' from lin2log.dbo.' + @table_from  + ' ( nolock) where log_id = 833 and act_time > ''2003/10/29 10:0:0''  '
exec (@sql)

set @table_from = replace ( @table_from, 'data2', 'data' )
set @sql = ' insert into ' + @tmp_table + ' ( log_id, etc_num1, etc_num2, etc_num3, etc_num4, etc_num5, etc_num6, etc_num7, etc_num8, etc_num9, etc_num10 ) ( select log_id, etc_num1, etc_num2, etc_num3, etc_num4, etc_num5, etc_num6, etc_num7, etc_num8, etc_num9, etc_num10 '
	+ ' from lin2log.dbo.' + @table_from  + ' ( nolock) where log_id = 833 and act_time > ''2003/10/29 10:0:0''   ) '
exec (@sql)


-- insert into report table

--  L--
set @sql = 'insert into ' + RTRIM(@table_to) + ' ( log_date,  level, class, slot_type, item_type, equip_count ) ( ' 
	+ ' select  ' + CAST(@logdate as varchar)  + ', etc_num1, etc_num2, 3, etc_num3, count( *)  from '
	+ @tmp_table + ' ( nolock )  group by etc_num1, etc_num2, etc_num3 ) option (MAXDOP 1 ) '
exec (@sql )

set @sql = 'insert into ' + RTRIM(@table_to) + ' ( log_date,  level, class, slot_type, item_type, equip_count ) ( ' 
	+ ' select  ' + CAST(@logdate as varchar)  + ', etc_num1, etc_num2, 4, etc_num4, count( *)  from '
	+ @tmp_table + ' ( nolock )  group by etc_num1, etc_num2, etc_num4 ) option (MAXDOP 1 ) '
exec (@sql )

set @sql = 'insert into ' + RTRIM(@table_to) + ' ( log_date,  level, class, slot_type, item_type, equip_count ) ( ' 
	+ ' select  ' + CAST(@logdate as varchar)  + ', etc_num1, etc_num2, 5, etc_num5, count( *)  from '
	+ @tmp_table + ' ( nolock )  group by etc_num1, etc_num2, etc_num5 ) option (MAXDOP 1 ) '
exec (@sql )

set @sql = 'insert into ' + RTRIM(@table_to) + ' ( log_date,  level, class, slot_type, item_type, equip_count ) ( ' 
	+ ' select  ' + CAST(@logdate as varchar)  + ', etc_num1, etc_num2, 6, etc_num6, count( *)  from '
	+ @tmp_table + ' ( nolock )  group by etc_num1, etc_num2, etc_num6 ) option (MAXDOP 1 ) '
exec (@sql )

set @sql = 'insert into ' + RTRIM(@table_to) + ' ( log_date,  level, class, slot_type, item_type, equip_count ) ( ' 
	+ ' select  ' + CAST(@logdate as varchar)  + ', etc_num1, etc_num2, 7, etc_num7, count( *)  from '
	+ @tmp_table + ' ( nolock )  group by etc_num1, etc_num2, etc_num7 ) option (MAXDOP 1 ) '
exec (@sql )

set @sql = 'insert into ' + RTRIM(@table_to) + ' ( log_date,  level, class, slot_type, item_type, equip_count ) ( ' 
	+ ' select  ' + CAST(@logdate as varchar)  + ', etc_num1, etc_num2, 8, etc_num8, count( *)  from '
	+ @tmp_table + ' ( nolock )  group by etc_num1, etc_num2, etc_num8 ) option (MAXDOP 1 ) '
exec (@sql )

set @sql = 'insert into ' + RTRIM(@table_to) + ' ( log_date,  level, class, slot_type, item_type, equip_count ) ( ' 
	+ ' select  ' + CAST(@logdate as varchar)  + ', etc_num1, etc_num2, 9, etc_num9, count( *)  from '
	+ @tmp_table + ' ( nolock )  group by etc_num1, etc_num2, etc_num9 ) option (MAXDOP 1 ) '
exec (@sql )

set @sql = 'insert into ' + RTRIM(@table_to) + ' ( log_date,  level, class, slot_type, item_type, equip_count ) ( ' 
	+ ' select  ' + CAST(@logdate as varchar)  + ', etc_num1, etc_num2, 10, etc_num10, count( *)  from '
	+ @tmp_table + ' ( nolock )  group by etc_num1, etc_num2, etc_num10 ) option (MAXDOP 1 ) '
exec (@sql )

-- drop 
set @sql = ' drop table ' + @tmp_table
exec ( @sql )
GO

/********************************************
lin_RPEquipItem
do make equip item report

#argument	@table_from	varchar(60)	log table to be a source
#argument	@table_to	varchar(60)	report table to be a destination
#argument	@logdate	int		the date of report to be created
#return
#result_set
#remark		This procedure creates the report by race, sex, class and level
#example	Exec lin_RPEquipItem 'L2004_11_30_log_data_8', 'R2004_11_EQUIPITEM_8', 20041130
#history	create		young	2003-03-28
#see
********************************************/
ALTER PROCEDURE [DBO].[lin_RPEquipItem]
	@table_from	varchar(60),
	@table_to	varchar(60),
	@logdate	int

AS
SET NOCOUNT ON

declare @sql varchar(4000)

-- check table whether @table_to is exists or not
set @sql = 'select * from lin2report.dbo.sysobjects (nolock) where name = ''' + @table_to + ''''
exec (@sql)

if (@@ROWCOUNT = 0)
begin
	set @sql = 'CREATE TABLE dbo.' + @table_to + ' (' 
		+ ' log_date	int, '
		+ 'log_type	smallint, '
		+ 'log_val	int, '
		+ ' item_type 	int , '
		+ ' equip_count 	int '
		+ ' ) '
	exec (@sql)

	set @sql = 'CREATE INDEX IX_' + @table_to + '_1 on dbo.' + @table_to + ' (log_date) '
	exec (@sql)
end
else begin
	set @sql = 'delete from dbo.' + @table_to + ' where log_date = ' + CAST(@logdate as varchar)
	exec (@sql)
end

-- check tmp table
declare @tmp_table varchar(512)
set @tmp_table = 'dbo.tmp' + @table_to

set @sql = 'select * from lin2report.dbo.sysobjects (nolock) where name = ''tmp' + @table_to + ''''
exec (@sql)

if (@@ROWCOUNT > 0)
begin
	set @sql = ' drop table dbo.tmp' + @table_to
	exec (@sql)
end

-- make tmptable
set @table_from = replace ( @table_from, 'data0', 'data2' )
set @sql = ' select log_id, etc_num1, etc_num2, etc_num3, etc_num4, etc_num6 into ' + @tmp_table
	+ ' from lin2log.dbo.' + @table_from  + ' ( nolock) where log_id = 824  '
exec (@sql)

set @table_from = replace ( @table_from, 'data2', 'data' )
set @sql = ' insert into ' + @tmp_table + ' ( log_id, etc_num1, etc_num2, etc_num3, etc_num4, etc_num6 ) ( select log_id, etc_num1, etc_num2, etc_num3, etc_num4, etc_num6 '
	+ ' from lin2log.dbo.' + @table_from  + ' ( nolock) where log_id = 824 ) '
exec (@sql)

-- insert into report table

-- race L--
set @sql = 'insert into ' + RTRIM(@table_to) + ' ( log_date,  log_type, log_val,  item_type, equip_count ) ( ' 
	+ ' select ' + CAST(@logdate as varchar) + ', 1, etc_num1,  etc_num6, count(log_id)  from   '
	+ @tmp_table  + ' ( nolock )  group by etc_num1, etc_num6 ) option (MAXDOP 1 )  '
exec (@sql )
-- sex  L--
set @sql = 'insert into ' + RTRIM(@table_to) + ' ( log_date,  log_type, log_val,  item_type, equip_count ) ( ' 
	+ ' select ' + CAST(@logdate as varchar) + ', 2, etc_num2,  etc_num6, count(log_id) from  '
	+ @tmp_table  + ' ( nolock )  group by etc_num2, etc_num6 ) option (MAXDOP 1 )  '
exec (@sql )
-- class  L--
set @sql = 'insert into ' + RTRIM(@table_to) + ' ( log_date,  log_type, log_val,  item_type, equip_count ) ( ' 
	+ ' select ' + CAST(@logdate as varchar) + ', 3, etc_num3,   etc_num6, count(log_id)  from  '
	+ @tmp_table  + ' ( nolock )  group by etc_num3, etc_num6 ) option (MAXDOP 1 )  '
exec (@sql )
-- level  L--
set @sql = 'insert into ' + RTRIM(@table_to) + ' ( log_date,  log_type, log_val,  item_type, equip_count ) ( ' 
	+ ' select  ' + CAST(@logdate as varchar) + ', 4, etc_num4,  etc_num6, count( log_id ) from    '
	+ @tmp_table  + ' ( nolock )  group by etc_num4, etc_num6 ) option (MAXDOP 1 ) '
exec (@sql )

-- drop tmptable
set @sql = ' drop table ' + @tmp_table
exec ( @sql )
GO

/********************************************
lin_RPEndQuest
do make end quest

#argument	@table_from	varchar(60)	log table to be a source
#argument	@table_to	varchar(60)	report table to be a destination
#argument	@logdate	int		the date of report to be created
#return
#result_set
#remark		This procedure creates the report by race, sex, class and level
#example	Exec lin_RPEndQuest 'L2004_11_30_log_data_8', 'R2004_11_ENDQUEST_8', 20041130
#history	create		young	2003-06-02
#see
********************************************/
ALTER PROCEDURE [DBO].[lin_RPEndQuest]
	@table_from	varchar(60),
	@table_to	varchar(60),
	@logdate	int

AS
SET NOCOUNT ON

declare @sql varchar(4000)

-- check table whether @table_to is exists or not
set @sql = 'select * from lin2report.dbo.sysobjects (nolock) where name = ''' + @table_to + ''''
exec (@sql)

if (@@ROWCOUNT = 0)
begin
	set @sql = 'CREATE TABLE dbo.' + @table_to + ' (' 
		+ ' log_date	int, '
		+ ' race		smallint, '
		+ ' class		smallint, '
		+ ' level		smallint, '
		+ ' quest_id	int, '
		+ ' quest_count	int  '
		+ ' ) '
	exec (@sql)

	set @sql = 'CREATE INDEX IX_' + @table_to + '_1 on dbo.' + @table_to + ' (log_date) '
	exec (@sql)
end
else begin
	set @sql = 'delete from dbo.' + @table_to + ' where log_date = ' + CAST(@logdate as varchar)
	exec (@sql)
end

-- check tmp table
declare @tmp_table varchar(512)
set @tmp_table = 'dbo.tmp' + @table_to

set @sql = 'select * from lin2report.dbo.sysobjects (nolock) where name = ''tmp' + @table_to + ''''
exec (@sql)

if (@@ROWCOUNT > 0)
begin
	set @sql = ' drop table dbo.tmp' + @table_to
	exec (@sql)
end


-- make tmptable
set @table_from = replace ( @table_from, 'data0', 'data2' )
set @sql = ' select log_id, etc_num1, etc_num3, etc_num4, etc_num5 into ' + @tmp_table
	+ ' from lin2log.dbo.' + @table_from  + ' ( nolock) where log_id = 305  '
exec (@sql)

set @table_from = replace ( @table_from, 'data2', 'data' )
set @sql = ' insert into ' + @tmp_table + ' ( log_id, etc_num1, etc_num3, etc_num4, etc_num5 ) ( select log_id, etc_num1, etc_num3, etc_num4, etc_num5 '
	+ ' from lin2log.dbo.' + @table_from  + ' ( nolock) where log_id = 305 ) '
exec (@sql)

-- insert into report table
-- begin quest report
set @sql = 'insert into ' + RTRIM(@table_to) + ' ( log_date,  race, class, level, quest_id, quest_count  ) ( ' 
	+ ' select ' + CAST(@logdate as varchar) + ', etc_num1, etc_num3, etc_num4, etc_num5, count(log_id) from  '
	+ @tmp_table  + ' ( nolock )  group by  etc_num1, etc_num3, etc_num4, etc_num5 ) option (MAXDOP 1 ) '
exec (@sql )

-- drop tmptable
set @sql = ' drop table ' + @tmp_table
exec ( @sql )
GO

/********************************************
lin_RPEnchantFail
do make enchant item failedreport table

#argument	@table_from	varchar(60)	log table to be a source
#argument	@table_to	varchar(60)	report table to be a destination
#argument	@logdate	int		the date of report to be created
#return
#result_set
#remark
#example	Exec lin_RPEnchantFail 'L2004_11_30_log_data_8', 'R2004_11_ENCHANTFAIL_8', 20041130
#history	create		young	2003-03-17
#see
********************************************/
ALTER PROCEDURE [DBO].[lin_RPEnchantFail ]
	@table_from	varchar(60),
	@table_to	varchar(60),
	@logdate	int

AS
SET NOCOUNT ON

declare @sql varchar(4000)

-- check table whether @table_to is exists or not
set @sql = 'select * from lin2report.dbo.sysobjects (nolock) where name = ''' + @table_to + ''''
exec (@sql)

if (@@ROWCOUNT = 0)
begin
	set @sql = 'CREATE TABLE dbo.' + @table_to + ' (' 
		+ ' log_date	int, '
		+ ' item_id	int,'
		+ ' old_enchant	smallint, ' 
		+ ' fail_count 	int'
		+ ' ) '
	exec (@sql)

	set @sql = 'CREATE INDEX IX_' + @table_to + '_1 on dbo.' + @table_to + ' (log_date) '
	exec (@sql)
end
else begin
	set @sql = 'delete from dbo.' + @table_to + ' where log_date = ' + CAST(@logdate as varchar)
	exec (@sql)
end

-- check tmp table
declare @tmp_table varchar(512)
set @tmp_table = 'dbo.tmp' + @table_to

set @sql = 'select * from lin2report.dbo.sysobjects (nolock) where name = ''tmp' + @table_to + ''''
exec (@sql)

if (@@ROWCOUNT > 0)
begin
	set @sql = ' drop table dbo.tmp' + @table_to
	exec (@sql)
end


-- make tmptable
set @table_from = replace ( @table_from, 'data0', 'data2' )
set @sql = ' select log_id, etc_num7, etc_num8 into ' + @tmp_table
	+ ' from lin2log.dbo.' + @table_from  + ' ( nolock) where log_id = 926  '
exec (@sql)

set @table_from = replace ( @table_from, 'data2', 'data' )
set @sql = ' insert into ' + @tmp_table + ' ( log_id, etc_num7, etc_num8 ) ( select log_id, etc_num7, etc_num8 '
	+ ' from lin2log.dbo.' + @table_from  + ' ( nolock) where log_id = 926 ) '
exec (@sql)

-- insert into report table

--  enchant  L--
set @sql = 'insert into ' + RTRIM(@table_to) + ' ( log_date,  item_id, old_enchant, fail_count ) ( ' 
	+ ' select  ' + CAST(@logdate as varchar)  + ', etc_num8, etc_num7, count(log_id)  from  '
	+ @tmp_table + ' ( nolock )  group by etc_num8, etc_num7 ) option (MAXDOP 1 ) '
exec (@sql )

-- drop tmptable
set @sql = ' drop table ' + @tmp_table
exec ( @sql)
GO

/********************************************
lin_RPEnchant
do make enchant item succeeded report table

#argument	@table_from	varchar(60)	log table to be a source
#argument	@table_to	varchar(60)	report table to be a destination
#argument	@logdate	int		the date of report to be created
#return
#result_set
#remark
#example	Exec lin_RPEnchant 'L2004_11_30_log_data_8', 'R2004_11_ENCHANT_8', 20041130
#history	create		young	2003-03-17
#see
********************************************/
ALTER PROCEDURE [DBO].[lin_RPEnchant ]
	@table_from	varchar(60),
	@table_to	varchar(60),
	@logdate	int

AS
SET NOCOUNT ON

declare @sql varchar(4000)

-- check table whether @table_to is exists or not
set @sql = 'select * from lin2report.dbo.sysobjects (nolock) where name = ''' + @table_to + ''''
exec (@sql)

if (@@ROWCOUNT = 0)
begin
	set @sql = 'CREATE TABLE dbo.' + @table_to + ' (' 
		+ ' log_date	int, '
		+ ' item_id	int,'
		+ ' old_enchant	smallint, ' 
		+ ' succeed_count 	int'
		+ ' ) '
	exec (@sql)

	set @sql = 'CREATE INDEX IX_' + @table_to + '_1 on dbo.' + @table_to + ' (log_date) '
	exec (@sql)
end
else begin
	set @sql = 'delete from dbo.' + @table_to + ' where log_date = ' + CAST(@logdate as varchar)
	exec (@sql)
end

-- check tmp table
declare @tmp_table varchar(512)
set @tmp_table = 'dbo.tmp' + @table_to

set @sql = 'select * from lin2report.dbo.sysobjects (nolock) where name = ''tmp' + @table_to + ''''
exec (@sql)

if (@@ROWCOUNT > 0)
begin
	set @sql = ' drop table dbo.tmp' + @table_to
	exec (@sql)
end

-- make tmptable
set @table_from = replace ( @table_from, 'data0', 'data2' )
set @sql = ' select log_id, etc_num5, etc_num8 into ' + @tmp_table
	+ ' from lin2log.dbo.' + @table_from  + ' ( nolock) where log_id = 925  '
exec (@sql)

set @table_from = replace ( @table_from, 'data2', 'data' )
set @sql = ' insert into ' + @tmp_table + ' ( log_id, etc_num5, etc_num8  ) ( select log_id, etc_num5, etc_num8  '
	+ ' from lin2log.dbo.' + @table_from  + ' ( nolock) where log_id = 925 ) '
exec (@sql)

-- insert into report table

--  enchant  L--
set @sql = 'insert into ' + RTRIM(@table_to) + ' ( log_date,  item_id, old_enchant, succeed_count ) ( ' 
	+ ' select  ' + CAST(@logdate as varchar)  + ', etc_num8, etc_num5, count( log_id)  from  '
	+ @tmp_table + ' ( nolock )  group by etc_num8, etc_num5 ) option (MAXDOP 1 ) '
exec (@sql )

-- drop tmptable
set @sql = ' drop table ' + @tmp_table
exec ( @sql)
GO

/********************************************
lin_RPEarnAdena
do make earn adena 

#argument	@table_from	varchar(60)	log table to be a source
#argument	@table_to	varchar(60)	report table to be a destination
#argument	@logdate	int		the date of report to be created
#return
#result_set
#remark		This procedure creates the report by race, sex, class and level
#example	Exec lin_RPEarnAdena 'L2004_11_30_log_data_8', 'R2004_11_EARNADENA_8', 20041130
#history	create		young	2003-03-17
#see
********************************************/
ALTER PROCEDURE [DBO].[lin_RPEarnAdena]
	@table_from	varchar(60),
	@table_to	varchar(60),
	@logdate	int

AS
SET NOCOUNT ON

declare @sql varchar(4000)

-- check table whether @table_to is exists or not
set @sql = 'select * from lin2report.dbo.sysobjects (nolock) where name = ''' + @table_to + ''''
exec (@sql)

if (@@ROWCOUNT = 0)
begin
	set @sql = 'CREATE TABLE dbo.' + @table_to + ' (' 
		+ ' log_date	int, '
		+ 'log_type	smallint, '
		+ 'log_val	int, '
		+ 'log_count 	money , '
		+ ' get_count	int '
		+ ' ) '
	exec (@sql)

	set @sql = 'CREATE INDEX IX_' + @table_to + '_1 on dbo.' + @table_to + ' (log_date) '
	exec (@sql)
end
else begin
	set @sql = 'delete from dbo.' + @table_to + ' where log_date = ' + CAST(@logdate as varchar)
	exec (@sql)
end

-- check tmp table
declare @tmp_table varchar(512)
set @tmp_table = 'dbo.tmp' + @table_to

set @sql = 'select * from lin2report.dbo.sysobjects (nolock) where name = ''tmp' + @table_to + ''''
exec (@sql)

if (@@ROWCOUNT > 0)
begin
	set @sql = ' drop table dbo.tmp' + @table_to
	exec (@sql)
end


-- insert into report table

-- get item


-- make tmptable
set @table_from = replace ( @table_from, 'data0', 'data2' )
set @sql = ' select log_id, etc_num1, etc_num2, etc_num3, etc_num4, etc_num8, etc_num9, actor  into ' + @tmp_table
	+ ' from lin2log.dbo.' + @table_from  + ' ( nolock) where log_id = 906 and etc_num8 = 57  '
exec (@sql)

set @table_from = replace ( @table_from, 'data2', 'data' )
set @sql = ' insert into ' + @tmp_table + ' ( log_id, etc_num1, etc_num2, etc_num3, etc_num4, etc_num8, etc_num9, actor  ) ( select log_id, etc_num1, etc_num2, etc_num3, etc_num4, etc_num8, etc_num9, actor  '
	+ ' from lin2log.dbo.' + @table_from  + ' ( nolock) where log_id = 906 and etc_num8 = 57 ) '
exec (@sql)

-- race - - adena +T -
set @sql = 'insert into ' + RTRIM(@table_to) + ' ( log_date,  log_type, log_val,  log_count, get_count ) ( ' 
	+ ' select ' + CAST(@logdate as varchar) + ', 1, etc_num1, sum(cast (etc_num9 as money) ) , count( distinct actor )  from '
	+ @tmp_table  + ' ( nolock )  group by etc_num1 )  option (MAXDOP 1 ) '
exec (@sql )

-- sex - - adena +T -
set @sql = 'insert into ' + RTRIM(@table_to) + ' ( log_date,  log_type, log_val,  log_count , get_count ) ( ' 
	+ ' select ' + CAST(@logdate as varchar) + ', 2, etc_num2,  sum(cast (etc_num9 as money) )  , count(distinct actor ) from '
	+ @tmp_table  + ' ( nolock )  group by etc_num2 )  option (MAXDOP 1 ) '
exec (@sql )

-- class - - adena +T -
set @sql = 'insert into ' + RTRIM(@table_to) + ' ( log_date,  log_type, log_val,  log_count, get_count ) ( ' 
	+ ' select ' + CAST(@logdate as varchar) + ', 3, etc_num3,  sum(cast (etc_num9 as money) ) , count(distinct actor ) from '
	+ @tmp_table  + ' ( nolock )  group by etc_num3 ) option (MAXDOP 1 ) '
exec (@sql )

-- level - - adena +T -
set @sql = 'insert into ' + RTRIM(@table_to) + ' ( log_date,  log_type, log_val, log_count , get_count) ( ' 
	+ ' select  ' + CAST(@logdate as varchar) + ', 4, etc_num4,  sum(cast (etc_num9 as money) ) , count(distinct actor )  from  '
	+ @tmp_table  + ' ( nolock )  group by etc_num4 )  option (MAXDOP 1 ) '
exec (@sql )

-- drop tmptable
set @sql = ' drop table ' + @tmp_table
exec ( @sql)




-- sell store
-- make tmptable
set @table_from = replace ( @table_from, 'data0', 'data2' )
set @sql = ' select log_id, etc_num1, etc_num2, etc_num3, etc_num4, etc_num8, etc_num9, actor  into ' + @tmp_table
	+ ' from lin2log.dbo.' + @table_from  + ' ( nolock) where log_id = 902 and etc_num8 = 57  '
exec (@sql)

set @table_from = replace ( @table_from, 'data2', 'data' )
set @sql = ' insert into ' + @tmp_table + ' ( log_id, etc_num1, etc_num2, etc_num3, etc_num4, etc_num8, etc_num9, actor  ) ( select log_id, etc_num1, etc_num2, etc_num3, etc_num4, etc_num8, etc_num9, actor  '
	+ ' from lin2log.dbo.' + @table_from  + ' ( nolock) where log_id = 902 and etc_num8 = 57 ) '
exec (@sql)

-- race - - adena +T -
set @sql = 'insert into ' + RTRIM(@table_to) + ' ( log_date,  log_type, log_val,  log_count, get_count ) ( ' 
	+ ' select ' + CAST(@logdate as varchar) + ', 1, etc_num1, sum(cast (etc_num9 as money) ) , count( distinct actor )  from '
	+ @tmp_table  + ' ( nolock ) where   etc_num8 > 0  group by etc_num1 )  option (MAXDOP 1 ) '
exec (@sql )

-- sex - - adena +T -
set @sql = 'insert into ' + RTRIM(@table_to) + ' ( log_date,  log_type, log_val,  log_count , get_count ) ( ' 
	+ ' select ' + CAST(@logdate as varchar) + ', 2, etc_num2,  sum(cast (etc_num9 as money) )  , count(distinct actor ) from '
	+ @tmp_table  + ' ( nolock ) where  etc_num9 > 0  group by etc_num2 )  option (MAXDOP 1 ) '
exec (@sql )

-- class - - adena +T -
set @sql = 'insert into ' + RTRIM(@table_to) + ' ( log_date,  log_type, log_val,  log_count, get_count ) ( ' 
	+ ' select ' + CAST(@logdate as varchar) + ', 3, etc_num3,  sum(cast (etc_num9 as money) ) , count(distinct actor ) from '
	+ @tmp_table  + ' ( nolock ) where  etc_num9 > 0  group by etc_num3 ) option (MAXDOP 1 ) '
exec (@sql )

-- level - - adena +T -
set @sql = 'insert into ' + RTRIM(@table_to) + ' ( log_date,  log_type, log_val, log_count , get_count) ( ' 
	+ ' select  ' + CAST(@logdate as varchar) + ', 4, etc_num4,  sum(cast (etc_num9 as money) ) , count(distinct actor )  from  '
	+ @tmp_table  + ' ( nolock ) where  etc_num9 > 0  group by etc_num4 )  option (MAXDOP 1 ) '
exec (@sql )

-- drop tmptable
set @sql = ' drop table ' + @tmp_table
exec ( @sql)


-- sell private store
-- make tmptable
set @table_from = replace ( @table_from, 'data0', 'data2' )
set @sql = ' select log_id, etc_num1, etc_num2, etc_num3, etc_num4, etc_num10, actor  into ' + @tmp_table
	+ ' from lin2log.dbo.' + @table_from  + ' ( nolock) where log_id = 931 '
exec (@sql)

set @table_from = replace ( @table_from, 'data2', 'data' )
set @sql = ' insert into ' + @tmp_table + ' ( log_id, etc_num1, etc_num2, etc_num3, etc_num4, etc_num10, actor  ) ( select log_id, etc_num1, etc_num2, etc_num3, etc_num4, etc_num10, actor  '
	+ ' from lin2log.dbo.' + @table_from  + ' ( nolock) where log_id = 931 ) '
exec (@sql)


-- race - - adena +T -
set @sql = 'insert into ' + RTRIM(@table_to) + ' ( log_date,  log_type, log_val,  log_count, get_count ) ( ' 
	+ ' select ' + CAST(@logdate as varchar) + ', 1, etc_num1, sum(cast (etc_num10 as money) ) , count( distinct actor )  from '
	+ @tmp_table  + ' ( nolock )  group by etc_num1 )  option (MAXDOP 1 ) '
exec (@sql )

-- sex - - adena +T -
set @sql = 'insert into ' + RTRIM(@table_to) + ' ( log_date,  log_type, log_val,  log_count , get_count ) ( ' 
	+ ' select ' + CAST(@logdate as varchar) + ', 2, etc_num2,  sum(cast (etc_num10 as money) )  , count(distinct actor ) from '
	+ @tmp_table  + ' ( nolock )  group by etc_num2 )  option (MAXDOP 1 ) '
exec (@sql )

-- class - - adena +T -
set @sql = 'insert into ' + RTRIM(@table_to) + ' ( log_date,  log_type, log_val,  log_count, get_count ) ( ' 
	+ ' select ' + CAST(@logdate as varchar) + ', 3, etc_num3,  sum(cast (etc_num10 as money) ) , count(distinct actor ) from '
	+ @tmp_table + ' ( nolock )  group by etc_num3 ) option (MAXDOP 1 ) '
exec (@sql )

-- level - - adena +T -
set @sql = 'insert into ' + RTRIM(@table_to) + ' ( log_date,  log_type, log_val, log_count , get_count) ( ' 
	+ ' select  ' + CAST(@logdate as varchar) + ', 4, etc_num4,  sum(cast (etc_num10 as money) ) , count(distinct actor )  from  '
	+ @tmp_table  + ' ( nolock )  group by etc_num4 )  option (MAXDOP 1 ) '
exec (@sql )

-- drop tmptable
set @sql = ' drop table ' + @tmp_table
exec ( @sql )
GO

/********************************************
lin_RPDieDuration
do make die duration report

#argument	@table_from	varchar(60)	log table to be a source
#argument	@table_to	varchar(60)	report table to be a destination
#argument	@logdate	int		the date of report to be created
#return
#result_set
#remark
#example	Exec lin_RPDieDuration 'L2004_11_30_log_data_8', 'R2004_11_DIEDURATION_8', 20041130
#history	create		young	2003-03-17
#see
********************************************/
ALTER PROCEDURE [DBO].[lin_RPDieDuration]
	@table_from	varchar(60),
	@table_to	varchar(60),
	@logdate	int

AS
SET NOCOUNT ON

declare @sql varchar(4000)

-- check table whether @table_to is exists or not
set @sql = 'select * from lin2report.dbo.sysobjects (nolock) where name = ''' + @table_to + ''''
exec (@sql)

if (@@ROWCOUNT = 0)
begin
	set @sql = 'CREATE TABLE dbo.' + @table_to + ' (' 
		+ ' log_date	int, '
		+ ' npc_id	int, '
		+ ' npc_lev	smallint, '
		+ ' die_duration	int, '
		+ ' die_count	int  '
		+ ' ) '
	exec (@sql)

	set @sql = 'CREATE INDEX IX_' + @table_to + '_1 on dbo.' + @table_to + ' (log_date) '
	exec (@sql)
end
else begin
	set @sql = 'delete from dbo.' + @table_to + ' where log_date = ' + CAST(@logdate as varchar)
	exec (@sql)
end

-- check tmp table
declare @tmp_table varchar(512)
set @tmp_table = 'dbo.tmp' + @table_to

set @sql = 'select * from lin2report.dbo.sysobjects (nolock) where name = ''tmp' + @table_to + ''''
exec (@sql)

if (@@ROWCOUNT > 0)
begin
	set @sql = ' drop table dbo.tmp' + @table_to
	exec (@sql)
end

-- make tmptable
set @table_from = replace ( @table_from, 'data0', 'data2' )
set @sql = ' select log_id, target_account, etc_num7, etc_num8 into ' + @tmp_table
	+ ' from lin2log.dbo.' + @table_from  + ' ( nolock) where log_id = 1112 '
exec (@sql)

set @table_from = replace ( @table_from, 'data2', 'data' )
set @sql = ' insert into ' + @tmp_table + ' ( log_id, target_account, etc_num7, etc_num8) ( select log_id, target_account, etc_num7, etc_num8 '
	+ ' from lin2log.dbo.' + @table_from  + ' ( nolock) where log_id = 1112 ) '
exec (@sql)


-- insert into report table

	-- new report
	set @sql = 'insert into ' + RTRIM(@table_to) + ' ( log_date,  npc_id, npc_lev, die_duration, die_count ) ( ' 
		+ ' select ' + CAST(@logdate as varchar) + ', target_account, etc_num7, sum(etc_num8), count(log_id)  from  '
		+ @tmp_table  + ' ( nolock )  group by target_account , etc_num7 ) option (MAXDOP 1 ) '
	exec (@sql )

-- drop tmptable
set @sql = ' drop table ' + @tmp_table
exec ( @sql )
GO

/********************************************
lin_RPDieDrop
do make die drop item report

#argument	@table_name	varchar(60)	log table to be a source
#argument	@table_to	varchar(60)	report table to be a destination
#argument	@logdate	int		the date of report to be created
#return
#result_set
#remark		This procedure creates the report by race, sex, class and level
#example	Exec lin_RPDieDrop 'L2004_11_30_log_data_8', 'R2004_11_DIEDROP_8', 20041130
#history	create	young	2003-08-19
#see
********************************************/
ALTER PROCEDURE [DBO].[lin_RPDieDrop]
	@table_from	varchar(60),
	@table_to	varchar(60),
	@logdate	int

AS
SET NOCOUNT ON

declare @sql varchar(4000)

-- check table whether @table_to is exists or not
set @sql = 'select * from lin2report.dbo.sysobjects (nolock) where name = ''' + @table_to + ''''
exec (@sql)

if (@@ROWCOUNT = 0)
begin
	set @sql = 'CREATE TABLE dbo.' + @table_to + ' (' 
		+ ' log_date	int, '
		+ ' race		smallint, '
		+ ' class		smallint, '
		+ ' level		smallint, '
		+ ' item_type	int, '
		+ ' drop_count	int, '
		+ ' drop_amount	int  '
		+ ' ) '
	exec (@sql)

	set @sql = 'CREATE INDEX IX_' + @table_to + '_1 on dbo.' + @table_to + ' (log_date) '
	exec (@sql)
end
else begin
	set @sql = 'delete from dbo.' + @table_to + ' where log_date = ' + CAST(@logdate as varchar)
	exec (@sql)
end

-- check tmp table
declare @tmp_table varchar(512)
set @tmp_table = 'dbo.tmp' + @table_to

set @sql = 'select * from lin2report.dbo.sysobjects (nolock) where name = ''tmp' + @table_to + ''''
exec (@sql)

if (@@ROWCOUNT > 0)
begin
	set @sql = ' drop table dbo.tmp' + @table_to
	exec (@sql)
end

-- make tmptable
set @table_from = replace ( @table_from, 'data0', 'data2' )
set @sql = ' select log_id, etc_num1, etc_num3, etc_num4, etc_num8, etc_num9  into ' + @tmp_table
	+ ' from lin2log.dbo.' + @table_from  + ' ( nolock) where log_id = 915 '
exec (@sql)

set @table_from = replace ( @table_from, 'data2', 'data' )
set @sql = ' insert into ' + @tmp_table + ' ( log_id, etc_num1, etc_num3, etc_num4, etc_num8, etc_num9 ) ( select log_id, etc_num1, etc_num3, etc_num4, etc_num8, etc_num9 '
	+ ' from lin2log.dbo.' + @table_from  + ' ( nolock) where log_id = 915 ) '
exec (@sql)


-- insert into report table

set @sql = 'insert into ' + RTRIM(@table_to) + ' ( log_date,  race, class, level, item_type, drop_count, drop_amount  ) ( ' 
	+ ' select ' + CAST(@logdate as varchar) + ', etc_num1, etc_num3, etc_num4, etc_num8, count(log_id) , sum(etc_num9) from '
	+ @tmp_table  + ' ( nolock )  group by  etc_num1, etc_num3, etc_num4, etc_num8 )  option (MAXDOP 1 ) '

exec (@sql )

-- 
set @sql = ' drop  table ' + @tmp_table
exec ( @sql )
GO

/********************************************
lin_RPDailyLevUp
do make a report table that shows how many character do level-up daily

#argument	@table_from	varchar(60)	log table to be a source
#argument	@table_to	varchar(60)	report table to be a destination
#argument	@logdate	int		the date of report to be created
#return
#result_set
#remark
#example	lin_RPDailyLevUp 'L2004_06_26_log_data_8', 'R2004_06_LEVUP_8', 20040626
#history	create		flagoftiger	2004-06-28
#history	modified		zzangse		2004-11-11
#history	modified		kernel0		2005-05-04
#see
********************************************/
ALTER PROCEDURE [DBO].[lin_RPDailyLevUp]
	@table_from	varchar(60),
	@table_to	varchar(60),
	@logdate	int

AS
SET NOCOUNT ON

declare @sql varchar(4000)

-- check table whether @table_to is exists or not
set @sql = 'select * from lin2report.dbo.sysobjects (nolock) where name = ''' + @table_to + ''''
exec (@sql)

if (@@ROWCOUNT = 0)
begin
	set @sql = 'CREATE TABLE dbo.' + @table_to + ' (' 
		+ ' log_date	int, '
		+ ' char_id	int, '
		+ ' char_name	nvarchar(60), '
		+ ' lev_min	smallint, '
		+ ' lev_max	smallint, '
		+ ' lev_diff	smallint, '
		+ ' exp_min	int, '
		+ ' exp_max	int, '
		+ ' exp_diff	int, '
		+ ' class              int '
		+ ' ) '
	exec (@sql)

	set @sql = 'CREATE clustered INDEX IX_' + @table_to + '_2 on dbo.' + @table_to + ' (log_date asc, exp_diff desc ) with fillfactor = 90 '
	exec (@sql)
end
else begin
	set @sql = 'delete from dbo.' + @table_to + ' where log_date = ' + CAST(@logdate as varchar)
	exec (@sql)
end

-- check tmp table
declare @tmp_table varchar(512)
set @tmp_table = 'dbo.tmp' + @table_to

set @sql = 'select * from lin2report.dbo.sysobjects (nolock) where name = ''tmp' + @table_to + ''''
exec (@sql)

if (@@ROWCOUNT > 0)
begin
	set @sql = ' drop table dbo.tmp' + @table_to
	exec (@sql)
end

-- make tmptable
set @sql = ' select log_id, actor, STR_actor, etc_num7, etc_num4, etc_num5  into ' + @tmp_table
	+ ' from lin2log.dbo.' + @table_from  + ' ( nolock ) where log_id = 813   '
exec (@sql)



-- insert into report table
-- begin quest report
set @sql = 'insert into ' + RTRIM(@table_to) + ' ( log_date, char_id, char_name, lev_min, lev_max, lev_diff, exp_min, exp_max, exp_diff, class  ) ( ' 
	+ ' select ' + CAST(@logdate as varchar) + ', actor, STR_actor, min(etc_num4), max(etc_num4), 0, 0, 0, sum(etc_num7), etc_num5  from '
	+ @tmp_table + ' ( nolock )  group by  actor, STR_actor, etc_num5	) option (MAXDOP 1 ) '
exec (@sql )

-- drop tmptable
set @sql = ' drop table ' + @tmp_table
exec (@sql)
GO

/********************************************
lin_RPCrystalize
do make die item crystalize stats

#argument	@table_from	varchar(60)	log table to be a source
#argument	@table_to	varchar(60)	report table to be a destination
#argument	@logdate	int		the date of report to be created
#return
#result_set
#remark
#example	Exec lin_RPCrystalize 'L2004_11_30_log_data_8', 'R2004_11_CRYSTALIZE_8', 20041130
#history	create		young	2003-06-02
#see
********************************************/
ALTER PROCEDURE [DBO].[lin_RPCrystalize]
	@table_from	varchar(60),
	@table_to	varchar(60),
	@logdate	int

AS
SET NOCOUNT ON

declare @sql varchar(4000)

-- check table whether @table_to is exists or not
set @sql = 'select * from lin2report.dbo.sysobjects (nolock) where name = ''' + @table_to + ''''
exec (@sql)

if (@@ROWCOUNT = 0)
begin
	set @sql = 'CREATE TABLE dbo.' + @table_to + ' (' 
		+ ' log_date	int, '
		+ ' item_id	int, '
		+ ' enchant 	int, '
		+ ' cry_item_id	int, '
		+ ' item_cnt	int, '
		+ ' cry_item_cnt	int  '
		+ ' ) '
	exec (@sql)

	set @sql = 'CREATE INDEX IX_' + @table_to + '_1 on dbo.' + @table_to + ' (log_date) '
	exec (@sql)
end
else begin
	set @sql = 'delete from dbo.' + @table_to + ' where log_date = ' + CAST(@logdate as varchar)
	exec (@sql)
end

-- check tmp table
declare @tmp_table varchar(512)
set @tmp_table = 'dbo.tmp' + @table_to

set @sql = 'select * from lin2report.dbo.sysobjects (nolock) where name = ''tmp' + @table_to + ''''
exec (@sql)

if (@@ROWCOUNT > 0)
begin
	set @sql = ' drop table dbo.tmp' + @table_to
	exec (@sql)
end


-- make tmptable
set @table_from = replace ( @table_from, 'data0', 'data2' )
set @sql = ' select log_id, etc_num5, etc_num7, etc_num8, etc_num9 , etc_num10  into ' + @tmp_table
	+ ' from lin2log.dbo.' + @table_from  + ' ( nolock) where log_id = 933 '
exec (@sql)

set @table_from = replace ( @table_from, 'data2', 'data' )
set @sql = ' insert into ' + @tmp_table + ' ( log_id, etc_num5, etc_num7,  etc_num8, etc_num9 , etc_num10  ) ( select log_id, etc_num5, etc_num7, etc_num8, etc_num9 , etc_num10  '
	+ ' from lin2log.dbo.' + @table_from  + ' ( nolock) where log_id = 933 ) '
exec (@sql)



-- insert into report table
-- levelup report

set @sql = 'insert into ' + RTRIM(@table_to) + ' ( log_date,  item_id, enchant, cry_item_id, item_cnt, cry_item_cnt ) ( ' 
	+ ' select ' + CAST(@logdate as varchar) + ', etc_num8, etc_num7, etc_num5, count( etc_num8 ), sum(etc_num10) from  '
	+ @tmp_table  + ' ( nolock )  group by  etc_num8, etc_num7, etc_num5 ) option (MAXDOP 1 ) '
exec (@sql )

-- 
set @sql = ' drop table ' + @tmp_table
exec ( @sql )
GO

/********************************************
lin_RPConcurrent
do make concurrent connection  report

#argument	@table_from	varchar(60)	log table to be a source
#argument	@table_to	varchar(60)	report table to be a destination
#argument	@logdate	int		the date of report to be created
#return
#result_set
#remark
#example	Exec lin_RPConcurrent 'L2004_11_30_log_data_8', 'R2004_11_CONCURRENT_8', 20041130
#history	create	young	2003-03-17
#see
********************************************/
ALTER PROCEDURE [DBO].[lin_RPConcurrent]
	@table_from	varchar(60),
	@table_to	varchar(60),
	@logdate	int

AS
SET NOCOUNT ON

declare @sql varchar(4000)

-- check table whether @table_to is exists or not
set @sql = 'select * from lin2report.dbo.sysobjects (nolock) where name = ''' + @table_to + ''''
exec (@sql)

if (@@ROWCOUNT = 0)
begin
	set @sql = 'CREATE TABLE dbo.' + @table_to + ' (' 
		+ ' log_date	int, '
		+ ' log_hour	smallint, '
		+ ' log_min	smallint, '
		+ ' min_logon	int, '
		+ ' max_logon	int  '
		+ ' ) '
	exec (@sql)

	set @sql = 'CREATE INDEX IX_' + @table_to + '_1 on dbo.' + @table_to + ' (log_date) '
	exec (@sql)
end
else begin
	set @sql = 'delete from dbo.' + @table_to + ' where log_date = ' + CAST(@logdate as varchar)
	exec (@sql)
end

-- check tmp table
declare @tmp_table varchar(512)
set @tmp_table = 'dbo.tmp' + @table_to

set @sql = 'select * from lin2report.dbo.sysobjects (nolock) where name = ''tmp' + @table_to + ''''
exec (@sql)

if (@@ROWCOUNT > 0)
begin
	set @sql = ' drop table dbo.tmp' + @table_to
	exec (@sql)
end



-- make tmptable
set @table_from = replace ( @table_from, 'data0', 'data2' )
set @sql = ' select log_id, act_time, etc_num5 into ' + @tmp_table
	+ ' from lin2log.dbo.' + @table_from  + ' ( nolock) where log_id = 803 '
exec (@sql)

set @table_from = replace ( @table_from, 'data2', 'data' )
set @sql = ' insert into ' + @tmp_table + ' ( log_id, act_time, etc_num5 ) ( select log_id, act_time, etc_num5 '
	+ ' from lin2log.dbo.' + @table_from  + ' ( nolock) where log_id = 803 ) '
exec (@sql)

-- insert into report table
-- levelup report
set @sql = 'insert into ' + RTRIM(@table_to) + ' ( log_date,  log_hour, log_min, min_logon, max_logon ) ( ' 
	+ ' select ' + CAST(@logdate as varchar) + ', datepart(hour, act_time), datepart(minute, act_time), min(etc_num5),  max(etc_num5)  from  '
	+ @tmp_table  + ' ( nolock )  group by datepart(hour, act_time), datepart(minute, act_time)  )  option (MAXDOP 1 ) '
exec (@sql )

--
set @sql = ' drop table ' + @tmp_table
exec ( @sql )
GO

/********************************************
lin_RPClassInc
do make class  increase report table

#argument	@table_from	varchar(60)	log table to be a source
#argument	@table_to	varchar(60)	report table to be a destination
#argument	@logdate	int		the date of report to be created
#return
#result_set
#remark
#example	Exec lin_RPClassInc 'L2004_11_30_log_data_8', 'R2004_11_CLASSINC_8', 20041130
#history	create	young	2003-11-10
#see
********************************************/
ALTER PROCEDURE [DBO].[lin_RPClassInc ]
	@table_from	varchar(60),
	@table_to	varchar(60),
	@logdate	int

AS
SET NOCOUNT ON

declare @sql varchar(4000)

-- check table whether @table_to is exists or not
set @sql = 'select * from lin2report.dbo.sysobjects (nolock) where name = ''' + @table_to + ''''
exec (@sql)

if (@@ROWCOUNT = 0)
begin
	set @sql = 'CREATE TABLE dbo.' + @table_to + ' (' 
		+ ' log_date	int, '
		+ ' class		int, '
		+ ' amount	int '
		+ ' ) '
	exec (@sql)

	set @sql = 'CREATE INDEX IX_' + @table_to + '_1 on dbo.' + @table_to + ' (log_date) '
	exec (@sql)
end
else begin
	set @sql = 'delete from dbo.' + @table_to + ' where log_date = ' + CAST(@logdate as varchar)
	exec (@sql)
end

-- check tmp table
declare @tmp_table varchar(512)
set @tmp_table = 'dbo.tmp' + @table_to

set @sql = 'select * from lin2report.dbo.sysobjects (nolock) where name = ''tmp' + @table_to + ''''
exec (@sql)

if (@@ROWCOUNT > 0)
begin
	set @sql = ' drop table dbo.tmp' + @table_to
	exec (@sql)
end

-- insert into report table

--  class change
-- log_id = 816
-- make tmptable
set @table_from = replace ( @table_from, 'data0', 'data2' )
set @sql = ' select log_id, etc_num3 into ' + @tmp_table
	+ ' from lin2log.dbo.' + @table_from  + ' ( nolock) where log_id = 816  '
exec (@sql)

set @table_from = replace ( @table_from, 'data2', 'data' )
set @sql = ' insert into ' + @tmp_table + ' ( log_id, etc_num3 ) ( select log_id, etc_num3 '
	+ ' from lin2log.dbo.' + @table_from  + ' ( nolock) where log_id = 816 ) '
exec (@sql)

set @sql = 'insert into ' + RTRIM(@table_to) + ' ( log_date,  class, amount ) ( ' 
	+ ' select  ' + CAST(@logdate as varchar)  + ', etc_num3, count( log_id ) from  '
	+ @tmp_table  + ' ( nolock )  group by etc_num3  ) option (MAXDOP 1 ) '
exec (@sql )

-- drop tmptable
set @sql = ' drop table ' + @tmp_table
exec (@sql)
GO

/********************************************
lin_RPClassDec
do make class  decrease report table

#argument	@table_from	varchar(60)	log table to be a source
#argument	@table_to	varchar(60)	report table to be a destination
#argument	@logdate	int		the date of report to be created
#return
#result_set
#remark
#example	Exec lin_RPClassDec 'L2004_11_30_log_data_8', 'R2004_11_CLASSDEC_8', 20041130
#history	create	young	2003-11-10
#see
********************************************/
ALTER PROCEDURE [DBO].[lin_RPClassDec ]
	@table_from	varchar(60),
	@table_to	varchar(60),
	@logdate	int

AS
SET NOCOUNT ON

declare @sql varchar(4000)

-- check table whether @table_to is exists or not
set @sql = 'select * from lin2report.dbo.sysobjects (nolock) where name = ''' + @table_to + ''''
exec (@sql)

if (@@ROWCOUNT = 0)
begin
	set @sql = 'CREATE TABLE dbo.' + @table_to + ' (' 
		+ ' log_date	int, '
		+ ' class		int, '
		+ ' amount	int '
		+ ' ) '
	exec (@sql)

	set @sql = 'CREATE INDEX IX_' + @table_to + '_1 on dbo.' + @table_to + ' (log_date) '
	exec (@sql)
end
else begin
	set @sql = 'delete from dbo.' + @table_to + ' where log_date = ' + CAST(@logdate as varchar)
	exec (@sql)
end

-- check tmp table
declare @tmp_table varchar(512)
set @tmp_table = 'dbo.tmp' + @table_to

set @sql = 'select * from lin2report.dbo.sysobjects (nolock) where name = ''tmp' + @table_to + ''''
exec (@sql)

if (@@ROWCOUNT > 0)
begin
	set @sql = ' drop table dbo.tmp' + @table_to
	exec (@sql)
end

-- insert into report table

--  class change
-- log_id = 816
-- make tmptable
set @table_from = replace ( @table_from, 'data0', 'data2' )
set @sql = ' select log_id, etc_num5 into ' + @tmp_table
	+ ' from lin2log.dbo.' + @table_from  + ' ( nolock) where log_id = 816  '
exec (@sql)

set @table_from = replace ( @table_from, 'data2', 'data' )
set @sql = ' insert into ' + @tmp_table + ' ( log_id, etc_num5 ) ( select log_id, etc_num5 '
	+ ' from lin2log.dbo.' + @table_from  + ' ( nolock) where log_id = 816 ) '
exec (@sql)

set @sql = 'insert into ' + RTRIM(@table_to) + ' ( log_date,  class, amount ) ( ' 
	+ ' select  ' + CAST(@logdate as varchar)  + ', etc_num5, -1 * count( log_id ) from  '
	+ @tmp_table  + ' ( nolock )  group by etc_num5  ) option (MAXDOP 1 ) '
exec (@sql )

-- drop tmptable
set @sql = ' drop table ' + @tmp_table
exec (@sql)
GO

/********************************************
lin_RPClass
do make class change report table

#argument	@table_from	varchar(60)	log table to be a source
#argument	@table_to	varchar(60)	report table to be a destination
#argument	@logdate	int		the date of report to be created
#return
#result_set
#remark
#example	Exec lin_RPClass 'L2004_11_30_log_data_8', 'R2004_11_CLASS_8', 20041130
#history	create		young	203-03-17
#see
********************************************/
ALTER PROCEDURE [DBO].[lin_RPClass ]
	@table_from	varchar(60),
	@table_to	varchar(60),
	@logdate	int

AS
SET NOCOUNT ON

declare @sql varchar(4000)

-- check table whether @table_to is exists or not
set @sql = 'select * from lin2report.dbo.sysobjects (nolock) where name = ''' + @table_to + ''''
exec (@sql)

if (@@ROWCOUNT = 0)
begin
	set @sql = 'CREATE TABLE dbo.' + @table_to + ' (' 
		+ ' log_date	int, '
		+ ' old_class	smallint, '
		+ ' new_class	smallint, '
		+ ' change_count 	int'
		+ ' ) '
	exec (@sql)

	set @sql = 'CREATE INDEX IX_' + @table_to + '_1 on dbo.' + @table_to + ' (log_date) '
	exec (@sql)
end
else begin
	set @sql = 'delete from dbo.' + @table_to + ' where log_date = ' + CAST(@logdate as varchar)
	exec (@sql)
end

-- check tmp table
declare @tmp_table varchar(512)
set @tmp_table = 'dbo.tmp' + @table_to

set @sql = 'select * from lin2report.dbo.sysobjects (nolock) where name = ''tmp' + @table_to + ''''
exec (@sql)

if (@@ROWCOUNT > 0)
begin
	set @sql = ' drop table dbo.tmp' + @table_to
	exec (@sql)
end

-- make tmptable
set @table_from = replace ( @table_from, 'data0', 'data2' )
set @sql = ' select log_id, etc_num3, etc_num5, etc_num7  into ' + @tmp_table
	+ ' from lin2log.dbo.' + @table_from  + ' ( nolock) where log_id = 816 and ( etc_num7 is null or etc_num7 = 0 )  '
exec (@sql)

set @table_from = replace ( @table_from, 'data2', 'data' )
set @sql = ' insert into ' + @tmp_table + ' ( log_id, etc_num3, etc_num5, etc_num7  ) ( select log_id, etc_num3, etc_num5, etc_num7  '
	+ ' from lin2log.dbo.' + @table_from  + ' ( nolock) where log_id = 816 and ( etc_num7 is null or etc_num7 = 0 )  ) '
exec (@sql)


-- insert into report table

--  L+T L--
set @sql = 'insert into ' + RTRIM(@table_to) + ' ( log_date,  old_class, new_class, change_count ) ( ' 
	+ ' select  ' + CAST(@logdate as varchar)  + ', etc_num5, etc_num3, count(log_id)  from '
	+ @tmp_table + ' ( nolock )  group by etc_num5, etc_num3 ) option (MAXDOP 1 ) '
exec (@sql )

-- drop 
set @sql = ' drop table ' + @tmp_table
exec ( @sql )
GO

/********************************************
lin_RPCharPlayTime
do make char play time report

#argument	@table_from	varchar(60)	log table to be a source
#argument	@table_to	varchar(60)	report table to be a destination
#argument	@logdate	int		the date of report to be created
#return
#result_set
#remark
#example	Exec lin_RPCharPlayTime 'L2004_11_30_log_data_8', 'R2004_11_CHARPALYTIME_8', 20041130
#history	create	 young	2003-10-22
#see
********************************************/
ALTER PROCEDURE [DBO].[lin_RPCharPlayTime]
	@table_from	varchar(60),
	@table_to	varchar(60),
	@logdate	int

AS
SET NOCOUNT ON

declare @sql varchar(4000)

-- check table whether @table_to is exists or not
set @sql = 'select * from lin2report.dbo.sysobjects (nolock) where name = ''' + @table_to + ''''
exec (@sql)

if (@@ROWCOUNT = 0)
begin
	set @sql = 'CREATE TABLE dbo.' + @table_to + ' (' 
		+ ' log_date	int, '
		+ ' user_id	int, '
		+ ' user_level	int, '
		+ ' log_count	int, '
		+ ' play_time	int '
		+ ' ) '
	exec (@sql)

	set @sql = 'CREATE INDEX IX_' + @table_to + '_1 on dbo.' + @table_to + ' (log_date) '
	exec (@sql)
end
else begin
	set @sql = 'delete from dbo.' + @table_to + ' where log_date = ' + CAST(@logdate as varchar)
	exec (@sql)
end

-- check tmp table
declare @tmp_table varchar(512)
set @tmp_table = 'dbo.tmp' + @table_to

set @sql = 'select * from lin2report.dbo.sysobjects (nolock) where name = ''tmp' + @table_to + ''''
exec (@sql)

if (@@ROWCOUNT > 0)
begin
	set @sql = ' drop table dbo.tmp' + @table_to
	exec (@sql)
end

-- make tmptable
set @table_from = replace ( @table_from, 'data0', 'data2' )
set @sql = ' select log_id, actor, etc_num4, etc_num5 into ' + @tmp_table
	+ ' from lin2log.dbo.' + @table_from  + ' ( nolock) where log_id = 805  '
exec (@sql)

set @table_from = replace ( @table_from, 'data2', 'data' )
set @sql = ' insert into ' + @tmp_table + ' ( log_id, actor, etc_num4, etc_num5 ) ( select log_id, actor, etc_num4, etc_num5 '
	+ ' from lin2log.dbo.' + @table_from  + ' ( nolock) where log_id = 805 ) '
exec (@sql)


-- insert into report table
-- char play time report
set @sql = 'insert into ' + RTRIM(@table_to) + ' ( log_date,  user_id, user_level, log_count, play_time ) ( ' 
	+ ' select ' + CAST(@logdate as varchar) + ', actor, max ( etc_num4), count ( log_id), sum (etc_num5)  from '
	+ @tmp_table + ' ( nolock )  group by actor )  option (MAXDOP 1 ) '

exec (@sql )


-- drop tmptable
set @sql = ' drop table ' + @tmp_table
exec ( @sql )
GO

/********************************************
lin_RPCharPlay
do make char play stat

#argument	@table_from	varchar(60)	log table to be a source
#argument	@table_to	varchar(60)	report table to be a destination
#argument	@logdate	int		the date of report to be created
#return
#result_set
#remark
#example	Exec lin_RPCharPlay 'L2004_11_30_log_data_8', 'R2004_11_CHARPLAY_8', 20041130
#history	create		young	2004-03-16
#see
********************************************/
ALTER PROCEDURE [DBO].[lin_RPCharPlay]
	@table_from	varchar(60),
	@table_to	varchar(60),
	@logdate	int

AS
SET NOCOUNT ON

declare @sql varchar(4000)

-- check table whether @table_to is exists or not
set @sql = 'select * from lin2report.dbo.sysobjects (nolock) where name = ''' + @table_to + ''''
exec (@sql)

if (@@ROWCOUNT = 0)
begin
	set @sql = 'CREATE TABLE dbo.' + @table_to + ' (' 
		+ ' log_date	int, '
		+ ' class		smallint, '
		+ ' level		smallint, '
		+ ' loc_x		int, '
		+ ' loc_y		int,  '
		+ ' play_count	int   '
		+ ' ) '
	exec (@sql)

	set @sql = 'CREATE INDEX IX_' + @table_to + '_1 on dbo.' + @table_to + ' ( log_date, loc_x,  loc_y,class,  level  ) '
	exec (@sql)
end
else begin
	set @sql = 'delete from dbo.' + @table_to + ' where log_date = ' + CAST(@logdate as varchar)
	exec (@sql)
end



-- check tmp table
declare @tmp_table varchar(512)
set @tmp_table = 'dbo.tmp' + @table_to

set @sql = 'select * from lin2report.dbo.sysobjects (nolock) where name = ''tmp' + @table_to + ''''
exec (@sql)

if (@@ROWCOUNT > 0)
begin
	set @sql = ' drop table dbo.tmp' + @table_to
	exec (@sql)
end

-- make tmptable
set @table_from = replace ( @table_from, 'data0', 'data2' )
set @sql = ' select log_id, etc_num10, etc_num5, location_x, location_y into ' + @tmp_table
	+ ' from lin2log.dbo.' + @table_from  + ' ( nolock) where log_id = 812  '
exec (@sql)

set @table_from = replace ( @table_from, 'data2', 'data' )
set @sql = ' insert into ' + @tmp_table + ' ( log_id, etc_num10, etc_num5, location_x, location_y ) ( select log_id, etc_num10, etc_num5, location_x, location_y '
	+ ' from lin2log.dbo.' + @table_from  + ' ( nolock) where log_id = 812 ) '
exec (@sql)

-- insert into report table
-- begin quest report
set @sql = 'insert into ' + RTRIM(@table_to) + ' ( log_date,  class, level, loc_x, loc_y, play_count ) ( ' 
	+ ' select ' + CAST(@logdate as varchar) + ', etc_num10, etc_num5, floor( location_x / 1024.0) ,  floor ( location_y / 1024.0 ) , count ( log_id )  from '
	+ @tmp_table  + ' ( nolock )  group by etc_num10, etc_num5, floor( location_x / 1024.0) ,  floor ( location_y / 1024.0 )   )  option (MAXDOP 1 ) '
exec (@sql )

-- drop tmptable
set @sql = ' drop table ' + @tmp_table
exec ( @sql )
GO

/********************************************
lin_RPCastSpoil
do make cast spoin skill stats

#argument	@table_from	varchar(60)	log table to be a source
#argument	@table_to	varchar(60)	report table to be a destination
#argument	@logdate	int		the date of report to be created
#return
#result_set
#remark
#example	Exec lin_RPCastSpoil 'L2004_11_30_log_data_8', 'R2004_11_CASTSPOIL_8', 20041130
#history	create	young	2003-12-16
#see
********************************************/
ALTER PROCEDURE [DBO].[lin_RPCastSpoil]
	@table_from	varchar(60),
	@table_to	varchar(60),
	@logdate	int

AS
SET NOCOUNT ON

declare @sql varchar(4000)

-- check table whether @table_to is exists or not
set @sql = 'select * from lin2report.dbo.sysobjects (nolock) where name = ''' + @table_to + ''''
exec (@sql)

if (@@ROWCOUNT = 0)
begin
	set @sql = 'CREATE TABLE dbo.' + @table_to + ' (' 
		+ ' log_date	int, '
		+ ' log_type	smallint, '
		+ ' x_loc		int, '
		+ ' y_loc 	int, '
		+ ' npc_classid 	int, '
		+ ' cast_count	int '
		+ ' ) '
	exec (@sql)

	set @sql = 'CREATE INDEX IX_' + @table_to + '_1 on dbo.' + @table_to + ' (log_date) '
	exec (@sql)

	set @sql = 'CREATE INDEX IX_' + @table_to + '_3 on dbo.' + @table_to + ' (npc_classid) '
	exec (@sql)

end
else begin
	set @sql = 'delete from dbo.' + @table_to + ' where log_date = ' + CAST(@logdate as varchar)
	exec (@sql)
end

-- check tmp table
declare @tmp_table varchar(512)
set @tmp_table = 'dbo.tmp' + @table_to

set @sql = 'select * from lin2report.dbo.sysobjects (nolock) where name = ''tmp' + @table_to + ''''
exec (@sql)

if (@@ROWCOUNT > 0)
begin
	set @sql = ' drop table dbo.tmp' + @table_to
	exec (@sql)
end


-- make tmptable
set @table_from = replace ( @table_from, 'data0', 'data2' )
set @sql = ' select log_id, target, etc_num5,  location_x, location_y  into ' + @tmp_table
	+ ' from lin2log.dbo.' + @table_from  + ' ( nolock) where log_id = 403 and etc_num5 = 254  '
exec (@sql)

set @table_from = replace ( @table_from, 'data2', 'data' )
set @sql = ' insert into ' + @tmp_table + ' ( log_id, target, etc_num5,  location_x, location_y  ) ( select log_id, target, etc_num5,  location_x, location_y  '
	+ ' from lin2log.dbo.' + @table_from  + ' ( nolock) where log_id = 403 and etc_num5 = 254 ) '
exec (@sql)


-- insert into report table

-- 
set @sql = 'insert into ' + RTRIM(@table_to) + ' ( log_date,  log_type, x_loc, y_loc, npc_classid, cast_count  ) ( ' 
	+ ' select ' + CAST(@logdate as varchar) + ', 1,  FLOOR(location_x / 32768.0) , FLOOR(location_y / 32768.0) , target, count( target )  from '
	+ @tmp_table + '  ( nolock )  group by FLOOR(location_x / 32768.0) , FLOOR(location_y / 32768.0) , target  )  option (MAXDOP 1 ) '
exec (@sql )

-- 
set @sql = 'insert into ' + RTRIM(@table_to) + ' ( log_date,  log_type, x_loc, y_loc, npc_classid, cast_count  ) ( ' 
	+ ' select ' + CAST(@logdate as varchar) + ', 2,  FLOOR(location_x / 1024.0) , FLOOR(location_y / 1024.0) , target, count( target )  from '
	+ @tmp_table + '  ( nolock )  group by FLOOR(location_x / 1024.0) , FLOOR(location_y / 1024.0) , target  )  option (MAXDOP 1 ) '
exec (@sql )

-- drop tmptable
set @sql = ' drop table ' + @tmp_table
exec (@sql)
GO

/********************************************
lin_RPCastSkill
do make cast skill report

#argument	@table_from	varchar(60)	log table to be a source
#argument	@table_to	varchar(60)	report table to be a destination
#argument	@logdate	int		the date of report to be created
#return
#result_set
#remark		This procedure creates the report by race, sex, class and level
#example	Exec lin_RPCastSkill 'L2004_11_30_log_data_8', 'R2004_11_CASTSKILL_8', 20041130
#history	create		young	2003-03-28
#see
********************************************/
ALTER PROCEDURE [DBO].[lin_RPCastSkill]
	@table_from	varchar(60),
	@table_to	varchar(60),
	@logdate	int

AS
SET NOCOUNT ON

declare @sql varchar(4000)

-- check table whether @table_to is exists or not
set @sql = 'select * from lin2report.dbo.sysobjects (nolock) where name = ''' + @table_to + ''''
exec (@sql)

if (@@ROWCOUNT = 0)
begin
	set @sql = 'CREATE TABLE dbo.' + @table_to + ' (' 
		+ ' log_date	int, '
		+ 'log_type	smallint, '
		+ 'log_val	int, '
		+ ' skill_id 	int , '
		+ ' skill_level 	smallint , '
		+ ' cast_count 	int  '
		+ ' ) '
	exec (@sql)

	set @sql = 'CREATE INDEX IX_' + @table_to + '_1 on dbo.' + @table_to + ' (log_date) '
	exec (@sql)
end
else begin
	set @sql = 'delete from dbo.' + @table_to + ' where log_date = ' + CAST(@logdate as varchar)
	exec (@sql)
end

-- check tmp table
declare @tmp_table varchar(512)
set @tmp_table = 'dbo.tmp' + @table_to

set @sql = 'select * from lin2report.dbo.sysobjects (nolock) where name = ''tmp' + @table_to + ''''
exec (@sql)

if (@@ROWCOUNT > 0)
begin
	set @sql = ' drop table dbo.tmp' + @table_to
	exec (@sql)
end

-- make tmptable
set @table_from = replace ( @table_from, 'data0', 'data2' )
set @sql = ' select log_id, etc_num1, etc_num2, etc_num3, etc_num4, etc_num5, etc_num6, etc_num7 into ' + @tmp_table
	+ ' from lin2log.dbo.' + @table_from  + ' ( nolock) where log_id = 403 and ( etc_num7 is null or etc_num7 = 0 )  '
exec (@sql)

set @table_from = replace ( @table_from, 'data2', 'data' )
set @sql = ' insert into ' + @tmp_table + ' ( log_id, etc_num1, etc_num2, etc_num3, etc_num4, etc_num5, etc_num6, etc_num7 ) ( select log_id, etc_num1, etc_num2, etc_num3, etc_num4, etc_num5, etc_num6, etc_num7  '
	+ ' from lin2log.dbo.' + @table_from  + ' ( nolock) where log_id = 403 and ( etc_num7 is null or etc_num7 = 0 )  ) '
exec (@sql)

-- insert into report table

-- race L--
set @sql = 'insert into ' + RTRIM(@table_to) + ' ( log_date,  log_type, log_val,  skill_id, skill_level, cast_count ) ( ' 
	+ ' select ' + CAST(@logdate as varchar) + ', 1, etc_num1, etc_num5, etc_num6, count(log_id )  from   '
	+ @tmp_table + ' ( nolock )  group by etc_num5, etc_num6, etc_num1   )  option (MAXDOP 1 ) '
exec (@sql )
-- sex  L--
set @sql = 'insert into ' + RTRIM(@table_to) + ' ( log_date,  log_type, log_val,  skill_id, skill_level, cast_count ) ( ' 
	+ ' select ' + CAST(@logdate as varchar) + ', 2, etc_num2, etc_num5, etc_num6, count(log_id)  from  '
	+ @tmp_table  + ' ( nolock ) group by etc_num5, etc_num6, etc_num2    )  option (MAXDOP 1 ) '
exec (@sql )
-- class  L--
set @sql = 'insert into ' + RTRIM(@table_to) + ' ( log_date,  log_type, log_val,  skill_id, skill_level, cast_count ) ( ' 
	+ ' select ' + CAST(@logdate as varchar) + ', 3, etc_num3,  etc_num5, etc_num6, count(log_id) from  '
	+ @tmp_table  + ' ( nolock )  group by etc_num5, etc_num6, etc_num3  ) option (MAXDOP 1 )  '
exec (@sql )
-- level  L--
set @sql = 'insert into ' + RTRIM(@table_to) + ' ( log_date,  log_type, log_val,  skill_id, skill_level, cast_count ) ( ' 
	+ ' select  ' + CAST(@logdate as varchar) + ', 4, etc_num4,  etc_num5, etc_num6, count(log_id) from  '
	+ @tmp_table  + ' ( nolock )  group by etc_num5, etc_num6, etc_num4   )  option (MAXDOP 1 ) '
exec (@sql )

set @sql = ' drop table  ' + @tmp_table
exec ( @sql )
GO

/********************************************
lin_RPCastleWar
do make castle war winner report

#argument	@table_from	varchar(60)	varchar(60)	log table to be a source
#argument	@table_to	varchar(60)	report table to be a destination
#argument	@logdate	int		the date of report to be created
#return
#result_set
#remark
#example	Exec lin_RPCastleWar 'L2004_11_30_log_data_8', 'R2004_11_CASTLEWAR_8', 20041130
#history	create	young	2004-01-15
#see
********************************************/
ALTER PROCEDURE [DBO].[lin_RPCastleWar]
	@table_from	varchar(60),
	@table_to	varchar(60),
	@logdate	int

AS
SET NOCOUNT ON

declare @sql varchar(4000)

-- check table whether @table_to is exists or not
set @sql = 'select * from lin2report.dbo.sysobjects (nolock) where name = ''' + @table_to + ''''
exec (@sql)

if (@@ROWCOUNT = 0)
begin
	set @sql = 'CREATE TABLE dbo.' + @table_to + ' (' 
		+ ' log_date	int, '
		+ ' pledge_name	varchar(50), '
		+ ' log_id	int, '
		+ ' act_time	datetime, '
		+ ' castle_id 	int , '
		+ ' pledge_id 	int , '
		+ ' alliance_id 	int  '
		+ ' ) '
	exec (@sql)

	set @sql = 'CREATE INDEX IX_' + @table_to + '_1 on dbo.' + @table_to + ' (log_date) '
	exec (@sql)

end
else begin
	set @sql = 'delete from dbo.' + @table_to + ' where log_date = ' + CAST(@logdate as varchar)
	exec (@sql)
end


-- insert into report table

-- 
set @sql = 'insert into ' + RTRIM(@table_to) + ' ( log_date,  pledge_name, log_id, act_time,  castle_id, pledge_id, alliance_id ) ( ' 
	+ ' select ' + CAST(@logdate as varchar) + ', etc_str1, log_id, act_time, etc_num1, etc_num2, etc_num3  from lin2log.dbo.' + @table_from 
	+ ' (nolock)  where log_id in ( 244, 245 )  )  option (MAXDOP 1 ) '
exec (@sql )
GO

/********************************************
lin_RPCastleTaxTribute
do make castle tax tribute

#argument	@table_from	varchar(60)	log table to be a source
#argument	@table_to	varchar(60)	report table to be a destination
#argument	@logdate	int		the date of report to be created
#return
#result_set
#remark
#example	Exec lin_RPCastleTaxTribute 'L2004_11_30_log_data_8', 'R2004_11_TAXTRIBUTE_8', 20041130
#history	create		young	2004-02-15
#see
********************************************/
ALTER PROCEDURE [DBO].[lin_RPCastleTaxTribute]
	@table_from	varchar(60),
	@table_to	varchar(60),
	@logdate	int

AS
SET NOCOUNT ON

declare @sql varchar(512)

-- check table whether @table_to is exists or not
set @sql = 'select * from lin2report.dbo.sysobjects (nolock) where name = ''' + @table_to + ''''
exec (@sql)

if (@@ROWCOUNT = 0)
begin
	set @sql = 'CREATE TABLE dbo.' + @table_to + ' (' 
		+ ' log_date	int, '
		+ ' castle_id	smallint, '
		+ ' tribute_id	smallint, '
		+ ' tax		int, '
		+ ' total_sell	money , '
		+ ' total_tax	money , '
		+ ' ) '
	exec (@sql)

	set @sql = 'CREATE INDEX IX_' + @table_to + '_1 on dbo.' + @table_to + ' (log_date) '
	exec (@sql)
end
else begin
	set @sql = 'delete from dbo.' + @table_to + ' where log_date = ' + CAST(@logdate as varchar)
	exec (@sql)
end

-- insert into report table
set @sql = 'insert into ' + RTRIM(@table_to) + ' ( log_date, castle_id, tribute_id, tax, total_sell, total_tax ) ( ' 
	+ ' select ' + CAST(@logdate as varchar) + ', etc_num1, etc_num2, etc_num3, sum ( cast ( etc_num4 as money ) ), sum ( cast ( etc_num5 as money) )  from  '
	+ ' ( select log_id, etc_num1, etc_num2, etc_num3, etc_num4, etc_num5 '
	+ ' from lin2log.dbo.' + RTRIM(@table_from) + ' ( nolock ) where log_id = 949 ) as R1 group by etc_num1, etc_num2, etc_num3  )  option (MAXDOP 1 ) '
exec (@sql )
GO

/********************************************
lin_RPCastleTaxIncome
do make castle tax income

#argument	@table_from	varchar(60)	log table to be a source
#argument	@table_from	varchar(60)	report table to be a destination
#argument	@logdate	int		the date of report to be created
#return
#result_set
#remark
#example	Exec lin_RPCastleTaxIncome 'L2004_11_30_log_data_8', 'R2004_11_TAXINCOME_8', 20041130
#history	create		young	2004-02-15
#see
********************************************/
ALTER PROCEDURE [DBO].[lin_RPCastleTaxIncome]
	@table_from	varchar(60),
	@table_to	varchar(60),
	@logdate	int

AS
SET NOCOUNT ON

declare @sql varchar(512)

-- check table whether @table_to is exists or not
set @sql = 'select * from lin2report.dbo.sysobjects (nolock) where name = ''' + @table_to + ''''
exec (@sql)

if (@@ROWCOUNT = 0)
begin
	set @sql = 'CREATE TABLE dbo.' + @table_to + ' (' 
		+ ' log_date	int, '
		+ ' castle_id	smallint, '
		+ ' tax		int, '
		+ ' total_sell	money , '
		+ ' total_tax	money , '
		+ ' ) '
	exec (@sql)

	set @sql = 'CREATE INDEX IX_' + @table_to + '_1 on dbo.' + @table_to + ' (log_date) '
	exec (@sql)
end
else begin
	set @sql = 'delete from dbo.' + @table_to + ' where log_date = ' + CAST(@logdate as varchar)
	exec (@sql)
end

-- insert into report table
set @sql = 'insert into ' + RTRIM(@table_to) + ' ( log_date, castle_id, tax, total_sell, total_tax ) ( ' 
	+ ' select ' + CAST(@logdate as varchar) + ', etc_num5, etc_num6,  sum ( cast ( etc_num7 as money ) ), sum( cast ( etc_num8 as money ) ) from  '
	+ ' ( select etc_num5, etc_num6, etc_num7, etc_num8, log_id '
	+ ' from lin2log.dbo.' + RTRIM(@table_from) + ' ( nolock ) where log_id = 948 ) as R1 group by etc_num5, etc_num6 )  option (MAXDOP 1 ) '
exec (@sql )
GO

/********************************************
lin_RPCastleTax
do make castle tax income

#argument	@table_from	varchar(60)	varchar(60)	log table to be a source
#argument	@table_to	varchar(60)	report table to be a destination
#argument	@logdate	int		the date of report to be created
#return
#result_set
#remark
#example	Exec lin_RPCastleTax 'L2004_11_30_log_data_8', 'R2004_11_TAX_8', 20041130
#history	create	young	2004-02-26
#see
********************************************/
ALTER PROCEDURE [DBO].[lin_RPCastleTax]
	@table_from	varchar(60),
	@table_to	varchar(60),
	@logdate	int

AS
SET NOCOUNT ON

declare @sql varchar(512)

-- check table whether @table_to is exists or not
set @sql = 'select * from lin2report.dbo.sysobjects (nolock) where name = ''' + @table_to + ''''
exec (@sql)

if (@@ROWCOUNT = 0)
begin
	set @sql = 'CREATE TABLE dbo.' + @table_to + ' (' 
		+ ' log_date	int, '
		+ ' castle_id	smallint, '
		+ ' real_tax	int  '
		+ ' ) '
	exec (@sql)

	set @sql = 'CREATE INDEX IX_' + @table_to + '_1 on dbo.' + @table_to + ' (log_date) '
	exec (@sql)
end
else begin
	set @sql = 'delete from dbo.' + @table_to + ' where log_date = ' + CAST(@logdate as varchar)
	exec (@sql)
end

-- insert into report table
set @sql = 'insert into ' + RTRIM(@table_to) + ' ( log_date, castle_id, real_tax ) ( ' 
	+ ' select ' + CAST(@logdate as varchar) + ',  etc_num1, sum ( etc_num4 )   from  '
	+ ' lin2log.dbo.' + RTRIM(@table_from) + ' ( nolock ) where log_id = 950  group by etc_num1 )  option (MAXDOP 1 ) '
exec (@sql )
GO

/********************************************
lin_RPBeginQuest
do make begin quest report

#argument	@table_from	varchar(60)	log table to be a source
#argument	@table_to	varchar(60)	report table to be a destination
#argument	@logdate	int		the date of report to be created
#return
#result_set
#remark		This procedure creates the report by race, sex, class and level
#example	Exec lin_RPBeginQuest 'L2004_11_30_log_data_8', 'R2004_11_BEGINQUEST_8', 20041130
#history	create		young	2003-06-02
#see
********************************************/
ALTER PROCEDURE [DBO].[lin_RPBeginQuest]
	@table_from	varchar(60),
	@table_to	varchar(60),
	@logdate	int

AS
SET NOCOUNT ON

declare @sql varchar(4000)

-- check table whether @table_to is exists or not
set @sql = 'select * from lin2report.dbo.sysobjects (nolock) where name = ''' + @table_to + ''''
exec (@sql)

if (@@ROWCOUNT = 0)
begin
	set @sql = 'CREATE TABLE dbo.' + @table_to + ' (' 
		+ ' log_date	int, '
		+ ' race		smallint, '
		+ ' class		smallint, '
		+ ' level		smallint, '
		+ ' quest_id	int, '
		+ ' quest_count	int  '
		+ ' ) '
	exec (@sql)

	set @sql = 'CREATE INDEX IX_' + @table_to + '_1 on dbo.' + @table_to + ' (log_date) '
	exec (@sql)
end
else begin
	set @sql = 'delete from dbo.' + @table_to + ' where log_date = ' + CAST(@logdate as varchar)
	exec (@sql)
end

-- check tmp table
declare @tmp_table varchar(512)
set @tmp_table = 'dbo.tmp' + @table_to

set @sql = 'select * from lin2report.dbo.sysobjects (nolock) where name = ''tmp' + @table_to + ''''
exec (@sql)

if (@@ROWCOUNT > 0)
begin
	set @sql = ' drop table dbo.tmp' + @table_to
	exec (@sql)
end

-- make tmptable
set @table_from = replace ( @table_from, 'data0', 'data2' )
set @sql = ' select log_id, etc_num1, etc_num3, etc_num4, etc_num5  into ' + @tmp_table
	+ ' from lin2log.dbo.' + @table_from  + ' ( nolock) where log_id = 303   '
exec (@sql)

set @table_from = replace ( @table_from, 'data2', 'data' )
set @sql = ' insert into ' + @tmp_table + ' ( log_id, etc_num1, etc_num3, etc_num4, etc_num5  ) ( select log_id, etc_num1, etc_num3, etc_num4, etc_num5 '
	+ ' from lin2log.dbo.' + @table_from  + ' ( nolock) where log_id = 303  ) '
exec (@sql)


-- insert into report table
-- begin quest report
set @sql = 'insert into ' + RTRIM(@table_to) + ' ( log_date,  race, class, level, quest_id, quest_count  ) ( ' 
	+ ' select ' + CAST(@logdate as varchar) + ', etc_num1, etc_num3, etc_num4, etc_num5, count(log_id) from '
	+ @tmp_table  + ' ( nolock )  group by  etc_num1, etc_num3, etc_num4, etc_num5 )  option (MAXDOP 1 ) '
exec (@sql )

set @sql = ' drop table ' + @tmp_table
exec ( @sql )
GO

/********************************************
lin_RPAsset
do make item asset report

#argument	@table_from	varchar(60)	log table to be a source
#argument	@table_to	varchar(60)	report table to be a destination
#argument	@logdate	int		the date of report to be created
#return
#result_set
#remark
#example	Exec lin_RPAsset 'L2004_11_30_log_data_8', 'R2004_11_ASSET_8', 20041130
#history	create	young	2003-10-31
#see
********************************************/
ALTER PROCEDURE [DBO].[lin_RPAsset]
	@table_from	varchar(60),
	@table_to	varchar(60),
	@logdate	int

AS
SET NOCOUNT ON

declare @sql varchar(4000)

-- check table whether @table_to is exists or not
set @sql = 'select * from lin2report.dbo.sysobjects (nolock) where name = ''' + @table_to + ''''
exec (@sql)

if (@@ROWCOUNT = 0)
begin
	set @sql = 'CREATE TABLE dbo.' + @table_to + ' (' 
		+ ' log_date	int, '
		+ ' level		int,' 
		+ ' class		int, '
		+ ' adena_sum	int, '
		+ ' price_sum	int, '
		+ ' item_sum	int '
		+ ' ) '
	exec (@sql)

	set @sql = 'CREATE INDEX IX_' + @table_to + '_1 on dbo.' + @table_to + ' (log_date) '
	exec (@sql)
end
else begin
	set @sql = 'delete from dbo.' + @table_to + ' where log_date = ' + CAST(@logdate as varchar)
	exec (@sql)
end

-- check tmp table
declare @tmp_table varchar(512)
set @tmp_table = 'dbo.tmp' + @table_to

set @sql = 'select * from lin2report.dbo.sysobjects (nolock) where name = ''tmp' + @table_to + ''''
exec (@sql)

if (@@ROWCOUNT > 0)
begin
	set @sql = ' drop table dbo.tmp' + @table_to
	exec (@sql)
end

-- make tmptable
set @table_from = replace ( @table_from, 'data0', 'data2' )
set @sql = ' select log_id, actor,  etc_num1,  etc_num2, etc_num3, etc_num4, etc_num5 into ' + @tmp_table
	+ ' from lin2log.dbo.' + @table_from  + ' ( nolock) where log_id = 813 and etc_num6 < 600  '
exec (@sql)

set @table_from = replace ( @table_from, 'data2', 'data' )
set @sql = ' insert into ' + @tmp_table + ' ( log_id, actor,  etc_num1, etc_num2, etc_num3, etc_num4, etc_num5 ) ( select log_id, actor, etc_num1, etc_num2, etc_num3, etc_num4, etc_num5 '
	+ ' from lin2log.dbo.' + @table_from  + ' ( nolock) where log_id = 813 and etc_num6 < 600  ) '
exec (@sql)

-- insert into report table
-- item
set @sql = 'insert into ' + RTRIM(@table_to) + ' ( log_date, level, class, adena_sum, price_sum, item_sum ) ( ' 
	+ ' select  ' + CAST(@logdate as varchar) + ', etc_num4, etc_num5, avg ( cast ( ad as money) ),  avg ( cast ( dp as money) ),  avg ( cast ( ts as money) )  '
	+ '  from ( select actor, etc_num4, etc_num5, ad=avg ( cast ( etc_num1 as money) ),  dp=avg ( cast ( etc_num2 as money) ),  ts=avg ( cast ( etc_num3 as money) ) from '
	+ @tmp_table  + ' ( nolock )  group by actor, etc_num4, etc_num5 ) as R1  group by etc_num4, etc_num5 )  option (MAXDOP 1 )'
exec (@sql )

-- drop tmptable
set @sql = ' drop table ' + @tmp_table
exec ( @sql)
GO

/********************************************
lin_RPAccountPlayTime
do make account play time report

#argument	@table_from	varchar(60)	log table to be a source
#argument	@table_to	varchar(60)	report table to be a destination
#argument	@logdate	int		the date of report to be created
#return
#result_set
#remark
#example	Exec lin_RPAccountPlayTime 'L2004_11_30_log_data_8', 'R2004_11_ACCOUNTPLAYTIME_8', 20041130
#history	create		young	2003-03-28
#see
********************************************/
ALTER PROCEDURE [DBO].[lin_RPAccountPlayTime]
	@table_from	varchar(60),
	@table_to	varchar(60),
	@logdate	int

AS
SET NOCOUNT ON

declare @sql varchar(4000)

-- check table whether @table_to is exists or not
set @sql = 'select * from lin2report.dbo.sysobjects (nolock) where name = ''' + @table_to + ''''
exec (@sql)

if (@@ROWCOUNT = 0)
begin
	set @sql = 'CREATE TABLE dbo.' + @table_to + ' (' 
		+ ' log_date	int, '
		+ ' account_id	int, '
		+ ' play_time	int, '
		+ ' logoff_count	int'
		+ ' ) '
	exec (@sql)

	set @sql = 'CREATE INDEX IX_' + @table_to + '_1 on dbo.' + @table_to + ' (log_date) '
	exec (@sql)
end
else begin
	set @sql = 'delete from dbo.' + @table_to + ' where log_date = ' + CAST(@logdate as varchar)
	exec (@sql)
end

-- check tmp table
declare @tmp_table varchar(512)
set @tmp_table = 'dbo.tmp' + @table_to

set @sql = 'select * from lin2report.dbo.sysobjects (nolock) where name = ''tmp' + @table_to + ''''
exec (@sql)

if (@@ROWCOUNT > 0)
begin
	set @sql = ' drop table dbo.tmp' + @table_to
	exec (@sql)

end


-- make tmptable
set @table_from = replace ( @table_from, 'data0', 'data2' )
set @sql = ' select log_id, actor_account, etc_num5  into ' + @tmp_table
	+ ' from lin2log.dbo.' + @table_from  + ' ( nolock) where log_id = 805   '
exec (@sql)

set @table_from = replace ( @table_from, 'data2', 'data' )
set @sql = ' insert into ' + @tmp_table + ' ( log_id, actor_account, etc_num5  ) ( select log_id, actor_account, etc_num5 '
	+ ' from lin2log.dbo.' + @table_from  + ' ( nolock) where log_id = 805  ) '
exec (@sql)



-- insert into report table

-- --+- playtime
set @sql = 'insert into ' + RTRIM(@table_to) + ' ( log_date,  account_id, play_time, logoff_count ) ( ' 
	+ ' select ' + CAST(@logdate as varchar) + ', actor_account, sum(etc_num5 ), count(log_id) from  '
	+ @tmp_table  + ' ( nolock )  group by actor_account  )  option (MAXDOP 1 ) '
exec (@sql )

set @sql = ' drop table ' + @tmp_table
exec ( @sql )
GO

/********************************************
lin_RPNPCDieLoc2
do make cpc die location report ( group by class or level )

#argument	@table_from	varchar(60)	log table to be a source
#argument	@table_to	varchar(60)	report table to be a destination
#argument	@logdate	int		the date of report to be created
#return
#result_set
#remark		This procedure may not be used
#example	Exec lin_RPNPCDieLoc2 'L2004_11_30_log_data_8', 'R2004_11_NPCDIELOC2_8', 20041130
#history	create		young	2003-03-19
#see		lin_RPNPCDieLoc
********************************************/
ALTER PROCEDURE [DBO].[lin_RPNPCDieLoc2]
	@table_from	varchar(60),
	@table_to	varchar(60),
	@logdate	int

AS
SET NOCOUNT ON

return

/*
declare @sql varchar(4000)

-- check table whether @table_to is exists or not
set @sql = 'select * from lin2report.dbo.sysobjects (nolock) where name = ''' + @table_to + ''''
exec (@sql)

if (@@ROWCOUNT = 0)
begin
	set @sql = 'CREATE TABLE dbo.' + @table_to + ' (' 
		+ ' log_date	int, '
		+ ' log_type	smallint, '
		+ ' log_val	smallint, '
		+ ' x_loc		int, '
		+ ' y_loc 	int, '
		+ ' die_count	int '
		+ ' ) '
	exec (@sql)

	set @sql = 'CREATE INDEX IX_' + @table_to + '_1 on dbo.' + @table_to + ' (log_date) '
	exec (@sql)
end
else begin
	set @sql = 'delete from dbo.' + @table_to + ' where log_date = ' + CAST(@logdate as varchar)
	exec (@sql)
end

-- check tmp table
declare @tmp_table varchar(512)
set @tmp_table = 'dbo.tmp' + @table_to

set @sql = 'select * from lin2report.dbo.sysobjects (nolock) where name = ''tmp' + @table_to + ''''
exec (@sql)

if (@@ROWCOUNT > 0)
begin
	set @sql = ' drop table dbo.tmp' + @table_to
	exec (@sql)
end


-- make tmptable
set @table_from = replace ( @table_from, 'data0', 'data2' )
set @sql = ' select log_id, etc_num3, etc_num4,  location_x, location_y  into ' + @tmp_table
	+ ' from lin2log.dbo.' + @table_from  + ' ( nolock) where log_id = 1112  '
exec (@sql)

set @table_from = replace ( @table_from, 'data2', 'data' )
set @sql = ' insert into ' + @tmp_table + ' ( log_id, etc_num3, etc_num4,  location_x, location_y ) ( select log_id, etc_num3, etc_num4, location_x, location_y '
	+ ' from lin2log.dbo.' + @table_from  + ' ( nolock) where log_id = 1112  ) '
exec (@sql)


-- insert into report table

-- map - ++L L--  ( group by class )
set @sql = 'insert into ' + RTRIM(@table_to) + ' ( log_date,  log_type, log_val,  x_loc, y_loc, die_count ) ( ' 
	+ ' select ' + CAST(@logdate as varchar) + ', 3, etc_num3, FLOOR(location_x / 32768.0), FLOOR(location_y / 32768.0), count( log_id ) from '
	+ @tmp_table + '  ( nolock )  group by etc_num3, FLOOR(location_x / 32768.0), FLOOR(location_y / 32768.0) )  option (MAXDOP 1 ) '
exec (@sql )

-- map - ++L L-- ( group by level)
set @sql = 'insert into ' + RTRIM(@table_to) + ' ( log_date,  log_type, log_val,  x_loc, y_loc, die_count ) ( ' 
	+ ' select ' + CAST(@logdate as varchar) + ', 4, etc_num4, FLOOR(location_x / 32768.0), FLOOR(location_y / 32768.0), count(log_id)   from '
	+ @tmp_table + '  ( nolock )  group by etc_num4, FLOOR(location_x / 32768.0), FLOOR(location_y / 32768.0) )  option (MAXDOP 1 ) '
exec (@sql )

-- drop tmptable
set @sql = ' drop table ' + @tmp_table
exec (@sql)

*/
GO

/********************************************
lin_RPNPCDieLoc
do make npc die location report

#argument	@table_from	varchar(60)	log table to be a source
#argument	@table_to	varchar(60)	report table to be a destination
#argument	@logdate	int		the date of report to be created
#return
#result_set
#remark
#example	Exec lin_RPLoginCount 'L2004_11_30_log_data_8', 'R2004_11_NPCDIELOC_8', 20041130
#history	create		young	2003-03-19
#see		lin_RPNPCDieLoc2
********************************************/
ALTER PROCEDURE [DBO].[lin_RPNPCDieLoc]
	@table_from	varchar(60),
	@table_to	varchar(60),
	@logdate	int

AS
SET NOCOUNT ON

declare @sql varchar(4000)

-- check table whether @table_to is exists or not
set @sql = 'select * from lin2report.dbo.sysobjects (nolock) where name = ''' + @table_to + ''''
exec (@sql)

if (@@ROWCOUNT = 0)
begin
	set @sql = 'CREATE TABLE dbo.' + @table_to + ' (' 
		+ ' log_date	int, '
		+ ' log_type	smallint, '
		+ ' x_loc		int, '
		+ ' y_loc 	int, '
		+ ' die_count	int '
		+ ' ) '
	exec (@sql)

	set @sql = 'CREATE INDEX IX_' + @table_to + '_1 on dbo.' + @table_to + ' (log_date) '
	exec (@sql)
end
else begin
	set @sql = 'delete from dbo.' + @table_to + ' where log_date = ' + CAST(@logdate as varchar)
	exec (@sql)
end

-- check tmp table
declare @tmp_table varchar(512)
set @tmp_table = 'dbo.tmp' + @table_to

set @sql = 'select * from lin2report.dbo.sysobjects (nolock) where name = ''tmp' + @table_to + ''''
exec (@sql)

if (@@ROWCOUNT > 0)
begin
	set @sql = ' drop table dbo.tmp' + @table_to
	exec (@sql)
end


-- make tmptable
set @table_from = replace ( @table_from, 'data0', 'data2' )
set @sql = ' select log_id, etc_num10,  location_x, location_y  into ' + @tmp_table
	+ ' from lin2log.dbo.' + @table_from  + ' ( nolock) where log_id = 1112  '
exec (@sql)

set @table_from = replace ( @table_from, 'data2', 'data' )
set @sql = ' insert into ' + @tmp_table + ' ( log_id, etc_num10,  location_x, location_y ) ( select log_id, etc_num10, location_x, location_y '
	+ ' from lin2log.dbo.' + @table_from  + ' ( nolock) where log_id = 1112  ) '
exec (@sql)



-- insert into report table
	-- new report
	set @sql = 'insert into ' + RTRIM(@table_to) + ' ( log_date,  log_type, x_loc, y_loc, die_count ) ( ' 
		+ ' select ' + CAST(@logdate as varchar) + ', 1, FLOOR(location_x / 32768.0), FLOOR(location_y / 32768.0), count( distinct  etc_num10 )  from '
		+ @tmp_table + '  ( nolock )  group by FLOOR(location_x / 32768.0), FLOOR(location_y / 32768.0) )  option (MAXDOP 1 ) '
	exec (@sql )

-- drop tmptable
set @sql = ' drop table ' + @tmp_table
exec (@sql )
GO

/********************************************
lin_RPPCDieLoc2
do make pc die location report ( group by class or level )

#argument	@table_from	varchar(60)	log table to be a source
#argument	@table_to	varchar(60)	report table to be a destination
#argument	@logdate	int		the date of report to be created
#return
#result_set
#remark
#example	Exec lin_RPPCDieLoc2 'L2004_11_30_log_data_8', 'R2004_11_PCDieLoc2_8', 20041130
#history	create		young	2003-03-21
#see		lin_RPPCDieLoc
********************************************/
ALTER PROCEDURE [DBO].[lin_RPPCDieLoc2]
	@table_from	varchar(60),
	@table_to	varchar(60),
	@logdate	int

AS
SET NOCOUNT ON

declare @sql varchar(4000)

-- check table whether @table_to is exists or not
set @sql = 'select * from lin2report.dbo.sysobjects (nolock) where name = ''' + @table_to + ''''
exec (@sql)

if (@@ROWCOUNT = 0)
begin
	set @sql = 'CREATE TABLE dbo.' + @table_to + ' (' 
		+ ' log_date	int, '
		+ ' log_type	smallint, '
		+ ' log_val	smallint, '
		+ ' x_loc		int, '
		+ ' y_loc 	int, '
		+ ' die_count	int '
		+ ' ) '
	exec (@sql)

	set @sql = 'CREATE INDEX IX_' + @table_to + '_1 on dbo.' + @table_to + ' (log_date) '
	exec (@sql)
end
else begin
	set @sql = 'delete from dbo.' + @table_to + ' where log_date = ' + CAST(@logdate as varchar)
	exec (@sql)
end

-- check tmp table
declare @tmp_table varchar(512)
set @tmp_table = 'dbo.tmp' + @table_to

set @sql = 'select * from lin2report.dbo.sysobjects (nolock) where name = ''tmp' + @table_to + ''''
exec (@sql)

if (@@ROWCOUNT > 0)
begin
	set @sql = ' drop table dbo.tmp' + @table_to
	exec (@sql)
end

-- make tmptable
set @table_from = replace ( @table_from, 'data0', 'data2' )
set @sql = ' select log_id, etc_num3, etc_num4,location_x, location_y into ' + @tmp_table
	+ ' from lin2log.dbo.' + @table_from  + ' ( nolock) where log_id = 1101  '
exec (@sql)

set @table_from = replace ( @table_from, 'data2', 'data' )
set @sql = ' insert into ' + @tmp_table + ' ( log_id, etc_num3, etc_num4,location_x, location_y ) ( select log_id, etc_num3, etc_num4,location_x, location_y  '
	+ ' from lin2log.dbo.' + @table_from  + ' ( nolock) where log_id = 1101  ) '
exec (@sql)


-- insert into report table

-- map - ++L L-- ( class -+ )
set @sql = 'insert into ' + RTRIM(@table_to) + ' ( log_date,  log_type, log_val, x_loc, y_loc, die_count ) ( ' 
	+ ' select ' + CAST(@logdate as varchar) + ', 3, etc_num3, FLOOR(location_x / 32768.0), FLOOR(location_y / 32768.0), count(log_id)  from '
	+ ' ( select log_id, etc_num3, location_x, location_y from '
	+ @tmp_table  + ' ( nolock )  ) as R1   group by etc_num3, FLOOR(location_x / 32768.0), FLOOR(location_y / 32768.0) )  option (MAXDOP 1 ) '
exec (@sql )

-- map - ++L L-- ( level -+ )
set @sql = 'insert into ' + RTRIM(@table_to) + ' ( log_date,  log_type, log_val, x_loc, y_loc, die_count ) ( ' 
	+ ' select ' + CAST(@logdate as varchar) + ', 4, etc_num4, FLOOR(location_x / 32768.0), FLOOR(location_y / 32768.0), count(log_id)  from '
	+ ' ( select log_id, etc_num4, location_x, location_y from  '
	+ @tmp_table + ' ( nolock ) ) as R1  group by etc_num4, FLOOR(location_x / 32768.0), FLOOR(location_y / 32768.0) ) option (MAXDOP 1 )  '
exec (@sql )

-- drop tmptable
set @sql = ' drop table ' + @tmp_table
exec (@sql)
GO

/********************************************
lin_RPPCDieLoc
do make pc die location report

#argument	@table_from	varchar(60)	log table to be a source
#argument	@table_to	varchar(60)	report table to be a destination
#argument	@logdate	int		the date of report to be created
#return
#result_set
#remark
#example	Exec lin_RPPCDieLoc 'L2004_11_30_log_data_8', 'R2004_11_PCDieLoc_8', 20041130
#history	create		young	2003-03-19
#see
********************************************/
ALTER PROCEDURE [DBO].[lin_RPPCDieLoc]
	@table_from	varchar(60),
	@table_to	varchar(60),
	@logdate	int

AS
SET NOCOUNT ON

declare @sql varchar(4000)

-- check table whether @table_to is exists or not
set @sql = 'select * from lin2report.dbo.sysobjects (nolock) where name = ''' + @table_to + ''''
exec (@sql)

if (@@ROWCOUNT = 0)
begin
	set @sql = 'CREATE TABLE dbo.' + @table_to + ' (' 
		+ ' log_date	int, '
		+ ' log_type	smallint, '
		+ ' x_loc		int, '
		+ ' y_loc 	int, '
		+ ' die_count	int '
		+ ' ) '
	exec (@sql)

	set @sql = 'CREATE INDEX IX_' + @table_to + '_1 on dbo.' + @table_to + ' (log_date) '
	exec (@sql)
end
else begin
	set @sql = 'delete from dbo.' + @table_to + ' where log_date = ' + CAST(@logdate as varchar)
	exec (@sql)
end

-- check tmp table
declare @tmp_table varchar(512)
set @tmp_table = 'dbo.tmp' + @table_to

set @sql = 'select * from lin2report.dbo.sysobjects (nolock) where name = ''tmp' + @table_to + ''''
exec (@sql)

if (@@ROWCOUNT > 0)
begin
	set @sql = ' drop table dbo.tmp' + @table_to
	exec (@sql)
end

-- make tmptable
set @table_from = replace ( @table_from, 'data0', 'data2' )
set @sql = ' select log_id,  location_x, location_y into ' + @tmp_table
	+ ' from lin2log.dbo.' + @table_from  + ' ( nolock) where log_id = 1101  '
exec (@sql)

set @table_from = replace ( @table_from, 'data2', 'data' )
set @sql = ' insert into ' + @tmp_table + ' ( log_id,  location_x, location_y  ) ( select log_id,  location_x, location_y   '
	+ ' from lin2log.dbo.' + @table_from  + ' ( nolock) where log_id = 1101  ) '
exec (@sql)


-- insert into report table

-- map - ++L L--
set @sql = 'insert into ' + RTRIM(@table_to) + ' ( log_date,  log_type, x_loc, y_loc, die_count ) ( ' 
	+ ' select ' + CAST(@logdate as varchar) + ', 1, FLOOR(location_x / 32768.0), FLOOR(location_y / 32768.0), count(log_id) from  '
	+ ' ( select log_id, location_x, location_y from '
	+ @tmp_table  + ' ( nolock )  ) as R1 group by FLOOR(location_x / 32768.0), FLOOR(location_y / 32768.0) ) option (MAXDOP 1 ) '
exec (@sql )

-- drop tmptable
set @sql = ' drop  table ' + @tmp_table
exec (@sql)
GO

/********************************************
lin_RPPCDie
do make pc die report

#argument	@table_from	varchar(60)	log table to be a source
#argument	@table_to	varchar(60)	report table to be a destination
#argument	@logdate	int		the date of report to be created
#return
#result_set
#remark		This procedure creates the report by race, sex, class and level
#example	Exec lin_RPPCDie 'L2004_11_30_log_data_8', 'R2004_11_PCDIE_8', 20041130
#history	create		young	2003-03-19
#see
********************************************/
ALTER PROCEDURE [DBO].[lin_RPPCDie]
	@table_from	varchar(60),
	@table_to	varchar(60),
	@logdate	int

AS
SET NOCOUNT ON

declare @sql varchar(4000)

-- check table whether @table_to is exists or not
set @sql = 'select * from lin2report.dbo.sysobjects (nolock) where name = ''' + @table_to + ''''
exec (@sql)

if (@@ROWCOUNT = 0)
begin
	set @sql = 'CREATE TABLE dbo.' + @table_to + ' (' 
		+ ' log_date	int, '
		+ 'log_type	smallint, '
		+ 'log_val	int, '
		+ 'log_count 	int, '
		+ 'char_count 	int  '
		+ ' ) '
	exec (@sql)

	set @sql = 'CREATE INDEX IX_' + @table_to + '_1 on dbo.' + @table_to + ' (log_date) '
	exec (@sql)
end
else begin
	set @sql = 'delete from dbo.' + @table_to + ' where log_date = ' + CAST(@logdate as varchar)
	exec (@sql)
end

-- check tmp table
declare @tmp_table varchar(512)
set @tmp_table = 'dbo.tmp' + @table_to

set @sql = 'select * from lin2report.dbo.sysobjects (nolock) where name = ''tmp' + @table_to + ''''
exec (@sql)

if (@@ROWCOUNT > 0)
begin
	set @sql = ' drop table dbo.tmp' + @table_to
	exec (@sql)
end

-- make tmptable
set @table_from = replace ( @table_from, 'data0', 'data2' )
set @sql = ' select log_id,  etc_num1, etc_num2, etc_num3, etc_num4, actor  into ' + @tmp_table
	+ ' from lin2log.dbo.' + @table_from  + ' ( nolock) where log_id = 1101  '
exec (@sql)

set @table_from = replace ( @table_from, 'data2', 'data' )
set @sql = ' insert into ' + @tmp_table + ' ( log_id,  etc_num1, etc_num2, etc_num3, etc_num4, actor   ) ( select log_id,  etc_num1, etc_num2, etc_num3, etc_num4, actor    '
	+ ' from lin2log.dbo.' + @table_from  + ' ( nolock) where log_id = 1101  ) '
exec (@sql)


-- insert into report table

-- race - ++L L--
set @sql = 'insert into ' + RTRIM(@table_to) + ' ( log_date,  log_type, log_val,  log_count, char_count ) ( ' 
	+ ' select ' + CAST(@logdate as varchar) + ', 1, etc_num1, count(log_id) , count(distinct actor)  from '
	+ @tmp_table + ' (nolock)  group by etc_num1  )  option (MAXDOP 1 ) '
exec (@sql )
-- sex - ++L L--
set @sql = 'insert into ' + RTRIM(@table_to) + ' ( log_date,  log_type, log_val,  log_count , char_count ) ( ' 
	+ ' select ' + CAST(@logdate as varchar) + ', 2, etc_num2,  count(log_id) , count(distinct actor)  from '
	+ @tmp_table + ' (nolock) group by etc_num2   ) option (MAXDOP 1 ) '
exec (@sql )
-- class - ++L L--
set @sql = 'insert into ' + RTRIM(@table_to) + ' ( log_date,  log_type, log_val,  log_count, char_count ) ( ' 
	+ ' select ' + CAST(@logdate as varchar) + ', 3, etc_num3,   count(log_id)  , count(distinct actor) from '
	+ @tmp_table + '  ( nolock )  group by etc_num3 ) option (MAXDOP 1 ) '
exec (@sql )
-- level - ++L L--
set @sql = 'insert into ' + RTRIM(@table_to) + ' ( log_date,  log_type, log_val, log_count , char_count  ) ( ' 
	+ ' select  ' + CAST(@logdate as varchar) + ', 4, etc_num4,   count(log_id)  , count(distinct actor)  from '
	+ @tmp_table + ' ( nolock )  group by etc_num4  ) option (MAXDOP 1 ) '
exec (@sql )

-- drop tmptable
set @sql = ' drop table ' + @tmp_table
exec (@sql)
GO

/********************************************
lin_RPEarnSP
do make earn sp

#argument	@table_from	varchar(60)	log table to be a source
#argument	@table_to	varchar(60)	report table to be a destination
#argument	@logdate	int		the date of report to be created
#return
#result_set
#remark		This procedure creates the report by race, sex, class and level
#example	Exec lin_RPLoginCount 'L2004_11_30_log_data_8', 'R2004_11_EARNSP_8', 20041130
#history	create		young	2004-03-09
#see
********************************************/
ALTER PROCEDURE [DBO].[lin_RPEarnSP]
	@table_from	varchar(60),
	@table_to	varchar(60),
	@logdate	int

AS
SET NOCOUNT ON

declare @sql varchar(4000)

-- check table whether @table_to is exists or not
set @sql = 'select * from lin2report.dbo.sysobjects (nolock) where name = ''' + @table_to + ''''
exec (@sql)

if (@@ROWCOUNT = 0)
begin
	set @sql = 'CREATE TABLE dbo.' + @table_to + ' (' 
		+ ' log_date	int, '
		+ 'log_type	smallint, '
		+ 'log_val	int, '
		+ 'log_count 	money , '
		+ ' get_count	int ' 
		+ ' ) '
	exec (@sql)

	set @sql = 'CREATE INDEX IX_' + @table_to + '_1 on dbo.' + @table_to + ' (log_date) '
	exec (@sql)
end
else begin
	set @sql = 'delete from dbo.' + @table_to + ' where log_date = ' + CAST(@logdate as varchar)
	exec (@sql)
end

-- check tmp table
declare @tmp_table varchar(512)
set @tmp_table = 'dbo.tmp' + @table_to

set @sql = 'select * from lin2report.dbo.sysobjects (nolock) where name = ''tmp' + @table_to + ''''
exec (@sql)

if (@@ROWCOUNT > 0)
begin
	set @sql = ' drop table dbo.tmp' + @table_to
	exec (@sql)
end


-- make tmptable
set @table_from = replace ( @table_from, 'data0', 'data2' )
set @sql = ' select log_id, etc_num1, etc_num2, etc_num3, etc_num4, etc_num5, actor  into ' + @tmp_table
	+ ' from lin2log.dbo.' + @table_from  + ' ( nolock) where log_id = 1112  '
exec (@sql)

set @table_from = replace ( @table_from, 'data2', 'data' )
set @sql = ' insert into ' + @tmp_table + ' ( log_id, etc_num1, etc_num2, etc_num3, etc_num4, etc_num5, actor  ) ( select log_id, etc_num1, etc_num2, etc_num3, etc_num4, etc_num5, actor  '
	+ ' from lin2log.dbo.' + @table_from  + ' ( nolock) where log_id = 1112 ) '
exec (@sql)

-- insert into report table



-- race - - sp +T -
set @sql = 'insert into ' + RTRIM(@table_to) + ' ( log_date,  log_type, log_val,  log_count, get_count ) ( ' 
	+ ' select ' + CAST(@logdate as varchar) + ', 1, etc_num1, sum(cast ( etc_num5 as money )) , count(distinct actor )   from '
	+ @tmp_table + ' ( nolock )  group by etc_num1 ) option (MAXDOP 1 ) '
exec (@sql )
-- sex - - sp +T -
set @sql = 'insert into ' + RTRIM(@table_to) + ' ( log_date,  log_type, log_val,  log_count , get_count) ( ' 
	+ ' select ' + CAST(@logdate as varchar) + ', 2, etc_num2, sum(cast ( etc_num5 as money ))  , count(distinct actor ) from '
	+ @tmp_table  + ' ( nolock )  group by etc_num2 )  option (MAXDOP 1 )'
exec (@sql )
-- class - - sp +T -
set @sql = 'insert into ' + RTRIM(@table_to) + ' ( log_date,  log_type, log_val,  log_count , get_count ) ( ' 
	+ ' select ' + CAST(@logdate as varchar) + ', 3, etc_num3, sum(cast ( etc_num5 as money ))  , count(distinct actor )  from '
	+ @tmp_table + ' ( nolock )  group by etc_num3 ) option (MAXDOP 1 ) '
exec (@sql )
-- level - - sp +T -
set @sql = 'insert into ' + RTRIM(@table_to) + ' ( log_date,  log_type, log_val, log_count , get_count ) ( ' 
	+ ' select  ' + CAST(@logdate as varchar) + ', 4, etc_num4, sum(cast ( etc_num5 as money ))  , count(distinct actor )  from '
	+ @tmp_table  + ' ( nolock )  group by etc_num4 ) option (MAXDOP 1 ) '
exec (@sql )

-- drop tmptable
set @sql = ' drop table ' + @tmp_table
exec ( @sql )
GO

/********************************************
lin_RPNPCHunted
do make number of NPC hunted

#argument	@table_from	varchar(60)	log table to be a source
#argument	@table_to	varchar(60)	report table to be a destination
#argument	@logdate	int		the date of report to be created
#return
#result_set
#remark
#example	Exec lin_RPNPCHunted 'L2004_11_30_log_data_8', 'R2004_11_NPCHUNTED_8', 20041130
#history	create		young	2003-03-17
#see
********************************************/
ALTER PROCEDURE [DBO].[lin_RPNPCHunted]
	@table_from	varchar(60),
	@table_to	varchar(60),
	@logdate	int

AS
SET NOCOUNT ON

declare @sql varchar(4000)

-- check table whether @table_to is exists or not
set @sql = 'select * from lin2report.dbo.sysobjects (nolock) where name = ''' + @table_to + ''''
exec (@sql)

if (@@ROWCOUNT = 0)
begin
	set @sql = 'CREATE TABLE dbo.' + @table_to + ' (' 
		+ ' log_date	int, '
		+ 'log_val	int, '
		+ 'log_count 	int, '
		+ ' npc_level	smallint '
		+ ' ) '
	exec (@sql)

	set @sql = 'CREATE INDEX IX_' + @table_to + '_1 on dbo.' + @table_to + ' (log_date) '
	exec (@sql)
end
else begin
	set @sql = 'delete from dbo.' + @table_to + ' where log_date = ' + CAST(@logdate as varchar)
	exec (@sql)
end

-- check tmp table
declare @tmp_table varchar(512)
set @tmp_table = 'dbo.tmp' + @table_to

set @sql = 'select * from lin2report.dbo.sysobjects (nolock) where name = ''tmp' + @table_to + ''''
exec (@sql)

if (@@ROWCOUNT > 0)
begin
	set @sql = ' drop table dbo.tmp' + @table_to
	exec (@sql)
end

-- make tmptable
set @table_from = replace ( @table_from, 'data0', 'data2' )
set @sql = ' select target_account, etc_num10, etc_num7 into ' + @tmp_table
	+ ' from lin2log.dbo.' + @table_from  + ' ( nolock) where log_id = 1112  '
exec (@sql)

set @table_from = replace ( @table_from, 'data2', 'data' )
set @sql = ' insert into ' + @tmp_table + ' ( target_account, etc_num10, etc_num7 ) ( select target_account, etc_num10, etc_num7  '
	+ ' from lin2log.dbo.' + @table_from  + ' ( nolock) where log_id = 1112  ) '
exec (@sql)




-- insert into report table

	-- new insert 
	set @sql = 'insert into ' + RTRIM(@table_to) + ' ( log_date,  log_val, log_count , npc_level ) ( ' 
		+ ' select ' + CAST(@logdate as varchar) + ', target_account, count ( distinct etc_num10 ), etc_num7   from '
		+ @tmp_table + '  group by target_account , etc_num7  )  option (MAXDOP 1 ) '
	exec (@sql )

-- drop tmptable
set @sql = ' drop table ' + @tmp_table
exec (@sql)
GO

/********************************************
lin_RPPlayTime
do make average play time

#argument	@table_from	varchar(60)	log table to be a source
#argument	@table_to	varchar(60)	report table to be a destination
#argument	@logdate	int		the date of report to be created
#return
#result_set
#remark		This procedure creates the report by race, sex, class and level
#example	Exec lin_RPPlayTime 'L2004_11_30_log_data_8', 'R2004_11_PLAYTIME_8', 20041130
#history	create	young	2003-03-17
#see
********************************************/
ALTER PROCEDURE [DBO].[lin_RPPlayTime]
	@table_from	varchar(60),
	@table_to	varchar(60),
	@logdate	int

AS
SET NOCOUNT ON

declare @sql varchar(4000)

-- check table whether @table_to is exists or not
set @sql = 'select * from lin2report.dbo.sysobjects (nolock) where name = ''' + @table_to + ''''
exec (@sql)

if (@@ROWCOUNT = 0)
begin
	set @sql = 'CREATE TABLE dbo.' + @table_to + ' (' 
		+ ' log_date	int, '
		+ ' log_type	smallint, '
		+ ' log_val	int, '
		+ ' log_count	bigint, '
		+ ' char_count	int '
		+ ' ) '
	exec (@sql)

	set @sql = 'CREATE INDEX IX_' + @table_to + '_1 on dbo.' + @table_to + ' (log_date) '
	exec (@sql)
end
else begin
	set @sql = 'delete from dbo.' + @table_to + ' where log_date = ' + CAST(@logdate as varchar)
	exec (@sql)
end

-- check tmp table
declare @tmp_table varchar(512)
set @tmp_table = 'dbo.tmp' + @table_to

set @sql = 'select * from lin2report.dbo.sysobjects (nolock) where name = ''tmp' + @table_to + ''''
exec (@sql)

if (@@ROWCOUNT > 0)
begin
	set @sql = ' drop table dbo.tmp' + @table_to
	exec (@sql)
end

-- make tmptable
set @table_from = replace ( @table_from, 'data0', 'data2' )
set @sql = ' select log_id, etc_num1, etc_num2, etc_num3, etc_num4, etc_num5, actor into ' + @tmp_table
	+ ' from lin2log.dbo.' + @table_from  + ' ( nolock) where log_id = 805  '
exec (@sql)

set @table_from = replace ( @table_from, 'data2', 'data' )
set @sql = ' insert into ' + @tmp_table + ' ( log_id, etc_num1, etc_num2, etc_num3, etc_num4, etc_num5, actor  ) ( select log_id, etc_num1, etc_num2, etc_num3, etc_num4, etc_num5, actor  '
	+ ' from lin2log.dbo.' + @table_from  + ' ( nolock) where log_id = 805 ) '
exec (@sql)

-- insert into report table

-- race - +L -+-
set @sql = 'insert into ' + RTRIM(@table_to) + ' ( log_date,  log_type, log_val, log_count, char_count ) ( ' 
	+ ' select ' + CAST(@logdate as varchar) + ', 1,  etc_num1, sum(etc_num5), count(distinct actor)  from '
	+ @tmp_table  + ' ( nolock )  group by etc_num1  )  option (MAXDOP 1 )'
exec (@sql )

-- sex - +L -+-
set @sql = 'insert into ' + RTRIM(@table_to) + ' ( log_date,  log_type, log_val, log_count, char_count ) ( ' 
	+ ' select ' + CAST(@logdate as varchar) + ', 2,  etc_num2, sum(etc_num5), count(distinct actor) from '
	+ @tmp_table + ' ( nolock )  group by etc_num2  )  option (MAXDOP 1 ) '
exec (@sql )

-- class - +L -+-
set @sql = 'insert into ' + RTRIM(@table_to) + ' ( log_date,  log_type, log_val, log_count, char_count ) ( ' 
	+ ' select ' + CAST(@logdate as varchar) + ', 3,  etc_num3, sum(etc_num5), count(distinct actor) from '
	+ @tmp_table + ' ( nolock ) group by etc_num3  )  option (MAXDOP 1 ) '
exec (@sql )

-- level - +L -+-
set @sql = 'insert into ' + RTRIM(@table_to) + ' ( log_date,  log_type, log_val, log_count, char_count ) ( ' 
	+ ' select ' + CAST(@logdate as varchar) + ', 4,  etc_num4, sum(etc_num5), count(distinct actor) from '
	+ @tmp_table + ' ( nolock ) group by etc_num4  )  option (MAXDOP 1 ) '
exec (@sql )

-- drop tmptable
set @sql = ' drop table ' + @tmp_table
exec (@sql)
GO

/********************************************
lin_RPLearnSkillLev
do make average skill level to learn each skills

#argument	@table_from	varchar(60)	log table to be a source
#argument	@table_to	varchar(60)	report table to be a destination
#argument	@logdate	int		the date of report to be created
#return
#result_set
#remark
#example	Exec lin_RPLearnSkillLev 'L2004_11_30_log_data_8', 'R2004_11_LEARNSKILLLEV_8', 20041130
#history	create young	2003-03-17
#see
********************************************/
ALTER PROCEDURE [DBO].[lin_RPLearnSkillLev]
	@table_from	varchar(60),
	@table_to	varchar(60),
	@logdate	int

AS
SET NOCOUNT ON

declare @sql varchar(4000)

-- check table whether @table_to is exists or not
set @sql = 'select * from lin2report.dbo.sysobjects (nolock) where name = ''' + @table_to + ''''
exec (@sql)

if (@@ROWCOUNT = 0)
begin
	set @sql = 'CREATE TABLE dbo.' + @table_to + ' (' 
		+ ' log_date	int, '
		+ 'log_type	smallint, '
		+ 'log_val	int, '
		+ 'skill_id	int, '
		+ 'log_count 	int, '
		+ ' learnskill_count	int '
		+ ' ) '
	exec (@sql)

	set @sql = 'CREATE INDEX IX_' + @table_to + '_1 on dbo.' + @table_to + ' (log_date) '
	exec (@sql)
end
else begin
	set @sql = 'delete from dbo.' + @table_to + ' where log_date = ' + CAST(@logdate as varchar)
	exec (@sql)
end

-- check tmp table
declare @tmp_table varchar(512)
set @tmp_table = 'dbo.tmp' + @table_to

set @sql = 'select * from lin2report.dbo.sysobjects (nolock) where name = ''tmp' + @table_to + ''''
exec (@sql)

if (@@ROWCOUNT > 0)
begin
	set @sql = ' drop table dbo.tmp' + @table_to
	exec (@sql)
end

-- make tmptable
set @table_from = replace ( @table_from, 'data0', 'data2' )
set @sql = ' select log_id, etc_num1, etc_num3, etc_num5, etc_num4, etc_num8 into ' + @tmp_table
	+ ' from lin2log.dbo.' + @table_from  + ' ( nolock) where log_id = 401  and ( etc_num8 is null or etc_num8 = 0 ) '
exec (@sql)

set @table_from = replace ( @table_from, 'data2', 'data' )
set @sql = ' insert into ' + @tmp_table + ' ( log_id, etc_num1, etc_num3, etc_num5, etc_num4, etc_num8 ) ( select log_id, etc_num1, etc_num3, etc_num5, etc_num4, etc_num8 '
	+ ' from lin2log.dbo.' + @table_from  + ' ( nolock) where log_id = 401  and ( etc_num8 is null or etc_num8 = 0 ) ) '
exec (@sql)


-- insert into report table
-- race - -+L L=L- -- 
set @sql = 'insert into ' + RTRIM(@table_to) + ' ( log_date,  log_type, log_val, skill_id, log_count , learnskill_count ) ( ' 
	+ ' select ' + CAST(@logdate as varchar) + ', 1, etc_num1, etc_num5, sum(etc_num4) / count(log_id) , count(log_id) from '
	+ @tmp_table  + ' ( nolock )  group by etc_num5, etc_num1 )  option (MAXDOP 1 ) '
exec (@sql )

-- class - -+L L=L- -- 
set @sql = 'insert into ' + RTRIM(@table_to) + ' ( log_date,  log_type, log_val, skill_id, log_count , learnskill_count  ) ( ' 
	+ ' select ' + CAST(@logdate as varchar) + ', 2, etc_num3, etc_num5, sum(etc_num4) / count(log_id) , count(log_id) from '
	+ @tmp_table + ' ( nolock ) group by etc_num3, etc_num5 ) option (MAXDOP 1 ) '
exec (@sql )

-- drop tmptable
set @sql  = ' drop table ' + @tmp_table
exec (@sql)
GO

/********************************************
lin_RPHuntCount
do make hunting count report table

#argument	@table_from	varchar(60)	log table to be a source
#argument	@table_to	varcahr(60)	report table to be a destination
#argument	@logdate	int		the date of report to be created
#return
#result_set
#remark
#example	Exec lin_RPHuntCount 'L2004_11_30_log_data_8', 'R2004_11_HUNTCOUNT_8', 20041130
#history	create young	2003-03-17
#see
********************************************/
ALTER PROCEDURE [DBO].[lin_RPHuntCount]
	@table_from	varchar(60),
	@table_to	varchar(60),
	@logdate	int

AS
SET NOCOUNT ON

declare @sql varchar(4000)

-- check table whether @table_to is exists or not
set @sql = 'select * from lin2report.dbo.sysobjects (nolock) where name = ''' + @table_to + ''''
exec (@sql)

if (@@ROWCOUNT = 0)
begin
	set @sql = 'CREATE TABLE dbo.' + @table_to + ' (' 
		+ ' log_date	int, '
		+ 'log_type	smallint, '
		+ 'log_val	int, '
		+ 'npc_id	int, '
		+ ' npc_level	int, '
		+ 'log_count 	int'
		+ ' ) '
	exec (@sql)

	set @sql = 'CREATE INDEX IX_' + @table_to + '_1 on dbo.' + @table_to + ' (log_date) '
	exec (@sql)
end
else begin
	set @sql = 'delete from dbo.' + @table_to + ' where log_date = ' + CAST(@logdate as varchar)
	exec (@sql)
end

-- check tmp table
declare @tmp_table varchar(512)
set @tmp_table = 'dbo.tmp' + @table_to

set @sql = 'select * from lin2report.dbo.sysobjects (nolock) where name = ''tmp' + @table_to + ''''
exec (@sql)

if (@@ROWCOUNT > 0)
begin
	set @sql = ' drop table dbo.tmp' + @table_to
	exec (@sql)
end

-- make tmptable
set @table_from = replace ( @table_from, 'data0', 'data2' )
set @sql = ' select log_id, etc_num1, etc_num2, etc_num3, etc_num4, target_account, etc_num7, etc_num10 into ' + @tmp_table
	+ ' from lin2log.dbo.' + @table_from  + ' ( nolock) where log_id = 1112  '
exec (@sql)

set @table_from = replace ( @table_from, 'data2', 'data' )
set @sql = ' insert into ' + @tmp_table + ' ( log_id, etc_num1, etc_num2, etc_num3, etc_num4, target_account, etc_num7, etc_num10 ) ( select log_id, etc_num1, etc_num2, etc_num3, etc_num4, target_account, etc_num7, etc_num10 '
	+ ' from lin2log.dbo.' + @table_from  + ' ( nolock) where log_id = 1112 ) '
exec (@sql)

-- insert into report table

	-- race - T +T NPC-
	set @sql = 'insert into ' + RTRIM(@table_to) + ' ( log_date,  log_type, log_val, npc_id, npc_level,   log_count ) ( ' 
		+ ' select ' + CAST(@logdate as varchar) + ', 1, etc_num1, target_account, etc_num7, count(distinct etc_num10 )  from  '
		+ @tmp_table  + ' ( nolock )  group by etc_num1, target_account , etc_num7 )  option (MAXDOP 1 ) '
	exec (@sql )
	-- sex - T +T NPC-
	set @sql = 'insert into ' + RTRIM(@table_to) + ' ( log_date,  log_type, log_val, npc_id, npc_level,  log_count ) ( ' 
		+ ' select ' + CAST(@logdate as varchar) + ', 2, etc_num2, target_account, etc_num7, count(distinct etc_num10 )  from  '
		+ @tmp_table  + ' ( nolock )  group by etc_num2, target_account , etc_num7 ) option (MAXDOP 1 ) '
	exec (@sql )
	-- class - T +T NPC-
	set @sql = 'insert into ' + RTRIM(@table_to) + ' ( log_date,  log_type, log_val, npc_id,  npc_level, log_count ) ( ' 
		+ ' select ' + CAST(@logdate as varchar) + ', 3, etc_num3, target_account, etc_num7,  count(distinct etc_num10 ) from   '
		+ @tmp_table  + ' ( nolock )  group by etc_num3, target_account , etc_num7 )  option (MAXDOP 1 ) '
	exec (@sql )
	-- level - T +T NPC-
	set @sql = 'insert into ' + RTRIM(@table_to) + ' ( log_date,  log_type, log_val, npc_id,  npc_level, log_count ) ( ' 
		+ ' select  ' + CAST(@logdate as varchar) + ', 4, etc_num4, target_account, etc_num7, count(distinct etc_num10 ) from  '
		+ @tmp_table  + ' ( nolock )  group by etc_num4, target_account , etc_num7  ) option (MAXDOP 1 ) '
	exec (@sql )

-- drop tmptable
set @sql = 'drop table ' + @tmp_table
exec ( @sql )
GO

/********************************************
lin_RPLoginCount
do make login count report table

#argument	@table_from	varchar(60)	log table to be a source
#argument	@table_to	varcahr(60)	report table to be a destination
#argument	@logdate	int		the date of report to be created
#return
#result_set
#remark		This procedure creates the report by race, sex, class, level and total amount of sign-in account
#example	Exec lin_RPLoginCount 'L2004_11_30_log_data_8', 'R2004_11_30_LOGINCOUNT_8', 20041130
#history	create		young	2003-03-17
#see
********************************************/
ALTER PROCEDURE [DBO].[lin_RPLoginCount]
	@table_from	varchar(60),
	@table_to	varchar(60),
	@logdate	int

AS
SET NOCOUNT ON

declare @sql varchar(4000)

-- check table whether @table_to is exists or not
set @sql = 'select * from lin2report.dbo.sysobjects (nolock) where name = ''' + @table_to + ''''
exec (@sql)

if (@@ROWCOUNT = 0)
begin
	set @sql = 'CREATE TABLE dbo.' + @table_to + ' (' 
		+ ' log_date	int, '
		+ 'log_type	smallint, '
		+ 'log_val	int, '
		+ 'log_count 	int'
		+ ' ) '
	exec (@sql)

	set @sql = 'CREATE INDEX IX_' + @table_to + '_1 on dbo.' + @table_to + ' (log_date) '
	exec (@sql)
end
else begin
	set @sql = 'delete from dbo.' + @table_to + ' where log_date = ' + CAST(@logdate as varchar)
	exec (@sql)
end

-- check tmp table
declare @tmp_table varchar(512)
set @tmp_table = 'dbo.tmp' + @table_to

set @sql = 'select * from lin2report.dbo.sysobjects (nolock) where name = ''tmp' + @table_to + ''''
exec (@sql)

if (@@ROWCOUNT > 0)
begin
	set @sql = ' drop table dbo.tmp' + @table_to
	exec (@sql)
end


-- make tmptable
set @table_from = replace ( @table_from, 'data0', 'data2' )
set @sql = ' select log_id, etc_num1,  etc_num2, etc_num3, etc_num4, actor , actor_account  into ' + @tmp_table
	+ ' from lin2log.dbo.' + @table_from  + ' ( nolock) where log_id = 803  '
exec (@sql)

set @table_from = replace ( @table_from, 'data2', 'data' )
set @sql = ' insert into ' + @tmp_table + ' ( log_id, etc_num1, etc_num2, etc_num3, etc_num4,  actor , actor_account ) ( select log_id, etc_num1, etc_num2, etc_num3, etc_num4, actor , actor_account  '
	+ ' from lin2log.dbo.' + @table_from  + ' ( nolock) where log_id = 803  ) '
exec (@sql)



-- insert into report table

-- race - +-+L+T - -L-
set @sql = 'insert into ' + RTRIM(@table_to) + ' ( log_date,  log_type, log_val, log_count ) ( ' 
	+ ' select  ' + CAST(@logdate as varchar)  + ', 1, etc_num1, count(distinct actor) from '
	+ @tmp_table + '  ( nolock )  group by etc_num1 )  option (MAXDOP 1 ) '
exec (@sql )

-- sex - +-+L+T - -L-
set @sql = 'insert into ' + RTRIM(@table_to) + ' ( log_date,  log_type, log_val, log_count ) ( ' 
	+ ' select  ' + CAST(@logdate as varchar)   + ', 2, etc_num2, count(distinct actor) from '
	+ @tmp_table + '  ( nolock )  group by etc_num2 )  option (MAXDOP 1 ) '
exec (@sql )

-- class - +-+L+T - -L-
set @sql = 'insert into ' + RTRIM(@table_to) + ' ( log_date,  log_type, log_val, log_count ) ( ' 
	+ ' select  ' + CAST(@logdate as varchar)   + ', 3, etc_num3, count(distinct actor) from '
	+ @tmp_table + '   ( nolock )  group by etc_num3 )  option (MAXDOP 1 ) '
exec (@sql )

-- level - +-+L+T - -L-
set @sql = 'insert into ' + RTRIM(@table_to) + ' ( log_date,  log_type, log_val, log_count ) ( ' 
	+ ' select  ' + CAST(@logdate as varchar)   + ', 4, etc_num4, count(distinct actor) from '
	+ @tmp_table + '   ( nolock )  group by etc_num4 )  option (MAXDOP 1 ) '
exec (@sql )

-- +-+L+T --+ -L-
set @sql = 'insert into ' + RTRIM(@table_to) + ' ( log_date,  log_type, log_val, log_count ) ( ' 
	+ ' select  ' + CAST(@logdate as varchar)   + ', 5, 0, count(distinct actor_account) from '
	+ @tmp_table + '   ( nolock )   )  option (MAXDOP 1 ) '
exec (@sql )

-- drop tmptable
set @sql = ' drop table ' + @tmp_table
exec (@sql)
GO

/********************************************
lin_RPChangeClass
do make changed class

#argument	@table_from	varchar(60)	log table to be a source
#argument	@table_to	varchar(60)	report table to be a destination
#argument	@logdate	int		the date of report to be created
#return
#result_set
#remark
#example	Exec lin_RPChangeClass 'L2004_11_30_log_data_8', 'R2004_11_CHANGCLASS_8', 20041130
#history	create		young	2003-03-17
#see
********************************************/
ALTER PROCEDURE [DBO].[lin_RPChangeClass]
	@table_from	varchar(60),
	@table_to	varchar(60),
	@logdate	int

AS
SET NOCOUNT ON

declare @sql varchar(4000)

-- check table whether @table_to is exists or not
set @sql = 'select * from lin2report.dbo.sysobjects (nolock) where name = ''' + @table_to + ''''
exec (@sql)

if (@@ROWCOUNT = 0)
begin
	set @sql = 'CREATE TABLE dbo.' + @table_to + ' (' 
		+ ' log_date	int, '
		+ ' race		int, '
		+ ' level		int, '
		+ ' class_from	int, '
		+ ' class_to	int, '
		+ ' use_time	int '
		+ ' ) '
	exec (@sql)

	set @sql = 'CREATE INDEX IX_' + @table_to + '_1 on dbo.' + @table_to + ' (log_date) '
	exec (@sql)
end
else begin
	set @sql = 'delete from dbo.' + @table_to + ' where log_date = ' + CAST(@logdate as varchar)
	exec (@sql)
end

-- check tmp table
declare @tmp_table varchar(512)
set @tmp_table = 'dbo.tmp' + @table_to

set @sql = 'select * from lin2report.dbo.sysobjects (nolock) where name = ''tmp' + @table_to + ''''
exec (@sql)

if (@@ROWCOUNT > 0)
begin
	set @sql = ' drop table dbo.tmp' + @table_to
	exec (@sql)
end

-- insert into report table

-- +- -+-+L +- LL
set @sql = 'insert into ' + RTRIM(@table_to) + ' ( log_date,  race, level, class_from, class_to, use_time) ( ' 
	+ ' select ' + CAST(@logdate as varchar) + ', etc_num1, etc_num4, etc_num5, etc_num3, etc_num6 from '
	+ ' ( select log_id, etc_num1, etc_num4, etc_num3, etc_num5, etc_num6, etc_num7 '
	+ ' from lin2log.dbo.' + RTRIM(@table_from) + ' ( nolock ) where log_id = 816 and ( etc_num7 is null or etc_num7 = 0 ) ) as R1  ) option (MAXDOP 1 ) '
exec (@sql )
GO

/********************************************
lin_ProcessLog2
makes report tables from log tables every early morning.

#argument	@report_date	datetime	the date to create reports
#argument	@report_world	int		the number of world to create reports
#return
#result_set
#remark
#example	Exec lin_ProcessLog2 getdate(), 1: This Example makes the current report of the 1st world.
#history	create		young	2003-03-17
#see		lin_RPLoginCount
#see		lin_RPHuntCount
#see		lin_RPLearnSkillLev
#see		lin_RPChangeClass
#see		lin_RPPlayTime
#see		lin_RPNPCHunted
#see		lin_RPEarnSP
#see		lin_RPPCDie
#see		lin_RPPCDieLoc
#see		lin_RPNPCDieLoc
#see		lin_RPPCDieLoc2
#see		lin_RPNPCDieLoc2
#see		lin_RPUseSkill
#see		lin_RPAccountPlayTime
#see		lin_RPCastSkill
#see		lin_RPPCKillNPC
#see		lin_RPStand
#see		lin_RPDieDuration
#see		lin_RPConcurrent
#see		lin_RPClass
#see		lin_RPBeginQuest
#see		lin_RPEndQuest
#see		lin_RPStopQuest
#see		lin_RPSayCount
#see		lin_RPItemBuy
#see		lin_RPItemSell
#see		lin_RPEarnAdena
#see		lin_RPNPCDrop
#see		lin_RPNPCDrop2
#see		lin_RPWareDeposit
#see		lin_RPWareRetrieve
#see		lin_RPTradeGive
#see		lin_RPTradeGet
#see		lin_RPNPCDropLoc
#see		lin_RPEquipItem
#see		lin_RPEnchant
#see		lin_RPEnchantFail
#see		lin_RPCrystalize
#see		lin_RPSellPrivate
#see		lin_RPItemInc
#see		lin_RPItemDec
#see		lin_RPDieDrop
#see		lin_RPNPCDropItem
#see		lin_RPRecipe
#see		lin_RPCharPlayTime
#see		lin_RPExp
#see		lin_RPGetItem
#see		lin_RPAsset
#see		lin_RPEquipped
#see		lin_RPTradeItem
#see		lin_RPLevInc
#see		lin_RPLevDec
#see		lin_RPClassInc
#see		lin_RPClassDec
#see		lin_RPPrivateStore
#see		lin_RPSvrStart
#see		lin_RPCastSpoil
#see		lin_RPCastleWar
#see		lin_RPCastleTaxIncome
#see		lin_RPCastleTaxTribute
#see		lin_RPLevUp2
#see		lin_RPPledgeUp
#see		lin_RPPlayStat
#see		lin_RPPCKillPC
#see		lin_RPCastleTax
#see		lin_RPCharPlay
#see		lin_RPKillPCCount
#see		lin_RPKillPCCount2
#see		lin_RPDailyLevUp
********************************************/
ALTER PROCEDURE [DBO].[lin_ProcessLog2]

	@report_date datetime ,
	@report_world int = 1
AS


SET NOCOUNT ON

if @report_date is null
begin
	set @report_date = getdate()
	set @report_date = dateadd(d, -1, getdate())
end

DECLARE @nyear int
DECLARE @nmonth int
DECLARE @nday int
DECLARE @stryear varchar(10)
DECLARE @strmonth varchar(10)
DECLARE @strday varchar(10)
DECLARE @str_report varchar(32)
DECLARE @logdate int

set @nyear = datepart(yyyy, @report_date)
set @nmonth = datepart(mm, @report_date)
set @nday = datepart(dd, @report_date)

set @stryear = cast(@nyear as varchar)
if @nmonth < 10
	set @strmonth = '0' + cast(@nmonth as varchar)
else
	set @strmonth = cast (@nmonth as varchar)

if @nday < 10
	set @strday = '0' + cast(@nday as varchar)
else
	set @strday = cast (@nday as varchar)	

set @str_report = @stryear + '/' + @strmonth + '/' + @strday
set @logdate = cast(@stryear + @strmonth + @strday as int)

------------- now.. we have year, month, day string
DECLARE @table_from varchar(60)
DECLARE @table_to varchar(60)
declare @sql varchar(512)


--------------------------- using view
set @table_from = 'L' + @stryear  + '_' + @strmonth + '_' + @strday + '_log_data0_' + cast ( @report_world as varchar)


-----------------------------------------------------------------------------------------------------------------------------------------------------------------
-----------------------------------------------------------------------------------------------------------------------------------------------------------------

-- make LOGINCOUNT report
set @table_to =  'R' + @stryear + '_' + @strmonth  +  '_LOGINCOUNT_' + cast(@report_world as varchar)
exec lin_RPLoginCount @table_from, @table_to, @logdate
waitfor delay '0:0:6'

-- make HUNTCOUNT report
set @table_to =  'R' + @stryear + '_' + @strmonth  +  '_HUNTCOUNT_' + cast(@report_world as varchar)
exec lin_RPHuntCount @table_from, @table_to, @logdate
waitfor delay '0:0:6'

-- make LEARNSKILLLEV report
set @table_to =  'R' + @stryear + '_' + @strmonth  +  '_LEARNSKILLLEV_' + cast(@report_world as varchar)
exec lin_RPLearnSkillLev @table_from, @table_to, @logdate
waitfor delay '0:0:6'

-- make CHANGECLASS report
set @table_to =  'R' + @stryear + '_' + @strmonth  +  '_CHANGECLASS_' + cast(@report_world as varchar)
exec lin_RPChangeClass @table_from, @table_to, @logdate
waitfor delay '0:0:6'

-- make PLAYTIME report
set @table_to =  'R' + @stryear + '_' + @strmonth  +  '_PLAYTIME_' + cast(@report_world as varchar)
exec lin_RPPlayTime @table_from, @table_to, @logdate
waitfor delay '0:0:6'

-- make NPCHUNTED report
set @table_to =  'R' + @stryear + '_' + @strmonth  +  '_NPCHUNTED_' + cast(@report_world as varchar)
exec lin_RPNPCHunted @table_from, @table_to, @logdate
waitfor delay '0:0:6'

-- make EARNSP report
set @table_to =  'R' + @stryear + '_' + @strmonth  +  '_EARNSP_' + cast(@report_world as varchar)
exec lin_RPEarnSP @table_from, @table_to, @logdate
waitfor delay '0:0:6'


-- make LEVUP report
-- set @table_to =  'R' + @stryear + '_' + @strmonth  +  '_LEVUP_' + cast(@report_world as varchar)
-- exec lin_RPLevUp @table_from, @table_to, @logdate
-- waitfor delay '0:0:6'

-- make PCDIE report
set @table_to =  'R' + @stryear + '_' + @strmonth  +  '_PCDIE_' + cast(@report_world as varchar)
exec lin_RPPCDie @table_from, @table_to, @logdate
waitfor delay '0:0:6'

-- make PCDIELOC report
set @table_to =  'R' + @stryear + '_' + @strmonth  +  '_PCDIELOC_' + cast(@report_world as varchar)
exec lin_RPPCDieLoc @table_from, @table_to, @logdate
waitfor delay '0:0:6'

-- make NPCDIELOC report
set @table_to =  'R' + @stryear + '_' + @strmonth  +  '_NPCDIELOC_' + cast(@report_world as varchar)
exec lin_RPNPCDieLoc @table_from, @table_to, @logdate
waitfor delay '0:0:6'

-- make PCDIELOC2 report
set @table_to =  'R' + @stryear + '_' + @strmonth  +  '_PCDIELOC2_' + cast(@report_world as varchar)
exec lin_RPPCDieLoc2 @table_from, @table_to, @logdate
waitfor delay '0:0:6'

-- make NPCDIELOC2 report
set @table_to =  'R' + @stryear + '_' + @strmonth  +  '_NPCDIELOC2_' + cast(@report_world as varchar)
exec lin_RPNPCDieLoc2 @table_from, @table_to, @logdate
waitfor delay '0:0:6'

-- make USESKILL report
set @table_to =  'R' + @stryear + '_' + @strmonth  +  '_USESKILL_' + cast(@report_world as varchar)
exec lin_RPUseSkill @table_from, @table_to, @logdate
waitfor delay '0:0:6'

-- make ACCOUNTPLAYTIME  report
set @table_to =  'R' + @stryear + '_' + @strmonth  +  '_ACCOUNTPLAYTIME_' + cast(@report_world as varchar)
exec lin_RPAccountPlayTime @table_from, @table_to, @logdate
waitfor delay '0:0:6'

-- make CASTSKILL report
set @table_to =  'R' + @stryear + '_' + @strmonth  +  '_CASTSKILL_' + cast(@report_world as varchar)
exec lin_RPCastSkill @table_from, @table_to, @logdate
waitfor delay '0:0:6'

-- make PCKILLNPC report
set @table_to =  'R' + @stryear + '_' + @strmonth  +  '_PCKILLNPC_' + cast(@report_world as varchar)
exec lin_RPPCKillNPC @table_from, @table_to, @logdate
waitfor delay '0:0:6'

-- make STAND report
set @table_to =  'R' + @stryear + '_' + @strmonth  +  '_STAND_' + cast(@report_world as varchar)
exec lin_RPStand @table_from, @table_to, @logdate
waitfor delay '0:0:6'

-- make DIEDURATION report
set @table_to =  'R' + @stryear + '_' + @strmonth  +  '_DIEDURATION_' + cast(@report_world as varchar)
exec lin_RPDieDuration @table_from, @table_to, @logdate
waitfor delay '0:0:6'

-- make CONCURRENT  report
set @table_to =  'R' + @stryear + '_' + @strmonth  +  '_CONCURRENT_' + cast(@report_world as varchar)
exec lin_RPConcurrent @table_from, @table_to, @logdate
waitfor delay '0:0:6'

-- make CLASS report
set @table_to =  'R' + @stryear + '_' + @strmonth  +  '_CLASS_' + cast(@report_world as varchar)
exec lin_RPClass @table_from, @table_to, @logdate
waitfor delay '0:0:6'


-- make BEGINQUEST report
set @table_to =  'R' + @stryear + '_' + @strmonth  +  '_BEGINQUEST_' + cast(@report_world as varchar)
exec lin_RPBeginQuest @table_from, @table_to, @logdate
waitfor delay '0:0:6'

-- make ENDQUEST report
set @table_to =  'R' + @stryear + '_' + @strmonth  +  '_ENDQUEST_' + cast(@report_world as varchar)
exec lin_RPEndQuest @table_from, @table_to, @logdate
waitfor delay '0:0:6'

-- make STOPQUEST report
set @table_to =  'R' + @stryear + '_' + @strmonth  +  '_STOPQUEST_' + cast(@report_world as varchar)
exec lin_RPStopQuest @table_from, @table_to, @logdate
waitfor delay '0:0:6'

-- make SAYCOUNT  report
set @table_to =  'R' + @stryear + '_' + @strmonth  +  '_SAYCOUNT_' + cast(@report_world as varchar)
exec lin_RPSayCount @table_from, @table_to, @logdate
waitfor delay '0:0:6'


---------------------------------- item report part

-- make ITEMBUY report
set @table_to =  'R' + @stryear + '_' + @strmonth  +  '_ITEMBUY_' + cast(@report_world as varchar)
exec lin_RPItemBuy @table_from, @table_to, @logdate
waitfor delay '0:0:6'

-- make ITEMSELL report
set @table_to =  'R' + @stryear + '_' + @strmonth  +  '_ITEMSELL_' + cast(@report_world as varchar)
exec lin_RPItemSell @table_from, @table_to, @logdate
waitfor delay '0:0:6'


-- make EARNADENA report
set @table_to =  'R' + @stryear + '_' + @strmonth  +  '_EARNADENA_' + cast(@report_world as varchar)
exec lin_RPEarnAdena @table_from, @table_to, @logdate
waitfor delay '0:0:6'

-- make NPCDROP report
set @table_to =  'R' + @stryear + '_' + @strmonth  +  '_NPCDROP_' + cast(@report_world as varchar)
exec lin_RPNPCDrop @table_from, @table_to, @logdate
waitfor delay '0:0:6'

-- make NPCDROP2 report
set @table_to =  'R' + @stryear + '_' + @strmonth  +  '_NPCDROP2_' + cast(@report_world as varchar)
exec lin_RPNPCDrop2 @table_from, @table_to, @logdate
waitfor delay '0:0:6'

-- make WAREDEPOSIT report
set @table_to =  'R' + @stryear + '_' + @strmonth  +  '_WAREDEPOSIT_' + cast(@report_world as varchar)
exec lin_RPWareDeposit @table_from, @table_to, @logdate
waitfor delay '0:0:6'

-- make WARERETRIEVE report
set @table_to =  'R' + @stryear + '_' + @strmonth  +  '_WARERETRIEVE_' + cast(@report_world as varchar)
exec lin_RPWareRetrieve @table_from, @table_to, @logdate
waitfor delay '0:0:6'

-- make TRADEGIVE report
set @table_to =  'R' + @stryear + '_' + @strmonth  +  '_TRADEGIVE_' + cast(@report_world as varchar)
exec lin_RPTradeGive @table_from, @table_to, @logdate
waitfor delay '0:0:6'

-- make TRADEGET  report
set @table_to =  'R' + @stryear + '_' + @strmonth  +  '_TRADEGET_' + cast(@report_world as varchar)
exec lin_RPTradeGet  @table_from, @table_to, @logdate
waitfor delay '0:0:6'


-- make NPCDROPLOC report
set @table_to =  'R' + @stryear + '_' + @strmonth  +  '_NPCDROPLOC_' + cast(@report_world as varchar)
exec lin_RPNPCDropLoc @table_from, @table_to, @logdate
waitfor delay '0:0:6'

-- make EQUIPITEM report
set @table_to =  'R' + @stryear + '_' + @strmonth  +  '_EQUIPITEM_' + cast(@report_world as varchar)
exec lin_RPEquipItem @table_from, @table_to, @logdate
waitfor delay '0:0:6'

-- make ENCHANT report
set @table_to =  'R' + @stryear + '_' + @strmonth  +  '_ENCHANT_' + cast(@report_world as varchar)
exec lin_RPEnchant @table_from, @table_to, @logdate
waitfor delay '0:0:6'

-- make ENCHANTFAIL report
set @table_to =  'R' + @stryear + '_' + @strmonth  +  '_ENCHANTFAIL_' + cast(@report_world as varchar)
exec lin_RPEnchantFail @table_from, @table_to, @logdate
waitfor delay '0:0:6'

-- make CRYSTALIZE report
set @table_to =  'R' + @stryear + '_' + @strmonth  +  '_CRYSTALIZE_' + cast(@report_world as varchar)
exec lin_RPCrystalize @table_from, @table_to, @logdate
waitfor delay '0:0:6'

-- make SELLPRIVATE report
set @table_to =  'R' + @stryear + '_' + @strmonth  +  '_SELLPRIVATE_' + cast(@report_world as varchar)
exec lin_RPSellPrivate @table_from, @table_to, @logdate
waitfor delay '0:0:6'


-- make ITEMINC report
set @table_to =  'R' + @stryear + '_' + @strmonth  +  '_ITEMINC_' + cast(@report_world as varchar)
exec lin_RPItemInc @table_from, @table_to, @logdate
waitfor delay '0:0:6'

-- make ITEMDEC report
set @table_to =  'R' + @stryear + '_' + @strmonth  +  '_ITEMDEC_' + cast(@report_world as varchar)
exec lin_RPItemDec @table_from, @table_to, @logdate
waitfor delay '0:0:6'

-- make DIEDROP report
set @table_to =  'R' + @stryear + '_' + @strmonth  +  '_DIEDROP_' + cast(@report_world as varchar)
exec lin_RPDieDrop @table_from, @table_to, @logdate
waitfor delay '0:0:6'

-- make NPCDROPITEM report
set @table_to =  'R' + @stryear + '_' + @strmonth  +  '_NPCDROPITEM_' + cast(@report_world as varchar)
exec lin_RPNPCDropItem @table_from, @table_to, @logdate
waitfor delay '0:0:6'


-- make RECIPE report
set @table_to =  'R' + @stryear + '_' + @strmonth  +  '_RECIPE_' + cast(@report_world as varchar)

exec lin_RPRecipe @table_from, @table_to, @logdate
waitfor delay '0:0:6'

----------------------------------------- new reports
-- make CHARPLAYTIME report
set @table_to =  'R' + @stryear + '_' + @strmonth  +  '_CHARPLAYTIME_' + cast(@report_world as varchar)
exec lin_RPCharPlayTime @table_from, @table_to, @logdate
waitfor delay '0:0:6'

-- make EXP report
set @table_to =  'R' + @stryear + '_' + @strmonth  +  '_EXP_' + cast(@report_world as varchar)
exec lin_RPExp @table_from, @table_to, @logdate
waitfor delay '0:0:6'

-- make GETITEM  report
set @table_to =  'R' + @stryear + '_' + @strmonth  +  '_GETITEM_' + cast(@report_world as varchar)
exec lin_RPGetItem @table_from, @table_to, @logdate
waitfor delay '0:0:6'

-- make ASSET  report
set @table_to =  'R' + @stryear + '_' + @strmonth  +  '_ASSET_' + cast(@report_world as varchar)
exec lin_RPAsset @table_from, @table_to, @logdate
waitfor delay '0:0:6'

-- make EQUIPPED  report
set @table_to =  'R' + @stryear + '_' + @strmonth  +  '_EQUIPPED_' + cast(@report_world as varchar)
exec lin_RPEquipped @table_from, @table_to, @logdate
waitfor delay '0:0:6'

-- make TRADEITEM  report
set @table_to =  'R' + @stryear + '_' + @strmonth  +  '_TRADEITEM_' + cast(@report_world as varchar)
exec lin_RPTradeItem @table_from, @table_to, @logdate
waitfor delay '0:0:6'

-- make LEVINC report
set @table_to =  'R' + @stryear + '_' + @strmonth  +  '_LEVINC_' + cast(@report_world as varchar)
exec lin_RPLevInc @table_from, @table_to, @logdate
waitfor delay '0:0:6'

-- make LEVDEC report
set @table_to =  'R' + @stryear + '_' + @strmonth  +  '_LEVDEC_' + cast(@report_world as varchar)
exec lin_RPLevDec @table_from, @table_to, @logdate
waitfor delay '0:0:6'

-- make CLASSINC report
set @table_to =  'R' + @stryear + '_' + @strmonth  +  '_CLASSINC_' + cast(@report_world as varchar)
exec lin_RPClassInc @table_from, @table_to, @logdate
waitfor delay '0:0:6'

-- make CLASSDEC report
set @table_to =  'R' + @stryear + '_' + @strmonth  +  '_CLASSDEC_' + cast(@report_world as varchar)
exec lin_RPClassDec @table_from, @table_to, @logdate
waitfor delay '0:0:6'

-- make PRIVATESTORE report
set @table_to =  'R' + @stryear + '_' + @strmonth  +  '_PRIVATESTORE_' + cast(@report_world as varchar)
exec lin_RPPrivateStore @table_from, @table_to, @logdate

-- make SVRSTART  report
set @table_from = 'L' + @stryear  + '_' + @strmonth + '_' + @strday + '_log_realtime_' + cast ( @report_world as varchar)
set @table_to =  'R' + @stryear + '_' + @strmonth  +  '_SVRSTART_' + cast(@report_world as varchar)
exec lin_RPSvrStart @table_from, @table_to, @logdate
waitfor delay '0:0:6'

-- make CASTSPOIL  report
set @table_from = 'L' + @stryear  + '_' + @strmonth + '_' + @strday + '_log_data0_' + cast ( @report_world as varchar)
set @table_to =  'R' + @stryear + '_' + @strmonth  +  '_CASTSPOIL_' + cast(@report_world as varchar)
exec lin_RPCastSpoil @table_from, @table_to, @logdate
waitfor delay '0:0:6'

-- make CASTLEWAR report
set @table_from = 'L' + @stryear  + '_' + @strmonth + '_' + @strday + '_log_data0_' + cast ( @report_world as varchar)
set @table_to =  'R' + @stryear + '_' + @strmonth  +  '_CASTLEWAR_' + cast(@report_world as varchar)
exec lin_RPCastleWar @table_from, @table_to, @logdate
waitfor delay '0:0:6'

-- make TAXINCOME  report
set @table_from = 'L' + @stryear  + '_' + @strmonth + '_' + @strday + '_log_data0_' + cast ( @report_world as varchar)
set @table_to =  'R' + @stryear + '_' + @strmonth  +  '_TAXINCOME_' + cast(@report_world as varchar)
exec lin_RPCastleTaxIncome @table_from, @table_to, @logdate
waitfor delay '0:0:6'

-- make TAXTRIBUTE report
set @table_from = 'L' + @stryear  + '_' + @strmonth + '_' + @strday + '_log_data0_' + cast ( @report_world as varchar)
set @table_to =  'R' + @stryear + '_' + @strmonth  +  '_TAXTRIBUTE_' + cast(@report_world as varchar)
exec lin_RPCastleTaxTribute @table_from, @table_to, @logdate
waitfor delay '0:0:6'

-- make LEVUP2  report
set @table_from = 'L' + @stryear  + '_' + @strmonth + '_' + @strday + '_log_data0_' + cast ( @report_world as varchar)
set @table_to =  'R' + @stryear + '_' + @strmonth  +  '_LEVUP2_' + cast(@report_world as varchar)
exec lin_RPLevUp2 @table_from, @table_to, @logdate
waitfor delay '0:0:6'

-- make PLEDGEUP  report
set @table_from = 'L' + @stryear  + '_' + @strmonth + '_' + @strday + '_log_data0_' + cast ( @report_world as varchar)
set @table_to =  'R' + @stryear + '_' + @strmonth  +  '_PLEDGEUP_' + cast(@report_world as varchar)
exec lin_RPPledgeUp @table_from, @table_to, @logdate

waitfor delay '0:0:6'

-- make PLAYSTAT  report
set @table_from = 'L' + @stryear  + '_' + @strmonth + '_' + @strday + '_log_data0_' + cast ( @report_world as varchar)
set @table_to =  'R' + @stryear + '_' + @strmonth  +  '_PLAYSTAT_' + cast(@report_world as varchar)
exec lin_RPPlayStat @table_from, @table_to, @logdate

waitfor delay '0:0:6'

-- make PCKILLPC  report
set @table_from = 'L' + @stryear  + '_' + @strmonth + '_' + @strday + '_log_data0_' + cast ( @report_world as varchar)
set @table_to =  'R' + @stryear + '_' + @strmonth  +  '_PCKILLPC_' + cast(@report_world as varchar)
exec lin_RPPCKillPC @table_from, @table_to, @logdate

waitfor delay '0:0:6'

-- make TAX  report
set @table_from = 'L' + @stryear  + '_' + @strmonth + '_' + @strday + '_log_data0_' + cast ( @report_world as varchar)
set @table_to =  'R' + @stryear + '_' + @strmonth  +  '_TAX_' + cast(@report_world as varchar)
exec lin_RPCastleTax @table_from, @table_to, @logdate

waitfor delay '0:0:6'

-- make CHARPLAY report
set @table_from = 'L' + @stryear  + '_' + @strmonth + '_' + @strday + '_log_data0_' + cast ( @report_world as varchar)
set @table_to =  'R' + @stryear + '_' + @strmonth  +  '_CHARPLAY_' + cast(@report_world as varchar)
exec lin_RPCharPlay @table_from, @table_to, @logdate

waitfor delay '0:0:6'

-- make KILLPCCOUNT  report
set @table_from = 'L' + @stryear  + '_' + @strmonth + '_' + @strday + '_log_data0_' + cast ( @report_world as varchar)
set @table_to =  'R' + @stryear + '_' + @strmonth  +  '_KILLPCCOUNT_' + cast(@report_world as varchar)
exec lin_RPKillPCCount  @table_from, @table_to, @logdate

waitfor delay '0:0:6'

-- make KILLPCCOUNT2  report
set @table_from = 'L' + @stryear  + '_' + @strmonth + '_' + @strday + '_log_data0_' + cast ( @report_world as varchar)
set @table_to =  'R' + @stryear + '_' + @strmonth  +  '_KILLPCCOUNT2_' + cast(@report_world as varchar)
exec lin_RPKillPCCount2  @table_from, @table_to, @logdate

waitfor delay '0:0:6'

-- make DAILYLEVUP report
set @table_from = 'L' + @stryear  + '_' + @strmonth + '_' + @strday + '_log_data0_' + cast ( @report_world as varchar)
set @table_to =  'R' + @stryear + '_' + @strmonth  +  '_DAILYLEVUP_' + cast(@report_world as varchar)
exec lin_RPDailyLevUp  @table_from, @table_to, @logdate

/*
--------------------------- using sanp data
set @table_from = 'S' + @stryear  + '_' + @strmonth + '_' + @strday + '_snap_data_' + cast ( @report_world as varchar)

-- make RANKDAILYEXP report
set @table_to =  'R' + @stryear + '_' + @strmonth  +  '_RANKDAILYEXP_' + cast(@report_world as varchar)
exec lin_RPRankDailyExp  @table_from, @table_to, @logdate

waitfor delay '0:0:6'

--------------------------- using sanp item
set @table_from = 'S' + @stryear  + '_' + @strmonth + '_' + @strday + '_snap_item_' + cast ( @report_world as varchar)

-- make RANKDAILYADENA report
set @table_to =  'R' + @stryear + '_' + @strmonth  +  '_RANKDAILYADENA_' + cast(@report_world as varchar)
exec lin_RPRankDailyAdena  @table_from, @table_to, @logdate

waitfor delay '0:0:6'

-- make RANKDAILYCRYSTAL report
set @table_to =  'R' + @stryear + '_' + @strmonth  +  '_RANKDAILYCRYSTAL_' + cast(@report_world as varchar)
exec lin_RPRankDailyCrystal  @table_from, @table_to, @logdate

*/
GO

/********************************************
lin_RPPlaySex
do make play sexreport

#argument	@table_from	varchar(60)	log table to be a source
#argument	@table_to	varchar(60)	report table to be a destination
#argument	@logdate	int		the date of report to be created
#return
#result_set
#remark
#example	Exec lin_RPPlaySex 'L2004_11_30_log_data_8', 'R2004_11_PLAYSEX_8', 20041130
#history	create		young	2003-08-05
#see
********************************************/
ALTER PROCEDURE [DBO].[lin_RPPlaySex]
	@table_from	varchar(60),
	@table_to	varchar(60),
	@logdate	int

AS
SET NOCOUNT ON

declare @sql varchar(512)

-- check table whether @table_to is exists or not
set @sql = 'select * from lin2report.dbo.sysobjects (nolock) where name = ''' + @table_to + ''''
exec (@sql)

if (@@ROWCOUNT = 0)
begin
	set @sql = 'CREATE TABLE dbo.' + @table_to + ' (' 
		+ ' log_date	int, '
		+ ' sex		int, '
		+ ' play_count	int, '
		+ ' play_time	money  '
		+ ' ) '
	exec (@sql)

	set @sql = 'CREATE INDEX IX_' + @table_to + '_1 on dbo.' + @table_to + ' (log_date) '
	exec (@sql)
end
else begin
	set @sql = 'delete from dbo.' + @table_to + ' where log_date = ' + CAST(@logdate as varchar)
	exec (@sql)
end

-- insert into report table
set @sql = 'insert into ' + RTRIM(@table_to) + ' ( log_date,  sex , play_count, play_time  ) ( ' 
	+ ' select ' + CAST(@logdate as varchar) + ', etc_num3, count( distinct ( actor_account) ),  sum( cast ( etc_num4 as money) )  from  '
	+ ' ( select etc_num3, actor_account,  etc_num4  '
	+ ' from lin2log.dbo.' + RTRIM(@table_from) + ' ( nolock ) where log_id = 804 ) as R1 group by etc_num3  )  option (MAXDOP 1 ) '
exec (@sql )
GO

/********************************************
lin_RPPlayAge
do make play age report

#argument	@table_from	varchar(60)	log table to be a source
#argument	@table_to	varchar(60)	report table to be a destination
#argument	@logdate	int		the date of report to be created
#return
#result_set
#remark
#example	Exec lin_RPPlayAge 'L2004_11_30_log_data_8', 'R2004_11_PLAYAGE_8', 20041130
#history	create		young	2003-08-05
#see
********************************************/
ALTER PROCEDURE [DBO].[lin_RPPlayAge]
	@table_from	varchar(60),
	@table_to	varchar(60),
	@logdate	int

AS
SET NOCOUNT ON

declare @sql varchar(512)

-- check table whether @table_to is exists or not
set @sql = 'select * from lin2report.dbo.sysobjects (nolock) where name = ''' + @table_to + ''''
exec (@sql)

if (@@ROWCOUNT = 0)
begin
	set @sql = 'CREATE TABLE dbo.' + @table_to + ' (' 
		+ ' log_date	int, '
		+ ' age		int, '
		+ ' play_count	int, '
		+ ' play_time	money  '
		+ ' ) '
	exec (@sql)

	set @sql = 'CREATE INDEX IX_' + @table_to + '_1 on dbo.' + @table_to + ' (log_date) '
	exec (@sql)
end
else begin
	set @sql = 'delete from dbo.' + @table_to + ' where log_date = ' + CAST(@logdate as varchar)
	exec (@sql)
end

-- insert into report table
set @sql = 'insert into ' + RTRIM(@table_to) + ' ( log_date,  age, play_count, play_time  ) ( ' 
	+ ' select ' + CAST(@logdate as varchar) + ', etc_num2, count( distinct actor_account  ),  sum( cast ( etc_num4 as money) )  from  '
	+ ' ( select etc_num2, actor_account, etc_num4  '
	+ ' from lin2log.dbo.' + RTRIM(@table_from) + ' ( nolock ) where log_id = 804 ) as R1 group by etc_num2   )  option (MAXDOP 1 ) '
exec (@sql )
GO

/********************************************
lin_RPAuthStatSex
do make authed report

#argument	@table_from	varchar(60)	log table to be a source
#argument	@table_to	varchar(60)	report table to be a destination
#argument	@logdate	int		the date of report to be created
#return
#result_set
#remark
#example	Exec lin_RPAuthStatSex 'L2004_11_30_log_data_8', 'R2004_11_AUTHSTATSEX_8', 20041130
#history	create		young	2004-02-23
#see
********************************************/
ALTER PROCEDURE [DBO].[lin_RPAuthStatSex]
	@table_from	varchar(60),
	@table_to	varchar(60),
	@logdate	int

AS
SET NOCOUNT ON

declare @sql varchar(2048)

-- check table whether @table_to is exists or not
set @sql = 'select * from lin2report.dbo.sysobjects (nolock) where name = ''' + @table_to + ''''
exec (@sql)

if (@@ROWCOUNT = 0)
begin
	set @sql = 'CREATE TABLE dbo.' + @table_to + ' (' 
		+ ' log_date	int, '
		+ ' stat		int, '
		+ ' sex		smallint, '
		+ ' play_account int, '
		+ ' logout_count		int, '
		+ ' avg_playtime		int ,  '
		+ ' stdev_playtime	int ,  '
		+ ' sum_playtime		money  '
		+ ' ) '
	exec (@sql)

	set @sql = 'CREATE INDEX IX_' + @table_to + '_1 on dbo.' + @table_to + ' (log_date) '
	exec (@sql)
end
else begin
	set @sql = 'delete from dbo.' + @table_to + ' where log_date = ' + CAST(@logdate as varchar)
	exec (@sql)
end

-- insert into report table
set @sql = 'insert into ' + RTRIM(@table_to) + ' ( log_date,  stat, sex, play_account, logout_count, avg_playtime, stdev_playtime, sum_playtime  ) ( ' 
	+ ' select ' + CAST(@logdate as varchar) + ', stat, etc_num3, count ( distinct ( actor_account)), count ( stat ), avg ( cast ( etc_num4 as money ) ) , stdev ( cast ( etc_num4 as money ) ) ,  sum ( cast ( etc_num4 as money ) )    from   '
	+ ' ( select stat = case when etc_num1 < 1001 then 1 else 1001 end  ,  etc_num3, etc_num4 , actor_account  '
	+ ' from lin2log.dbo.' + RTRIM(@table_from) + ' ( nolock ) where log_id = 804 ) as R1 group by stat  , etc_num3 )  option (MAXDOP 1 ) '
exec (@sql )
GO

/********************************************
lin_RPAuthStatAge
do make authed report

#argument	@table_from	varchar(60)	log table to be a source
#argument	@table_to	varchar(60)	report table to be a destination
#argument	@logdate	int		the date of report to be created
#return
#result_set
#remark
#example	Exec lin_RPAuthStatAge 'L2004_11_30_log_data_8', 'R2004_11_AUTHSTATAGE_8', 20041130
#history	create		young	2004-02-23
#see
********************************************/
ALTER PROCEDURE [DBO].[lin_RPAuthStatAge]
	@table_from	varchar(60),
	@table_to	varchar(60),
	@logdate	int

AS
SET NOCOUNT ON

declare @sql varchar(2048)

-- check table whether @table_to is exists or not
set @sql = 'select * from lin2report.dbo.sysobjects (nolock) where name = ''' + @table_to + ''''
exec (@sql)

if (@@ROWCOUNT = 0)
begin
	set @sql = 'CREATE TABLE dbo.' + @table_to + ' (' 
		+ ' log_date	int, '
		+ ' stat		int, '
		+ ' age		smallint, '
		+ ' play_account int, '
		+ ' logout_count		int, '
		+ ' avg_playtime		int ,  '
		+ ' stdev_playtime	int ,  '
		+ ' sum_playtime		money  '
		+ ' ) '
	exec (@sql)

	set @sql = 'CREATE INDEX IX_' + @table_to + '_1 on dbo.' + @table_to + ' (log_date) '
	exec (@sql)
end
else begin
	set @sql = 'delete from dbo.' + @table_to + ' where log_date = ' + CAST(@logdate as varchar)
	exec (@sql)
end

-- insert into report table
set @sql = 'insert into ' + RTRIM(@table_to) + ' ( log_date,  stat, age, play_account, logout_count, avg_playtime, stdev_playtime, sum_playtime  ) ( ' 
	+ ' select ' + CAST(@logdate as varchar) + ', stat, etc_num2, count ( distinct ( actor_account)), count ( stat ), avg ( cast ( etc_num4 as money ) ) , stdev ( cast ( etc_num4 as money ) ) ,  sum ( cast ( etc_num4 as money ) )    from   '
	+ ' ( select stat = case when etc_num1 < 1001 then 1 else 1001 end  ,  etc_num2, etc_num4 , actor_account  '
	+ ' from lin2log.dbo.' + RTRIM(@table_from) + ' ( nolock ) where log_id = 804 ) as R1 group by stat  , etc_num2 )  option (MAXDOP 1 ) '
exec (@sql )
GO

/********************************************
lin_RPAuthStat
do make authed report

#argument	@table_from	varchar(60)	log table to be a source
#argument	@table_to	varchar(60)	report table to be a destination
#argument	@logdate	int		the date of report to be created
#return
#result_set
#remark
#example	Exec lin_RPAuthStat 'L2004_11_30_log_data_8', 'R2004_11_AUTHSTAT_8', 20041130
#history	create		young	2004-02-18
#see
********************************************/
ALTER PROCEDURE [DBO].[lin_RPAuthStat]
	@table_from	varchar(60),
	@table_to	varchar(60),
	@logdate	int

AS
SET NOCOUNT ON

declare @sql varchar(2048)

-- check table whether @table_to is exists or not
set @sql = 'select * from lin2report.dbo.sysobjects (nolock) where name = ''' + @table_to + ''''
exec (@sql)

if (@@ROWCOUNT = 0)
begin
	set @sql = 'CREATE TABLE dbo.' + @table_to + ' (' 
		+ ' log_date	int, '
		+ ' stat		int, '
		+ ' play_account int, '
		+ ' logout_count		int, '
		+ ' avg_playtime		int ,  '
		+ ' stdev_playtime	int ,  '
		+ ' sum_playtime		money  '
		+ ' ) '
	exec (@sql)

	set @sql = 'CREATE INDEX IX_' + @table_to + '_1 on dbo.' + @table_to + ' (log_date) '
	exec (@sql)
end
else begin
	set @sql = 'delete from dbo.' + @table_to + ' where log_date = ' + CAST(@logdate as varchar)
	exec (@sql)
end

-- insert into report table
set @sql = 'insert into ' + RTRIM(@table_to) + ' ( log_date,  stat, play_account, logout_count, avg_playtime, stdev_playtime, sum_playtime  ) ( ' 
	+ ' select ' + CAST(@logdate as varchar) + ', stat, count ( distinct ( actor_account)), count ( stat ), avg ( cast ( etc_num4 as money ) ) , stdev ( cast ( etc_num4 as money ) ) ,  sum ( cast ( etc_num4 as money ) )    from   '
	+ ' ( select stat = case when etc_num1 < 1001 then 1 else 1001 end  ,  etc_num4 , actor_account  '
	+ ' from lin2log.dbo.' + RTRIM(@table_from) + ' ( nolock ) where log_id = 804 ) as R1 group by stat  )  option (MAXDOP 1 ) '
exec (@sql )
GO

/********************************************
lin_RPAuthed2
do make authed report

#argument	@table_from	varchar(60)	log table to be a source
#argument	@table_to	varchar(60)	report table to be a destination
#argument	@logdate	int		the date of report to be created
#return
#result_set
#remark	
#example	Exec lin_RPAuthed2 'L2004_11_30_log_data_8', 'R2004_11_AUTHED2_8', 20041130
#history	create		young	2003-08-05
#see		lin_RPAuthed
********************************************/
ALTER PROCEDURE [DBO].[lin_RPAuthed2]
	@table_from	varchar(60),
	@table_to	varchar(60),
	@logdate	int

AS
SET NOCOUNT ON

declare @sql varchar(512)

-- check table whether @table_to is exists or not
set @sql = 'select * from lin2report.dbo.sysobjects (nolock) where name = ''' + @table_to + ''''
exec (@sql)

if (@@ROWCOUNT = 0)
begin
	set @sql = 'CREATE TABLE dbo.' + @table_to + ' (' 
		+ ' log_date	int, '
		+ ' log_hour	smallint, '
		+ ' log_min	smallint, '
		+ ' min_logon	int, '
		+ ' max_logon	int  '
		+ ' ) '
	exec (@sql)

	set @sql = 'CREATE INDEX IX_' + @table_to + '_1 on dbo.' + @table_to + ' (log_date) '
	exec (@sql)
end
else begin
	set @sql = 'delete from dbo.' + @table_to + ' where log_date = ' + CAST(@logdate as varchar)
	exec (@sql)
end

-- insert into report table
set @sql = 'insert into ' + RTRIM(@table_to) + ' ( log_date,  log_hour, log_min, min_logon, max_logon ) ( ' 
	+ ' select ' + CAST(@logdate as varchar) + ', datepart(hour, act_time), datepart(minute, act_time), min(etc_num4),  max(etc_num4)  from  '
	+ ' ( select log_id, act_time, etc_num4  '
	+ ' from lin2log.dbo.' + RTRIM(@table_from) + ' ( nolock ) where log_id = 802 ) as R1 group by datepart(hour, act_time), datepart(minute, act_time)  )  option (MAXDOP 1 ) '
exec (@sql )
GO

/********************************************
lin_RPAuthed
do make authed report

#argument	@table_from	varchar(60)	log table to be a source
#argument	@table_to	varchar(60)	report table to be a destination
#argument	@logdate	int		the date of report to be created
#return
#result_set
#remark
#example	Exec lin_RPAuthed 'L2004_11_30_log_data_8', 'R2004_11_AUTHED_8', 20041130
#history	create		young	2003-08-05
#see		lin_RPAuthed2
********************************************/
ALTER PROCEDURE [DBO].[lin_RPAuthed]
	@table_from	varchar(60),
	@table_to	varchar(60),
	@logdate	int

AS
SET NOCOUNT ON

declare @sql varchar(512)

-- check table whether @table_to is exists or not
set @sql = 'select * from lin2report.dbo.sysobjects (nolock) where name = ''' + @table_to + ''''
exec (@sql)

if (@@ROWCOUNT = 0)
begin
	set @sql = 'CREATE TABLE dbo.' + @table_to + ' (' 
		+ ' log_date	int, '
		+ ' log_hour	smallint, '
		+ ' log_min	smallint, '
		+ ' min_logon	int, '
		+ ' max_logon	int  '
		+ ' ) '
	exec (@sql)

	set @sql = 'CREATE INDEX IX_' + @table_to + '_1 on dbo.' + @table_to + ' (log_date) '
	exec (@sql)
end
else begin
	set @sql = 'delete from dbo.' + @table_to + ' where log_date = ' + CAST(@logdate as varchar)
	exec (@sql)
end

-- insert into report table
set @sql = 'insert into ' + RTRIM(@table_to) + ' ( log_date,  log_hour, log_min, min_logon, max_logon ) ( ' 
	+ ' select ' + CAST(@logdate as varchar) + ', datepart(hour, act_time), datepart(minute, act_time), min(etc_num4),  max(etc_num4)  from  '
	+ ' ( select log_id, act_time, etc_num4  '
	+ ' from lin2log.dbo.' + RTRIM(@table_from) + ' ( nolock ) where log_id = 801 ) as R1 group by datepart(hour, act_time), datepart(minute, act_time)  )  option (MAXDOP 1 ) '
exec (@sql )
GO

/********************************************
lin_ProcessLog3
makes report tables from log tables every early morning.

#argument	@report_date	datetime	the date to create reports
#argument	@report_world	int		the number of world to create reports
#return
#result_set
#remark		Currently, this procedure is not used.
#example	Exec lin_ProcessLog3 getdate(), 1: This Example makes the current report of the 1st world.
#history	create	young	2003-08-05
#see		lin_RPAuthed
#see		lin_RPAuthed2
#see		lin_RPPlayAge
#see		lin_RPPlaySex
#see		lin_RPAuthStat
#see		lin_RPAuthStatAge
#see		lin_RPAuthStatSex
********************************************/
ALTER PROCEDURE [DBO].[lin_ProcessLog3]

	@report_date datetime ,
	@report_world int = 1
AS
SET NOCOUNT ON

if @report_date is null
begin
	set @report_date = getdate()
	set @report_date = dateadd(d, -1, getdate())
end

DECLARE @nyear int
DECLARE @nmonth int
DECLARE @nday int
DECLARE @stryear varchar(10)
DECLARE @strmonth varchar(10)
DECLARE @strday varchar(10)
DECLARE @str_report varchar(32)
DECLARE @logdate int

set @nyear = datepart(yyyy, @report_date)
set @nmonth = datepart(mm, @report_date)
set @nday = datepart(dd, @report_date)

set @stryear = cast(@nyear as varchar)
if @nmonth < 10
	set @strmonth = '0' + cast(@nmonth as varchar)
else
	set @strmonth = cast (@nmonth as varchar)

if @nday < 10
	set @strday = '0' + cast(@nday as varchar)
else
	set @strday = cast (@nday as varchar)	

set @str_report = @stryear + '/' + @strmonth + '/' + @strday
set @logdate = cast(@stryear + @strmonth + @strday as int)

------------- now.. we have year, month, day string
DECLARE @table_from varchar(60)
set @table_from = 'L' + @stryear  + '_' + @strmonth + '_' + @strday + '_log_data_' + cast ( @report_world as varchar)

DECLARE @table_to varchar(60)



declare @sql varchar(512)



--------------------------- using view
set @table_from = 'L' + @stryear  + '_' + @strmonth + '_' + @strday + '_log_data0_' + cast ( @report_world as varchar)


-----------------------------------------------------------------------------------------------------------------------------------------------------------------
-----------------------------------------------------------------------------------------------------------------------------------------------------------------


-- make AUTHED report
set @table_to =  'R' + @stryear + '_' + @strmonth  +  '_AUTHED_' + cast(@report_world as varchar)
exec lin_RPAuthed @table_from, @table_to, @logdate
waitfor delay '0:0:6'

-- make AUTHED2 report
set @table_to =  'R' + @stryear + '_' + @strmonth  +  '_AUTHED2_' + cast(@report_world as varchar)
exec lin_RPAuthed2 @table_from, @table_to, @logdate
waitfor delay '0:0:6'

-- make PLAYAGE report
set @table_to =  'R' + @stryear + '_' + @strmonth  +  '_PLAYAGE_' + cast(@report_world as varchar)
exec lin_RPPlayAge @table_from, @table_to, @logdate
waitfor delay '0:0:6'

-- make PLAYSEX report
set @table_to =  'R' + @stryear + '_' + @strmonth  +  '_PLAYSEX_' + cast(@report_world as varchar)
exec lin_RPPlaySex @table_from, @table_to, @logdate

-- make AUTHSTAT  report
set @table_to =  'R' + @stryear + '_' + @strmonth  +  '_AUTHSTAT_' + cast(@report_world as varchar)
exec lin_RPAuthStat @table_from, @table_to, @logdate

-- make AUTHSTATAGE  report
set @table_to =  'R' + @stryear + '_' + @strmonth  +  '_AUTHSTATAGE_' + cast(@report_world as varchar)
exec lin_RPAuthStatAge @table_from, @table_to, @logdate

-- make AUTHSTATSEX  report
set @table_to =  'R' + @stryear + '_' + @strmonth  +  '_AUTHSTATSEX_' + cast(@report_world as varchar)
exec lin_RPAuthStatSex @table_from, @table_to, @logdate
GO

/********************************************
lin_ProcessLog4
makes report tables from log tables every early morning.

#argument	@report_date	datetime	the date to create reports
#argument	@report_world	int		the number of world to create reports
#return
#result_set
#remark		Currently, this procedure is not used.
#example	Exec lin_ProcessLog4 getdate(), 1: This Example makes the current report of the 1st world.
#history	create		young	2004-04-14
#see		lin_RPLoginCount
#see		lin_RPPlayTime
#see		lin_RPConcurrent
#see		lin_RPItemBuy
#see		lin_RPItemSell
#see		lin_RPTradeGive
#see		lin_RPTradeGet
#see		lin_RPSellPrivate
#see		lin_RPCharPlayTime
#see		lin_RPExp
#see		lin_RPPrivateStore
#see		lin_RPSvrStart
#see		lin_RPCastleWar
#see		lin_RPCastleTaxIncome
#see		lin_RPCastleTaxTribute
#see		lin_RPLevUp2
#see		lin_RPPledgeUp
#see		lin_RPPlayStat
#see		lin_RPPCKillPC
#see		lin_RPCastleTax
#see		lin_RPCharPlay
#see		lin_RPKillPCCount
********************************************/
ALTER PROCEDURE [DBO].[lin_ProcessLog4]

	@report_date datetime ,
	@report_world int = 1
AS


SET NOCOUNT ON

if @report_date is null
begin
	set @report_date = getdate()
	set @report_date = dateadd(d, -1, getdate())
end

DECLARE @nyear int
DECLARE @nmonth int
DECLARE @nday int
DECLARE @stryear varchar(10)
DECLARE @strmonth varchar(10)
DECLARE @strday varchar(10)
DECLARE @str_report varchar(32)
DECLARE @logdate int

set @nyear = datepart(yyyy, @report_date)
set @nmonth = datepart(mm, @report_date)
set @nday = datepart(dd, @report_date)

set @stryear = cast(@nyear as varchar)
if @nmonth < 10
	set @strmonth = '0' + cast(@nmonth as varchar)
else
	set @strmonth = cast (@nmonth as varchar)

if @nday < 10
	set @strday = '0' + cast(@nday as varchar)
else
	set @strday = cast (@nday as varchar)	

set @str_report = @stryear + '/' + @strmonth + '/' + @strday
set @logdate = cast(@stryear + @strmonth + @strday as int)

------------- now.. we have year, month, day string
DECLARE @table_from varchar(60)
DECLARE @table_to varchar(60)
declare @sql varchar(512)


--------------------------- using view
set @table_from = 'L' + @stryear  + '_' + @strmonth + '_' + @strday + '_log_data0_' + cast ( @report_world as varchar)


-----------------------------------------------------------------------------------------------------------------------------------------------------------------
-----------------------------------------------------------------------------------------------------------------------------------------------------------------

-- make LOGINCOUNT report
set @table_to =  'R' + @stryear + '_' + @strmonth  +  '_LOGINCOUNT_' + cast(@report_world as varchar)
exec lin_RPLoginCount @table_from, @table_to, @logdate
waitfor delay '0:0:6'
/*
-- make HUNTCOUNT report
set @table_to =  'R' + @stryear + '_' + @strmonth  +  '_HUNTCOUNT_' + cast(@report_world as varchar)
exec lin_RPHuntCount @table_from, @table_to, @logdate
waitfor delay '0:0:6'

-- make LEARNSKILLLEV report
set @table_to =  'R' + @stryear + '_' + @strmonth  +  '_LEARNSKILLLEV_' + cast(@report_world as varchar)
exec lin_RPLearnSkillLev @table_from, @table_to, @logdate
waitfor delay '0:0:6'

-- make CHANGECLASS report
set @table_to =  'R' + @stryear + '_' + @strmonth  +  '_CHANGECLASS_' + cast(@report_world as varchar)
exec lin_RPChangeClass @table_from, @table_to, @logdate
waitfor delay '0:0:6'
*/
-- make PLAYTIME report
set @table_to =  'R' + @stryear + '_' + @strmonth  +  '_PLAYTIME_' + cast(@report_world as varchar)
exec lin_RPPlayTime @table_from, @table_to, @logdate
waitfor delay '0:0:6'
/*
-- make NPCHUNTED report
set @table_to =  'R' + @stryear + '_' + @strmonth  +  '_NPCHUNTED_' + cast(@report_world as varchar)
exec lin_RPNPCHunted @table_from, @table_to, @logdate
waitfor delay '0:0:6'

-- make EARNSP report
set @table_to =  'R' + @stryear + '_' + @strmonth  +  '_EARNSP_' + cast(@report_world as varchar)
exec lin_RPEarnSP @table_from, @table_to, @logdate
waitfor delay '0:0:6'

-- make LEVUP report
-- set @table_to =  'R' + @stryear + '_' + @strmonth  +  '_LEVUP_' + cast(@report_world as varchar)
-- exec lin_RPLevUp @table_from, @table_to, @logdate
-- waitfor delay '0:0:6'

-- make PCDIE report
set @table_to =  'R' + @stryear + '_' + @strmonth  +  '_PCDIE_' + cast(@report_world as varchar)
exec lin_RPPCDie @table_from, @table_to, @logdate
waitfor delay '0:0:6'

-- make PCDIELOC report
set @table_to =  'R' + @stryear + '_' + @strmonth  +  '_PCDIELOC_' + cast(@report_world as varchar)
exec lin_RPPCDieLoc @table_from, @table_to, @logdate
waitfor delay '0:0:6'

-- make NPCDIELOC report
set @table_to =  'R' + @stryear + '_' + @strmonth  +  '_NPCDIELOC_' + cast(@report_world as varchar)
exec lin_RPNPCDieLoc @table_from, @table_to, @logdate
waitfor delay '0:0:6'

-- make PCDIELOC2 report
set @table_to =  'R' + @stryear + '_' + @strmonth  +  '_PCDIELOC2_' + cast(@report_world as varchar)
exec lin_RPPCDieLoc2 @table_from, @table_to, @logdate
waitfor delay '0:0:6'

-- make NPCDIELOC2 report
set @table_to =  'R' + @stryear + '_' + @strmonth  +  '_NPCDIELOC2_' + cast(@report_world as varchar)
exec lin_RPNPCDieLoc2 @table_from, @table_to, @logdate
waitfor delay '0:0:6'

-- make USESKILL report
set @table_to =  'R' + @stryear + '_' + @strmonth  +  '_USESKILL_' + cast(@report_world as varchar)
exec lin_RPUseSkill @table_from, @table_to, @logdate
waitfor delay '0:0:6'

-- make ACCOUNTPLAYTIME  report
set @table_to =  'R' + @stryear + '_' + @strmonth  +  '_ACCOUNTPLAYTIME_' + cast(@report_world as varchar)
exec lin_RPAccountPlayTime @table_from, @table_to, @logdate
waitfor delay '0:0:6'

-- make CASTSKILL report
set @table_to =  'R' + @stryear + '_' + @strmonth  +  '_CASTSKILL_' + cast(@report_world as varchar)
exec lin_RPCastSkill @table_from, @table_to, @logdate
waitfor delay '0:0:6'

-- make PCKILLNPC report
set @table_to =  'R' + @stryear + '_' + @strmonth  +  '_PCKILLNPC_' + cast(@report_world as varchar)
exec lin_RPPCKillNPC @table_from, @table_to, @logdate
waitfor delay '0:0:6'

-- make STAND report
set @table_to =  'R' + @stryear + '_' + @strmonth  +  '_STAND_' + cast(@report_world as varchar)
exec lin_RPStand @table_from, @table_to, @logdate
waitfor delay '0:0:6'

-- make DIEDURATION report
set @table_to =  'R' + @stryear + '_' + @strmonth  +  '_DIEDURATION_' + cast(@report_world as varchar)
exec lin_RPDieDuration @table_from, @table_to, @logdate
waitfor delay '0:0:6'
*/
-- make CONCURRENT  report
set @table_to =  'R' + @stryear + '_' + @strmonth  +  '_CONCURRENT_' + cast(@report_world as varchar)
exec lin_RPConcurrent @table_from, @table_to, @logdate
waitfor delay '0:0:6'
/*
-- make CLASS report
set @table_to =  'R' + @stryear + '_' + @strmonth  +  '_CLASS_' + cast(@report_world as varchar)
exec lin_RPClass @table_from, @table_to, @logdate
waitfor delay '0:0:6'


-- make BEGINQUEST report
set @table_to =  'R' + @stryear + '_' + @strmonth  +  '_BEGINQUEST_' + cast(@report_world as varchar)
exec lin_RPBeginQuest @table_from, @table_to, @logdate
waitfor delay '0:0:6'

-- make ENDQUEST report
set @table_to =  'R' + @stryear + '_' + @strmonth  +  '_ENDQUEST_' + cast(@report_world as varchar)
exec lin_RPEndQuest @table_from, @table_to, @logdate
waitfor delay '0:0:6'

-- make STOPQUEST report
set @table_to =  'R' + @stryear + '_' + @strmonth  +  '_STOPQUEST_' + cast(@report_world as varchar)
exec lin_RPStopQuest @table_from, @table_to, @logdate
waitfor delay '0:0:6'

-- make SAYCOUNT  report
set @table_to =  'R' + @stryear + '_' + @strmonth  +  '_SAYCOUNT_' + cast(@report_world as varchar)
exec lin_RPSayCount @table_from, @table_to, @logdate
waitfor delay '0:0:6'
*/

---------------------------------- item report part

-- make ITEMBUY report
set @table_to =  'R' + @stryear + '_' + @strmonth  +  '_ITEMBUY_' + cast(@report_world as varchar)
exec lin_RPItemBuy @table_from, @table_to, @logdate
waitfor delay '0:0:6'

-- make ITEMSELL report
set @table_to =  'R' + @stryear + '_' + @strmonth  +  '_ITEMSELL_' + cast(@report_world as varchar)
exec lin_RPItemSell @table_from, @table_to, @logdate
waitfor delay '0:0:6'

/*
-- make EARNADENA report
set @table_to =  'R' + @stryear + '_' + @strmonth  +  '_EARNADENA_' + cast(@report_world as varchar)
exec lin_RPEarnAdena @table_from, @table_to, @logdate
waitfor delay '0:0:6'

-- make NPCDROP report
set @table_to =  'R' + @stryear + '_' + @strmonth  +  '_NPCDROP_' + cast(@report_world as varchar)
exec lin_RPNPCDrop @table_from, @table_to, @logdate
waitfor delay '0:0:6'

-- make NPCDROP2 report
set @table_to =  'R' + @stryear + '_' + @strmonth  +  '_NPCDROP2_' + cast(@report_world as varchar)
exec lin_RPNPCDrop2 @table_from, @table_to, @logdate
waitfor delay '0:0:6'

-- make WAREDEPOSIT report
set @table_to =  'R' + @stryear + '_' + @strmonth  +  '_WAREDEPOSIT_' + cast(@report_world as varchar)
exec lin_RPWareDeposit @table_from, @table_to, @logdate
waitfor delay '0:0:6'

-- make WARERETRIEVE report
set @table_to =  'R' + @stryear + '_' + @strmonth  +  '_WARERETRIEVE_' + cast(@report_world as varchar)
exec lin_RPWareRetrieve @table_from, @table_to, @logdate
waitfor delay '0:0:6'
*/

-- make TRADEGIVE report
set @table_to =  'R' + @stryear + '_' + @strmonth  +  '_TRADEGIVE_' + cast(@report_world as varchar)
exec lin_RPTradeGive @table_from, @table_to, @logdate
waitfor delay '0:0:6'

-- make TRADEGET  report
set @table_to =  'R' + @stryear + '_' + @strmonth  +  '_TRADEGET_' + cast(@report_world as varchar)
exec lin_RPTradeGet  @table_from, @table_to, @logdate
waitfor delay '0:0:6'
/*

-- make NPCDROPLOC report
set @table_to =  'R' + @stryear + '_' + @strmonth  +  '_NPCDROPLOC_' + cast(@report_world as varchar)
exec lin_RPNPCDropLoc @table_from, @table_to, @logdate
waitfor delay '0:0:6'

-- make EQUIPITEM report
set @table_to =  'R' + @stryear + '_' + @strmonth  +  '_EQUIPITEM_' + cast(@report_world as varchar)
exec lin_RPEquipItem @table_from, @table_to, @logdate
waitfor delay '0:0:6'

-- make ENCHANT report
set @table_to =  'R' + @stryear + '_' + @strmonth  +  '_ENCHANT_' + cast(@report_world as varchar)
exec lin_RPEnchant @table_from, @table_to, @logdate
waitfor delay '0:0:6'

-- make ENCHANTFAIL report
set @table_to =  'R' + @stryear + '_' + @strmonth  +  '_ENCHANTFAIL_' + cast(@report_world as varchar)
exec lin_RPEnchantFail @table_from, @table_to, @logdate
waitfor delay '0:0:6'

-- make CRYSTALIZE report
set @table_to =  'R' + @stryear + '_' + @strmonth  +  '_CRYSTALIZE_' + cast(@report_world as varchar)
exec lin_RPCrystalize @table_from, @table_to, @logdate
waitfor delay '0:0:6'
*/
-- make SELLPRIVATE report
set @table_to =  'R' + @stryear + '_' + @strmonth  +  '_SELLPRIVATE_' + cast(@report_world as varchar)
exec lin_RPSellPrivate @table_from, @table_to, @logdate
waitfor delay '0:0:6'

/*
-- make ITEMINC report
set @table_to =  'R' + @stryear + '_' + @strmonth  +  '_ITEMINC_' + cast(@report_world as varchar)
exec lin_RPItemInc @table_from, @table_to, @logdate
waitfor delay '0:0:6'

-- make ITEMDEC report
set @table_to =  'R' + @stryear + '_' + @strmonth  +  '_ITEMDEC_' + cast(@report_world as varchar)
exec lin_RPItemDec @table_from, @table_to, @logdate
waitfor delay '0:0:6'

-- make DIEDROP report
set @table_to =  'R' + @stryear + '_' + @strmonth  +  '_DIEDROP_' + cast(@report_world as varchar)
exec lin_RPDieDrop @table_from, @table_to, @logdate
waitfor delay '0:0:6'

-- make NPCDROPITEM report
set @table_to =  'R' + @stryear + '_' + @strmonth  +  '_NPCDROPITEM_' + cast(@report_world as varchar)
exec lin_RPNPCDropItem @table_from, @table_to, @logdate
waitfor delay '0:0:6'


-- make RECIPE report
set @table_to =  'R' + @stryear + '_' + @strmonth  +  '_RECIPE_' + cast(@report_world as varchar)

exec lin_RPRecipe @table_from, @table_to, @logdate
waitfor delay '0:0:6'
*/
----------------------------------------- new reports
-- make CHARPLAYTIME report
set @table_to =  'R' + @stryear + '_' + @strmonth  +  '_CHARPLAYTIME_' + cast(@report_world as varchar)
exec lin_RPCharPlayTime @table_from, @table_to, @logdate
waitfor delay '0:0:6'

-- make EXP report
set @table_to =  'R' + @stryear + '_' + @strmonth  +  '_EXP_' + cast(@report_world as varchar)
exec lin_RPExp @table_from, @table_to, @logdate
waitfor delay '0:0:6'
/*
-- make GETITEM  report
set @table_to =  'R' + @stryear + '_' + @strmonth  +  '_GETITEM_' + cast(@report_world as varchar)
exec lin_RPGetItem @table_from, @table_to, @logdate
waitfor delay '0:0:6'

-- make ASSET  report
set @table_to =  'R' + @stryear + '_' + @strmonth  +  '_ASSET_' + cast(@report_world as varchar)
exec lin_RPAsset @table_from, @table_to, @logdate
waitfor delay '0:0:6'

-- make EQUIPPED  report
set @table_to =  'R' + @stryear + '_' + @strmonth  +  '_EQUIPPED_' + cast(@report_world as varchar)
exec lin_RPEquipped @table_from, @table_to, @logdate
waitfor delay '0:0:6'

-- make TRADEITEM  report
set @table_to =  'R' + @stryear + '_' + @strmonth  +  '_TRADEITEM_' + cast(@report_world as varchar)
exec lin_RPTradeItem @table_from, @table_to, @logdate
waitfor delay '0:0:6'

-- make LEVINC report
set @table_to =  'R' + @stryear + '_' + @strmonth  +  '_LEVINC_' + cast(@report_world as varchar)
exec lin_RPLevInc @table_from, @table_to, @logdate
waitfor delay '0:0:6'

-- make LEVDEC report
set @table_to =  'R' + @stryear + '_' + @strmonth  +  '_LEVDEC_' + cast(@report_world as varchar)
exec lin_RPLevDec @table_from, @table_to, @logdate
waitfor delay '0:0:6'

-- make CLASSINC report
set @table_to =  'R' + @stryear + '_' + @strmonth  +  '_CLASSINC_' + cast(@report_world as varchar)
exec lin_RPClassInc @table_from, @table_to, @logdate
waitfor delay '0:0:6'

-- make CLASSDEC report
set @table_to =  'R' + @stryear + '_' + @strmonth  +  '_CLASSDEC_' + cast(@report_world as varchar)
exec lin_RPClassDec @table_from, @table_to, @logdate
waitfor delay '0:0:6'
*/
-- make PRIVATESTORE report
set @table_to =  'R' + @stryear + '_' + @strmonth  +  '_PRIVATESTORE_' + cast(@report_world as varchar)
exec lin_RPPrivateStore @table_from, @table_to, @logdate

-- make SVRSTART  report
set @table_from = 'L' + @stryear  + '_' + @strmonth + '_' + @strday + '_log_realtime_' + cast ( @report_world as varchar)
set @table_to =  'R' + @stryear + '_' + @strmonth  +  '_SVRSTART_' + cast(@report_world as varchar)
exec lin_RPSvrStart @table_from, @table_to, @logdate
waitfor delay '0:0:6'
/*
-- make CASTSPOIL  report
set @table_from = 'L' + @stryear  + '_' + @strmonth + '_' + @strday + '_log_data0_' + cast ( @report_world as varchar)
set @table_to =  'R' + @stryear + '_' + @strmonth  +  '_CASTSPOIL_' + cast(@report_world as varchar)
exec lin_RPCastSpoil @table_from, @table_to, @logdate
waitfor delay '0:0:6'
*/
-- make CASTLEWAR report
set @table_from = 'L' + @stryear  + '_' + @strmonth + '_' + @strday + '_log_data0_' + cast ( @report_world as varchar)
set @table_to =  'R' + @stryear + '_' + @strmonth  +  '_CASTLEWAR_' + cast(@report_world as varchar)
exec lin_RPCastleWar @table_from, @table_to, @logdate
waitfor delay '0:0:6'

-- make TAXINCOME  report
set @table_from = 'L' + @stryear  + '_' + @strmonth + '_' + @strday + '_log_data0_' + cast ( @report_world as varchar)
set @table_to =  'R' + @stryear + '_' + @strmonth  +  '_TAXINCOME_' + cast(@report_world as varchar)
exec lin_RPCastleTaxIncome @table_from, @table_to, @logdate
waitfor delay '0:0:6'

-- make TAXTRIBUTE report
set @table_from = 'L' + @stryear  + '_' + @strmonth + '_' + @strday + '_log_data0_' + cast ( @report_world as varchar)
set @table_to =  'R' + @stryear + '_' + @strmonth  +  '_TAXTRIBUTE_' + cast(@report_world as varchar)
exec lin_RPCastleTaxTribute @table_from, @table_to, @logdate
waitfor delay '0:0:6'


-- make LEVUP2  report
set @table_from = 'L' + @stryear  + '_' + @strmonth + '_' + @strday + '_log_data0_' + cast ( @report_world as varchar)
set @table_to =  'R' + @stryear + '_' + @strmonth  +  '_LEVUP2_' + cast(@report_world as varchar)
exec lin_RPLevUp2 @table_from, @table_to, @logdate
waitfor delay '0:0:6'

-- make PLEDGEUP  report
set @table_from = 'L' + @stryear  + '_' + @strmonth + '_' + @strday + '_log_data0_' + cast ( @report_world as varchar)
set @table_to =  'R' + @stryear + '_' + @strmonth  +  '_PLEDGEUP_' + cast(@report_world as varchar)
exec lin_RPPledgeUp @table_from, @table_to, @logdate

waitfor delay '0:0:6'

-- make PLAYSTAT  report
set @table_from = 'L' + @stryear  + '_' + @strmonth + '_' + @strday + '_log_data0_' + cast ( @report_world as varchar)
set @table_to =  'R' + @stryear + '_' + @strmonth  +  '_PLAYSTAT_' + cast(@report_world as varchar)
exec lin_RPPlayStat @table_from, @table_to, @logdate

waitfor delay '0:0:6'

-- make PCKILLPC  report
set @table_from = 'L' + @stryear  + '_' + @strmonth + '_' + @strday + '_log_data0_' + cast ( @report_world as varchar)
set @table_to =  'R' + @stryear + '_' + @strmonth  +  '_PCKILLPC_' + cast(@report_world as varchar)
exec lin_RPPCKillPC @table_from, @table_to, @logdate

waitfor delay '0:0:6'

-- make TAX  report
set @table_from = 'L' + @stryear  + '_' + @strmonth + '_' + @strday + '_log_data0_' + cast ( @report_world as varchar)
set @table_to =  'R' + @stryear + '_' + @strmonth  +  '_TAX_' + cast(@report_world as varchar)
exec lin_RPCastleTax @table_from, @table_to, @logdate

waitfor delay '0:0:6'

-- make CHARPLAY report
set @table_from = 'L' + @stryear  + '_' + @strmonth + '_' + @strday + '_log_data0_' + cast ( @report_world as varchar)
set @table_to =  'R' + @stryear + '_' + @strmonth  +  '_CHARPLAY_' + cast(@report_world as varchar)
exec lin_RPCharPlay @table_from, @table_to, @logdate

waitfor delay '0:0:6'

-- make KILLPCCOUNT  report
set @table_from = 'L' + @stryear  + '_' + @strmonth + '_' + @strday + '_log_data0_' + cast ( @report_world as varchar)
set @table_to =  'R' + @stryear + '_' + @strmonth  +  '_KILLPCCOUNT_' + cast(@report_world as varchar)
exec lin_RPKillPCCount  @table_from, @table_to, @logdate
GO

/********************************************
lin_RPLevUp
do make levelup report

#argument	@table_from	varchar(60)	log table to be a source
#argument	@table_to	varchar(60)	report table to be a destination
#argument	@logdate	int		the date of report to be created
#return
#result_set
#remark		This procedure may not be used
#example	Exec lin_RPLevUp 'L2004_11_30_log_data_8', 'R2004_11_LEVUP_8', 20041130
#history	create		young	2003-03-17
#see		lin_RPLevUp2
********************************************/
ALTER PROCEDURE [DBO].[lin_RPLevUp]
	@table_from	varchar(60),
	@table_to	varchar(60),
	@logdate	int

AS
SET NOCOUNT ON

declare @sql varchar(4000)

-- check table whether @table_to is exists or not
set @sql = 'select * from lin2report.dbo.sysobjects (nolock) where name = ''' + @table_to + ''''
exec (@sql)

if (@@ROWCOUNT = 0)
begin
	set @sql = 'CREATE TABLE dbo.' + @table_to + ' (' 
		+ ' log_date	int, '
		+ ' levup_level	int, '
		+ ' levup_time	int, '
		+ ' char_count	int, '
		+ ' avg_time	bigint, '
		+ ' var_time	bigint, '
		+ ' v2_time	bigint, '
		+ ' min_time	int, '
		+ ' max_time	int '
		+ ' ) '
	exec (@sql)

	set @sql = 'CREATE INDEX IX_' + @table_to + '_1 on dbo.' + @table_to + ' (log_date) '
	exec (@sql)
end
else begin
	set @sql = 'delete from dbo.' + @table_to + ' where log_date = ' + CAST(@logdate as varchar)
	exec (@sql)
end

-- check tmp table
declare @tmp_table varchar(512)
set @tmp_table = 'dbo.tmp' + @table_to

set @sql = 'select * from lin2report.dbo.sysobjects (nolock) where name = ''tmp' + @table_to + ''''
exec (@sql)

if (@@ROWCOUNT > 0)
begin
	set @sql = ' drop table dbo.tmp' + @table_to
	exec (@sql)
end

-- make tmptable
set @table_from = replace ( @table_from, 'data0', 'data2' )
set @sql = ' select log_id, etc_num4, etc_num5,  etc_num6 , etc_num7  into ' + @tmp_table
	+ ' from lin2log.dbo.' + @table_from  + ' ( nolock) where log_id = 810  '
exec (@sql)

set @table_from = replace ( @table_from, 'data2', 'data' )
set @sql = ' insert into ' + @tmp_table + ' ( log_id, etc_num4, etc_num5,  etc_num6 , etc_num7   ) ( select log_id, etc_num4, etc_num5,  etc_num6 , etc_num7  '
	+ ' from lin2log.dbo.' + @table_from  + ' ( nolock) where log_id = 810  ) '
exec (@sql)


-- insert into report table
-- levelup report
set @sql = 'insert into ' + RTRIM(@table_to) + ' ( log_date,  levup_level, levup_time, char_count, avg_time, var_time, v2_time, min_time, max_time ) ( ' 
	+ ' select ' + CAST(@logdate as varchar) + ', etc_num4, sum(etc_num6), count(log_id), avg(etc_num6), var(etc_num6) , count(log_id) * (var(etc_num6) + cast(avg(etc_num6 ) as bigint) * cast(avg(etc_num6 ) as bigint ) ), min(etc_num6), max(etc_num6)  from '
	+ @tmp_table +  ' ( nolock ) where  etc_num4 > etc_num5 and etc_num6 > 0 and ( etc_num7 is null or etc_num7 = 0 )    group by etc_num4 )  option (MAXDOP 1 ) '
exec (@sql )


-- drop tmptable
set @sql = 'drop table ' + @tmp_table
exec (@sql)
GO

/********************************************
lin_ProcessLogNew
makes report tables from log tables every early morning.

#argument	@report_date	datetime	the date to create reports
#argument	@report_world	int		the number of world to create reports
#return
#result_set
#remark		Currently, this procedure is not used.
#example	Exec lin_ProcessLogNew getdate(), 1: This Example makes the current report of the 1st world.
#history	create		young	2003-9-23
#see		lin_RPLoginCount
#see		lin_RPHuntCount
#see		lin_RPLearnSkillLev
#see		lin_RPChangeClass
#see		lin_RPPlayTime
#see		lin_RPNPCHunted
#see		lin_RPItemBuy
#see		lin_RPItemSell
#see		lin_RPEarnAdena
#see		lin_RPEarnSP
#see		lin_RPNPCDrop
#see		lin_RPNPCDrop2
#see		lin_RPLevUp
#see		lin_RPPCDie
#see		lin_RPPCDieLoc
#see		lin_RPNPCDieLoc
#see		lin_RPPCDieLoc2
#see		lin_RPNPCDieLoc2
#see		lin_RPWareDeposit
#see		lin_RPWareRetrieve
#see		lin_RPTradeGive
#see		lin_RPTradeGet
#see		lin_RPUseSkill
#see		lin_RPAccountPlayTime
#see		lin_RPCastSkill
#see		lin_RPPCKillNPC
#see		lin_RPNPCDropLoc
#see		lin_RPEquipItem
#see		lin_RPStand
#see		lin_RPDieDuration
#see		lin_RPConcurrent
#see		lin_RPClass
#see		lin_RPEnchant
#see		lin_RPEnchantFail
#see		lin_RPCrystalize
#see		lin_RPSellPrivate
#see		lin_RPItemInc
#see		lin_RPItemDec
#see		lin_RPBeginQuest
#see		lin_RPEndQuest
#see		lin_RPStopQuest
#see		lin_RPDieDrop
#see		lin_RPNPCDropItem
#see		lin_RPSayCount
#see		lin_RPRecipe
********************************************/
ALTER PROCEDURE [DBO].[lin_ProcessLogNew]

	@report_date datetime ,
	@report_world int = 1
AS
SET NOCOUNT ON

if @report_date is null
begin
	set @report_date = getdate()
	set @report_date = dateadd(d, -1, getdate())
end

DECLARE @nyear int
DECLARE @nmonth int
DECLARE @nday int
DECLARE @stryear varchar(10)
DECLARE @strmonth varchar(10)
DECLARE @strday varchar(10)
DECLARE @str_report varchar(32)
DECLARE @logdate int

set @nyear = datepart(yyyy, @report_date)
set @nmonth = datepart(mm, @report_date)
set @nday = datepart(dd, @report_date)

set @stryear = cast(@nyear as varchar)
if @nmonth < 10
	set @strmonth = '0' + cast(@nmonth as varchar)
else
	set @strmonth = cast (@nmonth as varchar)

if @nday < 10
	set @strday = '0' + cast(@nday as varchar)
else
	set @strday = cast (@nday as varchar)	

set @str_report = @stryear + '/' + @strmonth + '/' + @strday
set @logdate = cast(@stryear + @strmonth + @strday as int)

------------- now.. we have year, month, day string
DECLARE @table_from varchar(60)
DECLARE @table_to varchar(60)
declare @sql varchar(512)


set @table_from = 'L' + @stryear  + '_' + @strmonth + '_' + @strday + '_log_data_' + cast ( @report_world as varchar)

-- check index
set @sql = 'select * from  lin2log.dbo.sysindexes (nolock) where name = ''IX_' + @table_from + '_3'''
exec (@sql)

if (@@ROWCOUNT = 0)
begin
	set @sql = 'CREATE CLUSTERED INDEX IX_' + @table_from + '_3 on lin2log.dbo.' + @table_from + ' (log_id) '
	exec (@sql)
end 

set @table_from = 'L' + @stryear  + '_' + @strmonth + '_' + @strday + '_log_data2_' + cast ( @report_world as varchar)

-- check index
set @sql = 'select * from  lin2log.dbo.sysindexes (nolock) where name = ''IX_' + @table_from + '_3'''
exec (@sql)

if (@@ROWCOUNT = 0)
begin
	set @sql = 'CREATE CLUSTERED INDEX IX_' + @table_from + '_3 on lin2log.dbo.' + @table_from + ' (log_id) '
	exec (@sql)
end 


--------------------------- using view
set @table_from = 'L' + @stryear  + '_' + @strmonth + '_' + @strday + '_log_data0_' + cast ( @report_world as varchar)


-----------------------------------------------------------------------------------------------------------------------------------------------------------------
-----------------------------------------------------------------------------------------------------------------------------------------------------------------

-- make LOGINCOUNT report
set @table_to =  'R' + @stryear + '_' + @strmonth  +  '_LOGINCOUNT_' + cast(@report_world as varchar)
exec lin_RPLoginCount @table_from, @table_to, @logdate
waitfor delay '0:0:6'

-- make HUNTCOUNT report
set @table_to =  'R' + @stryear + '_' + @strmonth  +  '_HUNTCOUNT_' + cast(@report_world as varchar)
exec lin_RPHuntCount @table_from, @table_to, @logdate
waitfor delay '0:0:6'

-- make LEARNSKILLLEV report
set @table_to =  'R' + @stryear + '_' + @strmonth  +  '_LEARNSKILLLEV_' + cast(@report_world as varchar)
exec lin_RPLearnSkillLev @table_from, @table_to, @logdate
waitfor delay '0:0:6'

-- make CHANGECLASS report
set @table_to =  'R' + @stryear + '_' + @strmonth  +  '_CHANGECLASS_' + cast(@report_world as varchar)
exec lin_RPChangeClass @table_from, @table_to, @logdate
waitfor delay '0:0:6'

-- make PLAYTIME report
set @table_to =  'R' + @stryear + '_' + @strmonth  +  '_PLAYTIME_' + cast(@report_world as varchar)
exec lin_RPPlayTime @table_from, @table_to, @logdate
waitfor delay '0:0:6'

-- make NPCHUNTED report
set @table_to =  'R' + @stryear + '_' + @strmonth  +  '_NPCHUNTED_' + cast(@report_world as varchar)
exec lin_RPNPCHunted @table_from, @table_to, @logdate
waitfor delay '0:0:6'

-- make ITEMBUY report
set @table_to =  'R' + @stryear + '_' + @strmonth  +  '_ITEMBUY_' + cast(@report_world as varchar)
exec lin_RPItemBuy @table_from, @table_to, @logdate
waitfor delay '0:0:6'

-- make ITEMSELL report
set @table_to =  'R' + @stryear + '_' + @strmonth  +  '_ITEMSELL_' + cast(@report_world as varchar)
exec lin_RPItemSell @table_from, @table_to, @logdate
waitfor delay '0:0:6'


-- make EARNADENA report
set @table_to =  'R' + @stryear + '_' + @strmonth  +  '_EARNADENA_' + cast(@report_world as varchar)
exec lin_RPEarnAdena @table_from, @table_to, @logdate
waitfor delay '0:0:6'

-- make EARNSP report
set @table_to =  'R' + @stryear + '_' + @strmonth  +  '_EARNSP_' + cast(@report_world as varchar)
exec lin_RPEarnSP @table_from, @table_to, @logdate
waitfor delay '0:0:6'

-- make NPCDROP report
set @table_to =  'R' + @stryear + '_' + @strmonth  +  '_NPCDROP_' + cast(@report_world as varchar)
exec lin_RPNPCDrop @table_from, @table_to, @logdate
waitfor delay '0:0:6'

-- make NPCDROP2 report
set @table_to =  'R' + @stryear + '_' + @strmonth  +  '_NPCDROP2_' + cast(@report_world as varchar)
exec lin_RPNPCDrop2 @table_from, @table_to, @logdate
waitfor delay '0:0:6'

-- make LEVUP report
set @table_to =  'R' + @stryear + '_' + @strmonth  +  '_LEVUP_' + cast(@report_world as varchar)
exec lin_RPLevUp @table_from, @table_to, @logdate
waitfor delay '0:0:6'

-- make PCDIE report
set @table_to =  'R' + @stryear + '_' + @strmonth  +  '_PCDIE_' + cast(@report_world as varchar)
exec lin_RPPCDie @table_from, @table_to, @logdate
waitfor delay '0:0:6'

-- make PCDIELOC report
set @table_to =  'R' + @stryear + '_' + @strmonth  +  '_PCDIELOC_' + cast(@report_world as varchar)
exec lin_RPPCDieLoc @table_from, @table_to, @logdate
waitfor delay '0:0:6'

-- make NPCDIELOC report
set @table_to =  'R' + @stryear + '_' + @strmonth  +  '_NPCDIELOC_' + cast(@report_world as varchar)
exec lin_RPNPCDieLoc @table_from, @table_to, @logdate
waitfor delay '0:0:6'

-- make PCDIELOC2 report
set @table_to =  'R' + @stryear + '_' + @strmonth  +  '_PCDIELOC2_' + cast(@report_world as varchar)
exec lin_RPPCDieLoc2 @table_from, @table_to, @logdate
waitfor delay '0:0:6'

-- make NPCDIELOC2 report
set @table_to =  'R' + @stryear + '_' + @strmonth  +  '_NPCDIELOC2_' + cast(@report_world as varchar)
exec lin_RPNPCDieLoc2 @table_from, @table_to, @logdate
waitfor delay '0:0:6'

-- make WAREDEPOSIT report
set @table_to =  'R' + @stryear + '_' + @strmonth  +  '_WAREDEPOSIT_' + cast(@report_world as varchar)
exec lin_RPWareDeposit @table_from, @table_to, @logdate
waitfor delay '0:0:6'

-- make WARERETRIEVE report
set @table_to =  'R' + @stryear + '_' + @strmonth  +  '_WARERETRIEVE_' + cast(@report_world as varchar)
exec lin_RPWareRetrieve @table_from, @table_to, @logdate
waitfor delay '0:0:6'

-- make TRADEGIVE report
set @table_to =  'R' + @stryear + '_' + @strmonth  +  '_TRADEGIVE_' + cast(@report_world as varchar)
exec lin_RPTradeGive @table_from, @table_to, @logdate
waitfor delay '0:0:6'

-- make TRADEGET  report
set @table_to =  'R' + @stryear + '_' + @strmonth  +  '_TRADEGET_' + cast(@report_world as varchar)
exec lin_RPTradeGet  @table_from, @table_to, @logdate
waitfor delay '0:0:6'

-- make USESKILL report
set @table_to =  'R' + @stryear + '_' + @strmonth  +  '_USESKILL_' + cast(@report_world as varchar)
exec lin_RPUseSkill @table_from, @table_to, @logdate
waitfor delay '0:0:6'

-- make ACCOUNTPLAYTIME  report
set @table_to =  'R' + @stryear + '_' + @strmonth  +  '_ACCOUNTPLAYTIME_' + cast(@report_world as varchar)
exec lin_RPAccountPlayTime @table_from, @table_to, @logdate
waitfor delay '0:0:6'

-- make CASTSKILL report
set @table_to =  'R' + @stryear + '_' + @strmonth  +  '_CASTSKILL_' + cast(@report_world as varchar)
exec lin_RPCastSkill @table_from, @table_to, @logdate
waitfor delay '0:0:6'

-- make PCKILLNPC report
set @table_to =  'R' + @stryear + '_' + @strmonth  +  '_PCKILLNPC_' + cast(@report_world as varchar)

exec lin_RPPCKillNPC @table_from, @table_to, @logdate
waitfor delay '0:0:6'

-- make NPCDROPLOC report
set @table_to =  'R' + @stryear + '_' + @strmonth  +  '_NPCDROPLOC_' + cast(@report_world as varchar)
exec lin_RPNPCDropLoc @table_from, @table_to, @logdate
waitfor delay '0:0:6'

-- make EQUIPITEM report
set @table_to =  'R' + @stryear + '_' + @strmonth  +  '_EQUIPITEM_' + cast(@report_world as varchar)
exec lin_RPEquipItem @table_from, @table_to, @logdate
waitfor delay '0:0:6'

-- make STAND report
set @table_to =  'R' + @stryear + '_' + @strmonth  +  '_STAND_' + cast(@report_world as varchar)
exec lin_RPStand @table_from, @table_to, @logdate
waitfor delay '0:0:6'

-- make DIEDURATION report
set @table_to =  'R' + @stryear + '_' + @strmonth  +  '_DIEDURATION_' + cast(@report_world as varchar)
exec lin_RPDieDuration @table_from, @table_to, @logdate
waitfor delay '0:0:6'

-- make CONCURRENT  report
set @table_to =  'R' + @stryear + '_' + @strmonth  +  '_CONCURRENT_' + cast(@report_world as varchar)
exec lin_RPConcurrent @table_from, @table_to, @logdate
waitfor delay '0:0:6'

-- make CLASS report
set @table_to =  'R' + @stryear + '_' + @strmonth  +  '_CLASS_' + cast(@report_world as varchar)
exec lin_RPClass @table_from, @table_to, @logdate
waitfor delay '0:0:6'

-- make ENCHANT report
set @table_to =  'R' + @stryear + '_' + @strmonth  +  '_ENCHANT_' + cast(@report_world as varchar)
exec lin_RPEnchant @table_from, @table_to, @logdate
waitfor delay '0:0:6'

-- make ENCHANTFAIL report
set @table_to =  'R' + @stryear + '_' + @strmonth  +  '_ENCHANTFAIL_' + cast(@report_world as varchar)
exec lin_RPEnchantFail @table_from, @table_to, @logdate
waitfor delay '0:0:6'

-- make CRYSTALIZE report
set @table_to =  'R' + @stryear + '_' + @strmonth  +  '_CRYSTALIZE_' + cast(@report_world as varchar)
exec lin_RPCrystalize @table_from, @table_to, @logdate
waitfor delay '0:0:6'

-- make SELLPRIVATE report
set @table_to =  'R' + @stryear + '_' + @strmonth  +  '_SELLPRIVATE_' + cast(@report_world as varchar)
exec lin_RPSellPrivate @table_from, @table_to, @logdate
waitfor delay '0:0:6'

-- make ITEMINC report
set @table_to =  'R' + @stryear + '_' + @strmonth  +  '_ITEMINC_' + cast(@report_world as varchar)
exec lin_RPItemInc @table_from, @table_to, @logdate
waitfor delay '0:0:6'

-- make ITEMDEC report
set @table_to =  'R' + @stryear + '_' + @strmonth  +  '_ITEMDEC_' + cast(@report_world as varchar)
exec lin_RPItemDec @table_from, @table_to, @logdate
waitfor delay '0:0:6'

-- make BEGINQUEST report
set @table_to =  'R' + @stryear + '_' + @strmonth  +  '_BEGINQUEST_' + cast(@report_world as varchar)
exec lin_RPBeginQuest @table_from, @table_to, @logdate
waitfor delay '0:0:6'

-- make ENDQUEST report
set @table_to =  'R' + @stryear + '_' + @strmonth  +  '_ENDQUEST_' + cast(@report_world as varchar)
exec lin_RPEndQuest @table_from, @table_to, @logdate
waitfor delay '0:0:6'

-- make STOPQUEST report
set @table_to =  'R' + @stryear + '_' + @strmonth  +  '_STOPQUEST_' + cast(@report_world as varchar)
exec lin_RPStopQuest @table_from, @table_to, @logdate
waitfor delay '0:0:6'

-- make DIEDROP report
set @table_to =  'R' + @stryear + '_' + @strmonth  +  '_DIEDROP_' + cast(@report_world as varchar)
exec lin_RPDieDrop @table_from, @table_to, @logdate
waitfor delay '0:0:6'

-- make NPCDROPITEM report
set @table_to =  'R' + @stryear + '_' + @strmonth  +  '_NPCDROPITEM_' + cast(@report_world as varchar)
exec lin_RPNPCDropItem @table_from, @table_to, @logdate
waitfor delay '0:0:6'

-- make SAYCOUNT  report
set @table_to =  'R' + @stryear + '_' + @strmonth  +  '_SAYCOUNT_' + cast(@report_world as varchar)
exec lin_RPSayCount @table_from, @table_to, @logdate
waitfor delay '0:0:6'

-- make RECIPE report
set @table_to =  'R' + @stryear + '_' + @strmonth  +  '_RECIPE_' + cast(@report_world as varchar)
exec lin_RPRecipe @table_from, @table_to, @logdate
GO

/********************************************
lin_RPAdenaStatus
do make adena status report

#argument	@table_from	varchar(60)	log table to be a source
#argument	@table_to	varchar(60)	report table to be a destination
#argument	@logdate	int		the date of report to be created
#return
#result_set
#remark
#example	Exec lin_RPAdenaStatus 'L2005_03_03_log_data_<world_id>', 'R2005_03_AdenaStatus_<world_id>', 20050303
#history		create	btwinuni	2005-03-03
#see
********************************************/
ALTER PROCEDURE [DBO].[lin_RPAdenaStatus]
	@table_from	varchar(60),
	@table_to	varchar(60),
	@logdate	int

AS
SET NOCOUNT ON

declare @sql varchar(4000)

-- check table whether @table_to is exists or not
set @sql = 'select * from lin2report.dbo.sysobjects (nolock) where name = ''' + @table_to + ''''
exec (@sql)

if (@@ROWCOUNT = 0)
begin
	set @sql = 'CREATE TABLE dbo.' + @table_to + ' (' 
		+ ' log_date	int, '
		+ ' log_id	int,' 
		+ ' amount	int '
		+ ' ) '
	exec (@sql)

	set @sql = 'CREATE INDEX IX_' + @table_to + '_1 on dbo.' + @table_to + ' (log_date) '
	exec (@sql)
end
else begin
	set @sql = 'delete from dbo.' + @table_to + ' where log_date = ' + CAST(@logdate as varchar)
	exec (@sql)
end

-- insert into report table
-- buy items in a store(-)
set @sql = 'insert into ' + RTRIM(@table_to) + ' (log_date, log_id, amount) '
	+ 'select ' + cast(@logdate as varchar) + ', log_id, sum(isnull(etc_num9, 0)) as amount '
	+ 'from lin2log.dbo.' + @table_from + '(nolock) '
	+ 'where etc_num9 < 0 '
	+ 'group by log_id, etc_num8 '
	+ 'having log_id = 901 '
	+ '	and etc_num8 = 57 '
exec ( @sql)

-- sell to a merchant(+)
set @sql = 'insert into ' + RTRIM(@table_to) + ' (log_date, log_id, amount) '
	+ 'select ' + cast(@logdate as varchar) + ', log_id, sum(isnull(etc_num9, 0)) as amount '
	+ 'from lin2log.dbo.' + @table_from + '(nolock) '
	+ 'where etc_num9 > 0 '
	+ 'group by log_id, etc_num8 '
	+ 'having log_id = 902  '
	+ '	and etc_num8 = 57 '
exec ( @sql)

-- drop(+)
set @sql = 'insert into ' + RTRIM(@table_to) + ' (log_date, log_id, amount) '
	+ 'select ' + cast(@logdate as varchar) + ', log_id, sum(isnull(etc_num9, 0)) as amount '
	+ 'from lin2log.dbo.' + @table_from + '(nolock) '
	+ 'group by log_id, etc_num8 '
	+ 'having log_id = 912  '
	+ '	and etc_num8 = 57 '
exec ( @sql)

-- teleport(-)
set @sql = 'insert into ' + RTRIM(@table_to) + ' (log_date, log_id, amount) '
	+ 'select ' + cast(@logdate as varchar) + ', log_id, sum(isnull(etc_num5, 0)) as amount '
	+ 'from lin2log.dbo.' + @table_from + '(nolock) '
	+ 'group by log_id '
	+ 'having log_id = 939 '
exec ( @sql)

-- lotto(-)
set @sql = 'insert into ' + RTRIM(@table_to) + ' (log_date, log_id, amount) '
	+ 'select ' + cast(@logdate as varchar) + ', log_id, sum(isnull(etc_num7, 0)) * 2000 as amount '
	+ 'from lin2log.dbo.' + @table_from + '(nolock) '
	+ 'group by log_id '
	+ 'having log_id = 963 '
exec ( @sql)

-- monster race(-)
set @sql = 'insert into ' + RTRIM(@table_to) + ' (log_date, log_id, amount) '
	+ 'select ' + cast(@logdate as varchar) + ', log_id, sum(isnull(etc_num9, 0)) as amount '
	+ 'from lin2log.dbo.' + @table_from + '(nolock) '
	+ 'group by log_id '
	+ 'having log_id = 965 '
exec ( @sql)

-- quest settlement(+)
set @sql = 'insert into ' + RTRIM(@table_to) + ' (log_date, log_id, amount) '
	+ 'select ' + cast(@logdate as varchar) + ', log_id, sum(isnull(etc_num6, 0)) as amount '
	+ 'from lin2log.dbo.' + @table_from + '(nolock) '
	+ 'group by log_id, etc_num5 '
	+ 'having log_id = 301 '
	+ '	and etc_num5 = 57 '
exec ( @sql)
GO

/********************************************
lin_RPCheckTable
check the existence of table

#argument	@table_name	varchar(60)	the name of table that we want to know whether exists or not
#return		0 (exist) or 1 (not exist)
#result_set
#remark
#example	Exec lin_RPCheckTable 'R2004_11_USESKILL_8': This example return 0 (exist) or 1 (not exist)
#history		create		btwinuni	2004-11-29
#see
********************************************/
ALTER PROCEDURE [DBO].[lin_RPCheckTable]
	@table_name	varchar(60)
AS
SET NOCOUNT ON

if exists (select * from dbo.sysobjects where id = object_id(@table_name) and OBJECTPROPERTY(id, N'IsUserTable') = 1)
	return 0
else
	return 1
GO

/********************************************
lin_RPItem
do make item snap shot report

#argument	@db_server	varchar(30)	server name of world
#argument	@user_id	varchar(30)	login id
#argument	@user_pass	varchar(30)	login password
#argument	@world_id	int		the number of world to create a snap-shot
#return
#result_set
#remark		This procedure may not be used
#example	Exec lin_RPLoginCount 'server_name', 'gamma', '', 1
#history	create		young	2003-06-18
#see
********************************************/
ALTER PROCEDURE [DBO].[lin_RPItem]
	@db_server	varchar(30),
	@user_id	varchar(30),
	@user_pass	varchar(30),
	@world_id	int

AS
SET NOCOUNT ON

declare @sql varchar(4000)
declare @dtnow datetime
declare @dtyear int
declare @dtmonth int
declare @dtday int
declare @logdate int
declare @table_to nvarchar(50)

set @dtnow = getdate()
set @dtyear = datepart( yyyy, @dtnow)
set @dtmonth = datepart( mm, @dtnow)
set @dtday = datepart( day, @dtnow)
set @logdate = @dtyear * 10000 + @dtmonth * 100 + @dtday

if @dtmonth < 10
	set @table_to = 'R' + cast( @dtyear as varchar) + '_0'  + cast( @dtmonth as varchar) + '_ITEM_' + cast( @world_id as varchar)
else
	set @table_to = 'R' + cast( @dtyear as varchar) + '_'  + cast( @dtmonth as varchar) + '_ITEM_' + cast( @world_id as varchar)


-- check table whether @table_to is exists or not
set @sql = 'select * from lin2report.dbo.sysobjects (nolock) where name = ''' + @table_to + ''''
exec (@sql)

if (@@ROWCOUNT = 0)
begin
	set @sql = 'CREATE TABLE dbo.' + @table_to + ' (' 
		+ ' log_date	int, '
		+ ' item_type	int, '
		+ ' warehouse	int, '
		+ ' amount	money '
		+ ' ) '
	exec (@sql)

	set @sql = 'CREATE INDEX IX_' + @table_to + '_1 on dbo.' + @table_to + ' (log_date) '
	exec (@sql)
end
else begin
	set @sql = 'delete from dbo.' + @table_to + ' where log_date = ' + CAST(@logdate as varchar)
	exec (@sql)
end

-- check tmp table
declare @tmp_table varchar(512)
set @tmp_table = 'dbo.tmp' + @table_to

set @sql = 'select * from lin2report.dbo.sysobjects (nolock) where name = ''tmp' + @table_to + ''''
exec (@sql)

if (@@ROWCOUNT > 0)
begin
	set @sql = ' drop table dbo.tmp' + @table_to
	exec (@sql)
end

-- insert into report table

set @sql = '  insert into ' + RTRIM(@table_to) + ' ( log_date, item_type, warehouse, amount ) ( ' 
	+ ' select  * '
	+ ' from OPENROWSET ( ''SQLOLEDB'', ''' + @db_server + ''';''' + @user_id + ''';''' + @user_pass  + ''',  '
	+ ' ''select log_date=' +  CAST( @logdate as NVARCHAR) + ' , item_type, warehouse, amount=sum( cast ( amount as money) ) from lin2world.dbo.user_item  (nolock) where char_id >1 group by item_type, warehouse'' )  )'
exec (@sql )
GO

/********************************************
lin_RPLocSweeper
make sweeper item class & amount from NPC for each map location report

#argument	@table_from	varchar(60)	table to be source
#argument	@table_to	varchar(60)	table to be destination
#argument	@logdate	int	logging date
#return
#result_set
#remark
#example	lin_RPLocSweeper 'L2004_06_15_log_data_8', 'R2004_06_LOCSWEEPER_8', 20040615
#history	create	flagoftiger	2004-06-15
#see
********************************************/
ALTER PROCEDURE [DBO].[lin_RPLocSweeper]
	@table_from	varchar(60),
	@table_to	varchar(60),
	@logdate	int

AS
SET NOCOUNT ON

declare @sql varchar(4000)

-- check table whether @table_to is exists or not
set @sql = 'select * from lin2report.dbo.sysobjects (nolock) where name = ''' + @table_to + ''''
exec (@sql)

if (@@ROWCOUNT = 0)
begin
	set @sql = 'CREATE TABLE dbo.' + @table_to + ' (' 
		+ ' log_date	int, '
		+ ' log_type	smallint, '
		+ ' x_loc	int, '
		+ ' y_loc	int, '
		+ ' pc_level	int, '
		+ ' npc_class	int, '
		+ ' npc_level	int, '
		+ ' item_class	int, '
		+ ' item_amount	int '
		+ ' ) '
	exec (@sql)

	set @sql = 'CREATE clustered INDEX IX_' + @table_to + '_1 on dbo.' + @table_to + ' (log_date, log_type, x_loc, y_loc) '
	exec (@sql)
end
else begin
	set @sql = 'delete from dbo.' + @table_to + ' where log_date = ' + CAST(@logdate as varchar)
	exec (@sql)
end

-- check tmp table
declare @tmp_table varchar(512)
set @tmp_table = 'dbo.tmp' + @table_to

set @sql = 'select * from lin2report.dbo.sysobjects (nolock) where name = ''tmp' + @table_to + ''''
exec (@sql)

if (@@ROWCOUNT > 0)
begin
	set @sql = ' drop table dbo.tmp' + @table_to
	exec (@sql)
end



-- make tmptable
set @table_from = replace ( @table_from, 'data0', 'data2' )
set @sql = ' select log_id, location_x, location_y, etc_num4, etc_num6, etc_num7, etc_num8, etc_num9 into ' + @tmp_table
	+ ' from lin2log.dbo.' + @table_from  + ' (nolock) where log_id = 954 '
exec (@sql)

set @table_from = replace ( @table_from, 'data2', 'data' )
set @sql = ' insert into ' + @tmp_table + ' ( log_id, location_x, location_y, etc_num4, etc_num6, etc_num7, etc_num8, etc_num9 ) '
	+ ' ( select log_id, location_x, location_y, etc_num4, etc_num6, etc_num7, etc_num8, etc_num9 '
	+ ' from lin2log.dbo.' + @table_from  + ' (nolock) where log_id = 954 ) '
exec (@sql)

-- insert into report table
-- Large Map
set @sql = 'insert into ' + RTRIM(@table_to) + ' ( log_date, log_type, x_loc, y_loc, pc_level, npc_class, npc_level, item_class, item_amount ) ( ' 
	+ ' select ' + CAST(@logdate as varchar) + ', 1, floor(location_x / 32786.0) , floor(location_y / 32786.0), etc_num4, etc_num6, etc_num7, etc_num8, sum(etc_num9)  from '
	+ @tmp_table + ' group by floor(location_x / 32786.0), floor(location_y / 32786.0), etc_num4, etc_num6, etc_num7, etc_num8 )  option (MAXDOP 1 ) '
exec (@sql)
-- Small Map
set @sql = 'insert into ' + RTRIM(@table_to) + ' ( log_date, log_type, x_loc, y_loc, pc_level, npc_class, npc_level, item_class, item_amount ) ( ' 
	+ ' select ' + CAST(@logdate as varchar) + ', 2, floor(location_x / 1024.0) , floor(location_y / 1024.0), etc_num4, etc_num6, etc_num7, etc_num8, sum(etc_num9)  from '
	+ @tmp_table + ' group by floor(location_x / 1024.0), floor(location_y / 1024.0), etc_num4, etc_num6, etc_num7, etc_num8 )  option (MAXDOP 1 ) '
exec (@sql)

-- drop tmptable
set @sql = ' drop table ' + @tmp_table
exec (@sql)
GO

/********************************************
lin_RPRankDailyGetExp
make Daily Get Exp Ranking Table

#argument	@table_from	varchar(60)	table to be source
#argument	@table_to	varchar(60)	table to be destination
#argument	@logdate	int	logging date
#return
#result_set
#remark
#example	lin_RPRankDailyGetExp '', '', 2004-07-13
#history	create	flagoftiger	2004-07-13
#see
********************************************/
ALTER PROCEDURE [DBO].[lin_RPRankDailyGetExp]
	@table_from	varchar(60),
	@table_to	varchar(60),
	@logdate	int

AS
SET NOCOUNT ON

declare @sql varchar(4000)

-- check table whether @table_to is exists or not
set @sql = 'select * from lin2report.dbo.sysobjects (nolock) where name = ''' + @table_to + ''''
exec (@sql)

if (@@ROWCOUNT = 0)
begin
	set @sql = 'CREATE TABLE dbo.' + @table_to + ' (' 
		+ ' log_date	int, '
		+ ' char_id	int, '
		+ ' char_name	nvarchar(60), '
		+ ' level_min	smallint, '
		+ ' level_max	smallint, '
		+ ' level_diff	smallint, '
		+ ' exp_min	int, '
		+ ' exp_max	int, '
		+ ' exp_diff	int '
		+ ' ) '
	exec (@sql)

	set @sql = 'CREATE clustered INDEX IX_' + @table_to + '_2 on dbo.' + @table_to + ' (log_date asc, exp_diff desc ) with fillfactor = 90 '
	exec (@sql)
end
else begin
	set @sql = 'delete from dbo.' + @table_to + ' where log_date = ' + CAST(@logdate as varchar)
	exec (@sql)
end

-- check tmp table
declare @tmp_table varchar(512)
set @tmp_table = 'dbo.tmp' + @table_to

set @sql = 'select * from lin2report.dbo.sysobjects (nolock) where name = ''tmp' + @table_to + ''''
exec (@sql)

if (@@ROWCOUNT > 0)
begin
	set @sql = ' drop table dbo.tmp' + @table_to
	exec (@sql)
end

-- make tmptable
set @table_from = replace ( @table_from, 'data0', 'data2' )
set @sql = ' select log_id, actor, STR_actor, etc_num4, etc_num5 into ' + @tmp_table
	+ ' from lin2log.dbo.' + @table_from  + ' ( nolock) where log_id = 812   '
exec (@sql)

set @table_from = replace ( @table_from, 'data2', 'data' )
set @sql = ' insert into ' + @tmp_table + ' ( log_id, actor, STR_actor, etc_num4, etc_num5 ) ( select log_id, actor, STR_actor, etc_num4, etc_num5 '
	+ ' from lin2log.dbo.' + @table_from  + ' ( nolock) where log_id = 812 ) '
exec (@sql)


-- insert into report table
-- begin quest report
set @sql = 'insert into ' + RTRIM(@table_to) + ' ( log_date, char_id, char_name, level_min, level_max, level_diff, exp_min, exp_max, exp_diff  ) ( ' 
	+ ' select ' + CAST(@logdate as varchar) + ', actor, STR_actor, min(etc_num5), max(etc_num5), max(etc_num5)-min(etc_num5), min(etc_num4), max(etc_num4), max(etc_num4)-min(etc_num4)  from '
	+ @tmp_table + ' ( nolock )  group by  actor, STR_actor) option (MAXDOP 1 ) '
exec (@sql )

-- drop tmltable
set @sql = ' drop table ' + @tmp_table
exec (@sql)
GO

/********************************************
lin_RPTblCastleWar
make castle war winner report

#argument	@table_from	varchar(60)	table to be source
#argument	@table_to	varchar(60)	table to be destination
#argument	@logdate	int	logging date
#return
#result_set
#remark
#example	lin_RPTblCasleWar '', '', 20040804
#history	create	flagoftiger	2004-08-04
#see
********************************************/
ALTER PROCEDURE [DBO].[lin_RPTblCastleWar]
	@table_from	varchar(60),
	@table_to	varchar(60),
	@logdate	int

AS
SET NOCOUNT ON

declare @sql varchar(4000)

-- check table whether @table_to is exists or not
set @sql = 'select * from lin2report.dbo.sysobjects (nolock) where name = ''' + @table_to + ''''
exec (@sql)

if (@@ROWCOUNT = 0)
begin
	set @sql = 'CREATE TABLE dbo.' + @table_to + ' (' 
		+ ' log_date	int, '
		+ ' pledge_name	varchar(50), '
		+ ' log_id	int, '
		+ ' act_time	datetime, '
		+ ' castle_id 	int , '
		+ ' pledge_id 	int , '
		+ ' alliance_id 	int  '
		+ ' ) '
	exec (@sql)

	set @sql = 'CREATE clustered INDEX IX_' + @table_to + '_1 on dbo.' + @table_to + ' (log_date) '
	exec (@sql)

end
else begin
	set @sql = 'delete from dbo.' + @table_to + ' where log_date = ' + CAST(@logdate as varchar)
	exec (@sql)
end


-- insert into report table
set @sql = 'insert into ' + RTRIM(@table_to) + ' ( log_date,  pledge_name, log_id, act_time,  castle_id, pledge_id, alliance_id ) ( ' 
	+ ' select ' + CAST(@logdate as varchar) + ', etc_str1, log_id, act_time, etc_num1, etc_num2, etc_num3  from lin2log.dbo.' + @table_from 
	+ ' (nolock)  where log_id in ( 244, 245 )  )  option (MAXDOP 1 ) '
exec (@sql )
GO

/********************************************
lin_RPTblGetQuestItem
do make a report that shows total amount of adena by quest

#argument	@table_from	varchar(60)	log table to be a source
#argument	@table_to	varchar(60)	report table to be a destination
#argument	@logdate	int		the date of report to be created
#return
#result_set
#remark
#example	lin_RPTblGetQuestItem 'L2004_11_30_log_data_8', 'RP_TBLGETQUESTITEMCHAR_8', 20041130
#history	create	zzangse	2004-09-14
#see
********************************************/
ALTER       PROCEDURE [DBO].[lin_RPTblGetQuestItem]
	@table_from	varchar(60),
	@table_to	varchar(60),
	@logdate	int

AS
SET NOCOUNT ON

declare @sql varchar(4000)

-- check table whether @table_to is exists or not
set @sql = 'select * from lin2report.dbo.sysobjects (nolock) where name = ''' + @table_to + ''''
exec (@sql)

if (@@ROWCOUNT = 0)
begin
	set @sql = 'CREATE TABLE dbo.' + @table_to + ' (' 
		+ ' log_date	int, '
		+ ' quest_id	int, '
		+ ' adena	bigint, '
		+ ' all_dprice	bigint '
		+ ' ) '
	exec (@sql)

	set @sql = 'CREATE clustered INDEX IX_' + @table_to + '_1 on dbo.' + @table_to + ' (log_date asc, adena desc, all_dprice desc) with fillfactor = 90 '
	exec (@sql)
	set @sql = 'CREATE nonclustered INDEX IX_' + @table_to + '_2 on dbo.' + @table_to + ' (log_date asc, all_dprice desc, adena desc ) with fillfactor = 90 '
	exec (@sql)
end
else begin
	set @sql = 'delete from dbo.' + @table_to + ' where log_date = ' + CAST(@logdate as varchar)
	exec (@sql)
end

-- check tmp table
declare @tmp_table varchar(512)
set @tmp_table = 'dbo.tmp' + @table_to

set @sql = 'select * from lin2report.dbo.sysobjects (nolock) where name = ''' + @tmp_table + ''''
exec (@sql)

if (@@ROWCOUNT > 0)
begin
	set @sql = ' drop table ' + @tmp_table
	exec (@sql)
end

-- make tmptable
set @sql = ' select log_id, etc_num7,  etc_num5, etc_num6, etc_num8 into ' + @tmp_table
	+ ' from lin2log.dbo.' + @table_from  + '(nolock) where log_id = 301   '
exec (@sql)


-- insert into report table
-- begin quest report
set @sql = 'insert into ' + RTRIM(@table_to) + ' ( log_date, quest_id, adena, all_dprice  ) ( ' 
	+ ' select ' + CAST(@logdate as varchar) 
	+ ' , A.etc_num7 ' 
	+ ' ,  (select case when sum(cast(B.etc_num6 as bigint)) is null then 0 else sum(cast(B.etc_num6 as bigint)) end from ' 
	+ @tmp_table + '  B(nolock) where B.etc_num5 = 57 and B.etc_num7 = A.etc_num7 ' + ' ) ' 
	+ ' , case when sum(cast( A.etc_num8 as bigint ) ) is null then 0 else sum ( cast ( A.etc_num8 as bigint ) ) end ' 
	+ ' from ' + @tmp_table + ' A(nolock) ' 
	+ ' group by  A.etc_num7 ) option (MAXDOP 1 ) ' 


exec (@sql )

-- drop tmltable
set @sql = ' drop table ' + @tmp_table
exec (@sql)
GO

/********************************************
lin_RPTblGetQuestItemChar
do make a report that shows adena get from quest

#argument	@table_from	varchar(60)	log table to be a source
#argument	@table_to	varchar(60)	report table to be a destination
#argument	@logdate	int		the date of report to be created
#return
#result_set
#remark
#example	lin_RPTblGetQuestItemChar 'L2004_11_30_log_data_8', 'RP_TBLGETQUESTITEMCHAR_8', 20040914
#history	create	flagoftiger	2004-09-14
#see
********************************************/
ALTER     PROCEDURE [DBO].[lin_RPTblGetQuestItemChar]
	@table_from	varchar(60),
	@table_to	varchar(60),
	@logdate	int

AS
SET NOCOUNT ON

declare @sql varchar(4000)

-- check table whether @table_to is exists or not
set @sql = 'select * from lin2report.dbo.sysobjects (nolock) where name = ''' + @table_to + ''''
exec (@sql)

if (@@ROWCOUNT = 0)
begin
	set @sql = 'CREATE TABLE dbo.' + @table_to + ' (' 
		+ ' log_date	int, '
		+ ' char_id	int, '
		+ ' char_name	nvarchar(60), '
		+ ' adena	bigint, '
		+ ' dprice	bigint '
		+ ' ) '
	exec (@sql)

	set @sql = 'CREATE clustered INDEX IX_' + @table_to + '_1 on dbo.' + @table_to + ' (log_date asc, adena desc, dprice desc) with fillfactor = 90 '
	exec (@sql)
	set @sql = 'CREATE nonclustered INDEX IX_' + @table_to + '_2 on dbo.' + @table_to + ' (log_date asc, dprice desc, adena desc ) with fillfactor = 90 '
	exec (@sql)
end
else begin
	set @sql = 'delete from dbo.' + @table_to + ' where log_date = ' + CAST(@logdate as varchar)
	exec (@sql)
end

-- check tmp table
declare @tmp_table varchar(512)
set @tmp_table = 'dbo.tmp' + @table_to

set @sql = 'select * from lin2report.dbo.sysobjects (nolock) where name = ''tmp' + @table_to + ''''
exec (@sql)

if (@@ROWCOUNT > 0)
begin
	set @sql = ' drop table dbo.tmp' + @table_to
	exec (@sql)
end

-- make tmptable
set @sql = ' select log_id, actor, STR_actor, etc_num5, etc_num6, etc_num7, etc_num8 into ' + @tmp_table
	+ ' from lin2log.dbo.' + @table_from  + ' ( nolock) where log_id = 301   '
exec (@sql)

-- insert into report table
-- begin quest report
set @sql = 'insert into ' + RTRIM(@table_to) + ' ( log_date, char_id, char_name, adena, dprice  ) ( ' 
	+ ' select ' + CAST(@logdate as varchar) + ', b.actor, b.STR_actor, (select case when sum(cast(etc_num6 as bigint)) is null then 0 else sum(cast(etc_num6 as bigint)) end from ' 
	+ @tmp_table + ' a (nolock) where a.actor = b.actor and a.etc_num5 = 57 ' + '), sum(cast(b.etc_num8 as bigint))  from '
	+ @tmp_table + ' b ( nolock )  group by  actor, STR_actor) option (MAXDOP 1 ) '
exec (@sql )

-- drop tmltable
set @sql = ' drop table ' + @tmp_table
exec (@sql)
GO

/********************************************
lin_RPTblPledgeLevUp
make pledge level up report

#argument	@table_from	varchar(60)	table to be source
#argument	@table_to	varchar(60)	table to be destination
#argument	@logdate	int	logging date
#return
#result_set
#remark
#example	lin_RPTblPledgeLevUp '', '', 20040804
#history	create	flagoftiger	2004-08-04
#see
********************************************/
ALTER PROCEDURE [DBO].[lin_RPTblPledgeLevUp]
	@table_from	varchar(60),
	@table_to	varchar(60),
	@logdate	int

AS
SET NOCOUNT ON

declare @sql varchar(4000)

-- check table whether @table_to is exists or not
set @sql = 'select * from lin2report.dbo.sysobjects (nolock) where name = ''' + @table_to + ''''
exec (@sql)

if (@@ROWCOUNT = 0)
begin
	set @sql = 'CREATE TABLE dbo.' + @table_to + ' (' 
		+ ' log_date	int, '
		+ ' level		smallint, '
		+ ' level_count	int '
		+ ' ) '
	exec (@sql)

	set @sql = 'CREATE clustered INDEX IX_' + @table_to + '_1 on dbo.' + @table_to + ' (log_date) '
	exec (@sql)
end
else begin
	set @sql = 'delete from dbo.' + @table_to + ' where log_date = ' + CAST(@logdate as varchar)
	exec (@sql)
end


-- insert into report table
set @sql = 'insert into ' + RTRIM(@table_to) + ' (log_date,  level, level_count) ( ' 
	+ ' select ' + CAST(@logdate as varchar) + ', etc_num7, count(etc_num7)  from '
	+ ' lin2log.dbo.' + @table_from  + ' (nolock)  where log_id = 215 and etc_num6 = 5 group by etc_num7) option (MAXDOP 1) '

exec (@sql )
GO

/********************************************
lin_RPTblQuestBegin
do make die item crystalize stats

#argument	@table_from	varchar(60)	table to be source
#argument	@table_to	varchar(60)	table to be destination
#argument	@logdate	int	logging date
#return
#result_set
#remark
#example	lin_RPTblQuestBegin '', '', 20040804
#history	create	flagoftiger	2004-08-04
#see
********************************************/
ALTER PROCEDURE [DBO].[lin_RPTblQuestBegin]
	@table_from	varchar(60),
	@table_to	varchar(60),
	@logdate	int

AS
SET NOCOUNT ON

declare @sql varchar(4000)

-- check table whether @table_to is exists or not
set @sql = 'select * from lin2report.dbo.sysobjects (nolock) where name = ''' + @table_to + ''''
exec (@sql)

if (@@ROWCOUNT = 0)
begin
	set @sql = 'CREATE TABLE dbo.' + @table_to + ' (' 
		+ ' log_date	int, '
		+ ' race		smallint, '
		+ ' class		smallint, '
		+ ' level		smallint, '
		+ ' quest_id	int, '
		+ ' quest_count	int  '
		+ ' ) '
	exec (@sql)

	set @sql = 'CREATE clustered INDEX IX_' + @table_to + '_1 on dbo.' + @table_to + ' (log_date, race, quest_count desc) '
	exec (@sql)
	set @sql = 'CREATE INDEX IX_' + @table_to + '_1 on dbo.' + @table_to + ' (log_date, class, quest_count desc) '
	exec (@sql)
	set @sql = 'CREATE INDEX IX_' + @table_to + '_1 on dbo.' + @table_to + ' (log_date, level, quest_count desc) '
	exec (@sql)
	set @sql = 'CREATE INDEX IX_' + @table_to + '_1 on dbo.' + @table_to + ' (log_date, quest_id, quest_count desc) '
	exec (@sql)
end
else begin
	set @sql = 'delete from dbo.' + @table_to + ' where log_date = ' + CAST(@logdate as varchar)
	exec (@sql)
end

-- check tmp table
declare @tmp_table varchar(512)
set @tmp_table = 'dbo.tmp' + @table_to

set @sql = 'select * from lin2report.dbo.sysobjects (nolock) where name = ''tmp' + @table_to + ''''
exec (@sql)

if (@@ROWCOUNT > 0)
begin
	set @sql = ' drop table dbo.tmp' + @table_to
	exec (@sql)
end

-- make tmptable
set @sql = ' select log_id, etc_num1, etc_num3, etc_num4, etc_num5  into ' + @tmp_table
	+ ' from lin2log.dbo.' + @table_from  + ' ( nolock) where log_id = 303   '
exec (@sql)

-- insert into report table
-- begin quest report
set @sql = 'insert into ' + RTRIM(@table_to) + ' ( log_date,  race, class, level, quest_id, quest_count  ) ( ' 
	+ ' select ' + CAST(@logdate as varchar) + ', etc_num1, etc_num3, etc_num4, etc_num5, count(log_id) from '
	+ @tmp_table  + ' ( nolock )  group by  etc_num1, etc_num3, etc_num4, etc_num5 )  option (MAXDOP 1 ) '
exec (@sql )

set @sql = ' drop table ' + @tmp_table
exec ( @sql )
GO

/********************************************
lin_RPTblQuestEnd
make end quest report

#argument	@table_from	varchar(60)	table to be source
#argument	@table_to	varchar(60)	table to be destination
#argument	@logdate	int	logging date
#return
#result_set
#remark
#example	lin_RPTblQuestEnd '', '', 20040804
#history	create	flagoftiger	2004-08-04
#see
********************************************/
ALTER PROCEDURE [DBO].[lin_RPTblQuestEnd]
	@table_from	varchar(60),
	@table_to	varchar(60),
	@logdate	int

AS
SET NOCOUNT ON

declare @sql varchar(4000)

-- check table whether @table_to is exists or not
set @sql = 'select * from lin2report.dbo.sysobjects (nolock) where name = ''' + @table_to + ''''
exec (@sql)

if (@@ROWCOUNT = 0)
begin
	set @sql = 'CREATE TABLE dbo.' + @table_to + ' (' 
		+ ' log_date	int, '
		+ ' race		smallint, '
		+ ' class		smallint, '
		+ ' level		smallint, '
		+ ' quest_id	int, '
		+ ' quest_count	int  '
		+ ' ) '
	exec (@sql)

	set @sql = 'CREATE clustered INDEX IX_' + @table_to + '_1 on dbo.' + @table_to + ' (log_date, race, quest_count desc) '
	exec (@sql)
	set @sql = 'CREATE INDEX IX_' + @table_to + '_1 on dbo.' + @table_to + ' (log_date, class, quest_count desc) '
	exec (@sql)
	set @sql = 'CREATE INDEX IX_' + @table_to + '_1 on dbo.' + @table_to + ' (log_date, level, quest_count desc) '
	exec (@sql)
	set @sql = 'CREATE INDEX IX_' + @table_to + '_1 on dbo.' + @table_to + ' (log_date, quest_id, quest_count desc) '
	exec (@sql)
end
else begin
	set @sql = 'delete from dbo.' + @table_to + ' where log_date = ' + CAST(@logdate as varchar)
	exec (@sql)
end

-- check tmp table
declare @tmp_table varchar(512)
set @tmp_table = 'dbo.tmp' + @table_to

set @sql = 'select * from lin2report.dbo.sysobjects (nolock) where name = ''tmp' + @table_to + ''''
exec (@sql)

if (@@ROWCOUNT > 0)
begin
	set @sql = ' drop table dbo.tmp' + @table_to
	exec (@sql)
end


-- make tmptable
set @sql = ' select log_id, etc_num1, etc_num3, etc_num4, etc_num5 into ' + @tmp_table
	+ ' from lin2log.dbo.' + @table_from  + ' ( nolock) where log_id = 305  '
exec (@sql)

-- insert into report table
-- begin quest report
set @sql = 'insert into ' + RTRIM(@table_to) + ' ( log_date,  race, class, level, quest_id, quest_count  ) ( ' 
	+ ' select ' + CAST(@logdate as varchar) + ', etc_num1, etc_num3, etc_num4, etc_num5, count(log_id) from  '
	+ @tmp_table  + ' ( nolock )  group by  etc_num1, etc_num3, etc_num4, etc_num5 ) option (MAXDOP 1 ) '
exec (@sql )

-- drop tmptable
set @sql = ' drop table ' + @tmp_table
exec ( @sql )
GO

/********************************************
lin_RPTblQuestStop
make stop quest report

#argument	@table_from	varchar(60)	table to be source
#argument	@table_to	varchar(60)	table to be destination
#argument	@logdate	int	logging date
#return
#result_set
#remark
#example	lin_RPTblQuestStop '', '', 20040804
#history	create	flagoftiger	2004-08-04
#see
********************************************/
ALTER PROCEDURE [DBO].[lin_RPTblQuestStop]
	@table_from	varchar(60),
	@table_to	varchar(60),
	@logdate	int

AS
SET NOCOUNT ON

declare @sql varchar(4000)

-- check table whether @table_to is exists or not
set @sql = 'select * from lin2report.dbo.sysobjects (nolock) where name = ''' + @table_to + ''''
exec (@sql)

if (@@ROWCOUNT = 0)
begin
	set @sql = 'CREATE TABLE dbo.' + @table_to + ' (' 
		+ ' log_date	int, '
		+ ' race		smallint, '
		+ ' class		smallint, '
		+ ' level		smallint, '
		+ ' quest_id	int, '
		+ ' quest_count	int  '
		+ ' ) '
	exec (@sql)

	set @sql = 'CREATE clustered INDEX IX_' + @table_to + '_1 on dbo.' + @table_to + ' (log_date, race, quest_count desc) '
	exec (@sql)
	set @sql = 'CREATE INDEX IX_' + @table_to + '_1 on dbo.' + @table_to + ' (log_date, class, quest_count desc) '
	exec (@sql)
	set @sql = 'CREATE INDEX IX_' + @table_to + '_1 on dbo.' + @table_to + ' (log_date, level, quest_count desc) '
	exec (@sql)
	set @sql = 'CREATE INDEX IX_' + @table_to + '_1 on dbo.' + @table_to + ' (log_date, quest_id, quest_count desc) '
	exec (@sql)
end
else begin
	set @sql = 'delete from dbo.' + @table_to + ' where log_date = ' + CAST(@logdate as varchar)
	exec (@sql)
end

-- check tmp table
declare @tmp_table varchar(512)
set @tmp_table = 'dbo.tmp' + @table_to

set @sql = 'select * from lin2report.dbo.sysobjects (nolock) where name = ''tmp' + @table_to + ''''
exec (@sql)

if (@@ROWCOUNT > 0)
begin
	set @sql = ' drop table dbo.tmp' + @table_to
	exec (@sql)
end

-- make tmptable
set @sql = ' select log_id, etc_num1, etc_num3, etc_num4, etc_num5 into ' + @tmp_table
	+ ' from lin2log.dbo.' + @table_from  + ' ( nolock) where log_id = 307   '
exec (@sql)

-- insert into report table
-- begin quest report
set @sql = 'insert into ' + RTRIM(@table_to) + ' ( log_date,  race, class, level, quest_id, quest_count  ) ( ' 
	+ ' select ' + CAST(@logdate as varchar) + ', etc_num1, etc_num3, etc_num4, etc_num5, count(log_id)  from '
	+ @tmp_table + ' ( nolock )  group by  etc_num1, etc_num3, etc_num4, etc_num5 ) option (MAXDOP 1 ) '
exec (@sql )

-- drop tmltable
set @sql = ' drop table ' + @tmp_table
exec (@sql)
GO

/********************************************
lin_RPWorldSnap
do make snap shot report. item, class, level

#argument	@db_server	varchar(30)	name or ip of database
#argument	@user_id	varchar(30)	user id
#argument	@user_pass	varchar(30)	user password
#argument	@world_id	int		the number of world
#return
#result_set
#remark
#example	Exec lin_RPWorldSnap 'db_server', 'gamma', '', 1
#history	create	young	2003-10-31
#see
********************************************/
ALTER PROCEDURE [DBO].[lin_RPWorldSnap]
	@db_server	varchar(30),
	@user_id	varchar(30),
	@user_pass	varchar(30),
	@world_id	int

AS

SET NOCOUNT ON

declare @sql varchar(4000)
declare @dtnow datetime
declare @dtyear int
declare @dtmonth int
declare @dtday int
declare @logdate int
declare @table_to nvarchar(50)

set @dtnow = getdate()
set @dtyear = datepart( yyyy, @dtnow)
set @dtmonth = datepart( mm, @dtnow)
set @dtday = datepart( day, @dtnow)
set @logdate = @dtyear * 10000 + @dtmonth * 100 + @dtday

--------------------------------------------------------------------------------------------------------------------------------------------
--------------------------------------------------------------------------------------------------------------------------------------------
-- item snap shot
--------------------------------------------------------------------------------------------------------------------------------------------
--------------------------------------------------------------------------------------------------------------------------------------------
if @dtmonth < 10
	set @table_to = 'R' + cast( @dtyear as varchar) + '_0'  + cast( @dtmonth as varchar) + '_SNAPITEM_' + cast( @world_id as varchar)
else
	set @table_to = 'R' + cast( @dtyear as varchar) + '_'  + cast( @dtmonth as varchar) + '_SNAPITEM_' + cast( @world_id as varchar)

-- check table whether @table_to is exists or not
set @sql = 'select * from lin2report.dbo.sysobjects (nolock) where name = ''' + @table_to + ''''
exec (@sql)

if (@@ROWCOUNT = 0)
begin
	set @sql = 'CREATE TABLE dbo.' + @table_to + ' (' 
		+ ' log_date	int, '
		+ ' item_type	int, '
		+ ' warehouse	int, '
		+ ' amount	money '
		+ ' ) '
	exec (@sql)

	set @sql = 'CREATE INDEX IX_' + @table_to + '_1 on dbo.' + @table_to + ' (log_date) '
	exec (@sql)
end
else begin
	set @sql = 'delete from dbo.' + @table_to + ' where log_date = ' + CAST(@logdate as varchar)
	exec (@sql)
end

set @sql =   '   insert into ' + RTRIM(@table_to) + ' ( log_date, item_type, warehouse, amount ) ( ' 
	+ ' select  * '
	+ ' from OPENROWSET ( ''SQLOLEDB'', ''' + @db_server + ''';''' + @user_id + ''';''' + @user_pass  + ''',  '
	+ ' ''select log_date=' +  CAST( @logdate as NVARCHAR) + ' , item_type, warehouse, amount=sum( cast ( amount as money) ) from lin2world.dbo.user_item  (nolock) where char_id >1 group by item_type, warehouse'' )  )'

exec (@sql )


--------------------------------------------------------------------------------------------------------------------------------------------
--------------------------------------------------------------------------------------------------------------------------------------------
-- level  snap shot
--------------------------------------------------------------------------------------------------------------------------------------------
--------------------------------------------------------------------------------------------------------------------------------------------
if @dtmonth < 10
	set @table_to = 'R' + cast( @dtyear as varchar) + '_0'  + cast( @dtmonth as varchar) + '_SNAPLEV_' + cast( @world_id as varchar)
else
	set @table_to = 'R' + cast( @dtyear as varchar) + '_'  + cast( @dtmonth as varchar) + '_SNAPLEV_' + cast( @world_id as varchar)

-- check table whether @table_to is exists or not
set @sql = 'select * from lin2report.dbo.sysobjects (nolock) where name = ''' + @table_to + ''''
exec (@sql)


if (@@ROWCOUNT = 0)
begin
	set @sql = 'CREATE TABLE dbo.' + @table_to + ' (' 
		+ ' log_date	int, '
		+ ' lev		int, '
		+ ' lev_count	int ' 
		+ ' ) '
	exec (@sql)

	set @sql = 'CREATE INDEX IX_' + @table_to + '_1 on dbo.' + @table_to + ' (log_date) '
	exec (@sql)
end
else begin
	set @sql = 'delete from dbo.' + @table_to + ' where log_date = ' + CAST(@logdate as varchar)
	exec (@sql)
end

-- insert into report table

set @sql = '  insert into ' + RTRIM(@table_to) + ' ( log_date, lev, lev_count ) ( ' 
	+ ' select  * '
	+ ' from OPENROWSET ( ''SQLOLEDB'', ''' + @db_server + ''';''' + @user_id + ''';''' + @user_pass  + ''',  '

	+ ' ''select log_date=' +  CAST( @logdate as NVARCHAR) + ' , lev, count( lev )  from lin2world.dbo.user_data  (nolock) where char_id >1 group by lev '' )  )'
exec (@sql )


--------------------------------------------------------------------------------------------------------------------------------------------
--------------------------------------------------------------------------------------------------------------------------------------------
-- class  snap shot
--------------------------------------------------------------------------------------------------------------------------------------------
--------------------------------------------------------------------------------------------------------------------------------------------
if @dtmonth < 10
	set @table_to = 'R' + cast( @dtyear as varchar) + '_0'  + cast( @dtmonth as varchar) + '_SNAPCLASS_' + cast( @world_id as varchar)
else
	set @table_to = 'R' + cast( @dtyear as varchar) + '_'  + cast( @dtmonth as varchar) + '_SNAPCLASS_' + cast( @world_id as varchar)

-- check table whether @table_to is exists or not
set @sql = 'select * from lin2report.dbo.sysobjects (nolock) where name = ''' + @table_to + ''''
exec (@sql)

if (@@ROWCOUNT = 0)
begin
	set @sql = 'CREATE TABLE dbo.' + @table_to + ' (' 
		+ ' log_date	int, '
		+ ' class		int, '
		+ ' class_count	int ' 
		+ ' ) '
	exec (@sql)

	set @sql = 'CREATE INDEX IX_' + @table_to + '_1 on dbo.' + @table_to + ' (log_date) '
	exec (@sql)
end
else begin
	set @sql = 'delete from dbo.' + @table_to + ' where log_date = ' + CAST(@logdate as varchar)
	exec (@sql)
end

-- insert into report table

set @sql = '  insert into ' + RTRIM(@table_to) + ' ( log_date, class, class_count ) ( ' 
	+ ' select  * '
	+ ' from OPENROWSET ( ''SQLOLEDB'', ''' + @db_server + ''';''' + @user_id + ''';''' + @user_pass  + ''',  '
	+ ' ''select log_date=' +  CAST( @logdate as NVARCHAR) + ' , class, count( class )  from lin2world.dbo.user_data  (nolock) where char_id >1 group by class '' )  )'
exec (@sql )
GO
